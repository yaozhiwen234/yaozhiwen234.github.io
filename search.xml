<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>AKF服务拆分原则</title>
    <url>/2021/04/18/AKF%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E5%8E%9F%E5%88%99/</url>
    <content><![CDATA[<h1 id="AKF服务拆分原则"><a href="#AKF服务拆分原则" class="headerlink" title="AKF服务拆分原则"></a>AKF服务拆分原则</h1><p>在设计微服务的时候，我们一般会遵循以下4个原则：</p>
<p>1）AKF拆分原则</p>
<p>2）前后端分离原则</p>
<p>3）无状态服务</p>
<p>4）restful的通信风格</p>
<p>下面我们来详细了解以下AKF拆分原则。</p>
<p>1 AKF拆分原则 业界对可扩展系统架构设计有一个朴素的概念，就是：**通过加机器可以解决容量和可用性问题（如果一台不行就两台）</p>
<p>这一理念在“云计算”概念疯狂流行的今天。得到了广泛的认可。对于一个规模迅速增长的系统而言。容量和性能问题当然是首当其冲的。但是随着时间的向前，系统规模的增长，除了面对性能与容量的问题外，还需要面对功能与模块数量上增长带来的系统复杂性问题。以及业务变化带来的提供差异化服务问题。而许多系统在架构设计时并未充分考虑到这些问题，导致系统的重构成为常态。从而影响业务交付能力，还浪费人力财力。对此《可扩展的艺术》一书提出了一个更加系统的可扩展模型—-AKF可扩展立方。这个立方体中沿着三个坐标轴设置分别为X，Y，Z。</p>
<p>2 Y轴功能Y轴扩展会将庞大的整体应用拆分为多个服务。每个服务实现一组相关的功能。如订单管理，客户管理等。在工程上常见的方案是服务化架构（SOA），比如对于一个电子商务平台，我们可以拆分成不同的服务组成下面这样的架构。</p>
<p>但是通过上图容易发现，当服务数量增多时，服务调用关系变得复杂，为系统添加一个新功能。要调用的服务数也变得不可控。由此引发的服务管理上的混乱，一般情况下，需要采用服务注册的机制，形成服务网关来进行服务治理。系统架构将变成如下图所示。</p>
<p>3 X轴（水平扩展）X轴扩展与我们前面理念是一致的。通过绝对平等的复制服务与数据，以及容量和可用性问题。其实就是将微服务运行多个实例。做集群，负载均衡的模式。</p>
<p>为了提升当个服务的可用性和容量。对每一个服务进行x轴扩展划分。</p>
<p><img src="https://pics7.baidu.com/feed/35a85edf8db1cb13a6fbd16fcafd974a93584b6e.jpeg?token=7361c837d5226bd2d991d894cd8126e7&s=95A05F300306454D5EC4C5CA0300F0B3" alt="img"></p>
<p>1.4 Z轴（数据分区）</p>
<p>Z周扩展通常是指基于请求和用户独特的需求，进行系统划分，并使得划分出来的子系统相互隔离，但又是完整的。</p>
<p>1.4.1工程领域常见的这种扩展有以下两种方案。</p>
<p>1.4.1.1 单元化架构</p>
<p>在分布式服务设计领域，一个单元就是满足某个分区所有业务操作的自包含闭环。如上面我们所说的y轴扩展的SOA架构。客户端对服务端节点的选择一般是随机的。但是，如果在此加上这周扩展，那么服务的节点选择将不再是随机的。而是每个单元自成一体。如下图。</p>
<p>1.4.1.2数据分区</p>
<p>为了性能数据安全上的考虑。我们将一个完整的数据集按照一定的维度，划分出不同的子集。一个分区，就是整体数据集的一个子集。比如用尾号来划分用户，那同样尾号的那部分用户，就可以认为是一个分区。数据分析一般包括以下几种数据划分的方式。</p>
<p>数据类型（如：业务类型）</p>
<p>数据范围（如：时间段，用户id）</p>
<p>数据热度（如：用户活跃度，商品热度）</p>
<p>读写分离（如：商品描述，商品库存）</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>BIO</title>
    <url>/2021/06/08/BIO/</url>
    <content><![CDATA[<h3 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h3><p><strong>1. 什么是BIO</strong></p>
<blockquote>
<p>B I/O，意为Blocking I/O，即阻塞的I/O。</p>
<p>很明显重点在阻塞，但怎么就阻塞了？阻塞在哪了？阻塞带来了什么坏处？</p>
</blockquote>
<p><strong>2. BIO的代码实现：</strong></p>
<ol>
<li>服务端</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ServerSocket server = <span class="keyword">new</span> ServerSocket(<span class="number">9090</span>,<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;step1: new ServerSocket(9090) &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        Socket client = server.accept();  <span class="comment">//阻塞1</span></span><br><span class="line">        System.out.println(<span class="string">&quot;step2:client\t&quot;</span> + client.getPort());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            InputStream in = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                in = client.getInputStream();</span><br><span class="line">                BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in));</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                    String dataline = reader.readLine(); <span class="comment">//阻塞2</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">null</span> != dataline)&#123;</span><br><span class="line">                    System.out.println(dataline);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        client.close();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;客户端断开&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>客户端</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          Socket client = <span class="keyword">new</span> Socket(<span class="string">&quot;192.168.150.11&quot;</span>,<span class="number">9090</span>);</span><br><span class="line"></span><br><span class="line">          client.setSendBufferSize(<span class="number">20</span>);</span><br><span class="line">          client.setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line">          OutputStream out = client.getOutputStream();</span><br><span class="line"></span><br><span class="line">          InputStream in = System.in;</span><br><span class="line">          BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in));</span><br><span class="line"></span><br><span class="line">          <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">              String line = reader.readLine();</span><br><span class="line">              <span class="keyword">if</span>(line != <span class="keyword">null</span> )&#123;</span><br><span class="line">                  <span class="keyword">byte</span>[] bb = line.getBytes();</span><br><span class="line">                  <span class="keyword">for</span> (<span class="keyword">byte</span> b : bb) &#123;</span><br><span class="line">                      out.write(b);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>3. BIO的工作模式</strong></p>
<pre class="mermaid">graph TD
A[Client 1] --> S(Service 9090)
C[Client 2] --> S
D[Client 2] --> S
S --> F(Thread 1)
S --> E(Thread 2)
S --> G(Thread 3)
F -->   H(Socket1 处理 Client 1 )
E -->   I(Socket2 处理 Client 2 )
G -->   V(Socket3 处理 Client 3 )</pre>

<p><strong>4. 为什么要使用多线程：</strong></p>
<blockquote>
<p>这是一个经典的每连接每线程的模型，之所以使用多线程，主要原因在于socket.accept()、socket.read()、socket.write()三个主要函数都是同步阻塞的，当一个连接在处理I/O的时候，系统是阻塞的，如果是单线程的话必然就挂死在那里；但CPU是被释放出来的，开启多线程，就可以让CPU去处理更多的事情。其实这也是所有使用多线程的本质：</p>
</blockquote>
<p><strong>5. BIO的缺点</strong></p>
<blockquote>
<p>（1）线程创建资源开销巨大。如果有10000个连接怎么办？创建10000个线程？很明显不现实，太多的线程对系统资源的开销是巨大的。</p>
<p>（2）单个线程的资源浪费。</p>
<p>一个请求来了，如果这个线程从被创建为这个连接服务开始就一直在工工作，那么就不存在资源浪费，就像你找来一个服务员，他只服务一个客人，但他期间一直都有工作作，那么他的劳动力就算不上浪费。</p>
<p>但是绝大多数情况下客人多服务员的需求都是暂时的，服务员很多时候都在发呆玩手机，等待着回应客人的请求，这样这个服务员的劳动力就被浪费了。那么在Bio中线程等待服务的时候是什么样的呢，那就是阻塞，线程等待着为连接服务（读数据/写数据/业务处理），很多时候BIo的服务子线程都是在阻塞状态下的。</p>
</blockquote>
<p><strong>基于以上不足出现了NIO</strong></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>CAP定理</title>
    <url>/2021/04/18/CAP%E5%AE%9A%E7%90%86/</url>
    <content><![CDATA[<h1 id="CAP定理"><a href="#CAP定理" class="headerlink" title="CAP定理"></a>CAP定理</h1><h3 id="CAP理论概述"><a href="#CAP理论概述" class="headerlink" title="CAP理论概述"></a><strong>CAP理论概述</strong></h3><p>   一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition tolerance）这三项中的两     项。</p>
<h3 id="CAP的定义"><a href="#CAP的定义" class="headerlink" title="CAP的定义"></a><strong>CAP的定义</strong></h3><p><strong>Consistency 一致性</strong></p>
<p>一致性指“<code>all nodes see the same data at the same time</code>”，即所有节点在同一时间的数据完全一致。</p>
<p>一致性是因为多个数据拷贝下并发读写才有的问题，因此理解时一定要注意结合考虑多个数据拷贝下并发读写的场景。</p>
<p>对于一致性，可以分为从客户端和服务端两个不同的视角。</p>
<ul>
<li>客户端</li>
</ul>
<p>从客户端来看，一致性主要指的是多并发访问时更新过的数据如何获取的问题。</p>
<ul>
<li>服务端</li>
</ul>
<p>从服务端来看，则是更新如何分布到整个系统，以保证数据最终一致。</p>
<p>对于一致性，可以分为强/弱/最终一致性三类</p>
<p>从客户端角度，多进程并发访问时，更新过的数据在不同进程如何获取的不同策略，决定了不同的一致性。</p>
<ul>
<li>强一致性</li>
</ul>
<p>对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是强一致性。</p>
<ul>
<li>弱一致性</li>
</ul>
<p>如果能容忍后续的部分或者全部访问不到，则是弱一致性。</p>
<ul>
<li>最终一致性</li>
</ul>
<p>如果经过一段时间后要求能访问到更新后的数据，则是最终一致性。</p>
<h3 id="Availability-可用性"><a href="#Availability-可用性" class="headerlink" title="Availability 可用性"></a><strong>Availability 可用性</strong></h3><p>可用性指“<code>Reads and writes always succeed</code>”，即服务在正常响应时间内一直可用。</p>
<p>好的可用性主要是指系统能够很好的为用户服务，不出现用户操作失败或者访问超时等用户体验不好的情况。可用性通常情况下可用性和分布式数据冗余，负载均衡等有着很大的关联。</p>
<h2 id="Partition-Tolerance分区容错性"><a href="#Partition-Tolerance分区容错性" class="headerlink" title="Partition Tolerance分区容错性"></a><strong>Partition Tolerance分区容错性</strong></h2><p>分区容错性指“<code>the system continues to operate despite arbitrary message loss or failure of part of the system</code>”，即分布式系统在遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性或可用性的服务。</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>ConcurrentHashMap 详解</title>
    <url>/2021/05/27/ConcurrentHashMap%20%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="ConcurrentHashMap-详解"><a href="#ConcurrentHashMap-详解" class="headerlink" title="ConcurrentHashMap 详解"></a>ConcurrentHashMap 详解</h2><h3 id="private-static-final-int-MAXIMUM-CAPACITY-1-lt-lt-30"><a href="#private-static-final-int-MAXIMUM-CAPACITY-1-lt-lt-30" class="headerlink" title="private static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;"></a>private static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;</h3><ul>
<li><strong>MAXIMUM_CAPACITY是2的30次方 的原因</strong>`<ol>
<li>int的最大的值是2的31次方-1，所以容量无法到达2的31次方，</li>
<li>需要让容量满足2的幂次，所以设置为2的30次方 </li>
</ol>
</li>
</ul>
<h3 id="private-static-final-int-DEFAULT-CAPACITY-16"><a href="#private-static-final-int-DEFAULT-CAPACITY-16" class="headerlink" title="private static final int DEFAULT_CAPACITY = 16;"></a>private static final int DEFAULT_CAPACITY = 16;</h3><ul>
<li><strong>DEFAULT_CAPACITY = 16;</strong><ol>
<li>方便数据迁移</li>
<li>方便进行计算对应的位置</li>
<li>概率统计</li>
</ol>
</li>
</ul>
<h3 id="new-ConcurrentHashMap-lt-gt-2-自定义大小解释："><a href="#new-ConcurrentHashMap-lt-gt-2-自定义大小解释：" class="headerlink" title="new ConcurrentHashMap&lt;&gt;(2); 自定义大小解释："></a>new ConcurrentHashMap&lt;&gt;(2); 自定义大小解释：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">               MAXIMUM_CAPACITY :</span><br><span class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tableSizeFor的功能（不考虑大于最大容量的情况）是返回大于输入参数且最近的2的整数次幂的数。比如10，则返回16。 </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = c - <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 类的加载过程</title>
    <url>/2021/06/24/Java%20%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<h3 id="Java-类的加载过程"><a href="#Java-类的加载过程" class="headerlink" title="Java 类的加载过程"></a>Java 类的加载过程</h3><h4 id=""><a href="#" class="headerlink" title=""></a><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BA%94%E4%B8%AA%E9%83%A8%E5%88%86%281%29.jpg" alt="类的加载过程"></h4><h3 id="1-Loading-使用双亲委派机制将-class加载到内存中"><a href="#1-Loading-使用双亲委派机制将-class加载到内存中" class="headerlink" title="1.Loading 使用双亲委派机制将 .class加载到内存中"></a><strong>1.Loading 使用双亲委派机制将 .class加载到内存中</strong></h3><p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE.jpg" alt="类的加载机制"></p>
<ol>
<li><p><strong>为什么要使用双亲委派</strong></p>
<blockquote>
<p>　<strong>防止加载同一个.class。</strong>通过委托去询问上级是否已经加载过该.class，如果加载过了，则不需要重新加载。保证了数据安全。</p>
<p>　<strong>保证核心.class不被篡改。</strong>通过委托的方式，保证核心.class不被篡改，即使被篡改也不会被加载，即使被加载也不会是同一个class对象，因为不同的加载器加载同一个.class也不是同一个Class对象。这样则保证了Class的执行安全。</p>
</blockquote>
</li>
<li><p><strong>自定义类加载器 加密代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderWithEncription</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> seed = <span class="number">0B10110110</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">&quot;c:/test/&quot;</span>, name.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.msbclass&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line">            ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">int</span> b = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((b=fis.read()) !=<span class="number">0</span>) &#123;</span><br><span class="line">                baos.write(b ^ seed);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] bytes = baos.toByteArray();</span><br><span class="line">            baos.close();</span><br><span class="line">            fis.close();<span class="comment">//可以写的更加严谨</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> defineClass(name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name); <span class="comment">//throws ClassNotFoundException</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        encFile(<span class="string">&quot;com.yzw.jvm.hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ClassLoader l = <span class="keyword">new</span> ClassLoaderWithEncription();</span><br><span class="line">        Class clazz = l.loadClass(<span class="string">&quot;com.yzw.jvm.Hello&quot;</span>);</span><br><span class="line">        Hello h = (Hello)clazz.newInstance();</span><br><span class="line">        h.m();</span><br><span class="line"></span><br><span class="line">        System.out.println(l.getClass().getClassLoader());</span><br><span class="line">        System.out.println(l.getParent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encFile</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">&quot;c:/test/&quot;</span>, name.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(<span class="string">&quot;c:/test/&quot;</span>, name.replaceAll(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>).concat(<span class="string">&quot;.msbclass&quot;</span>)));</span><br><span class="line">        <span class="keyword">int</span> b = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((b = fis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            fos.write(b ^ seed);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fis.close();</span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><strong>如何打破：重写loadClass（）</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T012_ClassReloading2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">            File f = <span class="keyword">new</span> File(<span class="string">&quot;C:/work/ijprojects/JVM/out/production/JVM/&quot;</span> + name.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!f.exists()) <span class="keyword">return</span> <span class="keyword">super</span>.loadClass(name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                InputStream is = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[is.available()];</span><br><span class="line">                is.read(b);</span><br><span class="line">                <span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.loadClass(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MyLoader m = <span class="keyword">new</span> MyLoader();</span><br><span class="line">        Class clazz = m.loadClass(<span class="string">&quot;com.yzw.jvm.Hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">        m = <span class="keyword">new</span> MyLoader();</span><br><span class="line">        Class clazzNew = m.loadClass(<span class="string">&quot;com.yzw.jvm.Hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(clazz == clazzNew);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p><strong>打破双亲委派的用途</strong></p>
<blockquote>
<ol>
<li>ThreadContextClassLoader可以实现基础类调用实现类代码，通过thread.setContextClassLoader指定</li>
<li>热启动，热部署</li>
<li>osgi tomcat 都有自己的模块指定classloader（可以加载同一类库的不同版本）</li>
</ol>
</blockquote>
</li>
</ol>
</li>
</ol>
<h4 id="2-Linking"><a href="#2-Linking" class="headerlink" title="2. Linking"></a><strong>2. Linking</strong></h4><ol>
<li>Verification<ol>
<li>验证文件是否符合JVM规定</li>
</ol>
</li>
<li>Preparation<ol>
<li>静态成员变量赋默认值</li>
</ol>
</li>
<li>Resolution<ol>
<li>将类、方法、属性等符号引用解析为直接引用<br>常量池中的各种符号引用解析为指针、偏移量等内存地址的直接引用</li>
</ol>
</li>
</ol>
<h4 id="3-Initializing"><a href="#3-Initializing" class="headerlink" title="3.Initializing"></a><strong>3.Initializing</strong></h4><ol>
<li>调用类初始化代码 <clinit>，给静态成员变量赋初始值</li>
</ol>
<h4 id="4-小总结："><a href="#4-小总结：" class="headerlink" title="4. 小总结："></a><strong>4. 小总结：</strong></h4><ol>
<li><p>load - 默认值 - 初始值</p>
</li>
<li><p>new - 申请内存 - 默认值 - 初始值</p>
</li>
<li><p>java 执行的方式是 混合执行 即编译执行+解释执行 jvm会对热点代码进行编译为本地的可执行文件  </p>
</li>
</ol>
<p>​                编译执行： 代码运行速度快，但第一次运行时速度极慢</p>
<p>​                解释执行： 代码以运行速度稍慢</p>
<p>​              -XX:CICompilerCount=n 指定JIT编译器用来编译方法的线程数量</p>
<p>​              -XX:CompileThreshold = 10000:   一个方法调用多少次会被 HotSpot和JIT 编译器能编译它</p>
<p>​               -Xcomp： 指定JVM在第一次使用时把所有的字节码编译成本地代码. (即CompileThreshold=1)</p>
<p>​              -Xint 仅仅使用解释模式，不激活JIT编译器 (即CompileThreshold=0)</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>Java中的深克隆和浅克隆</title>
    <url>/2020/12/18/Java%E4%B8%AD%E7%9A%84%E6%B7%B1%E5%85%8B%E9%9A%86%E5%92%8C%E6%B5%85%E5%85%8B%E9%9A%86/</url>
    <content><![CDATA[<h4 id="Java中的深克隆和浅克隆"><a href="#Java中的深克隆和浅克隆" class="headerlink" title="Java中的深克隆和浅克隆"></a>Java中的深克隆和浅克隆</h4><p><strong>浅克隆：</strong> 创建一个新对象，新对象的属性和原来对象完全相同（新对象的地址 ！= 原来对象的地址），对于非基本类型属性，仍指向原有属性所指向的对象的内存地址。**(String 类型除外)**。</p>
<p><strong>深克隆：</strong> 创建一个新对象，属性中引用的其他对象也会被克隆，不再指向原有对象地址。</p>
<p><strong>浅克隆示例：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">student</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">teacher</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] drive;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">    <span class="keyword">private</span> student stu;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object clone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clone = <span class="keyword">super</span>.clone();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        teacher tea = <span class="keyword">new</span> teacher();</span><br><span class="line">        <span class="keyword">int</span>[] i = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        i[<span class="number">0</span>]=<span class="number">88</span>;</span><br><span class="line">        tea.setDrive(i);</span><br><span class="line">        tea.setName(<span class="string">&quot;老师&quot;</span>);</span><br><span class="line">        student student = <span class="keyword">new</span> student();</span><br><span class="line">        student.setAge(<span class="number">33</span>);</span><br><span class="line">        student.setName(<span class="string">&quot;学生&quot;</span>);</span><br><span class="line">        tea.setAge(<span class="number">56</span>);</span><br><span class="line">        tea.setSex(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        tea.setStu(student);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">       teacher clone = (teacher) tea.clone();</span><br><span class="line">         i[<span class="number">0</span>] = <span class="number">99</span>;</span><br><span class="line">        clone.setDrive(i);</span><br><span class="line">        clone.setAge(<span class="number">78</span>);</span><br><span class="line">        clone.setName(<span class="string">&quot;克隆老师&quot;</span>);</span><br><span class="line">        clone.getStu().setAge(<span class="number">99</span>);</span><br><span class="line">        clone.getStu().setName(<span class="string">&quot;小学生&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(tea);</span><br><span class="line">        System.out.println(clone);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结果</li>
</ul>
<p><strong>注意 此处只有基本数据类型被克隆 引用类型的地址并没有发生变化  Sting除外 因为String是final</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">teacher(drive=[<span class="number">99</span>], name=老师, age=<span class="number">56</span>, sex=男, stu=student(name=小学生, age=<span class="number">99</span>))</span><br><span class="line">teacher(drive=[<span class="number">99</span>], name=克隆老师, age=<span class="number">78</span>, sex=男, stu=student(name=小学生,age=<span class="number">99</span>))</span><br></pre></td></tr></table></figure>

<p><strong>附图：</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/%E6%B5%85%E6%8B%B7%E8%B4%9D.png" alt="浅克隆UNL"></p>
<p><strong>深克隆示例：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">student</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object clone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clone = <span class="keyword">super</span>.clone();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">teacher</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] drive;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> student stu;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意此处</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object clone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clone = <span class="keyword">super</span>.clone();</span><br><span class="line">            student clone1 = (student) <span class="keyword">this</span>.getStu().clone();</span><br><span class="line">            <span class="keyword">this</span>.setStu(clone1);</span><br><span class="line">            <span class="keyword">int</span>[] clone2 = <span class="keyword">this</span>.getDrive().clone();</span><br><span class="line">            <span class="keyword">this</span>.setDrive(clone2);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      teacher tea = <span class="keyword">new</span> teacher();</span><br><span class="line">      <span class="keyword">int</span>[] i = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">      i[<span class="number">0</span>] = <span class="number">88</span>;</span><br><span class="line">      tea.setDrive(i);</span><br><span class="line">      tea.setName(<span class="string">&quot;老师&quot;</span>);</span><br><span class="line">      student student = <span class="keyword">new</span> student();</span><br><span class="line">      student.setAge(<span class="number">33</span>);</span><br><span class="line">      student.setName(<span class="string">&quot;学生&quot;</span>);</span><br><span class="line">      tea.setAge(<span class="number">56</span>);</span><br><span class="line">      tea.setSex(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">      tea.setStu(student);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">      teacher clone = (teacher) tea.clone();</span><br><span class="line">      i[<span class="number">0</span>] = <span class="number">99</span>;</span><br><span class="line">      clone.setDrive(i);</span><br><span class="line">      clone.setAge(<span class="number">78</span>);</span><br><span class="line">      clone.setName(<span class="string">&quot;克隆老师&quot;</span>);</span><br><span class="line">      clone.getStu().setAge(<span class="number">99</span>);</span><br><span class="line">      clone.getStu().setName(<span class="string">&quot;小学生&quot;</span>);</span><br><span class="line"></span><br><span class="line">      System.out.println(tea);</span><br><span class="line">      System.out.println(clone);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结果</li>
</ul>
<p><strong>注意结果发生明显的变化， 因为没个对象都被克隆 所有的引用都指向了不同的地址</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">teacher(drive=[<span class="number">88</span>], name=老师, age=<span class="number">56</span>, sex=男, stu=student(name=学生, age=<span class="number">33</span>))</span><br><span class="line">teacher(drive=[<span class="number">99</span>], name=克隆老师, age=<span class="number">78</span>, sex=男, stu=student(name=小学生, age=<span class="number">99</span>))</span><br></pre></td></tr></table></figure>

<p><strong>附图：</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/%E6%B7%B1%E6%8B%B7%E8%B4%9D.png" alt="深克隆UML"></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>Java中的深克隆和浅克隆</tag>
      </tags>
  </entry>
  <entry>
    <title>Keepalived</title>
    <url>/2021/03/28/Keepalived/</url>
    <content><![CDATA[<h3 id="Keepalived"><a href="#Keepalived" class="headerlink" title="Keepalived"></a>Keepalived</h3><p><strong>LVS集群的缺点</strong></p>
<p>LVS能够实现四层负载，能够支持足够大的并发量，但使用LVS负载均衡集群有以下两个缺点。</p>
<p>① 如果调度器（Director）挂了（不可用），将会导致整个系统不可用，从而调度器成为了单点故障（SPOF）。</p>
<p>② 调度器（Director）无法对后端RealServer做健康状态检测。因此，如果后端的某一台RealServer挂了，前端调度器将无法得知，仍然会向该RealServer调度请求，导致服务不可用；另外，如果某一台挂了的RealServer但已经恢复正常并重新提供服务时，前端调度器也无法得知，并将其加入调度队列。</p>
<p>因此，为了能够使前端调度器（Director）能够冗余、使Director能够对后端各RS做健康状态检测，并按需增删RS，需要引入高可用集群的解决方案。以下介绍的是Keepalived高可用软件。</p>
<p><strong>Keepalived的介绍</strong></p>
<p>什么是keepalived呢？keepalived是实现高可用的一种轻量级的技术手段，主要用来防止单点故障(单点故障是指一旦某一点出现故障就会导致整个系统架构的不可用)的发生。</p>
<p>Keepalived的高可用功能是通过VRRP协议实现的，VRRP是Virtual Router Redundancy Protocol（虚拟路由器冗余协议）的缩写。VRRP的出现是为了解决静态路由单点故障的问题，当某一节点出现故障时，可以防止导致整个网络不可用。Keepalived除了可以高可用LVS之外，还可以作为其他系统网络服务（Nginx、Haproxy等）的高可用解决方案（Keepalived可通过调用vrrp_script来高可用其它服务，并通过调用vrrp_track来追踪每一个服务）。</p>
<p><strong>Keepalived的功能</strong></p>
<p>Keepalived有三个重要功能，如下。</p>
<ul>
<li>高可用系统网络服务。</li>
</ul>
<p>Keepalived可以实现在两台或多台主机之间的故障切换转移。如果在两台主机中都安装了Keepalived，当正常工作时，有一台主机工作为Master角色，另一台主机工作为Backup角色。角色为Master的主机获得所有资源（VIP资源、服务资源）并向用户提供服务，角色为Backup的主机不提供服务而仅作为Master主机的热备。当角色为Master的主机出现故障时，角色为Backup的主机将自动接管Master主机的所有资源（VIP资源、服务资源）并开始工作。当Master主机故障修复完成时，将重新接管原来的资源和工作，而Backup主机则释放Master主机故障时它接管的资源和工作，各自恢复原来的角色。</p>
<ul>
<li>实现对LVS集群中各RealServer的健康状态进行检测。</li>
</ul>
<p>Keepalived可以通过在自身配置文件keepalived.conf中配置LVS集群服务中各台RealServer的IP地址和相关参数，并可以通过网络层、传输层和应用层这三层进行探测各RealServer的健康状态。当有一台或多台RealServer出现故障而无法提供服务时，Keepalived服务可以把出现故障的RealServer从LVS的正常转发队列中移除，保证不影响用户的访问。而当有RealServer故障修复完成时，Keepalived服务可以将其重新加入LVS的正常转发队列中，向用户提供服务。</p>
<ul>
<li>管理LVS负载均衡软件</li>
</ul>
<p>Keepalived可以读取配置文件，并通过一个更为底层的接口来管理IPVS并生成IPVS规则，这使得LVS的使用更为方便。</p>
<p><strong>Keepalived工作原理</strong></p>
<p>前面提到，Keepalived的高可用功能是通过VRRP协议实现的，要了解Keepalived的工作原理，需要先了解VRRP协议的工作原理。</p>
<p><strong>VRRP</strong></p>
<p>​        VRRP是一种容错性协议，它是通过将多台设备虚拟化成一台设备，如果其中一台设备出现故障，那么另一台设备可以迅速接替其工作，已保证通讯的可靠性和连续性。</p>
<p>​     1.工作原理</p>
<p>​    在企业网当中，PC一般是需要使用”网关”来与外部网络进行通讯，这样如果网关出现了故障那么整一个子网的对外通讯都会被切断，VRRP的出现就能把这个问题很好地解决了，VRRP可以通过把多台设备（路由器、交换机、防火墙等）虚拟化成一台设备，然后通过配置虚拟IP地址作为网关就能实现对网关的备份（这虚拟IP地址是代表整个VRRP组内的所有设备），当其中一台设备出现故障之后，VRRP组内其他设备会通过某些机制来接替故障设备的工作。</p>
<p><strong>VRRP概念</strong></p>
<p><strong>虚拟设备：</strong>由一个”主（Master）”设备和多个”备（Backup）”设备组成的一个虚拟网关。</p>
<p><strong>主设备（Master）：</strong>负责转发数据报文和周期性向备设备发送VRRP协议报文。</p>
<p><strong>备设备（Backup）：</strong>不负责转发数据报文，在Master设备发生故障的时候会通过选举形式成为新的Master设备，该角色会接收来自Master设备的VRRP报文并加以分析。</p>
<p><strong>VRID：</strong>用来表示一个VRRP组。</p>
<p><strong>虚拟IP：</strong>配置在虚拟设备上的虚拟IP地址，一个虚拟设备可以拥有一个或者多个虚拟IP地址。</p>
<p><strong>IP地址拥有者：</strong>分配给虚拟设备的虚拟IP的真实拥有者（例如：分配个虚拟路由的IP为192.168.1.1，但是这个IP已经分配给物理接口G0/0/1这个接口那么这个接口就是”IP拥有者”），IP拥有者会直接跳过选举成为Master，并且是不可抢占的。</p>
<p><strong>虚拟MAC地址：</strong>由虚拟设备生成的虚拟MAC地址，每一个虚拟设备都会自动生成一个虚拟MAC地址，这个MAC地址是用于虚拟设备处理ARP报文的。</p>
<p><strong>优先级：</strong>用于表示物理设备的优先级，这个参数用于Master的选举，取值范围是1-254，这个有优先级有两个比较特殊的值，分别是0和255，优先级0是由原来Master设备发送的，这个优先级是声明此设备不再参与VRRP组。优先级为255的是IP拥有者的优先级，拥有这个优先级会直接成为Master。<strong>（优先级数值越低优先级则越高）</strong></p>
<p><strong>抢占模式：</strong>当Backup 设备接收到的VRRP报文通过分析得出当前Master设备的优先级低于Backup设备，则Backup设备会切换为Master设备。</p>
<p><strong>工作流程</strong></p>
<p>VRRP备份组会通过优先级选举出Master，Master会使用虚拟MAC发送ARP报文，使与Master连接的主机或者客户端建立与虚拟MAC对应的ARP映射表，同时Master会周期性发布VRRP报文向所有Backup通告其配置信息与工作状态。</p>
<p>如果当前Master出现故障，Backup设备将会在MASTER_DOWN_INTERVAL定时器超时或者其他联动技术检测到Master出现故障时则会根据Backup组内的成员的优先级选举出新的Master，如果Backup只有一台设备则直接成为Master。</p>
<p>新的Master使用虚拟MAC发送ARP报文，使连接在当前VRRP组内的客户端或者设备刷新其ARP映射表。</p>
<p>如果原来的Master从故障中恢复过来，如果其优先级为255则会直接切换到Master，若不是则会恢复到Backup状态，如果当前为抢占模式，当原Master接收到新Master的VRRP报文发现其优先级高于原Master则原Master会直接成为Master。如果处于非抢占模式，则原Master会在新Master出现故障时通过选举等方式成为Master。</p>
<p><strong>VRRP选举</strong></p>
<p>VRRP通过优先级来确定设备成为Master或者Backup，优先级取值越低，则优先级越高。</p>
<p>初始创建的VRRP设备都处于初始状态，在该状态下，如果设备的优先级为255，则直接成为Master并且跳过接下来的选举，若不是则会切换到Backup状态，然后会等待MASTER_DOWN_INTERVAL超时后成为Master。</p>
<p>首先切换到Master的设备会通过VRRP报文获取其他设备的优先级，然后通过以下规则进行选举：</p>
<ol>
<li>如果Backup设备接收到来自Master的VRRP报文，发现其优先级数值低于自身，则继续处于Backup状态。</li>
<li>如果Backup设备接收到来自Master的VRRP报文，发现其优先级数值高于自身，则当前Backup设备会切换到Master，而原Master设备会切换到Backup。如果在非抢占模式下，Backup设备仍然会处于Backup状态。</li>
<li>如果同时有多个设备切换到Master，则会互相通过VRRP报文确定其优先级，优先级高的则成为Master，若优先级一样，则对比IP地址，IP地址大的则成为Master。</li>
</ol>
<p> <strong>VRRP状态通告</strong></p>
<p>Master设备会周期性发送VRRP报文，通告其配置信息与工作状态，Backup则会接收并处理VRRP报文确定Master设备的工作状态。</p>
<p>当Master主动退出VRRP组是，会发送优先级为0的报文通知所有的Backup设备，Backup设备接收到之后会直接切换到Master状态，若Backup组内有多台设备则通过上述选举选出新的Master设备，而不需要等待MASTER_DOWN_INTERVAL超时后再进行切换或者选举。</p>
<p>当Master设备由于故障不能发送VRRP报文，所有的Backup设备都需要等待MASTER_DOWN_INTERVAL 超时后才会认为Master设备出现故障，之后才切换到Master。</p>
<h3 id="如何保证单台服务器的可靠性"><a href="#如何保证单台服务器的可靠性" class="headerlink" title="如何保证单台服务器的可靠性"></a><strong>如何保证单台服务器的可靠性</strong></h3><p><strong>可以借用VRRP的两种模式</strong></p>
<ul>
<li><p>主备备份模式</p>
</li>
<li><p>负载分担模式</p>
</li>
</ul>
<h3 id="主备备份模式："><a href="#主备备份模式：" class="headerlink" title="主备备份模式："></a><strong>主备备份模式：</strong></h3><p>主备备份模式就是只由Master设备负责转发数据，而Backup设备则处于待机备份模式不参与数据转发，当Master设备出现故障时才会切换到Master进行数据转发。</p>
<p>参照下图，正常情况下只有SW1转发数据，而SW2则处于待机状态，SW1会周期发送VRRP报文告知SW2自身的配置信息和工作状态，如果SW1发生故障，则SW2会自动切换到到Master继续进行数据转发等。</p>
<p>而当SW1恢复之后，若当前为抢占模式，若SW1的优先级为255那么SW1会直接成为Master否则会先切换到Backup然后再切换到Master。</p>
<pre class="mermaid">graph TD
A[pc]  
      A --> |客户端的情求| C[SW3]
      C -->  B[Master   SW1]
      C -->  f[Backup SW2]
      B --> c[SW3]
      f --> c[R]</pre>





<h3 id="负载分担模式："><a href="#负载分担模式：" class="headerlink" title="负载分担模式："></a><strong>负载分担模式：</strong></h3><p>上述的主备备份模式，若SW1一直正常工作，那么SW2则长期处于待机状态，显然这种做法比较浪费，所以一般会采用负载分担模式，负载分到模式会是SW2都处于工作状态。</p>
<p>参照下图，负载分担模式是创建两个VRRP组分别为A组和B组，A组的Master为SW1，Backup为SW2，而B组的Master为SW2，Backup为SW1，通过创建多个拥有不同虚拟IP的VRRP组，为不同的VLAN指定网关实现负载分担。</p>
<pre class="mermaid">graph TD

A[pc1]  
      D[pc2]
      A --> |客户端的情求| C[SW3]
      D --> |客户端的情求| C[vlan 10 192.168.10.1 </br> vlan 20   192.168.20.1</br>  SW3]
      C -->  B[Master:vlan 10 </br> backup:vlan 20 </br>  SW1]  
      C -->  f[Master:vlan 20 </br> backup:vlan 10 </br>  SW2]
      f --> E[R]
      B --> E[R]</pre>

<p>参照上图，在VLAN10当中Master是SW1，Backup为SW2，两台交换机都分别创建vlan10和vlan20 并且分配好IP地址，正常情况下vlan10的客户端会通过SW1访问R1，vlan20的客户端会通过SW2访问R1这样就实现了负载分担，如果SW1出现故障，那么SW2会成为vlan10的Master（同时也是vlan20的Master），接替SW1的工作，而vlan10的客户端也会通过SW2访问R1，而SW2故障则同理。</p>
<p> <strong>Keepalived的配置</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">主备服务安装Keepalived</span><br><span class="line">	yum install keepalived ipvsadm -y</span><br><span class="line">	</span><br><span class="line"> 修改配置文件：</span><br><span class="line">		cd  &#x2F;etc&#x2F;keepalived&#x2F;</span><br><span class="line">		cp keepalived.conf keepalived.conf.bak</span><br><span class="line">		vi keepalived.conf</span><br><span class="line"></span><br><span class="line">			node01:</span><br><span class="line">			vrrp：虚拟路由冗余协议！</span><br><span class="line">				vrrp_instance VI_1 &#123;</span><br><span class="line">					state MASTER     &#x2F;&#x2F;MASTER&#x2F; BACKUP</span><br><span class="line">					interface eth0  &#x2F;&#x2F;网关接口</span><br><span class="line">					virtual_router_id 51</span><br><span class="line">					priority 100 &#x2F;&#x2F;权重配置	100&#x2F; 50</span><br><span class="line">					advert_int 1</span><br><span class="line">					authentication &#123;</span><br><span class="line">						auth_type PASS</span><br><span class="line">						auth_pass 1111</span><br><span class="line">					&#125;</span><br><span class="line">					virtual_ipaddress &#123;</span><br><span class="line">						192.168.150.100&#x2F;24 dev eth0 label  eth0:3     &#x2F;&#x2F;虚拟IP</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">&#x2F;&#x2F;配置入包规则</span><br><span class="line">			virtual_server 192.168.150.100 80 &#123;</span><br><span class="line">				delay_loop 6</span><br><span class="line">				lb_algo rr   &#x2F;&#x2F;负载机制  rr轮询</span><br><span class="line">				lb_kind DR   &#x2F;&#x2F;模式</span><br><span class="line">				nat_mask 255.255.255.0</span><br><span class="line">&#x2F;&#x2F;在50秒内如果同一个用户有多次的请求发送过来则向固定的一台服务负载</span><br><span class="line">				persistence_timeout 50  </span><br><span class="line">				protocol TCP</span><br><span class="line">&#x2F;&#x2F; 出包规则</span><br><span class="line">				real_server 192.168.150.12 80 &#123;</span><br><span class="line">					weight 1</span><br><span class="line">					HTTP_GET &#123;</span><br><span class="line">						url &#123;</span><br><span class="line">						  path &#x2F;</span><br><span class="line">						  status_code 200</span><br><span class="line">						&#125;</span><br><span class="line">						connect_timeout 3</span><br><span class="line">						nb_get_retry 3</span><br><span class="line">						delay_before_retry 3</span><br><span class="line">					&#125;   </span><br><span class="line">				&#125;       </span><br><span class="line">				real_server 192.168.150.13 80 &#123;</span><br><span class="line">					weight 1</span><br><span class="line">					HTTP_GET &#123;</span><br><span class="line">						url &#123;</span><br><span class="line">						  path &#x2F;</span><br><span class="line">						  status_code 200</span><br><span class="line">						&#125;</span><br><span class="line">						connect_timeout 3</span><br><span class="line">						nb_get_retry 3</span><br><span class="line">						delay_before_retry 3</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br></pre></td></tr></table></figure>



<h3 id="详细参考https-www-cnblogs-com-wuweidong-p-13804180-html"><a href="#详细参考https-www-cnblogs-com-wuweidong-p-13804180-html" class="headerlink" title="详细参考https://www.cnblogs.com/wuweidong/p/13804180.html"></a>详细参考<a href="https://www.cnblogs.com/wuweidong/p/13804180.html">https://www.cnblogs.com/wuweidong/p/13804180.html</a></h3><link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>LVS</title>
    <url>/2021/03/21/LVS/</url>
    <content><![CDATA[<h3 id="LVS的介绍"><a href="#LVS的介绍" class="headerlink" title="LVS的介绍"></a>LVS的介绍</h3><p><strong>LVS是什么？</strong><br>LVS（Linux Virtual Server，Linux虚拟服务器）是由章文嵩开发的一款开源软件（遵循GPL协议）。LVS工作在layer 4，又称为四层路由/四层交换，能够根据请求报文的目标IP地址和目标PORT将其调度转发至后端的某台服务器上，调度转发是根据调度算法来进行的。</p>
<p>LVS由两部分组成，分别是工作在内核空间的ipvs框架和工作在用户空间的ipvsadm命令。ipvsadm是工作在用户空间的命令行工具，用于管理集群服务及集群服务上的Real Server（RS），而ipvs则是工作于内核上的netfilter的INPUT钩子上的程序，其功能是根据用户定义的集群实现对请求报文的转发。</p>
<p>LVS支持基于TCP、UDP、SCTP、AH、EST、AH_EST等协议进行调度。</p>
<p><strong>为什么要使用LVS？</strong></p>
<p>LVS是负载均衡能力最强的一款软件，对于选择LVS作为负载均衡的原因总结如下。</p>
<p>1、相比于Nginx、Haproxy等负载均衡器，LVS支持较大的并发量。Nginx、Haproxy是工作在七层的负载均衡器，因此需要监听在一个端口上，同时对于每一个客户端都需要打开一个套接字文件来接受请求数据，当在应用层分析完数据时，有需要扮演成客户端角色向后端的服务器主机发送请求报文，不仅需要打开大量套接字文件，还需要有多个随机端口可以使用，而端口数最多只有65535个，并且其中有一部分端口是不能使用的。因此，工作在七层的负载均衡软件（如Nginx、Haproxy等）的最大并发数受限于能够打开的套接字文件数（内核需要打开很多的文件描述符来维护）以及能使用的随机端口数。对于LVS而言，因此它工作在四层，所以不需要监听在某个端口以响应客户端请求，因此不需要打开套接字接受和发送数据，同时也不需要使用端口，所有功能均在ipvs中实现，因此LVS的性能更高，支持的并发量更大。据统计，LVS的最大并发量可以达到400~500w。</p>
<p>2、LVS是一款开源且免费的软件，结合Linux使用可以大大降低企业的应用成本。</p>
<p>3、LVS具有可伸缩性。当一台服务器负载压力增长时，系统可以在不降低服务质量的情况下通过扩展来满足需求。</p>
<p>4、LVS具有高可靠性。这在国内很多大型的、关键性的Web站点实践中得到印证。</p>
<h3 id="LVS的三种搭建模型"><a href="#LVS的三种搭建模型" class="headerlink" title="LVS的三种搭建模型"></a>LVS的三种搭建模型</h3><ul>
<li><p><strong>NAT模式</strong><br>优点：集群中的物理服务器可以使用任何支持TCP/IP操作系统，物理服务器可以分配Internet的保留私有地址，只有负载均衡器需要一个合法的IP地址。</p>
<p>不足：扩展性有限。当服务器节点（普通PC服务器）数据增长到20个或更多时,负载均衡器将成为整个系统的瓶颈，因为所有的请求包和应答包都需要经过负载均衡器再生。假使TCP包的平均长度是536字节的话，平均包再生延迟时间大约为60us（在Pentium处理器上计算的，采用更快的处理器将使得这个延迟时间变短），负载均衡器的最大容许能力为8.93M/s，假定每台物理服务器的平台容许能力为400K/s来计算，负责均衡器能为22台物理服务器计算。<br><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/data/%E7%BD%91%E7%BB%9C/lvs%20nat%E6%A8%A1%E5%9E%8B.png" alt="NAT模式"></p>
</li>
<li><p><strong>TUN模式</strong><br>我们发现，许多Internet服务（例如WEB服务器）的请求包很短小，而应答包通常很大。<br>优点：负载均衡器只负责将请求包分发给物理服务器，而物理服务器将应答包直接发给用户。所以，负载均衡器能处理很巨大的请求量，这种方式，一台负载均衡能为超过100台的物理服务器服务，负载均衡器不再是系统的瓶颈。使用VS-TUN方式，如果你的负载均衡器拥有100M的全双工网卡的话，就能使得整个Virtual Server能达到1G的吞吐量。<br>不足：但是，这种方式需要所有的服务器支持”IP Tunneling”(IP Encapsulation)协议，我仅在Linux系统上实现了这个，如果你能让其它操作系统支持，还在探索之中。<br><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/data/%E7%BD%91%E7%BB%9C/lvs%20TUN.png" alt="TUN"></p>
</li>
<li><p><strong>DR模式</strong><br>优点：和VS-TUN一样，负载均衡器也只是分发请求，应答包通过单独的路由方法返回给客户端。与VS-TUN相比，VS-DR这种实现方式不需要隧道结构，因此可以使用大多数操作系统做为物理服务器，其中包括：Linux 2.0.36、2.2.9、2.2.10、2.2.12；Solaris 2.5.1、2.6、2.7；FreeBSD 3.1、3.2、3.3；NT4.0无需打补丁；IRIX 6.5；HPUX11等。<br>不足：要求负载均衡器的网卡必须与物理网卡在一个物理段上<br><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/data/%E7%BD%91%E7%BB%9C/lvs%20DR.png" alt="DR"></p>
</li>
</ul>
<h3 id="使用LVS搭建基于四层网络模型的负载均衡器-DR模式"><a href="#使用LVS搭建基于四层网络模型的负载均衡器-DR模式" class="headerlink" title="使用LVS搭建基于四层网络模型的负载均衡器 DR模式"></a>使用LVS搭建基于四层网络模型的负载均衡器 DR模式</h3><p><strong>命令解释</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rr:轮循</span><br><span class="line">wrr:</span><br><span class="line">dh:</span><br><span class="line">sh:</span><br><span class="line"></span><br><span class="line">动态调度方法：</span><br><span class="line">lc: 最少连接</span><br><span class="line">wlc: 加权最少连接</span><br><span class="line">sed: 最短期望延迟</span><br><span class="line">nq: never queue</span><br><span class="line">LBLC: 基于本地的最少连接</span><br><span class="line">LBLCR: 基于本地的带复制功能的最少连接</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><figcaption><span>：</span></figcaption><table><tr><td class="code"><pre><span class="line">kernel parameter:</span><br><span class="line">目标mac地址为全F，交换机触发广播</span><br><span class="line">  &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;*IF*&#x2F;</span><br><span class="line">arp_ignore: 定义接收到ARP请求时的响应级别；</span><br><span class="line">  0：只要本地配置的有相应地址，就给予响应；</span><br><span class="line">  1：仅在请求的目标(MAC)地址配置请求</span><br><span class="line">        到达的接口上的时候，才给予响应；</span><br><span class="line"></span><br><span class="line">arp_announce：定义将自己地址向外通告时的通告级别；</span><br><span class="line">  0：将本地任何接口上的任何地址向外通告；</span><br><span class="line">  1：试图仅向目标网络通告与其网络匹配的地址；</span><br><span class="line">  2：仅向与本地接口上地址匹配的网络进行通告；</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install ipvsadm -y</span><br><span class="line"></span><br><span class="line">管理集群服务</span><br><span class="line">添加：-A -t|u|f service-address [-s scheduler]</span><br><span class="line">-t: TCP协议的集群</span><br><span class="line">-u: UDP协议的集群</span><br><span class="line">service-address:     IP:PORT</span><br><span class="line">-f: FWM: 防火墙标记</span><br><span class="line">service-address: Mark Number</span><br><span class="line">修改：-E</span><br><span class="line">删除：-D -t|u|f service-address</span><br><span class="line"></span><br><span class="line">ipvsadm -A -t 192.168.9.100:80 -s rr</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">添加：ipvsadm  -a -t|u|f service-address -r server-address [-g|i|m] [-w weight]</span><br><span class="line">  -t|u|f service-address：事先定义好的某集群服务</span><br><span class="line">  -r server-address: 某RS的地址，在NAT模型中，可使用IP：PORT实现端口映射；</span><br><span class="line">  [-g|i|m]: LVS类型 </span><br><span class="line">  -g: DR</span><br><span class="line">  -i: TUN</span><br><span class="line">  -m: NAT</span><br><span class="line">  [-w weight]: 定义服务器权重</span><br><span class="line">修改：-e</span><br><span class="line">删除：-d -t|u|f service-address -r server-address</span><br><span class="line"># ipvsadm -a -t 172.16.100.1:80 -r 192.168.10.8 –g</span><br><span class="line"># ipvsadm -a -t 172.16.100.1:80 -r 192.168.10.9 -g</span><br><span class="line">查看</span><br><span class="line">  -L|l</span><br><span class="line">  -n: 数字格式显示主机地址和端口</span><br><span class="line">  --stats：统计数据</span><br><span class="line">  --rate: 速率</span><br><span class="line">  --timeout: 显示tcp、tcpfin和udp的会话超时时长</span><br><span class="line">  -:c 显示当前的ipvs连接状况</span><br><span class="line">删除所有集群服务</span><br><span class="line">  -C：清空ipvs规则</span><br><span class="line">保存规则</span><br><span class="line">  -S</span><br><span class="line"># ipvsadm -S &gt; &#x2F;path&#x2F;to&#x2F;somefile</span><br><span class="line">载入此前的规则：</span><br><span class="line">  -R</span><br><span class="line"># ipvsadm -R &lt; &#x2F;path&#x2F;form&#x2F;somefile </span><br></pre></td></tr></table></figure>

<ul>
<li><strong>拓扑图</strong><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/data/%E7%BD%91%E7%BB%9C/lvs-DR%E6%90%AD%E5%BB%BA%E6%A8%A1%E5%9E%8B.png" alt="lvs-DR拓扑图"></li>
<li><strong>开始搭建</strong></li>
</ul>
<p>1.在192.168.150.11 中添加192.168.150.100的网卡</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">添加网卡  ifconfig eth0:2 192.168.150.100&#x2F;24</span><br><span class="line"></span><br><span class="line">注意&#x2F;24代表子网掩码是255.255.255.1</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>   <font color='red'> 删除 eth0:2网卡 ifconfig eth0:2 down </font></p>
<p> 2.调192.168.150.12  和 192.168.150.13的内核协议</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo 1  &gt;  &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;eth0&#x2F;arp_ignore </span><br><span class="line">echo 1  &gt;  &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;all&#x2F;arp_ignore </span><br><span class="line">echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;eth0&#x2F;arp_announce </span><br><span class="line">echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;all&#x2F;arp_announce </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3.配置192.168.150.12  和 192.168.150.13环行路由</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ifconfig lo:2 192.168.150.100 netmask 255.255.255.255</span><br></pre></td></tr></table></figure>
<p>4.在 192.168.150.12 和 192.168.150.13中安装 httpd</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install httpd -y</span><br><span class="line">启动  service httpd start</span><br><span class="line">创建主页vi &#x2F;var&#x2F;www&#x2F;html&#x2F;index.html</span><br></pre></td></tr></table></figure>
<p>5在浏览器中输入192.168.150.12:80测试</p>
<p>6.在192.168.150.11 中安装 ipvsadm</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install ipvsadm -y</span><br><span class="line">添加进包的规则：ipvsadm -A  -t  192.168.150.100:80  -s rr</span><br><span class="line">添加负载的规则:</span><br><span class="line">ipvsadm -a  -t 192.168.150.100:80  -r  192.168.150.12 -g -w 1</span><br><span class="line">ipvsadm -a  -t 192.168.150.100:80  -r  192.168.150.13 -g -w 1</span><br><span class="line"></span><br><span class="line">查看规则：ipvsadm  -ln</span><br></pre></td></tr></table></figure>
<p>7.验证：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">浏览器访问  192.168.150.100   看到负载  F5属性</span><br><span class="line">192.168.150.11：</span><br><span class="line">	netstat -natp   结论看不到socket连接</span><br><span class="line">192.168.150.12~192.168.150.13:</span><br><span class="line">	netstat -natp   结论看到很多的socket连接</span><br><span class="line">192.168.150.11:</span><br><span class="line">	ipvsadm -lnc    查看偷窥记录本</span><br><span class="line">	TCP 00:57  FIN_WAIT    192.168.150.1:51587 192.168.150.100:80 192.168.150.12:80</span><br><span class="line"></span><br><span class="line">	           FIN_WAIT： 连接过，偷窥了所有的包</span><br><span class="line">	           SYN_RECV： 基本上lvs都记录了，证明lvs没事，一定是后边网络层出问题</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
      </tags>
  </entry>
  <entry>
    <title>LVS三种搭建模式</title>
    <url>/2021/03/21/LVS%E4%B8%89%E7%A7%8D%E6%90%AD%E5%BB%BA%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h3 id="lvs的三种搭建模型"><a href="#lvs的三种搭建模型" class="headerlink" title="lvs的三种搭建模型"></a>lvs的三种搭建模型</h3><ul>
<li><p><strong>NAT模式</strong><br>优点：集群中的物理服务器可以使用任何支持TCP/IP操作系统，物理服务器可以分配Internet的保留私有地址，只有负载均衡器需要一个合法的IP地址。</p>
<p>不足：扩展性有限。当服务器节点（普通PC服务器）数据增长到20个或更多时,负载均衡器将成为整个系统的瓶颈，因为所有的请求包和应答包都需要经过负载均衡器再生。假使TCP包的平均长度是536字节的话，平均包再生延迟时间大约为60us（在Pentium处理器上计算的，采用更快的处理器将使得这个延迟时间变短），负载均衡器的最大容许能力为8.93M/s，假定每台物理服务器的平台容许能力为400K/s来计算，负责均衡器能为22台物理服务器计算。<br><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/data/%E7%BD%91%E7%BB%9C/lvs%20nat%E6%A8%A1%E5%9E%8B.png" alt="NAT模式"></p>
</li>
<li><p><strong>TUN模式</strong><br>我们发现，许多Internet服务（例如WEB服务器）的请求包很短小，而应答包通常很大。<br>优点：负载均衡器只负责将请求包分发给物理服务器，而物理服务器将应答包直接发给用户。所以，负载均衡器能处理很巨大的请求量，这种方式，一台负载均衡能为超过100台的物理服务器服务，负载均衡器不再是系统的瓶颈。使用VS-TUN方式，如果你的负载均衡器拥有100M的全双工网卡的话，就能使得整个Virtual Server能达到1G的吞吐量。<br>不足：但是，这种方式需要所有的服务器支持”IP Tunneling”(IP Encapsulation)协议，我仅在Linux系统上实现了这个，如果你能让其它操作系统支持，还在探索之中。<br><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/data/%E7%BD%91%E7%BB%9C/lvs%20TUN.png" alt="TUN"></p>
</li>
<li><p><strong>DR模式</strong><br>优点：和VS-TUN一样，负载均衡器也只是分发请求，应答包通过单独的路由方法返回给客户端。与VS-TUN相比，VS-DR这种实现方式不需要隧道结构，因此可以使用大多数操作系统做为物理服务器，其中包括：Linux 2.0.36、2.2.9、2.2.10、2.2.12；Solaris 2.5.1、2.6、2.7；FreeBSD 3.1、3.2、3.3；NT4.0无需打补丁；IRIX 6.5；HPUX11等。<br>不足：要求负载均衡器的网卡必须与物理网卡在一个物理段上<br><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/data/%E7%BD%91%E7%BB%9C/lvs%20DR.png" alt="DR"></p>
</li>
</ul>
<h3 id="使用LVS搭建基于四层网络模型的负载均衡器-DR模式"><a href="#使用LVS搭建基于四层网络模型的负载均衡器-DR模式" class="headerlink" title="使用LVS搭建基于四层网络模型的负载均衡器 DR模式"></a>使用LVS搭建基于四层网络模型的负载均衡器 DR模式</h3><p><strong>命令解释</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rr:轮循</span><br><span class="line">wrr:</span><br><span class="line">dh:</span><br><span class="line">sh:</span><br><span class="line"></span><br><span class="line">动态调度方法：</span><br><span class="line">lc: 最少连接</span><br><span class="line">wlc: 加权最少连接</span><br><span class="line">sed: 最短期望延迟</span><br><span class="line">nq: never queue</span><br><span class="line">LBLC: 基于本地的最少连接</span><br><span class="line">LBLCR: 基于本地的带复制功能的最少连接</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><figcaption><span>：</span></figcaption><table><tr><td class="code"><pre><span class="line">kernel parameter:</span><br><span class="line">目标mac地址为全F，交换机触发广播</span><br><span class="line">  &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;*IF*&#x2F;</span><br><span class="line">arp_ignore: 定义接收到ARP请求时的响应级别；</span><br><span class="line">  0：只要本地配置的有相应地址，就给予响应；</span><br><span class="line">  1：仅在请求的目标(MAC)地址配置请求</span><br><span class="line">        到达的接口上的时候，才给予响应；</span><br><span class="line"></span><br><span class="line">arp_announce：定义将自己地址向外通告时的通告级别；</span><br><span class="line">  0：将本地任何接口上的任何地址向外通告；</span><br><span class="line">  1：试图仅向目标网络通告与其网络匹配的地址；</span><br><span class="line">  2：仅向与本地接口上地址匹配的网络进行通告；</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install ipvsadm -y</span><br><span class="line"></span><br><span class="line">管理集群服务</span><br><span class="line">添加：-A -t|u|f service-address [-s scheduler]</span><br><span class="line">-t: TCP协议的集群</span><br><span class="line">-u: UDP协议的集群</span><br><span class="line">service-address:     IP:PORT</span><br><span class="line">-f: FWM: 防火墙标记</span><br><span class="line">service-address: Mark Number</span><br><span class="line">修改：-E</span><br><span class="line">删除：-D -t|u|f service-address</span><br><span class="line"></span><br><span class="line">ipvsadm -A -t 192.168.9.100:80 -s rr</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">添加：ipvsadm  -a -t|u|f service-address -r server-address [-g|i|m] [-w weight]</span><br><span class="line">  -t|u|f service-address：事先定义好的某集群服务</span><br><span class="line">  -r server-address: 某RS的地址，在NAT模型中，可使用IP：PORT实现端口映射；</span><br><span class="line">  [-g|i|m]: LVS类型 </span><br><span class="line">  -g: DR</span><br><span class="line">  -i: TUN</span><br><span class="line">  -m: NAT</span><br><span class="line">  [-w weight]: 定义服务器权重</span><br><span class="line">修改：-e</span><br><span class="line">删除：-d -t|u|f service-address -r server-address</span><br><span class="line"># ipvsadm -a -t 172.16.100.1:80 -r 192.168.10.8 –g</span><br><span class="line"># ipvsadm -a -t 172.16.100.1:80 -r 192.168.10.9 -g</span><br><span class="line">查看</span><br><span class="line">  -L|l</span><br><span class="line">  -n: 数字格式显示主机地址和端口</span><br><span class="line">  --stats：统计数据</span><br><span class="line">  --rate: 速率</span><br><span class="line">  --timeout: 显示tcp、tcpfin和udp的会话超时时长</span><br><span class="line">  -:c 显示当前的ipvs连接状况</span><br><span class="line">删除所有集群服务</span><br><span class="line">  -C：清空ipvs规则</span><br><span class="line">保存规则</span><br><span class="line">  -S</span><br><span class="line"># ipvsadm -S &gt; &#x2F;path&#x2F;to&#x2F;somefile</span><br><span class="line">载入此前的规则：</span><br><span class="line">  -R</span><br><span class="line"># ipvsadm -R &lt; &#x2F;path&#x2F;form&#x2F;somefile </span><br></pre></td></tr></table></figure>

<ul>
<li><strong>拓扑图</strong><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/data/%E7%BD%91%E7%BB%9C/lvs-DR%E6%90%AD%E5%BB%BA%E6%A8%A1%E5%9E%8B.png" alt="lvs-DR拓扑图"></li>
<li><strong>开始搭建</strong></li>
</ul>
<p>1.在192.168.150.11 中添加192.168.150.100的网卡</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">添加网卡  ifconfig eth0:2 192.168.150.100&#x2F;24</span><br><span class="line"></span><br><span class="line">注意&#x2F;24代表子网掩码是255.255.255.1</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>   <font color='red'> 删除 eth0:2网卡 ifconfig eth0:2 down </font></p>
<p> 2.调192.168.150.12  和 192.168.150.13的内核协议</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo 1  &gt;  &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;eth0&#x2F;arp_ignore </span><br><span class="line">echo 1  &gt;  &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;all&#x2F;arp_ignore </span><br><span class="line">echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;eth0&#x2F;arp_announce </span><br><span class="line">echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;all&#x2F;arp_announce </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3.配置192.168.150.12  和 192.168.150.13环行路由</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ifconfig lo:2 192.168.150.100 netmask 255.255.255.255</span><br></pre></td></tr></table></figure>
<p>4.在 192.168.150.12 和 192.168.150.13中安装 httpd</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install httpd -y</span><br><span class="line">启动  service httpd start</span><br><span class="line">创建主页vi &#x2F;var&#x2F;www&#x2F;html&#x2F;index.html</span><br></pre></td></tr></table></figure>
<p>5在浏览器中输入192.168.150.12:80测试</p>
<p>6.在192.168.150.11 中安装 ipvsadm</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install ipvsadm -y</span><br><span class="line">添加进包的规则：ipvsadm -A  -t  192.168.150.100:80  -s rr</span><br><span class="line">添加负载的规则:</span><br><span class="line">ipvsadm -a  -t 192.168.150.100:80  -r  192.168.150.12 -g -w 1</span><br><span class="line">ipvsadm -a  -t 192.168.150.100:80  -r  192.168.150.13 -g -w 1</span><br><span class="line"></span><br><span class="line">查看规则：ipvsadm  -ln</span><br></pre></td></tr></table></figure>
<p>7.验证：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">浏览器访问  192.168.150.100   看到负载  F5属性</span><br><span class="line">192.168.150.11：</span><br><span class="line">	netstat -natp   结论看不到socket连接</span><br><span class="line">192.168.150.12~192.168.150.13:</span><br><span class="line">	netstat -natp   结论看到很多的socket连接</span><br><span class="line">192.168.150.11:</span><br><span class="line">	ipvsadm -lnc    查看偷窥记录本</span><br><span class="line">	TCP 00:57  FIN_WAIT    192.168.150.1:51587 192.168.150.100:80 192.168.150.12:80</span><br><span class="line"></span><br><span class="line">	           FIN_WAIT： 连接过，偷窥了所有的包</span><br><span class="line">	           SYN_RECV： 基本上lvs都记录了，证明lvs没事，一定是后边网络层出问题</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
      </tags>
  </entry>
  <entry>
    <title>NIO</title>
    <url>/2021/06/08/NIO/</url>
    <content><![CDATA[<h3 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h3><p><strong>1. NIO是什么</strong></p>
<blockquote>
<p>NIO（Non-blocking I/O，在Java领域，也称为New I/O），是一种同步非阻塞的I/O模型，也是I/O多路复用的基础，已经被越来越多地应用到大型应用服务器，成为解决高并发与大量连接、I/O处理问题的有效方式。</p>
</blockquote>
<p><strong>2.常见I/O模型对比</strong></p>
<blockquote>
<p>所有的系统I/O都分为两个阶段：等待就绪和操作。举例来说，读函数，分为等待系统可读和真正的读；同理，写函数分为等待网卡可以写和真正的写。</p>
<p>需要说明的是等待就绪的阻塞是不使用CPU的，是在“空等”；而真正的读写操作的阻塞是使用CPU的，真正在”干活”，而且这个过程非常快，属于memory copy，带宽通常在1GB/s级别以上，可以理解为基本不耗时。</p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/io/NIO.png" alt="image-20210609165008795"></p>
<p>传统的BIO里面socket.read()，如果TCP RecvBuffer里没有数据，函数会一直阻塞，直到收到数据，返回读到的数据。</p>
<p>对于NIO，如果TCP RecvBuffer有数据，就把数据从网卡读到内存，并且返回给用户；反之则直接返回0，永远不会阻塞。</p>
<p>最新的AIO(Async I/O)里面会更进一步：不但等待就绪是非阻塞的，就连数据从网卡到内存的过程也是异步的。</p>
<p>换句话说，BIO里用户最关心“我要读”，NIO里用户最关心”我可以读了”，在AIO模型里用户更需要关注的是“读完了”。</p>
<p>NIO一个重要的特点是：socket主要的读、写、注册和接收函数，在等待就绪阶段都是非阻塞的，真正的I/O操作是同步阻塞的（消耗CPU但性能非常高）。</p>
</blockquote>
<p><strong>3. 如何结合事件模型使用NIO同步非阻塞特性</strong></p>
<blockquote>
<p>回忆BIO模型，之所以需要多线程，是因为在进行I/O操作的时候，一是没有办法知道到底能不能写、能不能读，只能”傻等”，即使通过各种估算，算出来操作系统没有能力进行读写，也没法在socket.read()和socket.write()函数中返回，这两个函数无法进行有效的中断。所以除了多开线程另起炉灶，没有好的办法利用CPU。</p>
<p>NIO的读写函数可以立刻返回，这就给了我们不开线程利用CPU的最好机会：如果一个连接不能读写（socket.read()返回0或者socket.write()返回0），我们可以把这件事记下来，记录的方式通常是在Selector上注册标记位，然后切换到其它就绪的连接（channel）继续进行读写。</p>
<p>下面具体看下如何利用事件模型单线程处理所有I/O请求：</p>
<p>NIO的主要事件有几个：读就绪、写就绪、有新连接到来。</p>
<p>我们首先需要注册当这几个事件到来的时候所对应的处理器。然后在合适的时机告诉事件选择器：我对这个事件感兴趣。对于写操作，就是写不出去的时候对写事件感兴趣；对于读操作，就是完成连接和系统没有办法承载新读入的数据的时；对于accept，一般是服务器刚启动的时候；而对于connect，一般是connect失败需要重连或者直接异步调用connect的时候。</p>
<p>其次，用一个死循环选择就绪的事件，会执行系统调用（Linux 2.6之前是select、poll，2.6之后是epoll，Windows是IOCP），还会阻塞的等待新事件的到来。新事件到来的时候，会在selector上注册标记位，标示可读、可写或者有连接到来。</p>
<p>注意，select是阻塞的，无论是通过操作系统的通知（epoll）还是不停的轮询(select，poll)，这个函数是阻塞的。所以你可以放心大胆地在一个while(true)里面调用这个函数而不用担心CPU空转。</p>
</blockquote>
<p><strong>代码展示：</strong></p>
<ol>
<li>服务端</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketNIO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        LinkedList&lt;SocketChannel&gt; clients = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        ServerSocketChannel ss = ServerSocketChannel.open();  <span class="comment">//服务端开启监听：接受客户端</span></span><br><span class="line">        ss.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">9090</span>));</span><br><span class="line">        ss.configureBlocking(<span class="keyword">false</span>); <span class="comment">//重点  OS  NONBLOCKING!!!  //只让接受客户端  不阻塞</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//接受客户端的连接</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            SocketChannel client = ss.accept(); <span class="comment">//不会阻塞？  -1 NULL</span></span><br><span class="line">            <span class="comment">//accept  调用内核了：1，没有客户端连接进来，返回值？在BIO 的时候一直卡着，但是在NIO ，不卡着，返回-1，NULL</span></span><br><span class="line">            <span class="comment">//如果来客户端的连接，accept 返回的是这个客户端的fd  5，client  object</span></span><br><span class="line">            <span class="comment">//NONBLOCKING 就是代码能往下走了，只不过有不同的情况</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (client == <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="comment">//   System.out.println(&quot;null.....&quot;);</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                client.configureBlocking(<span class="keyword">false</span>); <span class="comment">//重点  socket（服务端的listen socket&lt;连接请求三次握手后，往我这里扔，我去通过accept 得到  连接的socket&gt;，连接socket&lt;连接后的数据读写使用的&gt; ）</span></span><br><span class="line">                <span class="keyword">int</span> port = client.socket().getPort();</span><br><span class="line">                System.out.println(<span class="string">&quot;client..port: &quot;</span> + port);</span><br><span class="line">                clients.add(client);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ByteBuffer buffer = ByteBuffer.allocateDirect(<span class="number">4096</span>);  <span class="comment">//可以在堆里   堆外</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//遍历已经链接进来的客户端能不能读写数据</span></span><br><span class="line">            <span class="keyword">for</span> (SocketChannel c : clients) &#123;   <span class="comment">//串行化！！！！  多线程！！</span></span><br><span class="line">                <span class="keyword">int</span> num = c.read(buffer);  <span class="comment">// &gt;0  -1  0   //不会阻塞</span></span><br><span class="line">                <span class="keyword">if</span> (num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    buffer.flip();</span><br><span class="line">                    <span class="keyword">byte</span>[] aaa = <span class="keyword">new</span> <span class="keyword">byte</span>[buffer.limit()];</span><br><span class="line">                    buffer.get(aaa);</span><br><span class="line"></span><br><span class="line">                    String b = <span class="keyword">new</span> String(aaa);</span><br><span class="line">                    System.out.println(c.socket().getPort() + <span class="string">&quot; : &quot;</span> + b);</span><br><span class="line">                    buffer.clear();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>客户端</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     LinkedList&lt;SocketChannel&gt; clients = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">     InetSocketAddress serverAddr = <span class="keyword">new</span> InetSocketAddress(<span class="string">&quot;192.168.150.11&quot;</span>, <span class="number">9090</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//端口号的问题：65535</span></span><br><span class="line">     <span class="comment">//  windows</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">10000</span>; i &lt; <span class="number">65000</span>; i++) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             SocketChannel client1 = SocketChannel.open();</span><br><span class="line"></span><br><span class="line">             SocketChannel client2 = SocketChannel.open();</span><br><span class="line"></span><br><span class="line">             <span class="comment">/*</span></span><br><span class="line"><span class="comment">             linux中你看到的连接就是：</span></span><br><span class="line"><span class="comment">             client...port: 10508</span></span><br><span class="line"><span class="comment">             client...port: 10508</span></span><br><span class="line"><span class="comment">              */</span></span><br><span class="line"></span><br><span class="line">             client1.bind(<span class="keyword">new</span> InetSocketAddress(<span class="string">&quot;192.168.150.1&quot;</span>, i));</span><br><span class="line">             <span class="comment">//  192.168.150.1：10000   192.168.150.11：9090</span></span><br><span class="line">             client1.connect(serverAddr);</span><br><span class="line">             clients.add(client1);</span><br><span class="line"></span><br><span class="line">             client2.bind(<span class="keyword">new</span> InetSocketAddress(<span class="string">&quot;192.168.110.100&quot;</span>, i));</span><br><span class="line">             <span class="comment">//  192.168.110.100：10000  192.168.150.11：9090</span></span><br><span class="line">             client2.connect(serverAddr);</span><br><span class="line">             clients.add(client2);</span><br><span class="line"></span><br><span class="line">         &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line">     System.out.println(<span class="string">&quot;clients &quot;</span>+ clients.size());</span><br><span class="line"></span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         System.in.read();</span><br><span class="line">     &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>ThreadLocal</title>
    <url>/2021/06/03/ThreadLocal/</url>
    <content><![CDATA[<h3 id="java中的ThreadLocal"><a href="#java中的ThreadLocal" class="headerlink" title="java中的ThreadLocal"></a>java中的ThreadLocal</h3><p><strong>1. ThreadLocal的作用：</strong></p>
<p>ThreadLocal的作用主要是做数据隔离，填充的数据只属于当前线程，变量的数据对别的线程而言是相对隔离的，在多线程环境下，如何防止自己的变量被其它线程篡改。</p>
<p><strong>2. ThreadLocal使用到的场景：</strong></p>
<ol>
<li>Spring采用Threadlocal的方式，来保证单个线程中的数据库操作使用的是同一个数据库连接，同时，采用这种方式可以使业务层使用事务时不需要感知并管理connection对象，通过传播级别，巧妙地管理多个事务配置之间的切换，挂起和恢复。</li>
</ol>
<p><strong>3. ThreadLocal的原理：</strong></p>
<p>其实使用真的很简单，线程进来之后初始化一个可以泛型的ThreadLocal对象，之后这个线程只要在remove之前去get，都能拿到之前set的值，注意这里我说的是remove之前。</p>
<p>他是能做到线程间数据隔离的，所以别的线程使用get（）方法是没办法拿到其他线程的值的</p>
<ul>
<li>以下是set时的源码</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ThreadLocal&lt;String&gt; localName = <span class="keyword">new</span> ThreadLocal();</span><br><span class="line">localName.set(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">String name = localName.get();</span><br><span class="line">localName.remove();</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">     Thread t = Thread.currentThread();    <span class="comment">//获取当前线程</span></span><br><span class="line">     ThreadLocalMap map = getMap(t);       <span class="comment">//在当前线程中获取ThreadLocalMap对象</span></span><br><span class="line">     <span class="keyword">if</span> (map != <span class="keyword">null</span>)                       <span class="comment">//当前线程中存在ThreadLocalMap对象，直接设置值</span></span><br><span class="line">         map.set(<span class="keyword">this</span>, value);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">         createMap(t, value);              <span class="comment">// 不存在则创建一个为空的map对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们基本上可以找到ThreadLocal数据隔离的真相了，每个线程Thread都维护了自己的threadLocals变量，所以在每个线程创建ThreadLocal的时候，实际上数据是存在自己线程Thread的threadLocals变量里面的，别人没办法拿到，从而实现了隔离。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;</span><br><span class="line">          Entry[] tab = table;       <span class="comment">//其实它是把值放到了数组中</span></span><br><span class="line">          <span class="keyword">int</span> len = tab.length;</span><br><span class="line">          <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (len-<span class="number">1</span>);  <span class="comment">//根据ThreadLocal对象的hash值，计算到table中的位置</span></span><br><span class="line">        <span class="comment">//拿到ThreadLocal对象中的Entry,如果ThreadLocal对象的Entry不存在，就会在i位置直接 new Entry()</span></span><br><span class="line">         <span class="comment">//如果位置i的不为空，而且key不等于entry，那就找下一个空位置，直到为空为止。</span></span><br><span class="line">          <span class="keyword">for</span> (Entry e = tab[i];                      </span><br><span class="line">               e != <span class="keyword">null</span>;</span><br><span class="line">               e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">              ThreadLocal&lt;?&gt; k = e.get();  </span><br><span class="line"> </span><br><span class="line">              <span class="keyword">if</span> (k == key) &#123;    <span class="comment">// 如果值相等就刷新Entry中的value；</span></span><br><span class="line">                  e.value = value;</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;  <span class="comment">//如果当前位置是空的，就初始化一个Entry对象放在位置i上；</span></span><br><span class="line">                  replaceStaleEntry(key, value, i);</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          tab[i] = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line">          <span class="keyword">int</span> sz = ++size;</span><br><span class="line">          <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">              rehash();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以下是get时的源码</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">         Entry e = table[i];  </span><br><span class="line">        <span class="comment">// 如果当前线程在数组中存在直接返回 否则就直接找下一个</span></span><br><span class="line">         <span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">             <span class="keyword">return</span> e;</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">             <span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="keyword">int</span> i, Entry e)</span> </span>&#123;</span><br><span class="line">      Entry[] tab = table;</span><br><span class="line">      <span class="keyword">int</span> len = tab.length;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">          ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">          <span class="keyword">if</span> (k == key)</span><br><span class="line">              <span class="keyword">return</span> e;</span><br><span class="line">          <span class="keyword">if</span> (k == <span class="keyword">null</span>)</span><br><span class="line">              expungeStaleEntry(i);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">              i = nextIndex(i, len);</span><br><span class="line">          e = tab[i];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>4. ThreadLocal 数据共享</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ThreadLocal threadLocal = <span class="keyword">new</span> InheritableThreadLocal();</span><br><span class="line">        threadLocal.set(<span class="string">&quot;帅得一匹&quot;</span>);</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;  输出  &quot;</span> + threadLocal.get());</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t.start();</span><br><span class="line">        t.join();</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;  输出  &quot;</span> + threadLocal.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在子线程中我是能够正常输出那一行，这也就是父子线程数据传递的</p>
<p>**5. ThreadLocal内存溢出问题 **</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">            <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">            Object value;</span><br><span class="line"></span><br><span class="line">            Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">                <span class="keyword">super</span>(k);   <span class="comment">//key 为弱引用</span></span><br><span class="line">                value = v;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ThreadLocal在保存的时候会把自己当做Key存在ThreadLocalMap中，正常情况应该是key和value都应该被外界强引用才对，但是现在key被设计成WeakReference弱引用了。</p>
<p>这就导致了一个问题，ThreadLocal在没有外部强引用时，发生GC时会被回收，如果创建ThreadLocal的线程一直持续运行，那么这个Entry对象中的value就有可能一直得不到回收，发生内存泄露。</p>
<p>就比如线程池里面的线程，线程都是复用的，那么之前的线程实例处理完之后，出于复用的目的线程依然存活，所以，ThreadLocal设定的value值被持有，导致内存泄露。</p>
<p>按照道理一个线程使用完，ThreadLocalMap是应该要被清空的，但是现在线程被复用了。</p>
<p><strong><code>得在使用的最后用remove把值清空就好了</code></strong></p>
</blockquote>
<p><strong>ThreadLocal为什么要把key设计为弱引用？ 请看垃圾回收机制</strong></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>http协议</title>
    <url>/2021/03/21/http%E5%8D%8F%E8%AE%AE/</url>
    <content><![CDATA[<h3 id="http协议"><a href="#http协议" class="headerlink" title="http协议"></a>http协议</h3><p>HTTP协议是Hyper Text Transfer Protocol（超文本传输协议）的缩写,是用于从万维网（WWW:World Wide Web ）服务器传输超文本到本地浏览器的传送协议。</p>
<p>HTTP是一个基于TCP/IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。</p>
<p>HTTP是一个属于应用层的面向对象的协议，由于其简捷、快速的方式，适用于分布式超媒体信息系统。它于1990年提出，经过几年的使用与发展，得到不断地完善和扩展。目前在WWW中使用的是HTTP/1.0的第六版，HTTP/1.1的规范化工作正在进行之中，而且HTTP-NG(Next Generation of HTTP)的建议已经提出。</p>
<p>HTTP协议工作于客户端-服务端架构为上。浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求。Web服务器根据接收到的请求后，向客户端发送响应信息。</p>
<h4 id="http协议的特点"><a href="#http协议的特点" class="headerlink" title="http协议的特点"></a>http协议的特点</h4><p>1、简单快速：客户向服务器请求服务时，只需传送请求方法和路径。请求方法常用的有GET、HEAD、POST。每种方法规定了客户与服务器联系的类型不同。由于HTTP协议简单，使得HTTP服务器的程序规模小，因而通信速度很快。</p>
<p>2、灵活：HTTP允许传输任意类型的数据对象。正在传输的类型由Content-Type加以标记。</p>
<p>3.无连接：无连接的含义是限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间。</p>
<p>4.无状态：HTTP协议是无状态协议。无状态是指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。<br>5、支持B/S及C/S模式。</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
      </tags>
  </entry>
  <entry>
    <title>java 中的四大引用</title>
    <url>/2021/06/02/java%20%E4%B8%AD%E7%9A%84%E5%9B%9B%E5%A4%A7%E5%BC%95%E7%94%A8/</url>
    <content><![CDATA[<h2 id="java-中的四大引用"><a href="#java-中的四大引用" class="headerlink" title="java 中的四大引用"></a>java 中的四大引用</h2><p><strong>1. 强引用：（StrongReference）</strong></p>
<blockquote>
<p>强引用是使用最普遍的引用。如果一个对象具有强引用，那垃圾回收器绝不会回收它。当内存空间不足，Java虚拟机宁愿抛出OutOfMemoryError错误，使程序异常终止，也不会靠随意回收具有强引用的对象来解决内存不足的问题。 ps：强引用其实也就是我们平时<code>A a = new A()</code>这个意思。</p>
</blockquote>
<p><strong>2. 软引用（SoftReference）</strong></p>
<blockquote>
<p>如果一个对象只具有软引用，则内存空间足够，垃圾回收器就不会回收它；如果内存空间不足了，就会回收这些对象的内存。只要垃圾回收器没有回收它，该对象就可以被程序使用。软引用可用来实现内存敏感的高速缓存（下文给出示例）。<br>软引用可以和一个引用队列（ReferenceQueue）联合使用，如果软引用所引用的对象被垃圾回收器回收，Java虚拟机就会把这个软引用加入到与之关联的引用队列中。<br><code>String str = new String(&quot;abc&quot;); SoftReference&lt;String&gt; softReference = new SoftReference&lt;String&gt;(str);</code></p>
</blockquote>
<p><strong>3. 弱引用（WeakReference）</strong></p>
<blockquote>
<p>弱引用与软引用的区别在于：只具有弱引用的对象拥有更短暂的生命周期。在垃圾回收器线程扫描它所管辖的内存区域的过程中，一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。不过，由于垃圾回收器是一个优先级很低的线程，因此不一定会很快发现那些只具有弱引用的对象。<br>弱引用可以和一个引用队列（ReferenceQueue）联合使用，如果弱引用所引用的对象被垃圾回收，Java虚拟机就会把这个弱引用加入到与之关联的引用队列中。<br><code>String str = new String(&quot;哈哈哈哈&quot;); WeakReference wr = new  WeakReference(str);</code></p>
</blockquote>
<p><strong>4. 虚引用（PhantomReference）</strong></p>
<blockquote>
<p>“虚引用”顾名思义，就是形同虚设，与其他几种引用都不同，虚引用并不会决定对象的生命周期。如果一个对象仅持有虚引用，那么它就和没有任何引用一样，在任何时候都可能被垃圾回收器回收。<br>虚引用主要用来跟踪对象被垃圾回收器回收的活动。虚引用与软引用和弱引用的一个区别在于：虚引用必须和引用队列 （ReferenceQueue）联合使用。当垃圾回收器准备回收一个对象时，如果发现它还有虚引用，就会在回收对象的内存之前，把这个虚引用加入到与之 关联的引用队列中。<br><code>ReferenceQueue rq =  new  ReferenceQueue();        PhantomReference pr =  new  PhantomReference(str,rq);</code></p>
</blockquote>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>java8之Stream</title>
    <url>/2020/11/28/java8%E4%B9%8BStream/</url>
    <content><![CDATA[<h3 id="1-Stream介绍"><a href="#1-Stream介绍" class="headerlink" title="1. Stream介绍"></a>1. Stream介绍</h3><p>Stream不是集合元素，它不是数据结构并不保存数据，它是有关算法和计算的，它更像一个高级版本的Iterator。原始版本的Iterator，用户只能显式地一个一个遍历元素并对其执行某些操作；高级版本的Stream，用户只要给出需要对其包含的元素执行什么操作，比如，“过滤掉长度大于 10 的字符串”、“获取每个字符串的首字母”等，Stream会隐式地在内部进行遍历，做出相应的数据转换。Stream就如同一个迭代器（Iterator），单向，不可往复，数据只能遍历一次，遍历过一次后即用尽了。<br>在Java8 中增加了Stream API ，简化了串行或者并行的大批量的操作 。<br>Stream中的数据元素可以是对象引用，或者基本数据类型的值： int  long double  </p>
<h3 id="2-Stream的具体用法"><a href="#2-Stream的具体用法" class="headerlink" title="2. Stream的具体用法"></a>2. Stream的具体用法</h3><h4 id="1-Stream-常用的创建方法"><a href="#1-Stream-常用的创建方法" class="headerlink" title="1. Stream 常用的创建方法"></a>1. Stream 常用的创建方法</h4><pre><code>   ***使用Collection下的 stream() 和 parallelStream() 方法***　　
</code></pre>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">       </span><br><span class="line"> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Returns a sequential &#123;@code Stream&#125; with this collection as its source.(返回一个顺序的流，将此集合作为其源。)</span></span><br><span class="line">  Stream&lt;String&gt; stream = list.stream(); </span><br><span class="line"> <span class="comment">//Returns a possibly parallel &#123;@code Stream&#125; with this collection as its (返回一个可能是并行的流，其中包含此集合)</span></span><br><span class="line">  Stream&lt;String&gt; parallelStream = list.parallelStream();</span><br></pre></td></tr></table></figure>
<ul>
<li><em><strong>使用Arrays 中的 stream() 方法，将数组转成流</strong></em></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Integer[] nums = <span class="keyword">new</span> Integer[<span class="number">10</span>];</span><br><span class="line">Stream&lt;Integer&gt; stream = Arrays.stream(nums);</span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>使用Stream中的静态方法：of()、iterate()、generate()</strong></em></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream&lt;Integer&gt; stream = Stream.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">Stream&lt;Integer&gt; stream2 = Stream.iterate(<span class="number">0</span>, (x) -&gt; x + <span class="number">2</span>).limit(<span class="number">6</span>);</span><br><span class="line">stream2.forEach(System.out::println); <span class="comment">// 0 2 4 6 8 10</span></span><br><span class="line"></span><br><span class="line">Stream&lt;Double&gt; stream3 = Stream.generate(Math::random).limit(<span class="number">2</span>);</span><br><span class="line">stream3.forEach(System.out::println);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p><em><strong>使用 BufferedReader.lines() 方法，将每行内容转成流</strong></em></p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="string">&quot;D:\\test_stream.txt&quot;</span>));</span><br><span class="line">Stream&lt;String&gt; lineStream = reader.lines();</span><br><span class="line">lineStream.forEach(System.out::println);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><em><strong>使用 Pattern.splitAsStream() 方法，将字符串分隔成流</strong></em></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Pattern pattern = Pattern.compile(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">Stream&lt;String&gt; stringStream = pattern.splitAsStream(<span class="string">&quot;a,b,c,d&quot;</span>);</span><br><span class="line">stringStream.forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<h4 id="2-Stream的中间操作"><a href="#2-Stream的中间操作" class="headerlink" title="2 . Stream的中间操作"></a>2 . Stream的中间操作</h4><ul>
<li><em><strong>筛选与切片</strong></em></li>
</ul>
<p>​       filter：过滤流中的某些元素<br>　　 limit(n)：获取n个元素<br>　　 skip(n)：跳过n个元素，配合limit(n)可实现分页<br>　　 distinct：通过流中元素的 hashCode() 和 equals() 去除重复元素</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream&lt;Integer&gt; stream = Stream.of(<span class="number">6</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">14</span>);</span><br><span class="line">  </span><br><span class="line">Stream&lt;Integer&gt; newStream = stream.filter(s -&gt; s &gt; <span class="number">5</span>) <span class="comment">//6 6 7 9 8 10 12 14 14</span></span><br><span class="line">.distinct() <span class="comment">//6 7 9 8 10 12 14</span></span><br><span class="line">.skip(<span class="number">2</span>) <span class="comment">//9 8 10 12 14</span></span><br><span class="line">.limit(<span class="number">2</span>); <span class="comment">//9 8</span></span><br><span class="line">newStream.forEach(System.out::println);</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Student&gt; stuList = stuList();</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// 需要筛选的条件：从stuList中筛选出年龄为21和22的学生</span></span><br><span class="line">	List&lt;Integer&gt; ageList = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">	ageList.add(<span class="number">21</span>);</span><br><span class="line">	ageList.add(<span class="number">22</span>);</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// JDK1.8提供了lambda表达式， 可以从stuList中过滤出符合条件的结果。</span></span><br><span class="line">	<span class="comment">// 定义结果集</span></span><br><span class="line">	List&lt;Student&gt; result = <span class="keyword">null</span>;</span><br><span class="line">	result = stuList.stream()</span><br><span class="line">			.filter((Student s) -&gt; ageList.contains(s.getAge()))</span><br><span class="line">			.collect(Collectors.toList());</span><br><span class="line">   </span><br><span class="line">	<span class="comment">// 打印原有stuList集合中的数据</span></span><br><span class="line">	System.out.println(<span class="string">&quot;原有stuList集合中的数据&quot;</span>);</span><br><span class="line">	stuList.forEach((Student s) -&gt; System.out.println(s.getName() + <span class="string">&quot;---&gt;&quot;</span> + s.getAge()));</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>映射</strong></em></li>
</ul>
<p>​       map：接收一个函数作为参数，该函数会被应用到每个元素上，并将其映射成一个新的元素。<br>　   flatMap：接收一个函数作为参数，将流中的每个值都换成另一个流，然后把所有流连接成一个流。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;a,b,c&quot;</span>, <span class="string">&quot;1,2,3&quot;</span>);</span><br><span class="line">  </span><br><span class="line"><span class="comment">//将每个元素转成一个新的且不带逗号的元素</span></span><br><span class="line">Stream&lt;String&gt; s1 = list.stream().map(s -&gt; s.replaceAll(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">s1.forEach(System.out::println); <span class="comment">// abc 123</span></span><br><span class="line">  </span><br><span class="line">Stream&lt;String&gt; s3 = list.stream().flatMap(s -&gt; &#123;</span><br><span class="line"><span class="comment">//将每个元素转换成一个stream</span></span><br><span class="line">String[] split = s.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">Stream&lt;String&gt; s2 = Arrays.stream(split);</span><br><span class="line"><span class="keyword">return</span> s2;</span><br><span class="line">&#125;);</span><br><span class="line">s3.forEach(System.out::println); <span class="comment">// a b c 1 2 3</span></span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>排序</strong></em> </li>
</ul>
<p>​        sorted()：自然排序，流中元素需实现Comparable接口<br>　　sorted(Comparator com)：定制排序，自定义Comparator排序器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;ff&quot;</span>, <span class="string">&quot;dd&quot;</span>);</span><br><span class="line"><span class="comment">//String 类自身已实现Compareable接口</span></span><br><span class="line">list.stream().sorted().forEach(System.out::println);<span class="comment">// aa dd ff</span></span><br><span class="line">  </span><br><span class="line">Student s1 = <span class="keyword">new</span> Student(<span class="string">&quot;aa&quot;</span>, <span class="number">10</span>);</span><br><span class="line">Student s2 = <span class="keyword">new</span> Student(<span class="string">&quot;bb&quot;</span>, <span class="number">20</span>);</span><br><span class="line">Student s3 = <span class="keyword">new</span> Student(<span class="string">&quot;aa&quot;</span>, <span class="number">30</span>);</span><br><span class="line">Student s4 = <span class="keyword">new</span> Student(<span class="string">&quot;dd&quot;</span>, <span class="number">40</span>);</span><br><span class="line">List&lt;Student&gt; studentList = Arrays.asList(s1, s2, s3, s4);</span><br><span class="line">  </span><br><span class="line"><span class="comment">//自定义排序：先按姓名升序，姓名相同则按年龄升序</span></span><br><span class="line">studentList.stream().sorted(</span><br><span class="line">(o1, o2) -&gt; &#123;</span><br><span class="line"><span class="keyword">if</span> (o1.getName().equals(o2.getName())) &#123;</span><br><span class="line"><span class="keyword">return</span> o1.getAge() - o2.getAge();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> o1.getName().compareTo(o2.getName());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">).forEach(System.out::println);　</span><br></pre></td></tr></table></figure>
<ul>
<li><em><strong>消费</strong></em></li>
</ul>
<p>　　peek：如同于map，能得到流中的每一个元素。但map接收的是一个Function表达式，有返回值；而peek接收的是Consumer表达   式，没有返回值。</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Student s1 = <span class="keyword">new</span> Student(<span class="string">&quot;aa&quot;</span>, <span class="number">10</span>);</span><br><span class="line">Student s2 = <span class="keyword">new</span> Student(<span class="string">&quot;bb&quot;</span>, <span class="number">20</span>);</span><br><span class="line">List&lt;Student&gt; studentList = Arrays.asList(s1, s2);</span><br><span class="line">  </span><br><span class="line">studentList.stream()</span><br><span class="line">.peek(o -&gt; o.setAge(<span class="number">100</span>))</span><br><span class="line">.forEach(System.out::println);</span><br><span class="line">  </span><br><span class="line"><span class="comment">//结果：</span></span><br><span class="line">Student&#123;name=<span class="string">&#x27;aa&#x27;</span>, age=<span class="number">100</span>&#125;</span><br><span class="line">Student&#123;name=<span class="string">&#x27;bb&#x27;</span>, age=<span class="number">100</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-Stream的终止操作-常用函数"><a href="#3-Stream的终止操作-常用函数" class="headerlink" title="3. Stream的终止操作 (常用函数)"></a>3. Stream的终止操作 (常用函数)</h4><ul>
<li><em><strong>匹配 聚合操作</strong></em></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">  </span><br><span class="line"><span class="keyword">boolean</span> allMatch = list.stream().allMatch(e -&gt; e &gt; <span class="number">10</span>); <span class="comment">//false</span></span><br><span class="line"><span class="keyword">boolean</span> noneMatch = list.stream().noneMatch(e -&gt; e &gt; <span class="number">10</span>); <span class="comment">//true</span></span><br><span class="line"><span class="keyword">boolean</span> anyMatch = list.stream().anyMatch(e -&gt; e &gt; <span class="number">4</span>); <span class="comment">//true</span></span><br><span class="line">  </span><br><span class="line">Integer findFirst = list.stream().findFirst().get(); <span class="comment">//1</span></span><br><span class="line">Integer findAny = list.stream().findAny().get(); <span class="comment">//1</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">long</span> count = list.stream().count(); <span class="comment">//5</span></span><br><span class="line">Integer max = list.stream().max(Integer::compareTo).get(); <span class="comment">//5</span></span><br><span class="line">Integer min = list.stream().min(Integer::compareTo).get(); <span class="comment">//1　</span></span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>规约操作(reduce)</strong></em></li>
</ul>
<p> 三个重载的方法：</p>
<p>  1.Optional&lt;T&gt; reduce(BinaryOperator&lt;T&gt; accumulator);</p>
<p>  2.T reduce(T identity, BinaryOperator&lt;T&gt; accumulator)</p>
<p>  3.&lt;U&gt; U reduce(U identity, BiFunction&lt;U, ? super T, U&gt; accumulator, BinaryOperator&lt;U&gt; combiner);用在流并发操作的时候，将每个线程前两个参数形成的结果result集合并为一个。所以第三个参数是一个BinaryOperator函数接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//reduce(String identity, BinaryOperator&lt;String&gt; accumulator) 第一个参数相当于起始值 ，第二个参数是二元运算函数接口</span></span><br><span class="line">String s1 = custs.stream().map(Cust::getCustName).reduce(<span class="string">&quot;&quot;</span>, (x,y)-&gt;x+<span class="string">&quot;,&quot;</span>+y).replaceFirst(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">System.out.println(s1);</span><br><span class="line">		</span><br><span class="line"><span class="comment">//reduce(BinaryOperator&lt;String&gt; accumulator) 参数是二元运算函数接口，因为没有给默认值，所以为了避免使用时空指针异常，返回的是Optional</span></span><br><span class="line">Optional&lt;String&gt; opt = custs.stream().map(Cust::getCustName).reduce((x,y)-&gt;x+<span class="string">&quot;,&quot;</span>+y);</span><br><span class="line">String s2 = opt.get().replaceFirst(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>收集操作</strong></em><br><em><strong>collect:</strong></em> 接收一个Collector实例，将流中元素收集成另外一个数据结构。<br><em><strong>Collector&lt;T, A, R&gt;:</strong></em> 是一个接口，有以下5个抽象方法：<br>***Supplier&lt;A&gt; supplier():***创建一个结果容器A<br>***BiConsumer&lt;A, T&gt; accumulator():***消费型接口，第一个参数为容器A，第二个参数为流中元素T。<br>***BinaryOperator&lt;A&gt; combiner():***函数接口，该参数的作用跟上一个方法(reduce)中的combiner  参数一样，将并行流中各 个子进程          的运行结果(accumulator函数操作后的容器A)进行合并。<br>***Function&lt;A, R&gt; finisher():***函数式接口，参数为：容器A，返回类型为：collect方法最终想要的结果R。<br><em><strong>Set&lt;Characteristics&gt; characteristics():</strong></em>  返回一个不可变的Set集合，用来表明该Collector的特征。有以下三个特征：<br>***CONCURRENT:***表示此收集器支持并发。<br>***UNORDERED:***表示该收集操作不会保留流中元素原有的顺序。<br>***IDENTITY_FINISH:***表示finisher参数只是标识而已，可忽略。</li>
</ul>
<p><em><strong>Collector 工具库：Collectors</strong></em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Student s1 = <span class="keyword">new</span> Student(<span class="string">&quot;aa&quot;</span>, <span class="number">10</span>,<span class="number">1</span>);</span><br><span class="line">Student s2 = <span class="keyword">new</span> Student(<span class="string">&quot;bb&quot;</span>, <span class="number">20</span>,<span class="number">2</span>);</span><br><span class="line">Student s3 = <span class="keyword">new</span> Student(<span class="string">&quot;cc&quot;</span>, <span class="number">10</span>,<span class="number">3</span>);</span><br><span class="line">List&lt;Student&gt; list = Arrays.asList(s1, s2, s3);</span><br><span class="line"></span><br><span class="line"><span class="comment">//装成list</span></span><br><span class="line">List&lt;Integer&gt; ageList = list.stream().map(Student::getAge).collect(Collectors.toList()); <span class="comment">// [10, 20, 10]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//转成set</span></span><br><span class="line">Set&lt;Integer&gt; ageSet = list.stream().map(Student::getAge).collect(Collectors.toSet()); <span class="comment">// [20, 10]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//转成map,注:key不能相同，否则报错</span></span><br><span class="line">Map&lt;String, Integer&gt; studentMap = list.stream().collect(Collectors.toMap(Student::getName, Student::getAge)); <span class="comment">// &#123;cc=10, bb=20, aa=10&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//转成map 如何key相同 是否覆盖  (oldVal ,newVal)-&gt;newVal ? oldVal</span></span><br><span class="line"> Map&lt;String, Integer&gt; studentMap = list.stream().collect(Collectors.toMap(Student::getName, Student::getAge, (oldVal ,newVal)-&gt;newVal)); </span><br><span class="line"></span><br><span class="line"><span class="comment">//转为 LinkedHashMap   (LinkedHashMap::new)</span></span><br><span class="line">LinkedHashMap&lt;String, Integer&gt; collect = list.stream().collect(Collectors.toMap(Student::getName, Student::getAge, (oldVal, newVal) -&gt; newVal, LinkedHashMap::<span class="keyword">new</span>));<span class="comment">// &#123;cc=10, bb=20, aa=10&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//字符串分隔符连接</span></span><br><span class="line">String joinName = list.stream().map(Student::getName).collect(Collectors.joining(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>)); <span class="comment">// (aa,bb,cc)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//聚合操作</span></span><br><span class="line"><span class="comment">//1.学生总数</span></span><br><span class="line">Long count = list.stream().collect(Collectors.counting()); <span class="comment">// 3</span></span><br><span class="line"><span class="comment">//2.最大年龄 (最小的minBy同理)</span></span><br><span class="line">Integer maxAge = list.stream().map(Student::getAge).collect(Collectors.maxBy(Integer::compare)).get(); <span class="comment">// 20</span></span><br><span class="line"><span class="comment">//3.所有人的年龄</span></span><br><span class="line">Integer sumAge = list.stream().collect(Collectors.summingInt(Student::getAge)); <span class="comment">// 40</span></span><br><span class="line"><span class="comment">//4.平均年龄</span></span><br><span class="line">Double averageAge = list.stream().collect(Collectors.averagingDouble(Student::getAge)); <span class="comment">// 13.333333333333334</span></span><br><span class="line"><span class="comment">// 带上以上所有方法</span></span><br><span class="line">DoubleSummaryStatistics statistics = list.stream().collect(Collectors.summarizingDouble(Student::getAge));</span><br><span class="line">System.out.println(<span class="string">&quot;count:&quot;</span> + statistics.getCount() + <span class="string">&quot;,max:&quot;</span> + statistics.getMax() + <span class="string">&quot;,sum:&quot;</span> + statistics.getSum() + <span class="string">&quot;,average:&quot;</span> + statistics.getAverage());</span><br><span class="line"></span><br><span class="line"><span class="comment">//分组</span></span><br><span class="line">Map&lt;Integer, List&lt;Student&gt;&gt; ageMap = list.stream().collect(Collectors.groupingBy(Student::getAge));</span><br><span class="line"><span class="comment">//多重分组,先根据类型分再根据年龄分</span></span><br><span class="line">Map&lt;Integer, Map&lt;Integer, List&lt;Student&gt;&gt;&gt; typeAgeMap = list.stream().collect(Collectors.groupingBy(Student::getType, Collectors.groupingBy(Student::getAge)));</span><br><span class="line"></span><br><span class="line"><span class="comment">//分区</span></span><br><span class="line"><span class="comment">//分成两部分，一部分大于10岁，一部分小于等于10岁</span></span><br><span class="line">Map&lt;Boolean, List&lt;Student&gt;&gt; partMap = list.stream().collect(Collectors.partitioningBy(v -&gt; v.getAge() &gt; <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//规约</span></span><br><span class="line">Integer allAge = list.stream().map(Student::getAge).collect(Collectors.reducing(Integer::sum)).get(); <span class="comment">//40　</span></span><br></pre></td></tr></table></figure>

<h3 id="3-补充"><a href="#3-补充" class="headerlink" title="3.补充"></a>3.补充</h3><p>​     <em><strong>并行流：</strong></em>并行流就是把一个内容分成多个数据库卡，并用不同的线程分别处理每个数据块的流  </p>
<p>​    <em><strong>顺序流：</strong></em> 单线程执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * parallel（）  开启并行流</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Instant start = Instant.now();</span><br><span class="line">LongStream.rangeClosed(<span class="number">1</span>,<span class="number">10000000000L</span>).parallel().reduce(<span class="number">0</span>,Long::sum);</span><br><span class="line">System.out.println(<span class="string">&quot;系统执行时间:&quot;</span>+ Duration.between(start,Instant.now()).toMillis());</span><br></pre></td></tr></table></figure>

 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sequential()  开启顺序流</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Instant start1 = Instant.now();</span><br><span class="line">LongStream.rangeClosed(<span class="number">1</span>,<span class="number">10000000000L</span>).sequential().reduce(<span class="number">0</span>,Long::sum);</span><br><span class="line">System.out.println(<span class="string">&quot;系统执行时间:&quot;</span>+Duration.between(start1,Instant.now()).toMillis());</span><br></pre></td></tr></table></figure>

<h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><p>​     <em><strong>并行流 ：</strong></em>  </p>
<p>​               使用并行流并不是一定会提高效率，因为jvm对数据进行切片和切换线程也是需要时间的。</p>
<p>​               所以数据量越小，串行操作越快；数据量越大，并行操作效果越好。</p>
<p>​              并行流内部使用了默认的ForkJoinPool线程池，所以它默认的线程数量就是处理器的数量，通过它可以得到这个值。<br>​              <em><strong>System.out.println(Runtime.getRuntime().availableProcessors())。</strong></em></p>
<p>​                通过这个方法可以修改这个值，而且这个还是全局属性，不过建议一般不修改</p>
<p>​               <em><strong>System.setProperty(“java.util.concurrent.ForkJoinPool.common.parallelism”, “12”);</strong></em></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>Demo</tag>
      </tags>
  </entry>
  <entry>
    <title>java8之Stream补充</title>
    <url>/2021/03/16/java8%E4%B9%8BStream%E8%A1%A5%E5%85%85/</url>
    <content><![CDATA[<h3 id="java8之Stream补充"><a href="#java8之Stream补充" class="headerlink" title="java8之Stream补充"></a>java8之Stream补充</h3><p><strong>.findFirst()：</strong>  返回流中的第一个元素<br><strong>.findAny()</strong>   返回Stream中的任何元素<br><strong>.orElse(null)</strong>  表示如果一个都没找到返回null. 【orElse()中可以塞默认值。如果找不到就会返回orElse中你自己设置的默认值。】</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>Demo</tag>
      </tags>
  </entry>
  <entry>
    <title>java中基于文件的NIO</title>
    <url>/2021/06/08/java%E4%B8%AD%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E7%9A%84NIO/</url>
    <content><![CDATA[<h3 id="java-中文件NIO"><a href="#java-中文件NIO" class="headerlink" title="java 中文件NIO"></a>java 中文件NIO</h3><p><strong>1. 内存映射文件</strong></p>
<blockquote>
<p>通俗点，就是ReadFile和WriteFile这样的I/O系统函数， 在文件里来回地读、写、移动文件指针效率低 速度慢；CreateFileMapping函数允许应用程序把文件映射到一个进程，这样文件内的数据就可以用内存读/写指令来访问，提高效率。</p>
<p>再通俗点，就是比如 要读取一个文件里的东西 这时候你就得去硬盘读，但是映射到内存后 就可以直接对这块内存操作了；写操作也一个意思。。。。。就是把要在硬盘上搞的东西 弄到内存搞 搞起来方便</p>
<p>JDK1.4版本引入了java.nio包，对文件流进行读写操作，提供无阻塞模式，同时也提供了一种高效率的文件读写模式，内存映射文件，把文件某个区域块映射到内存，进行高效率的读写，主要用到下面类<br>java.nio.MappedByteBuffer;<br>java.nio.channels.FileChannel</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bjmashibing.system.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.RandomAccessFile;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.MappedByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.FileChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OSFileIO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">byte</span>[] data = <span class="string">&quot;123456789\n&quot;</span>.getBytes();</span><br><span class="line">    <span class="keyword">static</span> String path =  <span class="string">&quot;/root/testfileio/out.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最基本的file写</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title">testBasicFileIO</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(path);</span><br><span class="line">        FileOutputStream out = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            Thread.sleep(<span class="number">10</span>);</span><br><span class="line">            out.write(data);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试buffer文件IO</span></span><br><span class="line">    <span class="comment">// 在jvm上开启  8kB 的数据空间  写满8字节之后调用系统syscall以8字节的新式写到pageCahe  write(8KBbyte[])</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testBufferedFileIO</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(path);</span><br><span class="line">        BufferedOutputStream out = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            Thread.sleep(<span class="number">10</span>);</span><br><span class="line">            out.write(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试文件NIO</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testRandomAccessFileWrite</span><span class="params">()</span> <span class="keyword">throws</span>  Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(path, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line"></span><br><span class="line">        raf.write(<span class="string">&quot;hello mashibing\n&quot;</span>.getBytes());</span><br><span class="line">        raf.write(<span class="string">&quot;hello seanzhou\n&quot;</span>.getBytes());</span><br><span class="line">        System.out.println(<span class="string">&quot;write------------&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        raf.seek(<span class="number">4</span>);</span><br><span class="line">        raf.write(<span class="string">&quot;ooxx&quot;</span>.getBytes());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;seek---------&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        FileChannel rafchannel = raf.getChannel();</span><br><span class="line">        <span class="comment">//mmap  堆外  和文件映射的   byte  not  objtect</span></span><br><span class="line">        MappedByteBuffer map = rafchannel.map(FileChannel.MapMode.READ_WRITE, <span class="number">0</span>, <span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;@@@&quot;</span>.getBytes());  <span class="comment">//不是系统调用  但是数据会到达 内核的pagecache</span></span><br><span class="line">            <span class="comment">//曾经我们是需要out.write()  这样的系统调用，才能让程序的data 进入内核的pagecache</span></span><br><span class="line">            <span class="comment">//曾经必须有用户态内核态切换</span></span><br><span class="line">            <span class="comment">//mmap的内存映射，依然是内核的pagecache体系所约束的！！！</span></span><br><span class="line">            <span class="comment">//换言之，丢数据</span></span><br><span class="line">            <span class="comment">//你可以去github上找一些 其他C程序员写的jni扩展库，使用linux内核的Direct IO</span></span><br><span class="line">            <span class="comment">//直接IO是忽略linux的pagecache</span></span><br><span class="line">            <span class="comment">//是把pagecache  交给了程序自己开辟一个字节数组当作pagecache，动用代码逻辑来维护一致性/dirty。。。一系列复杂问题</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;map--put--------&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        map.force(); //  flush</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        raf.seek(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">8192</span>);</span><br><span class="line"><span class="comment">//        ByteBuffer buffer = ByteBuffer.allocateDirect(1024);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> read = rafchannel.read(buffer);   <span class="comment">//buffer.put()</span></span><br><span class="line">        System.out.println(buffer);</span><br><span class="line">        buffer.flip();</span><br><span class="line">        System.out.println(buffer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; buffer.limit(); i++) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">200</span>);</span><br><span class="line">            System.out.print(((<span class="keyword">char</span>)buffer.get(i)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">whatByteBuffer</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        ByteBuffer buffer = ByteBuffer.allocate(1024);</span></span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocateDirect(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;postition: &quot;</span> + buffer.position());</span><br><span class="line">        System.out.println(<span class="string">&quot;limit: &quot;</span> +  buffer.limit());</span><br><span class="line">        System.out.println(<span class="string">&quot;capacity: &quot;</span> + buffer.capacity());</span><br><span class="line">        System.out.println(<span class="string">&quot;mark: &quot;</span> + buffer);</span><br><span class="line"></span><br><span class="line">        buffer.put(<span class="string">&quot;123&quot;</span>.getBytes());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;-------------put:123......&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;mark: &quot;</span> + buffer);</span><br><span class="line"></span><br><span class="line">        buffer.flip();   <span class="comment">//读写交替</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;-------------flip......&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;mark: &quot;</span> + buffer);</span><br><span class="line"></span><br><span class="line">        buffer.get();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;-------------get......&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;mark: &quot;</span> + buffer);</span><br><span class="line"></span><br><span class="line">        buffer.compact();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;-------------compact......&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;mark: &quot;</span> + buffer);</span><br><span class="line"></span><br><span class="line">        buffer.clear();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;-------------clear......&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;mark: &quot;</span> + buffer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>java中的ThreadPoolExecutor</title>
    <url>/2021/06/04/java%E4%B8%AD%E7%9A%84ThreadPoolExecutor/</url>
    <content><![CDATA[<h3 id="java中的ThreadPoolExecutor"><a href="#java中的ThreadPoolExecutor" class="headerlink" title="java中的ThreadPoolExecutor"></a>java中的ThreadPoolExecutor</h3><p><strong>1. 为什么要使用线程池</strong></p>
<blockquote>
<ol>
<li>降低资源消耗。通过重复利用已创建的线程降低线程创建和销毁造成的消耗。</li>
<li>提高响应速度。当任务到达时，任务可以不需要的等到线程创建就能立即执行。</li>
<li>提高线程的可管理性。线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控。但是要做到合理的利用线程池，必须对其原理了如指掌。</li>
</ol>
</blockquote>
<p><strong>2. ThreadPoolExecutor中的构造器</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                             TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                             BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                             ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                             RejectedExecutionHandler handler)</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>corePoolSize（基本大小）:指定了线程池中的核心线程数量， 也就是线程池的目标大小。只有在工作队列满了的情况下才会创建超出这个数量的线程。</strong></p>
</blockquote>
<blockquote>
<p><strong>maximumPoolSize:指定了线程池中的总线程数量，为了保证系统资源有控制的消耗。</strong></p>
</blockquote>
<blockquote>
<p><strong>keepAliveTime:当线程池中空闲线程数量超过corePoolSize时，多余的线程会在多长时间内被销毁；</strong></p>
</blockquote>
<blockquote>
<p><strong>unit:keepAliveTime的单位</strong></p>
</blockquote>
<blockquote>
<p><strong>workQueue:任务队列，被添加到线程池中，但尚未被执行的任务；它一般分为直接提交队列、有界任务队列、无界任务队列、优先任务队列几种；</strong></p>
</blockquote>
<blockquote>
<p><strong>threadFactory:线程工厂，用于创建线程，一般用于给线程命名；</strong></p>
</blockquote>
<blockquote>
<p><strong>handler:拒绝策略；当任务太多来不及处理时，如何拒绝任务；</strong></p>
</blockquote>
<p>**3.  ThreadPoolExecutor中的构造器参数的额外说明 **</p>
<blockquote>
<p><strong>1.刚刚创建ThreadPoolExecutor的时候，线程并不会 立即启动，而是要等到有任务提交时才会启动。如果预先调用了prestartCoreThread()/prestartAllCoreThreads()，则会事先启动核心线程。</strong></p>
<p><strong>2. 考虑到keepAliveTime()和allowCoreThreadTimeOut()超市参数的影响，没有任务或者没有足够任务执行的时候，线程池中运行线程的数量（线程池的大小）小于等于corePoolSize。</strong></p>
<p><strong>3. 由于maximumPoolSize可以在运行中通过setMaximumPoolSize()来设置，所以可以通过largestPoolSize()方法来获得线程池曾经运行过的最大线程数量，来评估当前maximumPoolSize设置是否合适。</strong></p>
<p><strong>4. 对于核心线程，默认一直保留存活，如果将allowCoreThreadTimeOut设置为true，则核心线程也接受keepAliveTime的约束。</strong></p>
</blockquote>
<p><strong>4. 关于BlockingQueue的详细说明：</strong></p>
<blockquote>
<p>此BlockingQueue的实现有：<br>-&gt;ArrayBlockingQueue:基于数组结构的有届阻塞队列，FIFO<br>-&gt;LinkedBlockingQueue:基于链表的阻塞队列，FIFO。吞吐量大于上者。静态工厂方法Executors.newFixedThreadPool()使用了这个队列<br>-&gt;SynchronousQueue:一个不存储元素的阻塞队列。每个插入操作必须等到另一个线程调用移除操作，否则插入操作一直处于阻塞状态，吞吐量高于LinkedBlockingQueue.静态工厂方法Executors.newCachedThreadPool()使用了这个队列。<br>-&gt;PriorityBlockingQueue:一个具有优先级的无限阻塞队列。</p>
</blockquote>
<p><strong>5. 关于RejectedExecutionHandler的详细说明：</strong></p>
<blockquote>
<p>当队列和线程池都满了之后的饱和策略。默认情况下是AbortPolicy,表示无法处理新任务时抛出异常。以下是JDK1.5提供的四种策略：<br>-&gt;AbortPolicy:直接抛出异常<br>-&gt;CallerRunsPolicy:只用调用者所在的线程来运行任务。<br>-&gt;DiscardOldestPolicy:丢弃队列里最近一个任务，并执行当前任务。<br>-&gt;DiscardPolicy:不处理，丢弃掉。<br>-&gt;也可以根据应用场景需要来实现RejectedExecutionHandler接口自定义策略。如记录日志或持久化不能处理的任务。</p>
</blockquote>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>java中的位和位移运算符</title>
    <url>/2021/04/05/java%E4%B8%AD%E7%9A%84%E4%BD%8D%E5%92%8C%E4%BD%8D%E7%A7%BB%E8%BF%90%E7%AE%97%E7%AC%A6/</url>
    <content><![CDATA[<h3 id="位和位移运算符"><a href="#位和位移运算符" class="headerlink" title="位和位移运算符"></a>位和位移运算符</h3><table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td>&amp;</td>
<td>如果相对应的位数都是1，则结果为1，否则为0</td>
<td>(1100&amp;1101) = 1100</td>
</tr>
<tr>
<td>|</td>
<td>如果对应的位数有一个是1，则结果是1，否则为0</td>
<td>(1100&amp;1101) = 1101</td>
</tr>
<tr>
<td>^</td>
<td>如果相对应 位的值相同则取0，否则取1</td>
<td>(1100&amp;1101) = 0001</td>
</tr>
<tr>
<td>~</td>
<td>按位取反运算符，反转操作数的每一位，即0变成1，1变成0</td>
<td>~ 1100 = 0011</td>
</tr>
<tr>
<td>&lt;&lt;</td>
<td>按位左移运算符，按照指定的位数左移,不分正负数，低位补0,带符号位移，高位移出，低位补0，移动位数超过该类型的最大位数，则进行取模，如对Integer型左移34位，实际上只移动了两位。左移一位相当于乘以2的一次方，左移n位相当于乘以2的n次方。</td>
<td>1100 &lt;&lt; 1 = 1000</td>
</tr>
<tr>
<td>&gt;&gt;</td>
<td>按位右移运算符。按照指定的位数右移并以符号位填空 ,如果该数为正，则高位补0，若为负数，则高位补1；带符号右移</td>
<td>1100 &gt;&gt;1 = 1110</td>
</tr>
<tr>
<td>&gt;&gt;&gt;</td>
<td>按位右移补0操作,按照指定的位数右移并以零填空位,无符号右移，也叫逻辑右移，即若该数为正，则高位补0，而若该数为负数，则右移后高位同样补0；不带符号右移</td>
<td>1100 &gt;&gt;&gt; 1 =  0110</td>
</tr>
</tbody></table>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>java内存模型</title>
    <url>/2021/06/25/java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/</url>
    <content><![CDATA[<h3 id="Java内存区域（运行时数据区域）和内存模型（JMM）"><a href="#Java内存区域（运行时数据区域）和内存模型（JMM）" class="headerlink" title="Java内存区域（运行时数据区域）和内存模型（JMM）"></a>Java内存区域（运行时数据区域）和内存模型（JMM）</h3><blockquote>
<p><strong>Java 内存区域和内存模型是不一样的东西，内存区域是指 Jvm 运行时将数据分区域存储，强调对内存空间的划分。</strong></p>
<p><strong>而内存模型（Java Memory Model，简称 JMM ）是定义了线程和主内存之间的抽象关系，即 JMM 定义了 JVM 在计算机内存(RAM)中的工作方式，如果我们要想深入了解Java并发编程，就要先理解好Java内存模型。</strong></p>
</blockquote>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/jmm%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png" alt="jmm内存模型"></p>
<h3 id="JVM主内存与工作内存"><a href="#JVM主内存与工作内存" class="headerlink" title="JVM主内存与工作内存"></a>JVM主内存与工作内存</h3><p>Java 内存模型的主要目标是定义程序中各个变量的访问规则，即在虚拟机中将变量（线程共享的变量）存储到内存和从内存中取出变量这样底层细节。</p>
<p>Java内存模型中规定了所有的变量都存储在主内存中，每条线程还有自己的工作内存，线程对变量的所有操作都必须在工作内存中进行，而不能直接读写主内存中的变量。</p>
<p>这里的工作内存是 JMM 的一个抽象概念，也叫本地内存，其存储了该线程以读 / 写共享变量的副本。</p>
<p><strong>就像每个处理器内核拥有私有的高速缓存，JMM 中每个线程拥有私有的本地内存。</strong></p>
<p>不同线程之间无法直接访问对方工作内存中的变量，线程间的通信一般有两种方式进行，一是通过消息传递，二是共享内存。Java 线程间的通信采用的是共享内存方式，线程、主内存和工作内存的交互关系如下图所示：</p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/java%E5%B7%A5%E4%BD%9C%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B.png" alt="java工作线程模型"></p>
<p>这里所讲的主内存、工作内存与 Java 内存区域中的 Java 堆、栈、方法区等并不是同一个层次的内存划分，这两者基本上是没有关系的，如果两者一定要勉强对应起来，那从变量、主内存、工作内存的定义来看，主内存主要对应于Java堆中的对象实例数据部分，而工作内存则对应于虚拟机栈中的部分区域。</p>
<h3 id="重排序和happens-before规则"><a href="#重排序和happens-before规则" class="headerlink" title="重排序和happens-before规则"></a>重排序和happens-before规则</h3><p>在执行程序时为了提高性能，编译器和处理器常常会对指令做重排序。重排序分三种类型：</p>
<ol>
<li>编译器优化的重排序。编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序。</li>
<li>指令级并行的重排序。现代处理器采用了指令级并行技术（Instruction-Level Parallelism， ILP）来将多条指令重叠执行。如果不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序。</li>
<li>内存系统的重排序。由于处理器使用缓存和读 / 写缓冲区，这使得加载和存储操作看上去可能是在乱序执行。</li>
</ol>
<p>从 java 源代码到最终实际执行的指令序列，会分别经历下面三种重排序：</p>
<pre class="mermaid">graph LR
A[源代码] -->B[编译器优化重排]
B --> c[指令级重排序]
c --> E[内存系统重排序]
E --> G[最终执行的指令]</pre>

<p>JMM 属于语言级的内存模型，它确保在不同的编译器和不同的处理器平台之上，通过禁止特定类型的编译器重排序和处理器重排序，为程序员提供一致的内存可见性保证。</p>
<p>java 编译器禁止处理器重排序是通过在生成指令序列的适当位置会插入内存屏障（重排序时不能把后面的指令重排序到内存屏障之前的位置）指令来实现的。</p>
<h5 id="happens-before"><a href="#happens-before" class="headerlink" title="happens-before"></a>happens-before</h5><p>从 JDK5 开始，java 内存模型提出了 happens-before 的概念，通过这个概念来阐述操作之间的内存可见性。</p>
<p>如果一个操作执行的结果需要对另一个操作可见，那么这两个操作之间必须存在 happens-before 关系。这里提到的两个操作既可以是在一个线程之内，也可以是在不同线程之间。</p>
<p><strong>这里的“可见性”是指当一条线程修改了这个变量的值，新值对于其他线程来说是可以立即得知的。</strong></p>
<p>如果 A happens-before B，那么 Java 内存模型将向程序员保证—— A 操作的结果将对 B 可见，且 A 的执行顺序排在 B 之前。</p>
<p>重要的 happens-before 规则如下：</p>
<ol>
<li>程序顺序规则：一个线程中的每个操作，happens- before 于该线程中的任意后续操作。</li>
<li>监视器锁规则：对一个监视器锁的解锁，happens- before 于随后对这个监视器锁的加锁。</li>
<li>volatile 变量规则：对一个 volatile 域的写，happens- before 于任意后续对这个 volatile 域的读。</li>
<li>传递性：如果 A happens- before B，且 B happens- before C，那么 A happens- before C。 </li>
</ol>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>java好的开源项目</title>
    <url>/2021/01/08/java%E5%A5%BD%E7%9A%84%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/</url>
    <content><![CDATA[<h4 id="好的开源项目"><a href="#好的开源项目" class="headerlink" title="好的开源项目"></a>好的开源项目</h4><ul>
<li><strong>项目简介</strong></li>
</ul>
<p>一个基于 Spring Boot 2.1.0 、 Spring Boot Jpa、 JWT、Spring Security、Redis、Vue的前后端分离的后台管理系统</p>
<p>  <a href="https://el-admin.vip/">开发文档</a></p>
<p> <a href="https://doc.el-admin.xin/">备用文档</a></p>
<p><strong>账号密码：</strong> <code>admin / 123456</code></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>随笔记录</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>java对象结构</title>
    <url>/2021/05/24/java%E5%AF%B9%E8%B1%A1%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[<h1 id="java对象结构"><a href="#java对象结构" class="headerlink" title="java对象结构"></a>java对象结构</h1><p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/juc/%E5%AF%B9%E8%B1%A1%E7%BB%93%E6%9E%84.png" alt="对象布局"></p>
<p><strong>HotSpot虚拟机</strong> markOop.cpp 中的 C++ 代码注释片段，描述了 64bits 下 mark-word 的存储状态，也就是如上图结构示意。</p>
<p>markOop.cpp 源码地址： <a href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/oops/markOop.hpp">jdk8/hotspot/file/vm/oops/markOop.hpp</a></p>
<p><strong>HotSpot虚拟机中</strong>，对象在内存中存储的布局可以分为三块区域：<code>对象头（Header）</code>、<code>实例数据（Instance Data）</code>和<code>对齐填充（Padding）</code>。</p>
<ul>
<li>mark-word：对象标记字段占4个字节，用于存储一些列的标记位，比如：哈希值、轻量级锁的标记位，偏向锁标记位、分代年龄等。</li>
<li>Klass Pointer：Class对象的类型指针，Jdk1.8默认开启指针压缩后为4字节，关闭指针压缩（<code>-XX:-UseCompressedOops</code>）后，长度为8字节。其指向的位置是对象对应的Class对象（其对应的元数据对象）的内存地址。</li>
<li>对象实际数据：包括对象的所有成员变量，大小由各个成员变量决定，比如：byte占1个字节8比特位、int占4个字节32比特位。</li>
<li>对齐：最后这段空间补全并非必须，仅仅为了起到占位符的作用。由于HotSpot虚拟机的内存管理系统要求对象起始地址必须是8字节的整数倍，所以对象头正好是8字节的倍数。因此当对象实例数据部分没有对齐的话，就需要通过对齐填充来补全。</li>
</ul>
<p><strong>另外</strong>，在mark-word锁类型标记中，无锁，偏向锁，轻量锁，重量锁，以及GC标记，5种类中没法用2比特标记（2比特最终有4种组合<code>00</code>、<code>01</code>、<code>10</code>、<code>11</code>），所以无锁、偏向锁，前又占了一位偏向锁标记。最终：001为无锁、101为偏向锁。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.openjdk.jol/jol-core --&gt;</span></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.openjdk.jol&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jol-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.9&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class A &#123;</span><br><span class="line">    int i &#x3D; 3;</span><br><span class="line">    int i1 &#x3D; 3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class B &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        A a &#x3D; new A();</span><br><span class="line">&#x2F;&#x2F;        Object o &#x3D; new Object();</span><br><span class="line">&#x2F;&#x2F;        System.out.println(o + &quot; 十六进制哈希：&quot; + Integer.toHexString(o.hashCode()));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(ClassLayout.parseInstance(a).toPrintable());</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(a).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">com.yzw.juc.markWord.A@5cad8086 十六进制哈希：5cad8086</span><br><span class="line">com.yzw.juc.markWord.A object internals:</span><br><span class="line"> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      <span class="number">0</span>     <span class="number">4</span>        (object header)                           <span class="number">01</span> <span class="number">86</span> <span class="number">80</span> ad (<span class="number">00000001</span> <span class="number">10000110</span> <span class="number">10000000</span> <span class="number">10101101</span>) (-<span class="number">1384086015</span>)</span><br><span class="line">      <span class="number">4</span>     <span class="number">4</span>        (object header)                           5c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> (<span class="number">01011100</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span>) (<span class="number">92</span>)</span><br><span class="line">      <span class="number">8</span>     <span class="number">4</span>        (object header)                           <span class="number">43</span> c1 <span class="number">00</span> f8 (<span class="number">01000011</span> <span class="number">11000001</span> <span class="number">00000000</span> <span class="number">11111000</span>) (-<span class="number">134168253</span>)</span><br><span class="line">     <span class="number">12</span>     <span class="number">4</span>    <span class="keyword">int</span> A.i                                       <span class="number">3</span></span><br><span class="line">     <span class="number">16</span>     <span class="number">4</span>    <span class="keyword">int</span> A.i1                                      <span class="number">3</span></span><br><span class="line">     <span class="number">20</span>     <span class="number">4</span>        (loss due to the next object alignment)</span><br><span class="line">Instance size: <span class="number">24</span> bytes</span><br><span class="line">Space losses: <span class="number">0</span> bytes internal + <span class="number">4</span> bytes external = <span class="number">4</span> bytes total</span><br></pre></td></tr></table></figure>

<ul>
<li>运行结果</li>
</ul>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/juc/%E5%A4%B4%E5%83%8F%E5%A4%B4%E5%AD%98%E5%82%A8%E9%AA%8C%E8%AF%81.png" alt="验证"></p>
<ul>
<li><p><strong>如上图：</strong> markWord 占8字节   Klass Point占4字节  实际的对象数据占8字节  最后四个字节用于填充对齐</p>
</li>
<li><p><strong>如上图：</strong> 对象的头部也存放了hash,只不过这个哈希值是倒过来的</p>
<p><strong>关于倒过来的问题是大小端存储导致的</strong></p>
<ul>
<li>Big-Endian：高位字节存放于内存的低地址端，低位字节存放于内存的高地址端</li>
<li>Little-Endian：低位字节存放于内存的低地址端，高位字节存放于内存的高地址端</li>
</ul>
</li>
</ul>
<p><strong>markWord结构</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/juc/markword%E7%BB%93%E6%9E%84.png" alt="markWord"></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>java模拟浏览器做文件上传</title>
    <url>/2021/01/02/java%E6%A8%A1%E6%8B%9F%E6%B5%8F%E8%A7%88%E5%99%A8%E5%81%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/</url>
    <content><![CDATA[<h4 id="java模拟浏览器做文件上传"><a href="#java模拟浏览器做文件上传" class="headerlink" title="java模拟浏览器做文件上传"></a>java模拟浏览器做文件上传</h4><p><strong>所需jar:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;httpclient.version&gt;4.5.13&lt;/httpclient.version&gt;</span><br><span class="line">    &lt;httpcore.version&gt;4.4.14&lt;/httpcore.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;httpclient&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;httpclient.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;httpcore&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;4.4.14&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;httpmime&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;4.5.12&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>代码示例：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yzw.http;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.mime.HttpMultipartMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.mime.MultipartEntityBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.mime.content.FileBody;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yzw</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">httpClientUploadFile</span><span class="params">(String url, File file, Map&lt;String,String&gt; params)</span> </span>&#123;</span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.createDefault();</span><br><span class="line">        String result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//每个post参数之间的分隔。随意设定，只要不会和其他的字符串重复即可。</span></span><br><span class="line">        String boundary =<span class="string">&quot;--------------20200103121104567&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HttpPost httpPost = <span class="keyword">new</span> HttpPost(url);</span><br><span class="line">            <span class="comment">//设置请求头</span></span><br><span class="line">            httpPost.setHeader(<span class="string">&quot;Content-Type&quot;</span>,<span class="string">&quot;multipart/form-data; boundary=&quot;</span>+boundary);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//HttpEntity builder</span></span><br><span class="line">            MultipartEntityBuilder builder = MultipartEntityBuilder.create();</span><br><span class="line">            <span class="comment">//字符编码</span></span><br><span class="line">            builder.setCharset(Charset.forName(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            <span class="comment">//模拟浏览器</span></span><br><span class="line">            builder.setMode(HttpMultipartMode.BROWSER_COMPATIBLE);</span><br><span class="line">            <span class="comment">//boundary</span></span><br><span class="line">            builder.setBoundary(boundary);</span><br><span class="line">            <span class="comment">//multipart/form-data</span></span><br><span class="line">            builder.addPart(<span class="string">&quot;uploadimg&quot;</span>,<span class="keyword">new</span> FileBody(file));<span class="comment">//相当于&lt;input name=&#x27;file&#x27; type=&#x27;file&#x27;/&gt;</span></span><br><span class="line">            <span class="comment">// binary</span></span><br><span class="line"><span class="comment">//            builder.addBinaryBody(&quot;name=\&quot;file\&quot;; filename=\&quot;test.txt\&quot;&quot;, new FileInputStream(file), ContentType.MULTIPART_FORM_DATA, file.getName());// 文件流</span></span><br><span class="line">            <span class="comment">//其他参数</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : params.entrySet()) &#123;</span><br><span class="line">                builder.addTextBody(entry.getKey(), entry.getValue() );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//HttpEntity</span></span><br><span class="line">            HttpEntity entity = builder.build();</span><br><span class="line">            httpPost.setEntity(entity);</span><br><span class="line">            <span class="comment">// 执行提交</span></span><br><span class="line">            HttpResponse response = httpClient.execute(httpPost);</span><br><span class="line">            <span class="comment">//响应</span></span><br><span class="line">            HttpEntity responseEntity = response.getEntity();</span><br><span class="line">            <span class="keyword">if</span> (responseEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 将响应内容转换为字符串</span></span><br><span class="line">                result = EntityUtils.toString(responseEntity, Charset.forName(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                httpClient.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.err.println(<span class="string">&quot;result&quot;</span>+result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//main 方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Map&lt;String,String&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        String filePath = <span class="keyword">new</span> String(<span class="string">&quot;C:\\Users\\27184\\Desktop\\项目\\新建文件夹\\的文案.png&quot;</span>);</span><br><span class="line">        <span class="comment">// 把一个普通参数和文件上传给下面这个地址 是一个servlet</span></span><br><span class="line">        String httpPost = <span class="string">&quot;http://1.w2wz.com/upload.php&quot;</span>;</span><br><span class="line">        httpClientUploadFile(httpPost,<span class="keyword">new</span> File(filePath),params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>个人笔记</category>
      </categories>
      <tags>
        <tag>Demo</tag>
      </tags>
  </entry>
  <entry>
    <title>java运行时数据区</title>
    <url>/2021/06/25/java%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA/</url>
    <content><![CDATA[<h3 id="Java内存区域（运行时数据区域）和内存模型（JMM）"><a href="#Java内存区域（运行时数据区域）和内存模型（JMM）" class="headerlink" title="Java内存区域（运行时数据区域）和内存模型（JMM）"></a>Java内存区域（运行时数据区域）和内存模型（JMM）</h3><blockquote>
<p><strong>Java 内存区域和内存模型是不一样的东西，内存区域是指 Jvm 运行时将数据分区域存储，强调对内存空间的划分。</strong></p>
<p><strong>而内存模型（Java Memory Model，简称 JMM ）是定义了线程和主内存之间的抽象关系，即 JMM 定义了 JVM 在计算机内存(RAM)中的工作方式，如果我们要想深入了解Java并发编程，就要先理解好Java内存模型。</strong></p>
</blockquote>
<h4 id="Java运行时数据区域-Runtime-Data-Area"><a href="#Java运行时数据区域-Runtime-Data-Area" class="headerlink" title="Java运行时数据区域(Runtime Data Area)"></a>Java运行时数据区域(Runtime Data Area)</h4><p>众所周知，Java 虚拟机有自动内存管理机制，如果出现内存泄漏和溢出方面的问题，排查错误就必须要了解虚拟机是怎样使用内存的。</p>
<p>下图是 JDK8 之后的 JVM 内存布局。</p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/java%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.png" alt="java 运行时数据区"></p>
<h4 id="程序计数器-Program-Counter-Register"><a href="#程序计数器-Program-Counter-Register" class="headerlink" title="程序计数器(Program Counter Register)"></a><strong>程序计数器(Program Counter Register)</strong></h4><p>程序计数器（Program Counter Register）是一块较小的内存空间，它可以看作是当前线程所执行的字节码的行号指示器。</p>
<p>由于 Java 虚拟机的多线程是通过线程轮流切换并分配处理器执行时间的方式来实现的，在任何一个确定的时刻，一个处理器内核都只会执行一条线程中的指令。</p>
<p>因此，为了线程切换后能恢复到正确的执行位置，每条线程都需要有一个独立的程序计数器，各条线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存。</p>
<p>如果线程正在执行的是一个 Java 方法，这个计数器记录的是正在执行的虚拟机字节码指令的地址；如果正在执行的是 Native 方法，这个计数器值则为空（Undefined）。此内存区域是唯一一个在 Java 虚拟机规范中没有规定任何 OutOfMemoryError 情况的区域。</p>
<h4 id="Java虚拟机栈-Java-Virtual-Machine-Stacks"><a href="#Java虚拟机栈-Java-Virtual-Machine-Stacks" class="headerlink" title="Java虚拟机栈(Java Virtual Machine Stacks)"></a><strong>Java虚拟机栈(Java Virtual Machine Stacks)</strong></h4><p>与程序计数器一样，Java 虚拟机栈（Java Virtual Machine Stacks）也是线程私有的，它的生命周期与线程相同。</p>
<p>虚拟机栈描述的是 Java 方法执行的内存模型：每个方法在执行的同时都会创建一个栈帧（Stack Frame，是方法运行时的基础数据结构）用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程。</p>
<p>在活动线程中，只有位于栈顶的帧才是有效的，称为当前栈帧。正在执行的方法称为当前方法，栈帧是方法运行的基本结构。在执行引擎运行时，所有指令都只能针对当前栈帧进行操作。</p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/java%E6%A0%88%E6%A8%A1%E5%9E%8B%E5%9B%BE.png" alt="栈"></p>
<ol>
<li>局部变量表</li>
</ol>
<p>局部变量表是存放方法参数和局部变量的区域。 局部变量没有准备阶段， 必须显式初始化。如果是非静态方法，<strong>则在 index[0] 位置上存储的是方法所属对象的实例引用</strong>，一个引用变量占 4 个字节，随后存储的是参数和局部变量。字节码指令中的 STORE 指令就是将操作栈中计算完成的局部变呈写回局部变量表的存储空间内。</p>
<p>虚拟机栈规定了两种异常状况：如果线程请求的栈深度大于虚拟机所允许的深度，将抛出 StackOverflowError 异常；如果虚拟机栈可以动态扩展（当前大部分的 Java 虚拟机都可动态扩展），如果扩展时无法申请到足够的内存，就会抛出 OutOfMemoryError 异常。</p>
<ol start="2">
<li>操作栈</li>
</ol>
<p>操作栈是个初始状态为空的桶式结构栈。在方法执行过程中， 会有各种指令往<br>栈中写入和提取信息。JVM 的执行引擎是基于栈的执行引擎， 其中的栈指的就是操<br>作栈。字节码指令集的定义都是基于栈类型的，栈的深度在方法元信息的 stack 属性中。</p>
<p><strong>i++ 和 ++i 的区别：</strong></p>
<ol>
<li>i++：从局部变量表取出 i 并压入操作栈(load memory)，然后对局部变量表中的 i 自增 1(add&amp;store memory)，将操作栈栈顶值取出使用，如此线程从操作栈读到的是自增之前的值。</li>
<li>++i：先对局部变量表的 i 自增 1(load memory&amp;add&amp;store memory)，然后取出并压入操作栈(load memory)，再将操作栈栈顶值取出使用，线程从操作栈读到的是自增之后的值。</li>
</ol>
<p>​     之前之所以说 i++ 不是原子操作，即使使用 volatile 修饰也不是线程安全，就是因为，可能 i 被从局部变量表（内存）取出，压入操作         栈（寄存器），操作栈中自增，使用栈顶值更新局部变量表（寄存器更新写入内存），其中分为 3 步，volatile 保证可见性，保证每次从   局部变量表读取的都是最新的值，但可能这 3 步可能被另一个线程的 3 步打断，产生数据互相覆盖问题，从而导致 i 的值比预期的小。</p>
<ol start="3">
<li>动态链接</li>
</ol>
<p>每个栈帧中包含一个在常量池中对当前方法的引用， 目的是支持方法调用过程的动态连接。</p>
<p>4.方法返回地址</p>
<p>方法执行时有两种退出情况：</p>
<ol>
<li>正常退出，即正常执行到任何方法的返回字节码指令，如 RETURN、IRETURN、ARETURN 等；</li>
<li>异常退出。</li>
</ol>
<p>无论何种退出情况，都将返回至方法当前被调用的位置。方法退出的过程相当于弹出当前栈帧，退出可能有三种方式：</p>
<ol>
<li>返回值压入上层调用栈帧。</li>
<li>异常信息抛给能够处理的栈帧。</li>
<li>PC计数器指向方法调用后的下一条指令。</li>
</ol>
<h4 id="本地方法栈-Native-Method-Stack"><a href="#本地方法栈-Native-Method-Stack" class="headerlink" title="本地方法栈(Native Method Stack)"></a><strong>本地方法栈(Native Method Stack)</strong></h4><p>本地方法栈（Native Method Stack）与虚拟机栈所发挥的作用是非常相似的，它们之间的区别不过是虚拟机栈为虚拟机执行 Java 方法（也就是字节码）服务，而本地方法栈则为虚拟机使用到的 Native 方法服务。Sun HotSpot 虚拟机直接就把本地方法栈和虚拟机栈合二为一。与虚拟机栈一样，本地方法栈区域也会抛出 StackOverflowError 和 OutOfMemoryError 异常。</p>
<p>线程开始调用本地方法时，会进入 个不再受 JVM 约束的世界。本地方法可以通过 JNI(Java Native Interface)来访问虚拟机运行时的数据区，甚至可以调用寄存器，具有和 JVM 相同的能力和权限。 当大量本地方法出现时，势必会削弱 JVM 对系统的控制力，因为它的出错信息都比较黑盒。对内存不足的情况，本地方法栈还是会抛出 nativeheapOutOfMemory。</p>
<p>JNI 类本地方法最著名的应该是 <code>System.currentTimeMillis()</code> ，JNI使 Java 深度使用操作系统的特性功能，复用非 Java 代码。 但是在项目过程中， 如果大量使用其他语言来实现 JNI , 就会丧失跨平台特性。</p>
<h4 id="Java堆-Java-Heap"><a href="#Java堆-Java-Heap" class="headerlink" title="Java堆(Java Heap)"></a><strong>Java堆(Java Heap)</strong></h4><p>对于大多数应用来说，Java 堆（Java Heap）是 Java 虚拟机所管理的内存中最大的一块。Java 堆是被所有线程共享的一块内存区域，在虚拟机启动时创建。此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这里分配内存。</p>
<p>堆是垃圾收集器管理的主要区域，因此很多时候也被称做“GC堆”（Garbage Collected Heap）。从内存回收的角度来看，由于现在收集器基本都采用分代收集算法，所以 Java 堆中还可以细分为：新生代和老年代；再细致一点的有 Eden 空间、From Survivor 空间、To Survivor 空间等。从内存分配的角度来看，线程共享的 Java 堆中可能划分出多个线程私有的分配缓冲区（Thread Local Allocation Buffer,TLAB）。</p>
<p>Java 堆可以处于物理上不连续的内存空间中，只要逻辑上是连续的即可，当前主流的虚拟机都是按照可扩展来实现的（通过 -Xmx 和 -Xms 控制）。如果在堆中没有内存完成实例分配，并且堆也无法再扩展时，将会抛出 OutOfMemoryError 异常。</p>
<h4 id="方法区-Method-Area"><a href="#方法区-Method-Area" class="headerlink" title="方法区(Method Area)"></a><strong>方法区(Method Area)</strong></h4><p>方法区（Method Area）与 Java 堆一样，是各个线程共享的内存区域，它用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。虽然Java 虚拟机规范把方法区描述为堆的一个逻辑部分，但是它却有一个别名叫做 Non-Heap（非堆），目的应该是与 Java 堆区分开来。</p>
<p>Java 虚拟机规范对方法区的限制非常宽松，除了和 Java 堆一样不需要连续的内存和可以选择固定大小或者可扩展外，还可以选择不实现垃圾收集。垃圾收集行为在这个区域是比较少出现的，其内存回收目标主要是针对常量池的回收和对类型的卸载。当方法区无法满足内存分配需求时，将抛出 OutOfMemoryError 异常。</p>
<p><strong>JDK8 之前，Hotspot 中方法区的实现是永久代（Perm），JDK8 开始使用元空间（Metaspace），以前永久代所有内容的字符串常量移至堆内存，其他内容移至元空间，元空间直接在本地内存分配。</strong></p>
<blockquote>
<p>在 HotSpot JVM 中，永久代中用于存放类和方法的元数据以及常量池，比如<code>Class</code>和<code>Method</code>。每当一个类初次被加载的时候，它的元数据都会放到永久代中。<br>永久代是有大小限制的，因此如果加载的类太多，很有可能导致永久代内存溢出，即万恶的 <em>java.lang.OutOfMemoryError: PermGen</em> ，为此我们不得不对虚拟机做调优。那么，Java 8 中 PermGen 为什么被移出 HotSpot JVM 了？我总结了两个主要原因:</p>
<ol>
<li><p>由于 PermGen 内存经常会溢出，引发恼人的 <em>java.lang.OutOfMemoryError: PermGen</em>，因此 JVM 的开发者希望这一块内存可以更灵活地被管理，不要再经常出现这样的 OOM</p>
</li>
<li><p>移除 PermGen 可以促进 HotSpot JVM 与 JRockit VM 的融合，因为 JRockit 没有永久代。<br>根据上面的各种原因，PermGen 最终被移除，<strong>方法区移至 Metaspace，字符串常量移至 Java Heap</strong>。</p>
<p><strong>引用自<a href="https://www.sczyh30.com/posts/Java/jvm-metaspace/">https://www.sczyh30.com/posts/Java/jvm-metaspace/</a></strong></p>
</li>
</ol>
</blockquote>
<p> <strong>为什么要使用元空间取代永久代的实现？</strong></p>
<blockquote>
<ol>
<li>字符串存在永久代中，容易出现性能问题和内存溢出。</li>
<li>类及方法的信息等比较难确定其大小，因此对于永久代的大小指定比较困难，太小容易出现永久代溢出，太大则容易导致老年代溢出。</li>
<li>永久代会为 GC 带来不必要的复杂度，并且回收效率偏低。</li>
<li>将 HotSpot 与 JRockit 合二为一。</li>
</ol>
</blockquote>
<p><strong>总结</strong></p>
<blockquote>
<ol>
<li>Perm Space (&lt;1.8)<br>字符串常量位于PermSpace<br>FGC不会清理<br>大小启动的时候指定，不能变</li>
<li>Meta Space (&gt;=1.8)<br>字符串常量位于堆<br>会触发FGC清理<br>不设定的话，最大就是物理内存</li>
</ol>
</blockquote>
<p><strong>运行时常量池</strong></p>
<p>运行时常量池（Runtime Constant Pool）是方法区的一部分。Class 文件中除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池（Constant Pool Table），用于存放编译期生成的各种字面量和符号引用，这部分内容将在类加载后进入方法区的运行时常量池中存放。</p>
<p>一般来说，除了保存 Class 文件中描述的符号引用外，还会把翻译出来的直接引用也存储在运行时常量池中。</p>
<p>运行时常量池相对于 Class 文件常量池的另外一个重要特征是具备动态性，Java 语言并不要求常量一定只有编译期才能产生，也就是并非预置入 Class 文件中常量池的内容才能进入方法区运行时常量池，运行期间也可能将新的常量放入池中，这种特性被开发人员利用得比较多的便是 String 类的 intern() 方法。</p>
<p>既然运行时常量池是方法区的一部分，自然受到方法区内存的限制，当常量池无法再申请到内存时会抛出 OutOfMemoryError 异常。</p>
<h4 id="直接内存"><a href="#直接内存" class="headerlink" title="直接内存"></a><strong>直接内存</strong></h4><p>直接内存（Direct Memory）并不是虚拟机运行时数据区的一部分，也不是 Java 虚拟机规范中定义的内存区域。</p>
<p>在 JDK 1.4 中新加入了 NIO，引入了一种基于通道（Channel）与缓冲区（Buffer）的 I/O 方式，它可以使用 Native 函数库直接分配堆外内存，然后通过一个存储在 Java 堆中的 DirectByteBuffer 对象作为这块内存的引用进行操作。这样能在一些场景中显著提高性能，因为避免了在 Java 堆和 Native 堆中来回复制数据。</p>
<p>显然，本机直接内存的分配不会受到 Java 堆大小的限制，但是，既然是内存，肯定还是会受到本机总内存（包括 RAM 以及 SWAP 区或者分页文件）大小以及处理器寻址空间的限制。服务器管理员在配置虚拟机参数时，会根据实际内存设置 -Xmx 等参数信息，但经常忽略直接内存，使得各个内存区域总和大于物理内存限制（包括物理的和操作系统级的限制），从而导致动态扩展时出现 OutOfMemoryError 异常。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h4><p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/java%E5%86%85%E5%AD%98%E5%85%B1%E4%BA%AB.png" alt="线程共享内存模型"></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis相关笔记</title>
    <url>/2020/12/10/mybatis%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h4 id="mybatis中inster一条数据后返回数据库自增的主键值"><a href="#mybatis中inster一条数据后返回数据库自增的主键值" class="headerlink" title="mybatis中inster一条数据后返回数据库自增的主键值"></a>mybatis中inster一条数据后返回数据库自增的主键值</h4><ul>
<li>相关sql的写法<ol>
<li> keyProperty=”tid” 对应的是实体映射</li>
<li> keyColumn=”typing_test_id” 对应的是表中的字段自增主键 id</li>
</ol>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">&lt;insert id=&quot;insterTypingTest&quot; parameterType=&quot;com.mwt.oes.dto.TypingTestDTO&quot; useGeneratedKeys=&quot;true&quot;                 keyProperty=&quot;tid&quot;  keyColumn=&quot;typing_test_id&quot;&gt;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> typing_test ( title, test_user_role, typing_content_id, start_time, end_time, <span class="keyword">duration</span>,                create_user,create_time, update_time )</span><br><span class="line"> <span class="keyword">VALUES</span></span><br><span class="line">       (<span class="comment">#&#123;typingTestDTO.title&#125;,#&#123;typingTestDTO.userRole&#125;,#&#123;typingTestDTO.typingContentId&#125;,#          &#123;typingTestDTO.startTime&#125;,#&#123;typingTestDTO.endTime&#125;,#&#123;typingTestDTO.duration&#125;,#   &#123;typingTestDTO.createUser&#125;,now(),now())</span></span><br><span class="line">&lt;/<span class="keyword">insert</span>&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>service层的调用写法</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insterTypingTest</span><span class="params">(TypingTestDTO typingTestDTO)</span> </span>&#123;</span><br><span class="line">     typingTestMapper.insterTypingTest(typingTestDTO); <span class="comment">//执行完inster语句之后mybatis会自动封装到你的参数对象中</span></span><br><span class="line">     System.out.println(typingTestDTO.getTid())</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>mybatis</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql存储过程分割字符串</title>
    <url>/2021/01/07/mysql%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%88%86%E5%89%B2%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    <content><![CDATA[<h4 id="mysql存储过程循环分割字符串示例："><a href="#mysql存储过程循环分割字符串示例：" class="headerlink" title="mysql存储过程循环分割字符串示例："></a>mysql存储过程循环分割字符串示例：</h4><p><strong>业务逻辑：</strong> 在sys_menu表中 inster添加菜单数据，在sys_roles_menus表中给菜单分配权限     </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建菜单的存储过程 并为菜单赋权限  默认权限admin roleId = 1   </span></span><br><span class="line"><span class="keyword">CREATE</span>  <span class="keyword">PROCEDURE</span> <span class="string">`kq`</span>(<span class="keyword">IN</span> roleId <span class="built_in">INT</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span> i <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">declare</span> j <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">-- 记录所有的inster 之后的自增主键id	</span></span><br><span class="line">  <span class="keyword">declare</span> k   <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">-- 定义用于分割字符串的变量	</span></span><br><span class="line">  <span class="keyword">declare</span> _next <span class="built_in">TEXT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">declare</span> _nextlen <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">declare</span> _value <span class="built_in">TEXT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`sys_menu`</span>(<span class="string">`pid`</span>, <span class="string">`sub_count`</span>, <span class="string">`type`</span>, <span class="string">`title`</span>, <span class="string">`name`</span>, <span class="string">`component`</span>, <span class="string">`menu_sort`</span>, <span class="string">`icon`</span>, <span class="string">`path`</span>, <span class="string">`i_frame`</span>, <span class="string">`cache`</span>, <span class="string">`hidden`</span>, <span class="string">`permission`</span>, <span class="string">`create_by`</span>, <span class="string">`update_by`</span>, <span class="string">`create_time`</span>, <span class="string">`update_time`</span>) <span class="keyword">VALUES</span> ( <span class="literal">NULL</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="string">&#x27;人员温度管理&#x27;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">999</span>, <span class="string">&#x27;anq&#x27;</span>, <span class="string">&#x27;kq&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="literal">NULL</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="keyword">now</span>(), <span class="literal">null</span>);</span><br><span class="line"><span class="comment">-- 拿到inster 之后的自增主键id  以下数据依赖它的id</span></span><br><span class="line"><span class="keyword">set</span> i = <span class="keyword">LAST_INSERT_ID</span>();</span><br><span class="line"><span class="comment">-- 记录每一条的主键id k 用于sys_roles_menus表的角色分配</span></span><br><span class="line"><span class="keyword">set</span> k = i; </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`sys_menu`</span>( <span class="string">`pid`</span>, <span class="string">`sub_count`</span>, <span class="string">`type`</span>, <span class="string">`title`</span>, <span class="string">`name`</span>, <span class="string">`component`</span>, <span class="string">`menu_sort`</span>, <span class="string">`icon`</span>, <span class="string">`path`</span>, <span class="string">`i_frame`</span>, <span class="string">`cache`</span>, <span class="string">`hidden`</span>, <span class="string">`permission`</span>, <span class="string">`create_by`</span>, <span class="string">`update_by`</span>, <span class="string">`create_time`</span>, <span class="string">`update_time`</span>) <span class="keyword">VALUES</span> (i, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;异常记录&#x27;</span>, <span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;kq/error/index&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;Steve-Jobs&#x27;</span>, <span class="string">&#x27;error&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;errorRecord:list&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="keyword">now</span>(), <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">set</span> k = <span class="keyword">CONCAT</span>(k , <span class="string">&#x27;,&#x27;</span> ,<span class="keyword">LAST_INSERT_ID</span>()); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`sys_menu`</span>( <span class="string">`pid`</span>, <span class="string">`sub_count`</span>, <span class="string">`type`</span>, <span class="string">`title`</span>, <span class="string">`name`</span>, <span class="string">`component`</span>, <span class="string">`menu_sort`</span>, <span class="string">`icon`</span>, <span class="string">`path`</span>, <span class="string">`i_frame`</span>, <span class="string">`cache`</span>, <span class="string">`hidden`</span>, <span class="string">`permission`</span>, <span class="string">`create_by`</span>, <span class="string">`update_by`</span>, <span class="string">`create_time`</span>, <span class="string">`update_time`</span>) <span class="keyword">VALUES</span> (i, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;测温异常 &#x27;</span>, <span class="string">&#x27;temperature&#x27;</span>, <span class="string">&#x27;kq/temperature/index&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;temperature&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;temperatureError:list&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="keyword">now</span>(), <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">set</span> k = <span class="keyword">CONCAT</span>(k , <span class="string">&#x27;,&#x27;</span> ,<span class="keyword">LAST_INSERT_ID</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`sys_menu`</span>( <span class="string">`pid`</span>, <span class="string">`sub_count`</span>, <span class="string">`type`</span>, <span class="string">`title`</span>, <span class="string">`name`</span>, <span class="string">`component`</span>, <span class="string">`menu_sort`</span>, <span class="string">`icon`</span>, <span class="string">`path`</span>, <span class="string">`i_frame`</span>, <span class="string">`cache`</span>, <span class="string">`hidden`</span>, <span class="string">`permission`</span>, <span class="string">`create_by`</span>, <span class="string">`update_by`</span>, <span class="string">`create_time`</span>, <span class="string">`update_time`</span>) <span class="keyword">VALUES</span> (i, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;出入记录&#x27;</span>, <span class="string">&#x27;inOut&#x27;</span>, <span class="string">&#x27;kq/inOut/index&#x27;</span>, <span class="number">3</span>, <span class="string">&#x27;link&#x27;</span>, <span class="string">&#x27;inOut&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;inOutRecord:list&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="keyword">now</span>(), <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">set</span> k = <span class="keyword">CONCAT</span>(k , <span class="string">&#x27;,&#x27;</span> ,<span class="keyword">LAST_INSERT_ID</span>()); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`sys_menu`</span>(<span class="string">`pid`</span>, <span class="string">`sub_count`</span>, <span class="string">`type`</span>, <span class="string">`title`</span>, <span class="string">`name`</span>, <span class="string">`component`</span>, <span class="string">`menu_sort`</span>, <span class="string">`icon`</span>, <span class="string">`path`</span>, <span class="string">`i_frame`</span>, <span class="string">`cache`</span>, <span class="string">`hidden`</span>, <span class="string">`permission`</span>, <span class="string">`create_by`</span>, <span class="string">`update_by`</span>, <span class="string">`create_time`</span>, <span class="string">`update_time`</span>) <span class="keyword">VALUES</span> (i, <span class="number">2</span>, <span class="number">1</span>, <span class="string">&#x27;考勤统计&#x27;</span>, <span class="string">&#x27;errorPerson&#x27;</span>, <span class="string">&#x27;kq/errorPerson/index&#x27;</span>, <span class="number">4</span>, <span class="string">&#x27;permission&#x27;</span>, <span class="string">&#x27;errorPerson&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;kqCount:list&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="keyword">now</span>(), <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">set</span> j = <span class="keyword">LAST_INSERT_ID</span>();</span><br><span class="line"><span class="keyword">set</span> k = <span class="keyword">CONCAT</span>(k , <span class="string">&#x27;,&#x27;</span> ,j);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`sys_menu`</span>(<span class="string">`pid`</span>, <span class="string">`sub_count`</span>, <span class="string">`type`</span>, <span class="string">`title`</span>, <span class="string">`name`</span>, <span class="string">`component`</span>, <span class="string">`menu_sort`</span>, <span class="string">`icon`</span>, <span class="string">`path`</span>, <span class="string">`i_frame`</span>, <span class="string">`cache`</span>, <span class="string">`hidden`</span>, <span class="string">`permission`</span>, <span class="string">`create_by`</span>, <span class="string">`update_by`</span>, <span class="string">`create_time`</span>, <span class="string">`update_time`</span>) <span class="keyword">VALUES</span> (j, <span class="number">0</span>, <span class="number">2</span>, <span class="string">&#x27;缺勤列表&#x27;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">999</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;notPerson:list&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="keyword">now</span>(), <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">set</span> k = <span class="keyword">CONCAT</span>(k , <span class="string">&#x27;,&#x27;</span> ,<span class="keyword">LAST_INSERT_ID</span>()); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`sys_menu`</span>(<span class="string">`pid`</span>, <span class="string">`sub_count`</span>, <span class="string">`type`</span>, <span class="string">`title`</span>, <span class="string">`name`</span>, <span class="string">`component`</span>, <span class="string">`menu_sort`</span>, <span class="string">`icon`</span>, <span class="string">`path`</span>, <span class="string">`i_frame`</span>, <span class="string">`cache`</span>, <span class="string">`hidden`</span>, <span class="string">`permission`</span>, <span class="string">`create_by`</span>, <span class="string">`update_by`</span>, <span class="string">`create_time`</span>, <span class="string">`update_time`</span>) <span class="keyword">VALUES</span> (j, <span class="number">0</span>, <span class="number">2</span>, <span class="string">&#x27;异常列表&#x27;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">999</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;errorPerson:list&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="keyword">now</span>(), <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">set</span> k = <span class="keyword">CONCAT</span>(k , <span class="string">&#x27;,&#x27;</span> ,<span class="keyword">LAST_INSERT_ID</span>()); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- k = &#x27;151,152,153,154,155,156,157&#x27;</span></span><br><span class="line"><span class="comment">-- 循环分割 k 字符串</span></span><br><span class="line">iterator:</span><br><span class="line">LOOP</span><br><span class="line">  IF LENGTH(TRIM(k)) = 0 OR k IS NULL THEN</span><br><span class="line">    LEAVE iterator;</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">SET</span> _next = SUBSTRING_INDEX(k,<span class="string">&#x27;,&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">SET</span> _nextlen = <span class="keyword">LENGTH</span>(_next);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">SET</span> _value = <span class="keyword">TRIM</span>(_next);</span><br><span class="line">	</span><br><span class="line"><span class="comment">-- 拿到分割好的字符串插入表中</span></span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`sys_roles_menus`</span>(<span class="string">`menu_id`</span>, <span class="string">`role_id`</span>) <span class="keyword">VALUES</span> (_value, roleId );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">SET</span> k = <span class="keyword">INSERT</span>(k,<span class="number">1</span>,_nextlen + <span class="number">1</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用存储过程插入菜单 传入你要分配的角色id   默认admin角色id 是1  </span></span><br><span class="line"><span class="keyword">call</span> kq(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除存储过程</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> kq;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>Demo</tag>
      </tags>
  </entry>
  <entry>
    <title>springBoot整合 jpa数据源+mybatis数据源</title>
    <url>/2021/03/18/springBoot%E6%95%B4%E5%90%88%20jpa%E6%95%B0%E6%8D%AE%E6%BA%90+mybatis%E6%95%B0%E6%8D%AE%E6%BA%90/</url>
    <content><![CDATA[<h3 id="yml配置"><a href="#yml配置" class="headerlink" title="yml配置"></a>yml配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">dynamic:</span></span><br><span class="line">      <span class="attr">primary:</span> <span class="string">toc</span> <span class="comment">#设置默认的数据源或者数据源组,默认值即为master</span></span><br><span class="line">      <span class="attr">strict:</span> <span class="literal">false</span> <span class="comment">#设置严格模式,默认false不启动. 启动后在未匹配到指定数据源时候回抛出异常,不启动会使用默认数据源.</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">admin:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">          <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">jdbc:mysql://xx.xx.xx.xx:3306/xx?autoReconnect=true&amp;serverTimezone=Asia/Shanghai&amp;characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">xx</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">xxxx</span></span><br><span class="line">          <span class="attr">dbcp2:</span></span><br><span class="line">            <span class="attr">min-idle:</span> <span class="number">5</span>             <span class="comment"># 数据库连接池的最小维持连接数</span></span><br><span class="line">            <span class="attr">initial-size:</span> <span class="number">5</span>         <span class="comment"># 初始化连接数</span></span><br><span class="line">            <span class="attr">max-total:</span> <span class="number">5</span>            <span class="comment"># 最大连接数</span></span><br><span class="line">            <span class="attr">max-wait-millis:</span> <span class="number">150</span>    <span class="comment"># 等待连接获取的最大超时时间</span></span><br><span class="line">          <span class="attr">druid:</span></span><br><span class="line">            <span class="comment"># 初始连接数</span></span><br><span class="line">            <span class="attr">initial-size:</span> <span class="number">5</span></span><br><span class="line">            <span class="comment"># 最小连接数</span></span><br><span class="line">            <span class="attr">min-idle:</span> <span class="number">10</span></span><br><span class="line">            <span class="comment"># 最大连接数</span></span><br><span class="line">            <span class="attr">max-active:</span> <span class="number">20</span></span><br><span class="line">            <span class="comment"># 获取连接超时时间</span></span><br><span class="line">            <span class="attr">max-wait:</span> <span class="number">5000</span></span><br><span class="line">            <span class="comment"># 连接有效性检测时间</span></span><br><span class="line">            <span class="attr">time-between-eviction-runs-millis:</span> <span class="number">60000</span></span><br><span class="line">            <span class="comment"># 连接在池中最小生存的时间</span></span><br><span class="line">            <span class="attr">min-evictable-idle-time-millis:</span> <span class="number">300000</span></span><br><span class="line">            <span class="comment"># 连接在池中最大生存的时间</span></span><br><span class="line">            <span class="attr">max-evictable-idle-time-millis:</span> <span class="number">900000</span></span><br><span class="line">            <span class="attr">test-while-idle:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">test-on-borrow:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">test-on-return:</span> <span class="literal">false</span></span><br><span class="line">            <span class="comment"># 检测连接是否有效</span></span><br><span class="line">            <span class="attr">validation-query:</span> <span class="string">select</span> <span class="number">1</span></span><br><span class="line">            <span class="comment"># 配置监控统计</span></span><br><span class="line">            <span class="attr">webStatFilter:</span></span><br><span class="line">              <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">stat-view-servlet:</span></span><br><span class="line">              <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">              <span class="attr">url-pattern:</span> <span class="string">/druid/*</span></span><br><span class="line">              <span class="attr">reset-enable:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">filter:</span></span><br><span class="line">              <span class="attr">stat:</span></span><br><span class="line">                <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">                <span class="comment"># 记录慢SQL</span></span><br><span class="line">                <span class="attr">log-slow-sql:</span> <span class="literal">true</span></span><br><span class="line">                <span class="attr">slow-sql-millis:</span> <span class="number">1000</span></span><br><span class="line">                <span class="attr">merge-sql:</span> <span class="literal">true</span></span><br><span class="line">              <span class="attr">wall:</span></span><br><span class="line">                <span class="attr">config:</span></span><br><span class="line">                  <span class="attr">multi-statement-allow:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">toc:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">          <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">jdbc:mysql://xx.xx.xx.xx:3306/xx?autoReconnect=true&amp;serverTimezone=Asia/Shanghai&amp;characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">xx</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">xx</span></span><br><span class="line">          <span class="attr">dbcp2:</span></span><br><span class="line">            <span class="attr">min-idle:</span> <span class="number">5</span>             <span class="comment"># 数据库连接池的最小维持连接数</span></span><br><span class="line">            <span class="attr">initial-size:</span> <span class="number">5</span>         <span class="comment"># 初始化连接数</span></span><br><span class="line">            <span class="attr">max-total:</span> <span class="number">5</span>            <span class="comment"># 最大连接数</span></span><br><span class="line">            <span class="attr">max-wait-millis:</span> <span class="number">150</span>    <span class="comment"># 等待连接获取的最大超时时间</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>springBoot</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>spring校验注解</title>
    <url>/2021/03/16/spring%E6%A0%A1%E9%AA%8C%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<h3 id="NotNull-NotBlank和-NotEmpty的区别"><a href="#NotNull-NotBlank和-NotEmpty的区别" class="headerlink" title="@NotNull,@NotBlank和 @NotEmpty的区别"></a>@NotNull,@NotBlank和 @NotEmpty的区别</h3><ul>
<li>@NotEmpty 用在集合上面(不能注释枚举) 对象不能是 null 并且相关对象的 size 大于 0。</li>
<li>@NotBlank用在String上面  String 不能是 null 且去除两端空白字符后的长度(trimmed length)大于 0。</li>
<li>@NotNull用在所有类型上面  对象不能是 null, 但可以是空集(size = 0)。</li>
</ul>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>spring</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>spring的注解</title>
    <url>/2021/03/16/spring%E7%9A%84%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<h3 id="NotNull-NotBlank和-NotEmpty的区别"><a href="#NotNull-NotBlank和-NotEmpty的区别" class="headerlink" title="@NotNull,@NotBlank和 @NotEmpty的区别"></a>@NotNull,@NotBlank和 @NotEmpty的区别</h3><ul>
<li>@NotEmpty 用在集合上面(不能注释枚举) 对象不能是 null 并且相关对象的 size 大于 0。</li>
<li>@NotBlank用在String上面  String 不能是 null 且去除两端空白字符后的长度(trimmed length)大于 0。</li>
<li>@NotNull用在所有类型上面  对象不能是 null, 但可以是空集(size = 0)。</li>
</ul>
<h3 id="springMvc-使用LocalDate接收页面请求过来的参数时需要的注解"><a href="#springMvc-使用LocalDate接收页面请求过来的参数时需要的注解" class="headerlink" title="springMvc 使用LocalDate接收页面请求过来的参数时需要的注解"></a>springMvc 使用LocalDate接收页面请求过来的参数时需要的注解</h3><ul>
<li>  @DateTimeFormat(pattern = “yyyy-MM-dd”)</li>
</ul>
<h3 id="Valid与-Validated校验的区别"><a href="#Valid与-Validated校验的区别" class="headerlink" title="@Valid与@Validated校验的区别"></a>@Valid与@Validated校验的区别</h3><ul>
<li><strong>@Valid注解用于校验，所属包为：javax.validation.Valid。</strong><br>首先需要在实体类的相应字段上添加用于充当校验条件的注解，如：@Min,如下代码（age属于Girl类中的属性）：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Min(value = 18,message = &quot;未成年禁止入内&quot;)</span>  </span><br><span class="line"><span class="keyword">private</span> Integer age;</span><br></pre></td></tr></table></figure>

<p>其次在controller层的方法的要校验的参数上添加@Valid注解，并且需要传入BindingResult对象，用于获取校验失败情况下的反馈信息，如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/girls&quot;)</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> Girl <span class="title">addGirl</span><span class="params">(<span class="meta">@Valid</span> Girl girl, BindingResult bindingResult)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span>(bindingResult.hasErrors())&#123;    					                 	           System.out.println(bindingResult.getFieldError().getDefaultMessage()); </span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">  &#125;  </span><br><span class="line">    <span class="keyword">return</span> girlResposity.save(girl);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注: 通常不在这里处理异常, 由统一的exceptioin全局异常处理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = MethodArgumentNotValidException.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonResult <span class="title">violationException</span><span class="params">(MethodArgumentNotValidException exception)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不带任何参数访问接口,会抛出 BindException</span></span><br><span class="line">        <span class="comment">// 因此，我们只需捕获这个异常，并返回我们设置的 message 即可</span></span><br><span class="line">        String message = exception.getBindingResult().getAllErrors().get(<span class="number">0</span>).getDefaultMessage();</span><br><span class="line">        <span class="keyword">return</span> JsonResult.fail(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>@Validated是@Valid 的一次封装，是Spring提供的校验机制使用。</strong></p>
</li>
<li><p><strong>两者的区别</strong></p>
<p>在检验Controller的入参是否符合规范时，使用@Validated或者@Valid在基本验证功能上没有太多区别。但是在<strong>分组</strong>、<strong>注解地方</strong>、<strong>嵌套验证</strong>等功能上两个有所不同：</p>
<h4 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h4><p>@Valid 作为标准JSR-303规范，还没有吸收分组的功能。</p>
<p>@Validated Spring’s JSR-303规范，是标准JSR-303的一个变种, 提供了一个分组功能，可以在入参验证时，根据不同的分组采用不同的验证机制。</p>
<h4 id="注解地方"><a href="#注解地方" class="headerlink" title="注解地方"></a>注解地方</h4><p>@Valid：可以用在方法、构造函数、方法参数和成员属性（字段）上</p>
<p>@Validated：可以用在类型、方法和方法参数上。但是不能用在成员属性（字段）上</p>
<p>两者是否能用于成员属性（字段）上直接影响能否提供嵌套验证的功能。</p>
<h4 id="嵌套验证"><a href="#嵌套验证" class="headerlink" title="嵌套验证"></a>嵌套验证</h4><p>在比较两者嵌套验证时，先说明下什么叫做嵌套验证。比如我们现在有个实体叫做Item：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;id不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@Min(value = 1, message = &quot;id必须为正整数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;props不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 1, message = &quot;至少要有一个属性&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Prop&gt; props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Item带有很多属性，属性里面有属性id，属性值id，属性名和属性值，如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Prop</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;pid不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@Min(value = 1, message = &quot;pid必须为正整数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;vid不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@Min(value = 1, message = &quot;vid必须为正整数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long vid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;pidName不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String pidName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;vidName不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String vidName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>属性这个实体也有自己的验证机制，比如属性和属性值id不能为空，属性名和属性值不能为空等。</p>
<p>现在我们有个ItemController接受一个Item的入参，想要对Item进行验证，如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/item/add&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addItem</span><span class="params">(<span class="meta">@Validated</span> Item item, BindingResult bindingResult)</span> </span>&#123;</span><br><span class="line">        doSomething();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>在上图中，如果Item实体的props属性不额外加注释，只有@NotNull和@Size，无论入参采用@Validated还是@Valid验证，Spring Validation框架只会对Item的id和props做非空和数量验证，不会对props字段里的Prop实体进行字段验证，也就是**@Validated<strong>和</strong>@Valid**加在方法参数前，都不会自动对参数进行嵌套验证。也就是说如果传的List中有Prop的pid为空或者是负数，入参验证不会检测出来。</p>
<p>为了能够进行嵌套验证，必须手动在Item实体的props字段上明确指出这个字段里面的实体也要进行验证。由于@Validated不能用在成员属性（字段）上，但是@Valid能加在成员属性（字段）上，而且@Valid类注解上也说明了它支持嵌套验证功能，那么我们能够推断出：@Valid加在方法参数时并不能够自动进行嵌套验证，而是用在需要嵌套验证类的相应字段上，来配合方法参数上@Validated或@Valid来进行嵌套验证。</p>
<p>我们修改Item类如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;id不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@Min(value = 1, message = &quot;id必须为正整数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Valid</span> <span class="comment">// 嵌套验证必须用@Valid</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;props不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 1, message = &quot;props至少要有一个自定义属性&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Prop&gt; props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后我们在ItemController的addItem函数上再使用@Validated或者@Valid，就能对Item的入参进行嵌套验证。此时Item里面的props如果含有Prop的相应字段为空的情况，Spring Validation框架就会检测出来，bindingResult就会记录相应的错误。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>@Validated：用在方法入参上无法单独提供嵌套验证功能。<strong>不能用在成员属性（字段）上</strong>，也无法提示框架进行嵌套验证。能配合嵌套验证注解@Valid进行嵌套验证。</p>
<p>@Valid：用在方法入参上无法单独提供嵌套验证功能。<strong>能够用在成员属性（字段）上</strong>，提示验证框架进行嵌套验证。能配合嵌套验证注解@Valid进行嵌套验证。</p>
<p>注：</p>
<p>在MVC中如果使用@Validated的同时，<strong>不使用@RequestBody的情况下</strong>，需要对实体类进行验证时，全局异常处理<strong>不会抛出MethodArgumentNotValidException异常</strong>，而是<strong>抛出BindException异常</strong>，需增加全局异常捕获方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@ExceptionHandler(value = BindException.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonResult <span class="title">violationException</span><span class="params">(BindException exception)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 不带任何参数访问接口,会抛出 BindException</span></span><br><span class="line">    <span class="comment">// 因此，我们只需捕获这个异常，并返回我们设置的 message 即可</span></span><br><span class="line">    String message = exception.getBindingResult().getAllErrors().get(<span class="number">0</span>).getDefaultMessage();</span><br><span class="line">    <span class="keyword">return</span> JsonResult.fail(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>spring</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>synchronized</title>
    <url>/2021/05/24/synchronized/</url>
    <content><![CDATA[<h1 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h1><ul>
<li><p><strong>jdk早期的synchronized为什么是重量级的</strong></p>
<p>因为我们的jvm是运行在操作系统上的，即用户态，而我们的操作系统是运行在内核态的，用户态中的程序是不能直接调用系统指令的，所以synchronized必须经过老大操作系统,所以synchronized是重量级锁</p>
</li>
<li><p><strong>synchronized的升级过程</strong></p>
</li>
</ul>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/juc/synchronized%E5%8D%87%E7%BA%A7%E8%BF%87%E7%A8%8B.png" alt="锁升级"></p>
<ul>
<li><p><strong>偏向锁：</strong></p>
<p>引入偏向锁是为了在<code>无多线程</code>竞争的情况下尽量减少不必要的轻量级锁执行路径，因为轻量级锁的获取及释放依赖多次CAS原子指令，而偏向锁只需要在置换ThreadID的时候依赖一次CAS原子指令（由于一旦出现多线程竞争的情况就必须撤销偏向锁，所以偏向锁的撤销操作的性能损耗必须小于节省下来的CAS原子指令的性能消耗）。上面说过，轻量级锁是为了在线程交替执行同步块时提高性能，而偏向锁则是在只有一个线程执行同步块时进一步提高性能。</p>
</li>
<li><p><strong>偏向锁的获取：</strong></p>
<p>（1）访问Mark Word中偏向锁的标识是否设置成1，锁标志位是否为01——确认为可偏向状态。</p>
<p>（2）当第一次第一个线程来的时候将Mark Word中线程ID设置为当前线程ID</p>
</li>
<li><p><strong>偏向锁的释放</strong></p>
<p>偏向锁只有遇到其他线程尝试竞争偏向锁时，持有偏向锁的线程才会释放锁，线程不会主动去释放偏向锁。偏向锁的撤销，需要等待全局安全点（在这个时间点上没有字节码正在执行），它会首先暂停拥有偏向锁的线程，判断锁对象是否处于被锁定状态，撤销偏向锁后恢复到未锁定（标志位为“01”）或轻量级锁（标志位为“00”）的状态。</p>
</li>
<li><p><strong>偏向锁的使用</strong></p>
<p>偏向锁 - markword 上记录当前线程指针，下次同一个线程加锁的时候，不需要争用, 只需要判断线程指针是否同一个，所以，偏向              锁, 偏向加锁的第一个线程 。hashCode备份在线程栈上 线程销毁，锁降级为无锁</p>
<p> 有争用 - 锁升级为轻量级锁 - 每个线程有自己的LockRecord在自己的线程栈上，用CAS去争用markword的LR的指针，指针指向哪个线程的LR，哪个线程就拥有锁</p>
</li>
<li><p><strong>匿名偏向锁</strong></p>
<p>默认情况 偏向锁有个时延，默认是4秒</p>
<p>打开偏向锁刚 new 出来的对象就是匿名偏向锁</p>
</li>
</ul>
<ul>
<li><p><strong>注：</strong></p>
<p>  在 JDK 15 中，默认情况下禁用偏向锁（Biased Locking），并弃用所有相关的命令行选项。</p>
</li>
<li><p><strong>自旋锁</strong></p>
<p>自旋锁在 JDK1.4.2 中引入，使用 -XX:+UseSpinning 来开启。JDK 6 中变为默认开启，并且引入了自适应的自旋锁（适应性自旋锁）。</p>
<p>自适应自旋锁意味着自旋的时间（次数）不再固定，而是由前一次在同一个锁上的自旋时间及锁的拥有者的状态来决定。如果在同一个锁对象上，自旋等待刚刚成功获得过锁，并且持有锁的线程正在运行中，那么虚拟机就会认为这次自旋也是很有可能再次成功，进而它将允许自旋等待持续相对更长的时间。如果对于某个锁，自旋很少成功获得过，那在以后尝试获取这个锁时将可能省略掉自旋过程，直接阻塞线程，避免浪费处理器资源。</p>
</li>
<li><p><strong>什么情况下升级为重量级锁</strong></p>
<p>锁的时间长，或者自旋线程多</p>
</li>
<li><p><strong>new –&gt; 偏向锁 –&gt; 轻量级锁 （无锁, 自旋锁，自适应自旋）–&gt; 重量级锁</strong></p>
<ol>
<li><p>Object o = new Object()<br>锁 = 0 01 无锁态<br>注意：如果偏向锁打开，默认是匿名偏向状态,不偏向任何线程</p>
</li>
<li><p>o.hashCode()<br>001 + hashcode</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">00000001</span> <span class="number">10101101</span> <span class="number">00110100</span> <span class="number">00110110</span></span><br><span class="line"><span class="number">01011001</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br></pre></td></tr></table></figure>

<p>little endian big endian </p>
<p>00000000 00000000 00000000 01011001 00110110 00110100 10101101 00000000</p>
</li>
<li><p>默认synchronized(o)<br>00 -&gt; 轻量级锁<br>默认情况 偏向锁有个时延，默认是4秒<br>why? 因为JVM虚拟机自己有一些默认启动的线程，里面有好多sync代码，这些sync代码启动时就知道肯定会有竞争，如果使用偏向锁，就会造成偏向锁不断的进行锁撤销和锁升级的操作，效率较低。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-XX:BiasedLockingStartupDelay=0</span><br></pre></td></tr></table></figure></li>
<li><p>如果设定上述参数<br>new Object () - &gt; 101 偏向锁 -&gt;线程ID为0 -&gt; Anonymous BiasedLock<br>打开偏向锁，new出来的对象，默认就是一个可偏向匿名对象101</p>
</li>
<li><p>如果有线程上锁<br>上偏向锁，指的就是，把markword的线程ID改为自己线程ID的过程<br>偏向锁不可重偏向 批量偏向 批量撤销</p>
</li>
<li><p>如果有线程竞争<br>撤销偏向锁，升级轻量级锁<br>线程在自己的线程栈生成LockRecord ，用CAS操作将markword设置为指向自己这个线程的LR的指针，设置成功者得到锁</p>
</li>
<li><p>如果竞争加剧<br>竞争加剧：有线程超过10次自旋， -XX:PreBlockSpin， 或者自旋线程数超过CPU核数的一半， 1.6之后，加入自适应自旋 Adapative Self Spinning ， JVM自己控制<br>升级重量级锁：-&gt; 向操作系统申请资源，linux mutex , CPU从3级-0级系统调用，线程挂起，进入等待队列，等待操作系统的调度，然后再映射回用户空间</p>
</li>
</ol>
<p>(以上实验环境是JDK11，打开就是偏向锁，而JDK8默认对象头是无锁)</p>
<p>偏向锁默认是打开的，但是有一个时延，如果要观察到偏向锁，应该设定参数</p>
<p><strong>如果计算过对象的hashCode，则对象无法进入偏向状态！</strong></p>
<blockquote>
<p>轻量级锁重量级锁的hashCode存在与什么地方？</p>
<p>答案：线程栈中，轻量级锁的LR中，或是代表重量级锁的ObjectMonitor的成员中</p>
</blockquote>
<p><strong>为什么有自旋锁还需要重量级锁？</strong></p>
<blockquote>
<p>自旋是消耗CPU资源的，如果锁的时间长，或者自旋线程多，CPU会被大量消耗</p>
<p>重量级锁有等待队列，所有拿不到锁的进入等待队列，不需要消耗CPU资源</p>
</blockquote>
<p><strong>偏向锁是否一定比自旋锁效率高？</strong></p>
<blockquote>
<p>不一定，在明确知道会有多线程竞争的情况下，偏向锁肯定会涉及锁撤销，这时候直接使用自旋锁</p>
<p>JVM启动过程，会有很多线程竞争（明确），所以默认情况启动时不打开偏向锁，过一段儿时间再打开</p>
</blockquote>
</li>
<li><p><strong>锁重入</strong></p>
<p>sychronized是可重入锁</p>
<p>重入次数必须记录，因为要解锁几次必须得对应</p>
<p>偏向锁 自旋锁 -&gt; 线程栈 -&gt; LR + 1</p>
</li>
<li><p> <strong>锁消除 lock eliminate</strong></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String str1,String str2)</span></span>&#123;</span><br><span class="line">         StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">         sb.append(str1).append(str2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们都知道 StringBuffer 是线程安全的，因为它的关键方法都是被 synchronized 修饰过的，但我们看上面这段代码，我们会发现，sb 这个引用只会在 add 方法中使用，不可能被其它线程引用（因为是局部变量，栈私有），因此 sb 是不可能共享的资源，JVM 会自动消除 StringBuffer 对象内部的锁。</p>
<ul>
<li><strong>锁粗化 lock coarsening</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">       StringBuffer sb = <span class="keyword">new</span> StringBuffer():</span><br><span class="line">       <span class="keyword">while</span>(i &lt; <span class="number">100</span>)&#123;</span><br><span class="line">           sb.append(str);</span><br><span class="line">           i++;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> sb.toString():</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JVM 会检测到这样一连串的操作都对同一个对象加锁（while 循环内 100 次执行 append，没有锁粗化的就要进行 100  次加锁/解锁），此时 JVM 就会将加锁的范围粗化到这一连串的操作的外部（比如 while 虚幻体外），使得这一连串操作只需要加一次锁即可。</p>
<ul>
<li><strong>锁降级</strong></li>
</ul>
<p><a href="https://www.zhihu.com/question/63859501">https://www.zhihu.com/question/63859501</a></p>
<ul>
<li><strong>超线程</strong></li>
</ul>
<p>一个ALU + 两组Registers + PC</p>
<p>参考：<br><a href="https://cloud.tencent.com/developer/article/1480590">https://cloud.tencent.com/developer/article/1480590</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1480590">https://cloud.tencent.com/developer/article/1480590</a><br> <a href="https://cloud.tencent.com/developer/article/1484167">https://cloud.tencent.com/developer/article/1484167</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1485795">https://cloud.tencent.com/developer/article/1485795</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1482500">https://cloud.tencent.com/developer/article/1482500</a></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>tcpip协议</title>
    <url>/2021/03/21/tcpip%E5%8D%8F%E8%AE%AE/</url>
    <content><![CDATA[<h3 id="Tcp-ip协议"><a href="#Tcp-ip协议" class="headerlink" title="Tcp/ip协议"></a>Tcp/ip协议</h3><p>   <strong>TCP/IP传输协议，即传输控制/网络协议，也叫作网络通讯协议</strong></p>
<ul>
<li><p><strong>三次握手</strong><br><strong>为了对每次发送的数据量进行跟踪与协商，确保数据段的发送和接收同步，根据所接收到的数据量而确认数据发送、接收完毕后何时撤消联系，并建立虚连接。<br>为了提供可靠的传送，TCP在发送新的数据之前，以特定的顺序将数据包的序号，并需要这些包传送给目标机之后的确认消息。TCP总是用来发送大批量的数据。当应用程序在收到数据后要做出确认时也要用到TCP</strong><br><strong>第一次握手：</strong> 建立连接时，客户端发送syn包（seq=j）到服务器，并进入SYN_SENT状态，等待服务器确认；SYN：同步序列编号（Synchronize Sequence Numbers）。<br><strong>第二次握手：</strong>　服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（seq=k），即SYN+ACK包，此时服务器进入SYN_RECV状态。<br><strong>第三次握手：</strong> 客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入ESTABLISHED（TCP连接成功）状态，完成三次握手。</p>
</li>
<li><p><strong>为什么需要三次握手，两次不行吗</strong><br>1.通过以上我们知道，<br>  客户端——-syn(seq=j)——-&gt;服务器 <strong>此时服务器知道客户端的发送功能是正常的</strong><br>  客户端&lt;——-syn+ack———-服务器 <strong>此时客户端知道服务器的接收和发送的功能是正常的</strong></p>
<p><strong>以上的两次握手并不能满足Tcp/ip协议的可靠性，因为服务器只知道客户端的发送功能是正常的，并不知道客户端的接收功能是否正常，所以此时就需要第三次的握手来让服务器知道客户端的接收功能是否正常</strong></p>
</li>
<li><p><strong>四次挥手</strong><br><strong>对于一个已经建立的连接，TCP使用改进的四次握手来释放连接（使用一个带有FIN附加标记的报文段）。TCP关闭连接的步骤如下：</strong></p>
<p><strong>第一步:</strong> 当主机A的应用程序通知TCP数据已经发送完毕时，TCP向主机B发送一个带有FIN附加标记的报文段（FIN表示英文finish)<br><strong>第二步:</strong> 主机B收到这个FIN报文段之后，并不立即用FIN报文段回复主机A，而是先向主机A发送一个确认序号ACK，同时通知自己相应的应用程序：对方要求关闭连接（先发送ACK的目的是为了防止在这段时间内，对方重传FIN报文段）<br><strong>第三步</strong> 主机B的应用程序告诉TCP：我要彻底的关闭连接，TCP向主机A送一个FIN报文段。<br><strong>第四步</strong> 主机A收到这个FIN报文段后，向主机B发送一个ACK表示连接彻底释放。 </p>
</li>
<li><p><strong>为什么需要四次挥手</strong><br>因为当服务端收到客户端的SYN连接请求报文后，可以直接发送SYN+ACK报文。其中ACK报文是用来应答的，SYN报文是用来同步的。但是关闭连接时，当服务端收到FIN报文时，很可能并不会立即关闭SOCKET，所以只能先回复一个ACK报文，告诉客户端，“你发的FIN报文我收到了”。只有等到我服务端所有的报文都发送完了，我才能发送FIN报文，因此不能一起发送。故需要四次挥手</p>
</li>
</ul>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
      </tags>
  </entry>
  <entry>
    <title>volatile</title>
    <url>/2021/05/24/volatile/</url>
    <content><![CDATA[<h2 id="volatile的用途"><a href="#volatile的用途" class="headerlink" title="volatile的用途"></a>volatile的用途</h2><h3 id="问题：-DCL单例需不需要加volatile？"><a href="#问题：-DCL单例需不需要加volatile？" class="headerlink" title="问题： DCL单例需不需要加volatile？"></a>问题： DCL单例需不需要加volatile？</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Instance</span> </span>&#123;</span><br><span class="line">    <span class="comment">//此处加volatile 和 不加的区别</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Instance ins = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Instance <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ins == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Instance.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ins == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ins = <span class="keyword">new</span> Instance();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ins;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-防止指令重排序"><a href="#1-防止指令重排序" class="headerlink" title="1.防止指令重排序"></a>1.防止指令重排序</h3><ul>
<li>证明指令重排序存在</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> x = <span class="number">0</span>, y = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> a = <span class="number">0</span>, b = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">        x = <span class="number">0</span>;</span><br><span class="line">        y = <span class="number">0</span>;</span><br><span class="line">        a = <span class="number">0</span>;</span><br><span class="line">        b = <span class="number">0</span>;</span><br><span class="line">        Thread one = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            a = <span class="number">1</span>;</span><br><span class="line">            x = b;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread other = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            b = <span class="number">1</span>;</span><br><span class="line">            y = a;</span><br><span class="line">        &#125;);</span><br><span class="line">        one.start();</span><br><span class="line">        other.start();</span><br><span class="line">        one.join();</span><br><span class="line">        other.join();</span><br><span class="line">        String result = <span class="string">&quot;第&quot;</span> + i + <span class="string">&quot;次 (&quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;）&quot;</span>;</span><br><span class="line">        <span class="comment">// 出现00组合 证明cpu乱序执行了</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">0</span> &amp;&amp; y == <span class="number">0</span>) &#123;</span><br><span class="line">            System.err.println(result);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//  System.out.println(result);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>不存乱序的情况下应该输出的值</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">x = <span class="number">1</span>;</span><br><span class="line">y = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">x = <span class="number">0</span>;</span><br><span class="line">y = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">x = <span class="number">1</span>;</span><br><span class="line">y = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>存在乱序的情况下出现的值</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">第<span class="number">461233</span>次 (<span class="number">0</span>,<span class="number">0</span>）</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>对象创建的过程</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//https://blog.csdn.net/u010737756/article/details/104843152</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        C o = <span class="keyword">new</span> C();</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(o).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.使用 idea 的插件jclasslib  Bytecode Viewer 即可查看对象实例化过程的字节码</p>
<p><code>new C();</code>实列化过程 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">0 new #2 &lt;com/yzw/juc/markWord/C&gt;</span><br><span class="line"><span class="number">3</span> dup</span><br><span class="line">4 invokespecial #3 &lt;com/yzw/juc/markWord/C.&lt;init&gt;&gt;</span><br><span class="line"><span class="number">7</span> astore_1</span><br><span class="line"><span class="number">8</span> <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p><code>new C();</code>字节码解释</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span> <span class="keyword">new</span>                         创建一个对象，并且其引用进栈</span><br><span class="line"><span class="number">3</span> dup                         复制栈顶数值，并且复制值进栈</span><br><span class="line"><span class="number">4</span> invokespecial               调用超类构造方法、实例初始化方法、私有方法</span><br><span class="line"><span class="number">7</span> astore_1                    将栈顶数值（objectref）存入当前</span><br><span class="line"><span class="number">8</span> <span class="keyword">return</span>                      从当前方法返回<span class="keyword">void</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<ul>
<li><strong>字节码</strong></li>
</ul>
<p>0.new -&gt;申请内存。堆里有了一个新的内存。（<strong>半初始化。成员变量设置默认值</strong>）</p>
<pre class="mermaid">graph LR
A(c)    
B[i = 0]</pre>



<p>3 dup 因为invokespecial会消耗一份，所以必须先复制一份<br>4 invokespecial T initlize 初始化，<strong>调用他的构造方法</strong></p>
<pre class="mermaid">graph LR
A(c)  
B[i = 8]</pre>

<p>7 astore_1 <strong>把c与i建立关联</strong></p>
<pre class="mermaid">graph LR
A(c)  --> B[i = 8]</pre>

<p>8 return                      从当前方法返回void</p>
<ul>
<li>结论</li>
</ul>
<p>由上述步骤可以看出：<code>在多线程的环境下，假设线程1拿到锁Instance.class，线程1执行锁中的代码时有可能会发生  c与i先建立联系 ， 然后给i赋值，此时线程2如果出现进入第一个判断ins！= null,此时的线程2就会直接 return ins，所以这里就会出现问题</code></p>
<h3 id="2-保证线程的可见性"><a href="#2-保证线程的可见性" class="headerlink" title="2.保证线程的可见性"></a>2.<strong>保证线程的可见性</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//证明线程的可见性</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*volatile*/</span> <span class="keyword">boolean</span> running = <span class="keyword">true</span>; <span class="comment">//对比一下有无volatile的情况下，整个程序运行结果的区别</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">m</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;m start&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (running) &#123;</span><br><span class="line">            <span class="comment">//System.out.println(&quot;runing.....&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;m end!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        V v = <span class="keyword">new</span> V();</span><br><span class="line">        <span class="keyword">new</span> Thread(v::m, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        v.running = <span class="keyword">false</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;min stop&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-cpu为什么会出现乱序执行"><a href="#3-cpu为什么会出现乱序执行" class="headerlink" title="3.cpu为什么会出现乱序执行"></a>3.cpu为什么会出现乱序执行</h3><p>CPU缓存的出现主要是为了解决CPU运算速度与内存读写速度不匹配的矛盾，因为CPU运算速度要比内存读写速度快得多，举个例子：</p>
<ul>
<li>一次主内存的访问通常在几十到几百个时钟周期</li>
<li>一次L1高速缓存的读写只需要1~2个时钟周期</li>
<li>一次L2高速缓存的读写也只需要数十个时钟周期</li>
</ul>
<p>这种访问速度的显著差异，导致CPU可能会花费很长时间等待数据到来或把数据写入内存。</p>
<p>基于此，现在CPU大多数情况下读写都不会直接访问内存（CPU都没有连接到内存的管脚），取而代之的是CPU缓存，CPU缓存是位于CPU与内存之间的临时存储器，它的容量比内存小得多但是交换速度却比内存快得多。而缓存中的数据是内存中的一小部分数据，但这一小部分是短时间内CPU即将访问的，当CPU调用大量数据时，就可先从缓存中读取，从而加快读取速度。</p>
<p>按照读取顺序与CPU结合的紧密程度，CPU缓存可分为：</p>
<ul>
<li>一级缓存：简称L1 Cache，位于CPU内核的旁边，是与CPU结合最为紧密的CPU缓存</li>
<li>二级缓存：简称L2 Cache，分内部和外部两种芯片，内部芯片二级缓存运行速度与主频相同，外部芯片二级缓存运行速度则只有主频的一半</li>
<li>三级缓存：简称L3 Cache，部分高端CPU才有</li>
</ul>
<p>每一级缓存中所存储的数据全部都是下一级缓存中的一部分，这三种缓存的技术难度和制造成本是相对递减的，所以其容量也相对递增。</p>
<p>当CPU要读取一个数据时，首先从一级缓存中查找，如果没有再从二级缓存中查找，如果还是没有再从三级缓存中或内存中查找。一般来说每级缓存的命中率大概都有80%左右，也就是说全部数据量的80%都可以在一级缓存中找到，只剩下20%的总数据量才需要从二级缓存、三级缓存或内存中读取。</p>
<p><strong>缓存一致性协议</strong><br>为了解决这个问题，在早期的CPU当中，是通过在总线上直接加锁的形式来解决缓存不一致的问题。</p>
<p>但是正如Java中Synchronized一样，直接加锁太粗暴了，由于在锁住总线期间，其他CPU无法访问内存，导致效率低下。很明显这样做是不可取的。</p>
<p>所以就出现了缓存一致性协议。缓存一致性协议有MSI，MESI，MOSI，Synapse，Firefly及DragonProtocol等等。</p>
<p><strong>MESI协议</strong><br>最出名的就是Intel 的MESI协议，MESI协议保证了每个缓存中使用的共享变量的副本是一致的。</p>
<p>Modify（修改）：当缓存行中的数据被修改时，该缓存行置为M状态<br>Exclusive（独占）：当只有一个缓存行使用某个数据时，置为E状态<br>Shared（共享）：当其他CPU中也读取某数据到缓存行时，所有持有该数据的缓存行置为S状态<br>Invalid（无效）：当某个缓存行数据修改时，其他持有该数据的缓存行置为I状态<br>它核心的思想是：当CPU写数据时，如果发现操作的变量是共享变量，即在其他CPU中也存在该变量的副本，会发出信号通知其他CPU将该变量的缓存行置为无效状态，因此当其他CPU需要读取这个变量时，发现自己缓存中缓存该变量的缓存行是无效的，那么它就会从内存重新读取。</p>
<p>而这其中，监听和通知又基于总线嗅探机制来完成。</p>
<h3 id="4-volatile-是如何保证线程之间的可见性的"><a href="#4-volatile-是如何保证线程之间的可见性的" class="headerlink" title="4. volatile 是如何保证线程之间的可见性的"></a><strong>4. volatile 是如何保证线程之间的可见性的</strong></h3><p><strong>总线嗅探机制</strong><br>嗅探机制其实就是一个监听器，回到我们刚才的流程，如果是加入MESI缓存一致性协议和总线嗅探机制之后：</p>
<p>CPU1读取数据a=1，CPU1的缓存中都有数据a的副本，该缓存行置为（E）状态<br>CPU2也执行读取操作，同样CPU2也有数据a=1的副本，此时总线嗅探到CPU1也有该数据，则CPU1、CPU2两个缓存行都置为（S）状态<br>CPU1修改数据a=2，CPU1的缓存以及主内存a=2，同时CPU1的缓存行置为（S）状态，总线发出通知，CPU2的缓存行置为（I）状态<br>CPU2再次读取a，虽然CPU2在缓存中命中数据a=1，但是发现状态为（I），因此直接丢弃该数据，去主内存获取最新数据<br>当我们使用volatile关键字修饰某个变量之后，就相当于告诉CPU：我这个变量需要使用MESI和总线嗅探机制处理。从而也就保证了可见性。</p>
<h3 id="5-volatile是如何禁止指令重排序的"><a href="#5-volatile是如何禁止指令重排序的" class="headerlink" title="5.volatile是如何禁止指令重排序的"></a><strong>5.volatile是如何禁止指令重排序的</strong></h3><ol>
<li><p>字节码层面<br>ACC_VOLATILE</p>
</li>
<li><p>JVM层面<br>volatile内存区的读写 都加屏障</p>
<blockquote>
<p>StoreStoreBarrier</p>
<p>volatile 写操作</p>
<p>StoreLoadBarrier</p>
</blockquote>
<blockquote>
<p>LoadLoadBarrier</p>
<p>volatile 读操作</p>
<p>LoadStoreBarrier</p>
</blockquote>
</li>
<li><p>OS和硬件层面<br><a href="https://blog.csdn.net/qq_26222859/article/details/52235930">https://blog.csdn.net/qq_26222859/article/details/52235930</a><br>hsdis - HotSpot Dis Assembler<br>windows lock 指令实现 | MESI实现</p>
</li>
</ol>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>web安全笔记</title>
    <url>/2021/03/14/web%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h3 id="关于web端安全笔记"><a href="#关于web端安全笔记" class="headerlink" title="关于web端安全笔记"></a>关于web端安全笔记</h3><p>   <a href="https://websec.readthedocs.io/zh/latest/index.html">web安全地址</a></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>web安全</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>上网攻略</title>
    <url>/2021/01/14/%E4%B8%8A%E7%BD%91%E6%94%BB%E7%95%A5/</url>
    <content><![CDATA[<h4 id="上网攻略"><a href="#上网攻略" class="headerlink" title="上网攻略"></a>上网攻略</h4><p><strong>centos6+ wget链接到外网</strong></p>
<ul>
<li>执行以下命令修改文件</li>
</ul>
<p>​       vi /etc/resolv.conf</p>
<ul>
<li>把resolv.conf里面的文件替换为以下：</li>
</ul>
<p>​        nameserver 8.8.8.8<br>​         nameserver 114.114.114.114search localdomain</p>
<p><strong>注意：是用以上的配置替换文件中的所有配置</strong></p>
<h3 id="KX上网完整攻略"><a href="#KX上网完整攻略" class="headerlink" title="KX上网完整攻略"></a>KX上网完整攻略</h3><p>客观条件要求：<br>1，代理节点：<br>免费节点分享：<a href="http://bit.ly/3cFPrfV">http://bit.ly/3cFPrfV</a><br>免费节点订阅：<a href="http://bit.ly/2xa7o67">http://bit.ly/2xa7o67</a><br>2，代理客户端：<br>ssr客户端免费下载：<br>PC端：<a href="https://github.com/shadowsocksrr/shadowsocksr-csharp/releases">https://github.com/shadowsocksrr/shadowsocksr-csharp/releases</a><br>-下载最新版本的zip压缩包；<br>MAC端：<a href="https://github.com/qinyuhang/ShadowsocksX-NG-R/releases">https://github.com/qinyuhang/ShadowsocksX-NG-R/releases</a><br>-下载最新版本的dmg安装包；<br>安卓端：<a href="https://github.com/shadowsocksrr/shadowsocksr-android/releases">https://github.com/shadowsocksrr/shadowsocksr-android/releases</a><br>-下载最上面的版本 APK安装包（一般Android手机浏览器会自动下安装）。<br>v2ray客户端免费下载：<br>PC端和MAC端：<a href="https://github.com/v2ray/v2ray-core/releases">https://github.com/v2ray/v2ray-core/releases</a><br>-PC端下载最新版本的zip压缩包；MAC端下载最新的macos版本zip压缩包后解压；<br>MAC端其他版本v2rayU：<a href="https://github.com/yanue/V2rayU/releases">https://github.com/yanue/V2rayU/releases</a><br>-下载最新版本的dmg安装包;<br>安卓端：<a href="https://github.com/2dust/v2rayNG/releases">https://github.com/2dust/v2rayNG/releases</a><br>-下载最新版本的APK安装包。<br>IOS（苹果手机iphone或ipad）建议使用小火箭shadowrocket和quantumult，但因为大陆商店统统下架，所以只能使用非大陆地区的AppleID，打开App Store才能找到这两个软件，而且这两个软件收费;<br>如果希望不花钱也可以安装小火箭，请看我的视频：免费分享美区香港Apple ID(已购买小火箭shadowrocket)</p>
<p>小火箭shadowrocket ipa安装包下载：<br>小火箭爱思助手ipa安装包：<a href="http://bit.ly/38r7VNX">http://bit.ly/38r7VNX</a><br>小火箭和quantumult配置文件规则：<br>最完善的小火箭翻墙规则：<a href="https://github.com/h2y/Shadowrocket-ADBlock-Rules">https://github.com/h2y/Shadowrocket-ADBlock-Rules</a><br>quantumult等客户端配置规则：<a href="https://github.com/lhie1/Rules">https://github.com/lhie1/Rules</a><br>以上规则足够使用；<br>如果youtube出现黑屏 请点进去所使用的规则列表 搜索youtube 删除 “ads.youtube.com”这条规则.<br>如果不会添加规则，请看我的视频：小火箭使用教程</p>
<p>自己搭建代理节点<br>自己搭建代理节点，需要租用一台vps，视频教程里我会以谷歌云vps为例，因为谷歌云可以免费申请300美金的赠金，并且有一年的有效期。假如赠金用光或是有效期到期，还可以申请新的账号，再获取300美金赠金，并可转移至老账户作为付款账户，如此可以不用修改已经在用的节点而一直免费使用，爽吧！</p>
<p>一，ssr节点搭建步骤<br>系统要求：<br>CentOS 6+ / Debian 6+ / Ubuntu 14.04 +<br>推荐使用Debian 8+<br>安装：<br>简单的来说，如果你什么都不懂，那么你直接一路回车就可以了！</p>
<p>进入root目录：<br>首先确认命令符框最前面是不是root@xxxxx<br>如果不是, 说明不在根目录，请输入：<br>sudo su<br>输入上面代码回车后可能会提示你输入当前用户的密码，输入并回车后，没有报错就继续下面的步骤安装ShadowsocksR。<br>ssr一键安装脚本（逗比-单用户）：<br>wget -N –no-check-certificate <a href="https://raw.githubusercontent.com/ToyoDAdoubi/doubi/master/ssr.sh">https://raw.githubusercontent.com/ToyoDAdoubi/doubi/master/ssr.sh</a> &amp;&amp; chmod +x ssr.sh &amp;&amp; bash ssr.sh<br>单用户脚本：ssr.sh 则是单服务器单用户脚本，使用的是SSR服务端的单用户配置方式，即使实现了多端口，但是还算不上多用户，不支持每个用户(端口)不同的加密方式/协议/混淆等，并且无法管理流量使用。<br>ssr一键安装脚本（逗比-多用户）：<br>wget -N –no-check-certificate <a href="https://raw.githubusercontent.com/ToyoDAdoubiBackup/doubi/master/ssrmu.sh">https://raw.githubusercontent.com/ToyoDAdoubiBackup/doubi/master/ssrmu.sh</a> &amp;&amp; chmod +x ssrmu.sh &amp;&amp; bash ssrmu.sh<br>多用户脚本：ssrmu.sh 脚本是单服务器多用户脚本，使用的是SSR服务端的MudbJSON模式，可以给每个用户(端口)设置不同的加密方式/协议/混淆/限制速度/设备数限制/可用总流量等功能。即实现单服务器多用户流量管理等功能。<br>根据你的需求选择，比如你仅仅是 一个或两个人使用，并且不需要流量管理功能，那么选择 ssr.sh 好了。而如果很多人使用，并且都需要限制流量来管理，那你适合使用 ssrmu.sh , 所以自己看着选，多试试（两个脚本不能共存）！<br>运行后会提示你输入数字来选择要做什么。按提示操作即可;<br>如果全部完成，出现黑屏，请滑动一下你的鼠标滚轮！！！<br>使用管理：<br>运行脚本(单用户ssr.sh)：<br>bash ssr.sh<br>运行脚本(多用户ssrmu.sh)：<br>bash ssrmu.sh<br>输入对应的数字来执行相应的命令。<br>如果需要网络加速，可以安装BBR:<br>同样，需要在根目录操作：<br>如果没有安装wget GCP服务器，输入安装：<br>yum -y install wget<br>bbr加速一键安装脚本(其实以上ssr两个脚本14项“其他”里面已经可以安装）：<br>wget -N –no-check-certificate <a href="https://raw.githubusercontent.com/ToyoDAdoubiBackup/doubi/master/bbr.sh">https://raw.githubusercontent.com/ToyoDAdoubiBackup/doubi/master/bbr.sh</a> &amp;&amp; chmod +x bbr.sh &amp;&amp; bash bbr.sh<br>注意：在Debian系统中，删除旧内核时，会提示你是否终止删除内核的行为(点击打开图样)，这个需要你选择 (键盘方向键:选择，回车键:确认)。<br>使用管理：<br>1:启动bbr:bash bbr.sh start<br>2:关闭bbr:bash bbr.sh stop<br>3:查看bbr状态：bash bbr.sh status<br>二，v2ray节点搭建步骤<br>系统要求：<br>Ubuntu 16+ / Debian 8+ / CentOS 7+ 系统<br>推荐使用 Debian 9 系统，脚本会自动启用 BBR 优化。<br>安装：<br>进入root目录：<br>首先确认命令符框最前面是不是root@xxxxx<br>如果不是, 说明不在根目录，请输入：<br>sudo -i<br>v2ray一键安装脚本（233大佬)：<br>bash &lt;(curl -s -L <a href="https://git.io/v2ray.sh">https://git.io/v2ray.sh</a>)<br>如果提示 curl: command not found ，那是因为你的VPS没装Curl;<br>ubuntu/debian系统安装Curl,输入: apt-get update -y &amp;&amp; apt-get install curl -y<br>centos系统安装Curl,输入: yum update -y &amp;&amp; yum install curl -y<br>安装好curl之后就能安装脚本了!<br>安装完成后，自动启用bbr加速;<br>根目录下输入：v2ray 即可管理 V2Ray;<br>如果提示你的系统不支持此脚本，那么请尝试更换系统.<br>快速管理<br>查看 V2Ray 配置信息：v2ray info<br>修改 V2Ray 配置：v2ray config<br>生成 V2Ray 配置文件链接：v2ray link<br>生成 V2Ray 配置信息链接：v2ray infolink<br>生成 V2Ray 配置二维码链接：v2ray qr<br>查看 V2Ray 运行状态：v2ray status<br>启动 V2Ray：v2ray start<br>停止 V2Ray：v2ray stop<br>重启 V2Ray：v2ray restart<br>查看 V2Ray 运行日志：v2ray log<br>更新 V2Ray：v2ray update<br>更新 V2Ray 管理脚本：v2ray update.sh<br>卸载 V2Ray：v2ray uninstall<br>欢迎加入我的电报圈子<br>点击加入：<a href="https://bit.ly/2wqOQ1B">https://bit.ly/2wqOQ1B</a></p>
<p>Telegram客户端免费下载：<br>PC(desktop)端：<a href="https://desktop.telegram.org/">https://desktop.telegram.org/</a><br>安卓：<a href="https://play.google.com/store/apps/details?id=org.telegram.messenger">https://play.google.com/store/apps/details?id=org.telegram.messenger</a><br>IOS：<a href="https://www.apple.com/us/search/telegram?src=globalnav">https://www.apple.com/us/search/telegram?src=globalnav</a><br>MacOS：<a href="https://macos.telegram.org/">https://macos.telegram.org/</a><br>WP：<a href="https://www.microsoft.com/en-us/p/telegram-messenger/9wzdncrdzhs0?rtc=1&amp;activetab=pivot:overviewtab">https://www.microsoft.com/en-us/p/telegram-messenger/9wzdncrdzhs0?rtc=1&amp;activetab=pivot:overviewtab</a><br>Web网页端：<a href="https://web.telegram.org/#/login">https://web.telegram.org/#/login</a><br>电报MTproxy一键脚本(逗比):<br>wget -N –no-check-certificate <a href="https://raw.githubusercontent.com/ToyoDAdoubiBackup/doubi/master/mtproxy.sh">https://raw.githubusercontent.com/ToyoDAdoubiBackup/doubi/master/mtproxy.sh</a> &amp;&amp; chmod +x mtproxy.sh &amp;&amp; bash mtproxy.sh<br>管理脚本：<br>./mtproxy.sh<br>请勿违反国家法律法规，否则后果自负！<br>使用一键脚本并不会害了你，并且会让你节省大量的时间，工具从来都是为了更快的解决问题。</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
      </tags>
  </entry>
  <entry>
    <title>中介者设计模式</title>
    <url>/2020/12/24/%E4%B8%AD%E4%BB%8B%E8%80%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="中介者设计模式-Mediator-Pattern"><a href="#中介者设计模式-Mediator-Pattern" class="headerlink" title="中介者设计模式(Mediator Pattern)"></a>中介者设计模式(Mediator Pattern)</h4><p><strong>描述：</strong> 中介者设计模式是用来降低多个对象和类之间通信的复杂性。这种模式提供了一个中介类，该类通常处理不同类之间的通信，并支持松耦合，代码易于维护。中介模式属于行为型模式</p>
<p><strong>核心思想：</strong> 对象与对象之间存在大量的关联关系，这样势必会导致系统结构变的很复杂，同时若一个对象发生变化，我们也需要跟踪与之相关联的对象，同时做出相应的处理</p>
<p><strong>使用场景：</strong> </p>
<ul>
<li>系统中对对象之间存在比较复杂的引用关系，导致它们之间的依赖关系结构混乱而且难以服用改对象</li>
<li>想通过一个中间类来封装多个类中的行为，而不像生成太多的子类</li>
</ul>
<p><strong>中介者设计模式的优点：</strong></p>
<ul>
<li>降低了类的复杂度将一对多转化为一对一</li>
<li>各个类之间解耦</li>
<li>符合迪米特法则</li>
</ul>
<p><strong>中介者设计模式的缺点：</strong></p>
<ul>
<li>中介者会变得庞大， 变得复杂难以维护</li>
</ul>
<p><strong>示例：</strong> </p>
<ul>
<li>抽象中介者</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Mediator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(String message, Colleague colleague)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>中介者具体实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteMediator</span> <span class="keyword">implements</span> <span class="title">Mediator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConcreteColleague1 colleague1;</span><br><span class="line">    <span class="keyword">private</span> ConcreteColleague2 colleague2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColleague1</span><span class="params">(ConcreteColleague1 colleague1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.colleague1 = colleague1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColleague2</span><span class="params">(ConcreteColleague2 colleague2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.colleague2 = colleague2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String message, Colleague colleague)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (colleague == colleague1) &#123;</span><br><span class="line">            colleague2.notify(message);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            colleague1.notify(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>抽象出用户对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//抽象同事类</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Colleague</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Mediator mediator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Colleague</span><span class="params">(Mediator mediator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>用户的实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteColleague1</span> <span class="keyword">extends</span> <span class="title">Colleague</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteColleague1</span><span class="params">(Mediator mediator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(mediator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        mediator.send(message, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;同事1得到消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteColleague2</span> <span class="keyword">extends</span> <span class="title">Colleague</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteColleague2</span><span class="params">(Mediator mediator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(mediator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        mediator.send(message, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;同事1得到消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       ConcreteMediator mediator = <span class="keyword">new</span> ConcreteMediator();</span><br><span class="line"></span><br><span class="line">       ConcreteColleague1 colleague1 = <span class="keyword">new</span> ConcreteColleague1(mediator);</span><br><span class="line">       ConcreteColleague2 colleague2 = <span class="keyword">new</span> ConcreteColleague2(mediator);</span><br><span class="line"></span><br><span class="line">       mediator.setColleague1(colleague1);</span><br><span class="line">       mediator.setColleague2(colleague2);</span><br><span class="line"></span><br><span class="line">       colleague1.send(<span class="string">&quot;Nice to meet u.&quot;</span>);</span><br><span class="line">       colleague2.send(<span class="string">&quot;Nice to meet u too.&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>享元设计模式</title>
    <url>/2020/12/21/%E4%BA%AB%E5%85%83%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="享元设计模式-Flyweight-Pattern"><a href="#享元设计模式-Flyweight-Pattern" class="headerlink" title="享元设计模式(Flyweight Pattern)"></a>享元设计模式(Flyweight Pattern)</h4><p><strong>描述：</strong> 享元设计模式主要用于减少对象的创建，以减少内存的占用提高性能这种类型的设计模式属于结构型模式，它减少了对象的数量从而改善应用所需的对象结构的方式</p>
<p><strong>核心思想：</strong> 主要的思想和池化技术的概念类似。当我们取对象时如果有就返回，没有就创建。</p>
<p><strong>使用场景：</strong> </p>
<ul>
<li>系统有大量的相似对象</li>
<li>有缓冲池的场景</li>
</ul>
<p><strong>享元设计模式的优点：</strong></p>
<ul>
<li>降低内存的消耗，提高使用率</li>
</ul>
<p><strong>享元设计模式的缺点：</strong></p>
<ul>
<li>提高了系统的复杂度，需要分理处外部状态和内部的状态，而且外部状态具有固有化的性质，不应该随着内部状态的变化而变化，否则会造成系统的混乱。</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>抽象享元对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">borrow</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>享元对象的实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateBook</span> <span class="keyword">implements</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreateBook</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">borrow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;借出一本书 书名是：&quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>享元工厂</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Llibrary</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Book&gt; books;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Llibrary llibrary = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Llibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        books = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用单例 图书馆必须是一个</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Llibrary <span class="title">getLlibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (llibrary == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Llibrary.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (llibrary == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    llibrary = <span class="keyword">new</span> Llibrary();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> llibrary;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//此处借助于map 将享元对象存入map </span></span><br><span class="line">    <span class="comment">//传进来一个书的名字 此时如果有就直接返回这本书 如果没有就  添加一本书进来</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">libToBorrow</span><span class="params">(String bookName)</span> </span>&#123;</span><br><span class="line">        Book book = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (books.containsKey(bookName)) &#123;</span><br><span class="line">            book = books.get(bookName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            book = <span class="keyword">new</span> CreateBook(bookName);</span><br><span class="line">            books.put(bookName, book);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBookSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> books.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> List&lt;Book&gt; books = <span class="keyword">new</span> ArrayList&lt;Book&gt;();</span><br><span class="line">    <span class="keyword">static</span> Llibrary llibrary = Llibrary.getLlibrary();</span><br><span class="line">   <span class="comment">//调用book工厂 返回book对象</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">studentBorrow</span><span class="params">(String bookName)</span> </span>&#123;</span><br><span class="line">        books.add(llibrary.libToBorrow(bookName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        studentBorrow(<span class="string">&quot;java编程思想&quot;</span>);</span><br><span class="line">        studentBorrow(<span class="string">&quot;java核心卷一&quot;</span>);</span><br><span class="line">        studentBorrow(<span class="string">&quot;java核心卷二&quot;</span>);</span><br><span class="line"></span><br><span class="line">        studentBorrow(<span class="string">&quot;java核心卷一&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Book book : books) &#123;</span><br><span class="line">            book.borrow();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>代理设计模式</title>
    <url>/2020/12/22/%E4%BB%A3%E7%90%86%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="代理设计模式-Proxy-Pattern"><a href="#代理设计模式-Proxy-Pattern" class="headerlink" title="代理设计模式(Proxy Pattern)"></a>代理设计模式(Proxy Pattern)</h4><p><strong>描述：</strong> 代理设计模式就是一个对象代表另外一个对象的功能， 也就是指客户端并不直接调用实际的对象，而是通过中间的代理对象来间接的调用实际对象,  这种设计设计模式属于结构模式。</p>
<p><strong>核心思想：</strong> 为对象提供一种以代理对象控制这个对象的访问</p>
<p><strong>使用场景：</strong> 想访问一个类时做一些额外的操作，比如添加日志等</p>
<p><strong>代理设计模式的优点：</strong> </p>
<ul>
<li>职责清晰</li>
<li>高扩展</li>
</ul>
<p><strong>代理设计模式的缺点：</strong></p>
<ul>
<li>由于在客户端和真实主题之间增加了代理对象，因此有些类型的代理模式可能会造成请求的处理速度变慢。</li>
<li>实现代理模式需要额外的工作，有些代理模式的实现非常复杂。</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>创建一个接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Image</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建实现接口的类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RealImage</span> <span class="keyword">implements</span> <span class="title">Image</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">private</span> String fileName;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">RealImage</span><span class="params">(String fileName)</span></span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.fileName = fileName;</span><br><span class="line">      loadFromDisk(fileName);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Displaying &quot;</span> + fileName);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadFromDisk</span><span class="params">(String fileName)</span></span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Loading &quot;</span> + fileName);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>代理类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyImage</span> <span class="keyword">implements</span> <span class="title">Image</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">private</span> RealImage realImage;</span><br><span class="line">   <span class="keyword">private</span> String fileName;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ProxyImage</span><span class="params">(String fileName)</span></span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.fileName = fileName;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(realImage == <span class="keyword">null</span>)&#123;</span><br><span class="line">         realImage = <span class="keyword">new</span> RealImage(fileName);</span><br><span class="line">      &#125;</span><br><span class="line">      realImage.display();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyPatternDemo</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      Image image = <span class="keyword">new</span> ProxyImage(<span class="string">&quot;test_10mb.jpg&quot;</span>);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 图像将从磁盘加载</span></span><br><span class="line">      image.display(); </span><br><span class="line">      System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">      <span class="comment">// 图像不需要从磁盘加载</span></span><br><span class="line">      image.display();  </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>使用JavaAgent观察new对象占的的内存的大小</title>
    <url>/2021/06/24/%E4%BD%BF%E7%94%A8JavaAgent%E8%A7%82%E5%AF%9Fnew%E5%AF%B9%E8%B1%A1%E5%8D%A0%E7%9A%84%E7%9A%84%E5%86%85%E5%AD%98%E7%9A%84%E5%A4%A7%E5%B0%8F/</url>
    <content><![CDATA[<h2 id="new-Object-占的的内存的大小"><a href="#new-Object-占的的内存的大小" class="headerlink" title="new Object()占的的内存的大小"></a>new Object()占的的内存的大小</h2><h3 id="JavaAgent-介绍"><a href="#JavaAgent-介绍" class="headerlink" title="JavaAgent 介绍"></a>JavaAgent 介绍</h3><blockquote>
<p>以前在做后台服务开发的时候，SpringBoot每次改动代码都需要手动重启才能生效，感觉贼麻烦，后来使用Spring提供的一款热部署插件，它只是部分重启，相当于重新加载了我们自己写的代码，效率提高很多。后来遇到了<a href="https://zeroturnaround.com/software/jrebel/">Jrebel</a>，它只重新加载我们修改的那个类，比Springboot热部署插件重启速度更快，连改mybatis的xml文件都能热部署，太方便了有不有！（顺便安利一下同一家公司的另一个软件<a href="https://zeroturnaround.com/software/xrebel/download/">XRebel</a>，实时监控服务请求）后来又接触了<a href="https://github.com/btraceio/btrace">BTrace</a>，它可以线上调试代码而不需要重启项目，也是很吊的一个东西。通过了解，上面所说的几个东西都是通过Java Agent来实现的，那么Java Agent到底是啥，为啥这么吊？</p>
<p>在JDK1.5以后，我们可以使用agent技术构建一个独立于应用程序的代理程序（即为Agent），用来协助监测、运行甚至替换其他JVM上的程序。使用它可以实现虚拟机级别的AOP功能。</p>
<p>Agent分为两种，一种是在主程序之前运行的Agent，一种是在主程序之后运行的Agent（前者的升级版，1.6以后提供），这两种我们都会举个</p>
</blockquote>
<h3 id="对象大小（64位机）"><a href="#对象大小（64位机）" class="headerlink" title="对象大小（64位机）"></a>对象大小（64位机）</h3><h3 id="观察虚拟机配置"><a href="#观察虚拟机配置" class="headerlink" title="观察虚拟机配置"></a>观察虚拟机配置</h3><p>java -XX:+PrintCommandLineFlags -version</p>
<h3 id="普通对象"><a href="#普通对象" class="headerlink" title="普通对象"></a>普通对象</h3><ol>
<li>对象头：markword  8</li>
<li>ClassPointer指针：-XX:+UseCompressedClassPointers 为4字节 不开启为8字节</li>
<li>实例数据<ol>
<li>引用类型：-XX:+UseCompressedOops 为4字节 不开启为8字节<br>Oops Ordinary Object Pointers</li>
</ol>
</li>
<li>Padding对齐，8的倍数</li>
</ol>
<h3 id="数组对象"><a href="#数组对象" class="headerlink" title="数组对象"></a>数组对象</h3><ol>
<li>对象头：markword 8</li>
<li>ClassPointer指针同上</li>
<li>数组长度：4字节</li>
<li>数组数据</li>
<li>对齐 8的倍数</li>
</ol>
<h2 id="实验-使用JavaAgent测试Object的大小"><a href="#实验-使用JavaAgent测试Object的大小" class="headerlink" title="实验 使用JavaAgent测试Object的大小"></a>实验 使用JavaAgent测试Object的大小</h2><ol>
<li><p>新建项目ObjectSize （1.8）</p>
</li>
<li><p>创建文件ObjectSizeAgent</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mashibing.jvm.agent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectSizeAgent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Instrumentation inst;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation _inst)</span> </span>&#123;</span><br><span class="line">        inst = _inst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">sizeOf</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> inst.getObjectSize(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>src目录下创建META-INF/MANIFEST.MF</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Created-By: mashibing.com</span><br><span class="line">Premain-Class: com.mashibing.jvm.agent.ObjectSizeAgent</span><br></pre></td></tr></table></figure>

<p>注意Premain-Class这行必须是新的一行（回车 + 换行），确认idea不能有任何错误提示</p>
</li>
<li><p>打包jar文件</p>
</li>
<li><p>在需要使用该Agent Jar的项目中引入该Jar包<br>project structure - project settings - library 添加该jar包</p>
</li>
<li><p>运行时需要该Agent Jar的类，加入参数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">-javaagent:C:\work\ijprojects\ObjectSize\out\artifacts\ObjectSize_jar\ObjectSize.jar</span><br></pre></td></tr></table></figure></li>
<li><p>如何使用该类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">​```java</span><br><span class="line">   <span class="keyword">package</span> com.mashibing.jvm.c3_jmm;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">import</span> com.mashibing.jvm.agent.ObjectSizeAgent;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T03_SizeOfAnObject</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">           System.out.println(ObjectSizeAgent.sizeOf(<span class="keyword">new</span> Object()));</span><br><span class="line">           System.out.println(ObjectSizeAgent.sizeOf(<span class="keyword">new</span> <span class="keyword">int</span>[] &#123;&#125;));</span><br><span class="line">           System.out.println(ObjectSizeAgent.sizeOf(<span class="keyword">new</span> P()));</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">P</span> </span>&#123;</span><br><span class="line">                           <span class="comment">//8 _markword</span></span><br><span class="line">                           <span class="comment">//4 _oop指针</span></span><br><span class="line">           <span class="keyword">int</span> id;         <span class="comment">//4</span></span><br><span class="line">           String name;    <span class="comment">//4</span></span><br><span class="line">           <span class="keyword">int</span> age;        <span class="comment">//4</span></span><br><span class="line">   </span><br><span class="line">           <span class="keyword">byte</span> b1;        <span class="comment">//1</span></span><br><span class="line">           <span class="keyword">byte</span> b2;        <span class="comment">//1</span></span><br><span class="line">   </span><br><span class="line">           Object o;       <span class="comment">//4</span></span><br><span class="line">           <span class="keyword">byte</span> b3;        <span class="comment">//1</span></span><br><span class="line">   </span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Hotspot开启内存压缩的规则（64位机）"><a href="#Hotspot开启内存压缩的规则（64位机）" class="headerlink" title="Hotspot开启内存压缩的规则（64位机）"></a>Hotspot开启内存压缩的规则（64位机）</h2><ol>
<li>4G以下，直接砍掉高32位</li>
<li>4G - 32G，默认开启内存压缩 ClassPointers Oops</li>
<li>32G，压缩无效，使用64位<br>内存并不是越大越好（^-^）</li>
</ol>
<p><a href="https://cloud.tencent.com/developer/article/1480590">https://cloud.tencent.com/developer/article/1480590</a><br><a href="https://cloud.tencent.com/developer/article/1484167">https://cloud.tencent.com/developer/article/1484167</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1485795">https://cloud.tencent.com/developer/article/1485795</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1482500">https://cloud.tencent.com/developer/article/1482500</a></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>使用jacob实现word转pdf</title>
    <url>/2021/01/01/%E4%BD%BF%E7%94%A8jacob%E5%AE%9E%E7%8E%B0word%E8%BD%ACpdf/</url>
    <content><![CDATA[<h4 id="使用jacob实现word转pdf-WPS版"><a href="#使用jacob实现word转pdf-WPS版" class="headerlink" title="使用jacob实现word转pdf WPS版"></a>使用jacob实现word转pdf WPS版</h4><p><strong>准备：</strong></p>
<ul>
<li>java用到的jar包：jacob-1.18</li>
<li>jacob-1.18-x64.dll、jacob-1.18-x86.dll</li>
</ul>
<p><strong>根据您的操作系统的需要将jacob-1.18-x64.dll或jacob-1.18-x86.dll放置你的jdk/jre的bin目录下</strong></p>
<p><strong>在你的项目中引入jacob-1.18 jar</strong></p>
<p><strong>本下载压缩包内包含jacob-1.18和jacob-1.18-x64.dll、jacob-1.18-x86.dll</strong></p>
<p><a href="http://sourceforge.net/projects/jacob-project/"><strong>下载：官网</strong></a></p>
<p><strong>补充：</strong></p>
<ul>
<li><p>需要安装wps </p>
</li>
<li><p>jacob不得低于1.18</p>
</li>
<li><p>jdk1.8</p>
</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yzw;</span><br><span class="line"><span class="keyword">import</span> com.jacob.activeX.ActiveXComponent;</span><br><span class="line"><span class="keyword">import</span> com.jacob.com.Dispatch;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yzw</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/1/1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test1111</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> wdDoNotSaveChanges = <span class="number">0</span>;<span class="comment">// 不保存待定的更改。</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> wdFormatPDF = <span class="number">17</span>;<span class="comment">// PDF 格式</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toPDF</span><span class="params">(String filename, String toFilename)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;启动Word&quot;</span>);</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        ActiveXComponent app = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            app = <span class="keyword">new</span> ActiveXComponent(<span class="string">&quot;KWPS.Application&quot;</span>);</span><br><span class="line">            app.setProperty(<span class="string">&quot;Visible&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            Dispatch docs = app.getProperty(<span class="string">&quot;Documents&quot;</span>).toDispatch();</span><br><span class="line">            System.out.println(<span class="string">&quot;打开文档&quot;</span> + filename);</span><br><span class="line">            Dispatch doc = Dispatch.call(docs,<span class="comment">//</span></span><br><span class="line">                    <span class="string">&quot;Open&quot;</span>, <span class="comment">//</span></span><br><span class="line">                    filename,<span class="comment">// FileName</span></span><br><span class="line">                    <span class="keyword">false</span>,<span class="comment">// ConfirmConversions</span></span><br><span class="line">                    <span class="keyword">true</span> <span class="comment">// ReadOnly</span></span><br><span class="line">            ).toDispatch();</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;转换文档到PDF&quot;</span> + toFilename);</span><br><span class="line">            File tofile = <span class="keyword">new</span> File(toFilename);</span><br><span class="line">            <span class="keyword">if</span> (tofile.exists()) &#123;</span><br><span class="line">                tofile.delete();</span><br><span class="line">            &#125;</span><br><span class="line">            Dispatch.call(doc,<span class="comment">//</span></span><br><span class="line">                    <span class="string">&quot;SaveAs&quot;</span>, <span class="comment">//</span></span><br><span class="line">                    toFilename, <span class="comment">// FileName</span></span><br><span class="line">                    wdFormatPDF);</span><br><span class="line"></span><br><span class="line">            Dispatch.call(doc, <span class="string">&quot;Close&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">&quot;转换完成..用时：&quot;</span> + (end - start) + <span class="string">&quot;ms.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;========Error:文档转换失败：&quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (app != <span class="keyword">null</span>)</span><br><span class="line">                app.invoke(<span class="string">&quot;Quit&quot;</span>, wdDoNotSaveChanges);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String wordFile =<span class="string">&quot;C:\\Users\\27184\\Desktop\\项目\\新建文件夹\\CG20120719.docx&quot;</span>;</span><br><span class="line">        String pdfFile = <span class="string">&quot;C:\\Users\\27184\\Desktop\\项目\\新建文件夹\\成功.pdf&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Test1111 test1111 = <span class="keyword">new</span> Test1111();</span><br><span class="line">        Long  startTime = System.currentTimeMillis();</span><br><span class="line">        test1111.toPDF(wordFile, pdfFile);</span><br><span class="line">        Long  endTime = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;office转换pdf耗时：&quot;</span>+ (endTime - startTime) + <span class="string">&quot;毫秒。&quot;</span>);</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println(<span class="string">&quot;Office 转 PDF成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>个人笔记</category>
      </categories>
      <tags>
        <tag>Demo</tag>
      </tags>
  </entry>
  <entry>
    <title>单例设计模式</title>
    <url>/2020/12/07/%E5%8D%95%E4%BE%8B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="单例设计模式-（Singleton）"><a href="#单例设计模式-（Singleton）" class="headerlink" title="单例设计模式 （Singleton）"></a>单例设计模式 （Singleton）</h4><p><strong>描述：</strong> 一个类有且仅有一个实例的类</p>
<p><strong>特点：</strong> 单例类只有一个实例，单例必须自己创建自己的唯一实例，必须给其他的访问对象提供自己的试列 。这样的好处就是避免了内存的频繁的创建和销毁实例。</p>
<p><strong>饿汉式</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/*饿汉式</span></span><br><span class="line"><span class="comment">类加载到内存之后就一个实例 ， jvm保证线程的安全</span></span><br><span class="line"><span class="comment">缺点就是不管用到与否 都会在内存中产生一个实列*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="comment">//构造器私有，不能被外界随便调用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span>  <span class="title">Test</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span>  <span class="keyword">final</span>  Test t = <span class="keyword">new</span> Test();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供访问接口 只能是  类名.的方式调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>  Test <span class="title">getTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>懒汉式</strong>(线程不安全)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/*懒汉式 </span></span><br><span class="line"><span class="comment">    线程不安全*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Test t = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造器私有，不能被外界随便调用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供访问接口 只能是  类名.的方式调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Test <span class="title">getTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//在这里有可能发生线程不安全 假如t1执行到了这，此时cpu被另外的一个线程t2抢走 就会发生在内存中会有两个实例的存在</span></span><br><span class="line">            t = <span class="keyword">new</span> Test();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>懒汉式/双重检查机制</strong>(线程安全的 DCL)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/*懒汉式</span></span><br><span class="line"><span class="comment">    线程安全*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span>  <span class="keyword">static</span> Test t = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//注意 此处的 volatile  用来防止指令重排序的</span></span><br><span class="line">    <span class="comment">//当我们创建一个对象的时候 分为3步完成 1.在内存开辟空间  2.调用构造函数初始化成员变量  3.调用对象的&lt;init&gt; 指向内存空间</span></span><br><span class="line">    <span class="comment">//在cpu指令的优化下 此时可以看到  2和3 没有  逻辑上的顺序 所以此时有可能 1 3 2顺序执行  就在此时cpu指令执行到了 1 3         // 有一个线程抢走cpu 执行下方的第一个if代码 此时t 已经 !=null 但是成员变量并未初始化 所以报错</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//构造器私有，不能被外界随便调用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供访问接口 只能是  类名.的方式调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Test <span class="title">getTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;  <span class="comment">//此处的判断是为了考虑到运行的效率，假如此时有100个线程，如果在这里不加判断的情况就是100个线程都                           // 会在这里抢锁，消耗资源。  </span></span><br><span class="line">                          <span class="comment">// 加上锁之后 当一个线程执行完之后 t ！= null 所以就不用抢占资源 ，直接return</span></span><br><span class="line">            <span class="keyword">synchronized</span> (Test.class) &#123;</span><br><span class="line">                <span class="keyword">if</span>(t== <span class="keyword">null</span>)&#123;</span><br><span class="line">                    t = <span class="keyword">new</span> Test();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>静态内部类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/*静态内部类</span></span><br><span class="line"><span class="comment">  * jvm帮我们保证线程安全</span></span><br><span class="line"><span class="comment">  *jvm帮我们保证单例</span></span><br><span class="line"><span class="comment">  *外部类加载时 内部类不会加载（懒加载模式）</span></span><br><span class="line"><span class="comment">  * */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="comment">//构造器私有，不能被外界随便调用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span>    <span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span>  <span class="keyword">final</span> <span class="keyword">static</span>   Test t1 = <span class="keyword">new</span> Test();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//提供访问接口 只能是  类名.的方式调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Test <span class="title">getTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  Test1.t1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="基于枚举单列模式-推荐使用"><a href="#基于枚举单列模式-推荐使用" class="headerlink" title="基于枚举单列模式(推荐使用)"></a>基于枚举单列模式(推荐使用)</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span>  <span class="title">Test</span> </span>&#123;</span><br><span class="line">    TEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 注意: <strong>其中只有枚举方式的单例不会被破坏，其他都能够使用反射或者序列化的方式破坏单例</strong> </p>
<p><strong>实例: 使用反射破坏单例</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException </span>&#123;</span><br><span class="line">        <span class="comment">//通过静态方法获取单例</span></span><br><span class="line">        Test test = Test.getTest();</span><br><span class="line">        <span class="comment">//获取Singleton的无参构造器</span></span><br><span class="line">        Constructor&lt;Test&gt; constructor = Test.class.getDeclaredConstructor();</span><br><span class="line">        <span class="comment">//因为构造器是私有的，需要设置权限</span></span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//使用构造器创建对象</span></span><br><span class="line">        Test t1 = constructor.newInstance();</span><br><span class="line">        <span class="comment">//比较是否相等，答案是false</span></span><br><span class="line">        System.out.println(test.equals(t1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>避免反射破坏</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="comment">//构造器私有，不能被外界随便调用</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span>  <span class="keyword">final</span>  Test t = <span class="keyword">new</span> Test();</span><br><span class="line">    <span class="function"><span class="keyword">private</span>  <span class="title">Test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(t != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;请使用getSingleton()方法获取单例对象&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供访问接口 只能是  类名.的方式调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>  Test <span class="title">getTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用序列化破坏（须实现序列化接口  Serializable）</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       Singleton instance = Singleton.getInstance();</span><br><span class="line">       <span class="keyword">byte</span>[] serialize = SerializationUtils.serialize(instance);</span><br><span class="line">       Singleton newInstance = SerializationUtils.deserialize(serialize);</span><br><span class="line">       System.out.println(instance == newInstance);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>避免反序列化破坏  就是不实现反序列化接口</strong></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>原型设计模式</title>
    <url>/2020/12/18/%E5%8E%9F%E5%9E%8B%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="原型设计模式-Prototype-Pattern"><a href="#原型设计模式-Prototype-Pattern" class="headerlink" title="原型设计模式(Prototype Pattern)"></a>原型设计模式(Prototype Pattern)</h4><p><strong>描述：</strong> 它是用来创建重复对象的，首先创建一个实例然后通过这个实例拷贝创建新的实例</p>
<p><strong>核心思想：</strong> 使用克隆的方式进行对象的创建</p>
<p><strong>使用场景：</strong> </p>
<ul>
<li><p>一个复杂的对象，包含多种数据和结构，层次较深时，适用与原型模式（当需要创建一个与复杂对象部分数据相同的对象）</p>
</li>
<li><p> 当复杂对象需要独立于系统运行，而不破坏本系统中的结构</p>
</li>
<li><p>一个对象多个修改者的场景。</p>
</li>
</ul>
<p><strong>原型设计模式的优点：</strong> </p>
<ul>
<li>性能提高。 </li>
<li>逃避构造函数的约束。</li>
</ul>
<p><strong>原型设计模式的缺点：</strong></p>
<ul>
<li>引用含有循环引用如何处理</li>
<li>必须实现 Cloneable 接口。</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">student</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object clone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clone = <span class="keyword">super</span>.clone();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">teacher</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//老师有学生 的属性</span></span><br><span class="line">    <span class="keyword">private</span> student stu;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object clone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clone = <span class="keyword">super</span>.clone();</span><br><span class="line">            student clone1 = (student) <span class="keyword">this</span>.getStu().clone();</span><br><span class="line">            <span class="keyword">this</span>.setStu(clone1);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        teacher tea = <span class="keyword">new</span> teacher();</span><br><span class="line">        tea.setName(<span class="string">&quot;老师&quot;</span>);</span><br><span class="line">        student student = <span class="keyword">new</span> student();</span><br><span class="line">        student.setAge(<span class="number">33</span>);</span><br><span class="line">        student.setName(<span class="string">&quot;学生&quot;</span>);</span><br><span class="line">        tea.setAge(<span class="number">56</span>);</span><br><span class="line">        tea.setSex(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        tea.setStu(student);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        teacher clone = (teacher) tea.clone();</span><br><span class="line">        clone.setAge(<span class="number">78</span>);</span><br><span class="line">        clone.setName(<span class="string">&quot;克隆老师&quot;</span>);</span><br><span class="line">        clone.getStu().setAge(<span class="number">99</span>);</span><br><span class="line">        clone.getStu().setName(<span class="string">&quot;小学生&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(tea);</span><br><span class="line">        System.out.println(clone);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>输出结果</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">teacher(name=老师, age=<span class="number">56</span>, sex=男, stu=student(name=学生, age=<span class="number">33</span>))</span><br><span class="line">teacher(name=克隆老师, age=<span class="number">78</span>, sex=男, stu=student(name=小学生, age=<span class="number">99</span>))</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>命令设计模式</title>
    <url>/2020/12/22/%E5%91%BD%E4%BB%A4%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="命令设计模式-Command-Pattern"><a href="#命令设计模式-Command-Pattern" class="headerlink" title="命令设计模式(Command Pattern)"></a>命令设计模式(Command Pattern)</h4><p><strong>描述：</strong> 命令设计模式是一种数据驱动的设计模式，它属于行为模式，请求以命令的方式包裹在对象中，并传递给调用对象，调用对象寻找可以处理改命令的合适对象，并把该命令传递给相应的对象，该对象执行命令。</p>
<p><strong>核心思想：</strong> 将一个情求封装为一个对象，从而可以使用不同的请求对客户进行参数化</p>
<p><strong>使用场景：</strong> 认为是命令的地方可以使用命令设计模式</p>
<p><strong>命令设计模式的优点：</strong> </p>
<ul>
<li>降低系统的耦合</li>
<li>新的命令可以很容易的添加到系统中去</li>
</ul>
<p><strong>命令设计模式是缺点：</strong></p>
<ul>
<li>会导致某些系统过多的具体命名的类，不符合依赖倒置原则</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>抽象命令接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//命令接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="comment">//执行任务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建一个请求类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stock</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">&quot;ABC&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> quantity = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Stock [ Name: &quot;</span> + name +</span><br><span class="line">                <span class="string">&quot;  Quantity: &quot;</span> + quantity + <span class="string">&quot; ] bought&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Stock [ Name: &quot;</span> + name +</span><br><span class="line">                <span class="string">&quot;  Quantity: &quot;</span> + quantity + <span class="string">&quot; ] sold&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现命令的接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyStock</span> <span class="keyword">implements</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Stock abcStock;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BuyStock</span><span class="params">(Stock abcStock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.abcStock = abcStock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        abcStock.buy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SellStock</span> <span class="keyword">implements</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Stock abcStock;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SellStock</span><span class="params">(Stock abcStock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.abcStock = abcStock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        abcStock.sell();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>创建命令调用类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Broker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Order&gt; orderList = <span class="keyword">new</span> ArrayList&lt;Order&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeOrder</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">        orderList.add(order);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">placeOrders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Order order : orderList) &#123;</span><br><span class="line">            order.execute();</span><br><span class="line">        &#125;</span><br><span class="line">        orderList.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Stock abcStock = <span class="keyword">new</span> Stock();</span><br><span class="line"></span><br><span class="line">        BuyStock buyStockOrder = <span class="keyword">new</span> BuyStock(abcStock);</span><br><span class="line">        SellStock sellStockOrder = <span class="keyword">new</span> SellStock(abcStock);</span><br><span class="line"></span><br><span class="line">        Broker broker = <span class="keyword">new</span> Broker();</span><br><span class="line">        broker.takeOrder(buyStockOrder);</span><br><span class="line">        broker.takeOrder(sellStockOrder);</span><br><span class="line"></span><br><span class="line">        broker.placeOrders();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>备忘录设计模式</title>
    <url>/2020/12/24/%E5%A4%87%E5%BF%98%E5%BD%95%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="备忘录设计模式-Memento-Pattern"><a href="#备忘录设计模式-Memento-Pattern" class="headerlink" title="备忘录设计模式(Memento Pattern)"></a>备忘录设计模式(Memento Pattern)</h4><p><strong>描述：</strong> 备忘录设计模式是行为型设计模式之一，该设计模式用于保存对象当前的状态，并且在之后可以再次恢复到此状态，以便在适当的时候恢复此状态</p>
<p><strong>核心思想：</strong> 在不破坏封装的前提， 保存一个对象在某一个时刻的状态或者部分状态</p>
<p><strong>使用场景：</strong> </p>
<ul>
<li>需要保存恢复数据的相关状态场景</li>
<li>提供一个可回滚的操作</li>
<li>可以使用于快照功能</li>
</ul>
<p><strong>备忘录设计模式的优点</strong></p>
<ul>
<li>给用户提供了一种可以恢复状态的机制，可以使用户比较方便的回滚到某个历史状态</li>
<li>实现了历史的封装，使用户不用关心状态保存的细节</li>
</ul>
<p><strong>备忘录设计模式的缺点：</strong></p>
<ul>
<li>消耗资源，如果类的成员过多会占用比较大的资源，每一次保存都会消耗一定的内存</li>
</ul>
<p><strong>示例：</strong> </p>
<ul>
<li>备忘录</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memento</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> menoy;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;String&gt; fruits;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//窄接口，访问部分信息</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMenoy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> menoy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//宽接口，本包之内皆可访问</span></span><br><span class="line">    Memento(<span class="keyword">int</span> menoy) &#123;</span><br><span class="line">        <span class="keyword">this</span>.menoy = menoy;</span><br><span class="line">        fruits = <span class="keyword">new</span> ArrayList();<span class="comment">//每次调用的时候重新生成，很重要</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//宽接口，本包之内皆可访问</span></span><br><span class="line">    <span class="function">List <span class="title">getFruits</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (List) fruits.clone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//宽接口，本包之内皆可访问</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addFruits</span><span class="params">(String fruit)</span> </span>&#123;</span><br><span class="line">        fruits.add(fruit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Menoy：&quot;</span> + menoy + <span class="string">&quot; ,Fruits:&quot;</span> + fruits;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>原对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Gamer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> menoy;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; fruits;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">int</span> name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMenoy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> menoy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Gamer</span><span class="params">(<span class="keyword">int</span> menoy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.menoy = menoy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Memento <span class="title">createMemento</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Memento m = <span class="keyword">new</span> Memento(menoy);</span><br><span class="line">        fruits.stream().filter(x -&gt; x.startsWith(<span class="string">&quot;好吃&quot;</span>)).forEach(x -&gt; &#123;</span><br><span class="line">            m.addFruits(x);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreMemento</span><span class="params">(Memento memento)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.menoy = memento.getMenoy();</span><br><span class="line">        <span class="keyword">this</span>.fruits = memento.getFruits();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>客户端使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Gamer gamer = <span class="keyword">new</span> Gamer(<span class="number">100</span>);</span><br><span class="line">        Memento memento = <span class="keyword">null</span>;</span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(<span class="string">&quot;好吃的苹果&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;梨&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;好吃的橘子&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;香蕉&quot;</span>);</span><br><span class="line">        gamer.setFruits(list);</span><br><span class="line">        System.out.println(<span class="string">&quot;我是原本的&quot;</span> + gamer);</span><br><span class="line"></span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">int</span> i = scanner.nextInt();</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">                memento = gamer.createMemento();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">                gamer.restoreMemento(memento);</span><br><span class="line">                System.out.println(<span class="string">&quot;我是回退的:&quot;</span> + gamer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>外观设计模式</title>
    <url>/2020/12/21/%E5%A4%96%E8%A7%82%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="外观设计模式-Facade-pattern"><a href="#外观设计模式-Facade-pattern" class="headerlink" title="外观设计模式(Facade pattern)"></a>外观设计模式(Facade pattern)</h4><p><strong>描述：</strong> 外观设计模式就是隐藏系统的复杂性，向客户端提供一个客户端可以访问系统的接口，这种类型的设计模式属于结构型模式，它向现有的系统添加一个接口，来隐藏系统的复杂度</p>
<p><strong>核心思想：</strong> 封装系统的复杂度，对外提供简单的接口</p>
<p><strong>使用场景：</strong> </p>
<ul>
<li>为复杂的模块或者子系统提供外界访问的接口</li>
<li>子系统相对的独立</li>
</ul>
<p><strong>外观设计模式的优点：</strong></p>
<ul>
<li>减少系统相互依赖</li>
<li>提高灵活性</li>
<li>提高安全性</li>
</ul>
<p><strong>外观设计模式的缺点：</strong> </p>
<ul>
<li>不符合开闭原则，如果要改东西很麻烦，继承重写都不合适。</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>接口类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> <span class="keyword">implements</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Rectangle::draw()&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Square</span> <span class="keyword">implements</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Square::draw()&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">implements</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Circle::draw()&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>外观类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShapeMaker</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> Shape circle;</span><br><span class="line">   <span class="keyword">private</span> Shape rectangle;</span><br><span class="line">   <span class="keyword">private</span> Shape square;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ShapeMaker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      circle = <span class="keyword">new</span> Circle();</span><br><span class="line">      rectangle = <span class="keyword">new</span> Rectangle();</span><br><span class="line">      square = <span class="keyword">new</span> Square();</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawCircle</span><span class="params">()</span></span>&#123;</span><br><span class="line">      circle.draw();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawRectangle</span><span class="params">()</span></span>&#123;</span><br><span class="line">      rectangle.draw();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawSquare</span><span class="params">()</span></span>&#123;</span><br><span class="line">      square.draw();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FacadePatternDemo</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      ShapeMaker shapeMaker = <span class="keyword">new</span> ShapeMaker();</span><br><span class="line"> </span><br><span class="line">      shapeMaker.drawCircle();</span><br><span class="line">      shapeMaker.drawRectangle();</span><br><span class="line">      shapeMaker.drawSquare();      </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>享元设计模式</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>守护线程与用户线程</title>
    <url>/2021/06/05/%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%94%A8%E6%88%B7%E7%BA%BF%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="守护线程与用户线程"><a href="#守护线程与用户线程" class="headerlink" title="守护线程与用户线程"></a>守护线程与用户线程</h2><p>　　用户线程：我们平常创建的普通线程。</p>
<p>　　守护线程：用来服务于用户线程；不需要上层逻辑介入</p>
<p>　　java线程分为守护线程和非守护线程，当java jvm检测主线程或其他子线程执行完之后，守护线程也会马上停止执行，我们可以使用Thread.setDaemon(ture或false)来设置一个线程是守护线程还是非守护线程，默认为false，可以通过Thread.isDaemon()方法查询该线程是否是守护线程</p>
<p>1：我们将用案例来告诉你守护线程和非守护线程的区别和用法，代码如下，先设置其为守护线程。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class DeamonThread &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        &#x2F;&#x2F;&quot;DeamonThread::print&quot;是java1.8调用静态方法</span><br><span class="line">        Thread thread &#x3D; new Thread(DeamonThread::print);</span><br><span class="line">        thread.setDaemon(true);</span><br><span class="line">        thread.start();</span><br><span class="line">        System.out.println(&quot;退出Main方法&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void print() &#123;</span><br><span class="line">        int counter &#x3D; 1;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                System.out.println(&quot;Counter:&quot; + counter++);</span><br><span class="line">                Thread.sleep(2000);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>print()方法里面是一个while死循环，以上代码输出结果如下，只输出一次便退出了while(true)循环。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">退出Main方法&#96;&#96;Counter:1:</span><br></pre></td></tr></table></figure>

<p>2：如果我们将daemon设置为非守护线程，代码如下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">thread.setDaemon(false);</span><br></pre></td></tr></table></figure>

<p>这时候就不会退出while(true)循环了，会一直执行下去，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">退出Main方法&#96;&#96;Counter:1&#96;&#96;Counter:2&#96;&#96;Counter:3&#96;&#96;.......</span><br></pre></td></tr></table></figure>

<p>总结：非守护线程其实就是守护线程的氧气，如果氧气没了，守护线程也会跟着死掉。</p>
<p>当线程只剩下守护线程的时候,JVM就会退出；补充一点如果还有其他的任意一个用户线程还在，JVM就不会退出。</p>
<h2 id="使用它需要注意些什么？"><a href="#使用它需要注意些什么？" class="headerlink" title="使用它需要注意些什么？"></a>使用它需要注意些什么？</h2><ol>
<li>thread.setDaemon(true)必须在thread.start()之前设置，否则会跑出一个IllegalThreadStateException异常。你不能把正在运行的常规线程设置为守护线程。</li>
<li>在Daemon线程中产生的新线程也是Daemon的。</li>
<li>守护线程不能用于去访问固有资源，比如读写操作或者计算逻辑。因为它会在任何时候甚至在一个操作的中间发生中断。</li>
<li>Java自带的多线程框架，比如ExecutorService，会将守护线程转换为用户线程，所以如果要使用后台线程就不能用Java的线程池。</li>
</ol>
<h2 id="意义及应用场景"><a href="#意义及应用场景" class="headerlink" title="意义及应用场景"></a>意义及应用场景</h2><p>　　当主线程结束时，结束其余的子线程（守护线程）自动关闭，就免去了还要继续关闭子线程的麻烦。如：Java垃圾回收线程就是一个典型的守护线程；内存资源或者线程的管理，但是非守护线程也可以。</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>对象定位的两种方式</title>
    <url>/2021/06/24/%E5%AF%B9%E8%B1%A1%E5%AE%9A%E4%BD%8D%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<h1 id="对象定位的两种方式"><a href="#对象定位的两种方式" class="headerlink" title="对象定位的两种方式"></a>对象定位的两种方式</h1><p>  由于reference类型在Java虚拟机规范里只规定了一个指向对象的引用，并没有定义这个引用应该通过哪种方式去定位，以及访问到Java堆中的对象的具体位置，因此不同虚拟机实现的对象访问方式会有所不同，主流的访问方式有两种：使用句柄和直接指针。</p>
<p>1、使用句柄访问方式</p>
<p>如果使用句柄访问方式，Java堆中会划分出一块内存来作为句柄池，reference中存储的就是对象的句柄地址，而句柄中包含了对象实例数据和类型数据各自的具体地址信息。使用句柄方式最大的好处就是reference中存储的是稳定的句柄地址，在对象被移动（垃圾收集时移动对象是非常普遍的行为）时只会改变句柄中的实例数据指针，而reference本身不需要被修改。</p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/%E8%AF%AD%E7%97%85%E5%8F%A5%E8%AE%BF%E9%97%AE.png" alt="语柄句"></p>
<p>二、使用直接指针访问方式</p>
<p>如果使用该方式，Java堆对象的布局就必须考虑如何放置访问类型数据的相关信息，reference中直接存储的就是对象地址。使用直接指针方式最大的好处就是速度更快，他节省了一次指针定位的时间开销。</p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/%E7%9B%B4%E6%8E%A5%E6%8C%87%E9%92%88%E8%AE%BF%E9%97%AE.png" alt="直接指针"></p>
<p>就HotSpot而言，他使用的是直接指针访问方式进行对象访问，但从整个软件开发的范围来看，各种语言和框架使用句柄来访问的情况也十分常见。</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>工厂设计模式</title>
    <url>/2020/12/10/%E5%B7%A5%E5%8E%82%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="工厂设计模式-Factory-Pattern"><a href="#工厂设计模式-Factory-Pattern" class="headerlink" title="工厂设计模式(Factory Pattern)"></a>工厂设计模式(Factory Pattern)</h4><p><strong>描述：</strong> 工厂设计模式是用来生产对象的，在java中万般皆对象，如果创建的时候使用new 关键字会出现耦合严重，如果我们的对象名称换了那么所有出现此对象的地方都要进行修改。维护起来会十分的麻烦，所以就会使用工厂设计模式。</p>
<p><strong>工厂设计模式的种类：</strong></p>
<ul>
<li>简单工厂(Simple Factory Pattern)</li>
<li>工厂方法(Factory Method)</li>
<li>抽象工厂(Abstract Factory)</li>
</ul>
<h5 id="简单工厂设计模式-Simple-Factory-Pattern-静态工厂方法"><a href="#简单工厂设计模式-Simple-Factory-Pattern-静态工厂方法" class="headerlink" title="简单工厂设计模式(Simple Factory Pattern) /静态工厂方法"></a>简单工厂设计模式(Simple Factory Pattern) /静态工厂方法</h5><p><strong>示例：</strong></p>
<ul>
<li>电脑的抽象类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span>  <span class="class"><span class="keyword">interface</span> <span class="title">Computer</span> </span>&#123;</span><br><span class="line">     <span class="function">String <span class="title">getRAM</span><span class="params">()</span></span>;<span class="comment">//内存</span></span><br><span class="line">     <span class="function">String <span class="title">getCPU</span><span class="params">()</span></span>;<span class="comment">//cpu</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>联想电脑厂家</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lianxiang</span>  <span class="keyword">implements</span>  <span class="title">Computer</span></span>&#123;</span><br><span class="line">    String ram;</span><br><span class="line">    String cpu;</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="title">Lianxiang</span><span class="params">(String ram,String cpu)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cpu=cpu;</span><br><span class="line">        <span class="keyword">this</span>.ram=ram;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRAM</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;联想的cpu是&quot;</span>+cpu;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCPU</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;联想的ram是&quot;</span>+ram;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>华为电脑厂家</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Huawei</span> <span class="keyword">implements</span>   <span class="title">Computer</span> </span>&#123;</span><br><span class="line">    String ram;</span><br><span class="line">    String cpu;</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="title">Huawei</span><span class="params">(String ram,String cpu)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cpu=cpu;</span><br><span class="line">        <span class="keyword">this</span>.ram=ram;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRAM</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;华为的cpu是&quot;</span>+cpu;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCPU</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;华为的ram是&quot;</span>+ram;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>电脑工厂生产电脑对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComputerFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">static</span> Computer <span class="title">getComputer</span><span class="params">(String type,String cpu,String ram)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;Huawei&quot;</span>.equals(type))&#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="keyword">new</span> Huawei(ram,cpu);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;Lianxiang&quot;</span>.equals(type))&#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="keyword">new</span> Lianxiang(ram,cpu);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端的调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Computer computer = ComputerFactory.getComputer(<span class="string">&quot;Huawei&quot;</span>, <span class="string">&quot;32G&quot;</span>, <span class="string">&quot;Inter&quot;</span>);</span><br><span class="line">        System.out.println(computer.getCPU()+computer.getRAM());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优点：</strong> 上下解耦， 如联想的命名改变，则客户端是不需要知道的</p>
<p><strong>缺点：</strong> 违反开闭原则，当我要增加一种品牌的电脑时休要修改工厂类，因此它只适用于产品对象较少的需求。</p>
<p><strong>附图：</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82UML.png" alt="简单工厂设计模式UML"></p>
<h5 id="工厂方法设计模式-Factory-Method"><a href="#工厂方法设计模式-Factory-Method" class="headerlink" title="工厂方法设计模式(Factory Method)"></a>工厂方法设计模式(Factory Method)</h5><p><strong>描述：</strong> 主要用来创建单个产品的</p>
<p><strong>示例：</strong></p>
<ul>
<li>电脑的抽象类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span>  <span class="class"><span class="keyword">interface</span> <span class="title">Computer</span> </span>&#123;</span><br><span class="line">     <span class="function">String <span class="title">getRAM</span><span class="params">()</span></span>;</span><br><span class="line">     <span class="function">String <span class="title">getCPU</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>电脑工厂的抽象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ComputerFactory</span> </span>&#123;</span><br><span class="line">     <span class="function">Computer <span class="title">getComputer</span><span class="params">( String cpu, String ram)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>华为电脑厂家</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Huawei</span> <span class="keyword">implements</span> <span class="title">Computer</span> </span>&#123;</span><br><span class="line">    String ram;</span><br><span class="line">    String cpu;</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="title">Huawei</span><span class="params">(String ram,String cpu)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cpu=cpu;</span><br><span class="line">        <span class="keyword">this</span>.ram=ram;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRAM</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;华为的cpu是&quot;</span>+cpu;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCPU</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;华为的ram是&quot;</span>+ram;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li> 电脑工厂生产华为电脑厂家</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HuaweiFactory</span> <span class="keyword">implements</span>  <span class="title">ComputerFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Computer <span class="title">getComputer</span><span class="params">(String cpu, String ram)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Huawei(ram , cpu);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端的调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HuaweiFactory huaweiFactory = <span class="keyword">new</span> HuaweiFactory();</span><br><span class="line">        Computer inter = huaweiFactory.getComputer(<span class="string">&quot;inter&quot;</span>, <span class="string">&quot;32G&quot;</span>);</span><br><span class="line">        System.out.println(inter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优点：</strong> 符合开闭原则 ， 上下解耦 。 如果要增加一个电脑工厂不用修改任何代码，直接实现Computer 和 ComputerFactory 即可</p>
<p><strong>缺点：</strong> 如果电脑的厂家很多的话会造成类的爆炸式增长，</p>
<p><strong>附图：</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82UML.png" alt="工厂方法设计模式UML"></p>
<h5 id="抽象工厂设计模式-Abstract-Factory"><a href="#抽象工厂设计模式-Abstract-Factory" class="headerlink" title="抽象工厂设计模式(Abstract Factory)"></a>抽象工厂设计模式(Abstract Factory)</h5><p><strong>描述：</strong> 抽象工厂设计模式主要是用来创建 一系列的产品 </p>
<p><strong>应用场景：</strong> 当我们的一系列的产品簇趋向于稳定的时候，生产厂家可以变动，也就是华为只生产电脑和手机，不在扩展其他业务的时候使用它，而生产厂家可以有多个，不只华为一家 </p>
<p><strong>示例：</strong></p>
<ul>
<li>各种类型电脑的抽象类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DianNaoFactory</span> </span>&#123;</span><br><span class="line"><span class="comment">//各种系列的电脑</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hdiannao</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ldiannao</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">qdiannao</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">xdiannao</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>各种手机的抽象类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ShowJiFactory</span> </span>&#123;</span><br><span class="line">   <span class="comment">//各种系列的手机</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">p9shouji</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">p3shouji</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">p4shouji</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">p8shouji</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>华为厂家造电脑</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HuaweiDiaNao</span> <span class="keyword">implements</span>  <span class="title">DianNaoFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hdiannao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;h系类的电脑&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ldiannao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;l系类的电脑&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">qdiannao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;q系类的电脑&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">xdiannao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;x系类的电脑&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>华为厂家造手机</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HuaweiShouJi</span> <span class="keyword">implements</span> <span class="title">ShowJiFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">p9shouji</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;p9系类的手机&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">p3shouji</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;p3系类的手机&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">p4shouji</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;p4系类的手机&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">p8shouji</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;p8系类的手机&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>电子产品类的 抽象接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JiadainFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">//电脑的生产者</span></span><br><span class="line">    <span class="function">DianNaoFactory   <span class="title">dianNaoFactory</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//手机的生产者</span></span><br><span class="line">    <span class="function">ShowJiFactory   <span class="title">showJiFactory</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>华为生产电子产品</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Huawei</span> <span class="keyword">implements</span>  <span class="title">JiadainFactory</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DianNaoFactory <span class="title">dianNaoFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HuaweiDiaNao() ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShowJiFactory <span class="title">showJiFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HuaweiShouJi();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端的调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JiadainFactory jiadain = <span class="keyword">new</span> Huawei();</span><br><span class="line">             jiadain.dianNaoFactory().hdiannao();</span><br><span class="line">             jiadain.showJiFactory().p3shouji();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优点：</strong> 具体的产品代码隔离，无需关注创建的细节，将一个系列的产品在一起创建。也就是我们增加生产厂家的时候是很容易的。</p>
<p><strong>缺点：</strong> 显而易见，当我们要怎加一个产平簇的时候是很麻烦的，我们要修改生产厂家的接口，违反开闭原则。</p>
<p><strong>附图：</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82UML.png" alt="抽象工厂设计模式UML"></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>常用的批处理命令</title>
    <url>/2020/12/05/%E5%B8%B8%E7%94%A8%E7%9A%84%E6%89%B9%E5%A4%84%E7%90%86%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h2 id="常用的批处理命令"><a href="#常用的批处理命令" class="headerlink" title="常用的批处理命令"></a>常用的批处理命令</h2><h4 id="1-启动jar"><a href="#1-启动jar" class="headerlink" title="1.启动jar"></a>1.启动jar</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@echo off</span><br><span class="line">start javaw -jar oes.jar</span><br><span class="line"></span><br><span class="line">echo ------------启动成功!--------------------</span><br><span class="line">pause</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<h4 id="2-停止服务-杀死进程"><a href="#2-停止服务-杀死进程" class="headerlink" title="2. 停止服务 杀死进程"></a>2. 停止服务 杀死进程</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@echo off &amp; setlocal EnableDelayedExpansion</span><br><span class="line"></span><br><span class="line">set obj[0]&#x3D;9111</span><br><span class="line"></span><br><span class="line">set port&#x3D;0</span><br><span class="line">set pid&#x3D;0</span><br><span class="line"></span><br><span class="line">for &#x2F;f &quot;usebackq delims&#x3D;&#x3D; tokens&#x3D;1-2&quot; %%a in (&#96;set obj&#96;) do (</span><br><span class="line">    set port&#x3D;%%b</span><br><span class="line">    for &#x2F;f &quot;tokens&#x3D;5&quot; %%m in (&#39;netstat -aon ^| findstr &quot;:%%b&quot;&#39;) do (</span><br><span class="line">        set pid&#x3D;%%m</span><br><span class="line">    )</span><br><span class="line">    if &quot;!pid!&quot;&#x3D;&#x3D;&quot;0&quot; (</span><br><span class="line">        echo 端口号【!port!】没有占用</span><br><span class="line">    ) else (</span><br><span class="line">        echo 端口号【!port!】相关进程以杀死</span><br><span class="line">        taskkill &#x2F;f &#x2F;pid !pid!</span><br><span class="line">    )</span><br><span class="line">    set pid&#x3D;0</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">pause</span><br></pre></td></tr></table></figure>

<h4 id="3-部署hexo"><a href="#3-部署hexo" class="headerlink" title="3.部署hexo"></a>3.部署hexo</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@echo off &amp; setlocal EnableDelayedExpansion</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">D:</span><br><span class="line">cd D:\hexo</span><br><span class="line"></span><br><span class="line">echo.  </span><br><span class="line">echo.     </span><br><span class="line">echo.            </span><br><span class="line">echo ************************************ 美好的一天从敲代码开始 ********************************************************</span><br><span class="line">:s</span><br><span class="line">echo.    </span><br><span class="line">echo.     </span><br><span class="line">set &#x2F;p operation&#x3D;请输入你要的操作 n 代表你要新建一个markdown文件 d 代表你要部署项目到服务 :</span><br><span class="line">if &quot;%operation%&quot; &#x3D;&#x3D; &quot;n&quot; (</span><br><span class="line">echo.    </span><br><span class="line">echo.</span><br><span class="line">set &#x2F;p name&#x3D;请输入你要创建的文件名称:</span><br><span class="line">echo.    </span><br><span class="line">echo.</span><br><span class="line">echo 文件名称:!name!</span><br><span class="line">echo.    </span><br><span class="line">echo.</span><br><span class="line">echo 请稍候......</span><br><span class="line">goto n</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if &quot;%operation%&quot; &#x3D;&#x3D; &quot;d&quot; (</span><br><span class="line">goto d</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if &quot;%operation%&quot; NEQ  &quot;n&quot;  ( </span><br><span class="line">if &quot;%operation%&quot; NEQ  &quot;d&quot; (</span><br><span class="line">if &quot;%operation%&quot; &#x3D;&#x3D;  &quot;&quot; (</span><br><span class="line">echo 输入错误，请重新输入 &amp; pause</span><br><span class="line">goto s</span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">:n</span><br><span class="line">echo.    </span><br><span class="line">echo.   </span><br><span class="line">hexo new  !name! &amp;  start D:\App\app\Typora\Typora.exe   &quot;D:\hexo\source\_posts\%name%.md&quot;  </span><br><span class="line"></span><br><span class="line">:d</span><br><span class="line">echo.    </span><br><span class="line">echo.   </span><br><span class="line">hexo clean | hexo g &amp; gulp | hexo d </span><br><span class="line">echo.</span><br><span class="line">echo 部署完成</span><br><span class="line">echo.</span><br><span class="line">pause</span><br><span class="line">goto s</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>个人笔记</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>建造者设计模式</title>
    <url>/2020/12/08/%E5%BB%BA%E9%80%A0%E8%80%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="建造者设计模式-（BuilderPattern）"><a href="#建造者设计模式-（BuilderPattern）" class="headerlink" title="建造者设计模式 （BuilderPattern）"></a>建造者设计模式 （BuilderPattern）</h4><p><strong>描述：</strong> 首先建造者设计模式是用来构建复杂的对象的，它主要强调的是当对于一个复杂对象的构建，比如当一个类的构造函数的参数超过4个的时候，且都是可变参数时侯考虑使用建造者设计模式。</p>
<p><strong>核心思想:</strong>  当你的一个类需要很多的参数来构建时就可以把这些参数提取出来放在另一个类中进行构建</p>
<p><strong>建造者设计模式的优点：</strong></p>
<ul>
<li>封装性</li>
<li>独立 ， 易于扩展</li>
<li>便于控制细节风险，对建造过程逐步细化</li>
</ul>
<p><strong>建造者设计模式的使用场景：</strong></p>
<p>-　相同的方法，不同的执行顺序产生不同的结果<br>-　多个零件或者部件，可以配置到多个对象中产生不同的效果<br>-　产品类中调用的顺序不同会产生不同的结果</p>
<p><strong>示例:</strong></p>
<ul>
<li>构建 制茶模型</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TeaModel</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">caiZhai</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">weiTiao</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">hunGan</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">nianRou</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">faJiao</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">ganZao</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">baoCun</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCourse</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildTea</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        list.forEach(x -&gt; &#123;</span><br><span class="line">            <span class="keyword">switch</span> (x) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;采摘&quot;</span>:</span><br><span class="line">                    <span class="keyword">this</span>.caiZhai();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;萎调&quot;</span>:</span><br><span class="line">                    <span class="keyword">this</span>.weiTiao();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;烘干&quot;</span>:</span><br><span class="line">                    <span class="keyword">this</span>.hunGan();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;保存&quot;</span>:</span><br><span class="line">                    <span class="keyword">this</span>.baoCun();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;干燥&quot;</span>:</span><br><span class="line">                    <span class="keyword">this</span>.ganZao();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;发酵&quot;</span>:</span><br><span class="line">                    <span class="keyword">this</span>.faJiao();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;揉捻&quot;</span>:</span><br><span class="line">                    <span class="keyword">this</span>.nianRou();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    System.out.println(<span class="string">&quot;未知的操作&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>红茶实现模型</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackTeaModel</span> <span class="keyword">extends</span> <span class="title">TeaModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caiZhai</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;红茶：采摘&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">weiTiao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;红茶：萎调&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hunGan</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;红茶：烘干&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nianRou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;红茶：揉捻&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">faJiao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;红茶：发酵&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ganZao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;红茶：干燥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">baoCun</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;红茶： 保存&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>抽象制茶的建造者</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractTeaBuild</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置调制茶的顺序</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setCourse</span><span class="params">(ArrayList&lt;String&gt; list)</span></span>;</span><br><span class="line">     </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取茶叶</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> TeaModel <span class="title">getTea</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>具体茶叶的建造者</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackTeaBuilder</span> <span class="keyword">extends</span> <span class="title">AbstractTeaBuild</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 红茶的构建者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TeaModel tm = <span class="keyword">new</span> BlackTeaModel();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCourse</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        tm.setCourse(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TeaModel <span class="title">getTea</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调制茶叶</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeaMakeDirector</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AbstractTeaBuild ab = <span class="keyword">new</span> BlackTeaBuilder();</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//制作红茶 红茶制作工序 ：采摘 → 萎调 → 揉捻 → 发酵 → 干燥</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BlackTeaModel <span class="title">getBlackTea</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        list.clear();</span><br><span class="line">        list.add(<span class="string">&quot;采摘&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;萎调&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;揉捻&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;发酵&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;干燥&quot;</span>);</span><br><span class="line">        ab.setCourse(list);</span><br><span class="line">        <span class="keyword">return</span> (BlackTeaModel) ab.getTea();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>需求来了 要三个红茶</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="comment">//来三杯绿茶</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TeaMakeDirector teaMakeDirector = <span class="keyword">new</span> TeaMakeDirector();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; i++)&#123;</span><br><span class="line">            teaMakeDirector.getBlackTea().buildTea();</span><br><span class="line">            System.out.println(<span class="string">&quot;第&quot;</span>+i+ <span class="string">&quot;杯红茶已好&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结:</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/%E5%BB%BA%E9%80%A0%E8%80%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8Fuml.jpg" alt="建造者设计模式UML"></p>
<p><strong>product就是最终要生成的对象  例如:(BlackTeaModel)</strong></p>
<p><strong>Builde就是建造者的抽象基类  例如:( AbstractTeaBuild )</strong> </p>
<p><strong>ConcreteBuilde实现 Builde  例如:( BlackTeaBuilder)</strong> </p>
<p><strong>Director: 决定如何构建最终产品的算法. 其会包含一个负责组装的方法(getBlackTea) 调用这个方法就相当于组装好了一个产品  例如(TeaMakeDirector)</strong></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库幂等性</title>
    <url>/2021/08/10/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B9%82%E7%AD%89%E6%80%A7/</url>
    <content><![CDATA[<h3 id="数据库方式实现接口幂等性"><a href="#数据库方式实现接口幂等性" class="headerlink" title="数据库方式实现接口幂等性"></a>数据库方式实现接口幂等性</h3><p>幂等性：对于同一笔业务操作，不管调用多少次，得到的结果都是一样的。</p>
<p>以对接支付宝充值为例，如果我们系统对接支付宝充值功能，需要给支付宝提供一个回调接口，支付宝回调信息中会携带（out_trade_no【商户订单号】，trade_no【支付宝交易号】），trade_no在支付宝中是唯一的，out_trade_no在商户系统中是唯一的。</p>
<p>回调接口实现有以下实现方式。</p>
<p>（1）普通方式</p>
<p>过程如下：</p>
<p>1.接收到支付宝支付成功请求<br>2.根据trade_no查询当前订单是否处理过<br>3.如果订单已处理直接返回，若未处理，继续向下执行<br>4.开启本地事务<br>5.本地系统给用户加钱<br>6.将订单状态置为成功<br>7.提交本地事务</p>
<p>对于同一笔订单，如果支付宝同时通知多次，同时到达第2步时候，查询订单都是未处理的，会继续向下执行，最终本地会给用户加两次钱。</p>
<p>此方式适用于单机，通知按顺序执行的情况，只能用于自己测试。</p>
<p>（2）JVM加锁方式</p>
<p>方式（1）中由于并发出现了问题，此时我们使用java中的Lock加锁，来防止并发操作，过程如下：</p>
<p>1.接收到支付宝支付成功请求<br>2.调用java中的Lock加锁<br>3.根据trade_no查询当前订单是否处理过<br>4.如果订单已处理直接返回，若未处理，继续向下执行<br>5.开启本地事务<br>6.本地系统给用户加钱<br>7.将订单状态置为成功<br>8.提交本地事务<br>9.释放Lock锁</p>
<p>分析问题：<br>Lock只能在一个JVM中起效，如果多个请求都被同一套系统处理，上面这种使用Lock的方式是没有问题的，不过互联网系统中，多数是采用集群方式部署系统，同一套代码，服务器上会部署多套，如果支付宝同时发来多个通知经过负载均衡转发到不同的机器，上面的锁就不起效了。此时对于多个请求相当于无锁处理了，又会出现方式1中的结果。此时我们需要分布式锁来做处理。</p>
<p>（3）悲观锁方式</p>
<p>使用数据库中悲观锁实现。悲观锁类似于方式（2）中的Lock，只不过是依靠数据库来实现的。数据中悲观锁使用for update来实现，过程如下：</p>
<p>1.接收到支付宝支付成功请求<br>2.打开本地事务<br>3.查询订单信息并加悲观锁</p>
<p>select * from t_order where order_id = trade_no for update;</p>
<p>4.判断订单是已处理<br>5.如果订单已处理直接返回，若未处理，继续向下执行<br>6.给本地系统给用户加钱<br>7.将订单状态置为成功<br>8.提交本地事务</p>
<p>重点在于for update：<br>1.当线程A执行for update，数据库会对当前记录加锁，其他线程执行到此行代码的时候，会等待线程A释放锁之后，才可以获取锁，继续后续操作。<br>2.事务提交时，for update获取的锁会自动释放。</p>
<p>方式（3）可以正常实现我们需要的效果，能保证接口的幂等性，不过存在一些缺点：<br>如果业务处理比较耗时，并发情况下，后面线程会长期处于等待状态，占用了很多线程，让这些线程处于无效等待状态。我们的web服务中的线程数量一般都是有限的，如果大量线程由于获取for update锁处于等待状态，不利于系统并发度。</p>
<p>（4）乐观锁方式</p>
<p>依靠数据库中的乐观锁来实现。</p>
<p>1.接收到支付宝支付成功请求<br>2.查询订单信息</p>
<p>select * from t_order where order_id = trade_no;</p>
<p>3.判断订单是已处理<br>4.如果订单已处理直接返回，若未处理，继续向下执行<br>5.打开本地事务<br>6.给本地系统给用户加钱<br>7.将订单状态置为成功，注意这块是重点，伪代码：</p>
<p>update t_order set status = 1 where order_id = trade_no and status = 0;//会返回影响的行数num</p>
<p>if(num==1){<br> //表示更新成功</p>
<p> 提交事务;</p>
<p>}else{<br> //表示更新失败</p>
<p> 回滚事务;</p>
<p>}</p>
<p>注意：<br>update t_order set status = 1 where order_id = trade_no where status = 0; 是依靠乐观锁来实现的，status=0作为条件去更新，类似于java中的CAS操作。执行这条sql的时候，如果有多个线程同时到达这条代码，数据库内部会保证update同一条记录会排队执行，最终会有一条update会执行成功，其他未成功的，他们的num为0，然后根据num来进行提交或者回滚操作。</p>
<p>（5）唯一约束方式</p>
<p>依赖数据库中唯一约束来实现。</p>
<p>CREATE TABLE ‘t_unique_log’ (</p>
<p>  ‘id’ bigint(20) NOT NULL AUTO_INCREMENT,</p>
<p>  ‘ref_type’ varchar(32) NOT NULL DEFAULT ‘’ COMMENT ‘关联操作类型’,</p>
<p>  ‘ref_id’ varchar(64) NOT NULL DEFAULT ‘’ COMMENT ‘关联操作id’,</p>
<p>  PRIMARY KEY (‘id’),</p>
<p>  UNIQUE KEY ‘uq_key’ (‘ref_type’,’ref_id’) COMMENT ‘保证业务唯一性’</p>
<p>) ENGINE=InnoDB;</p>
<p>对于任何一个业务，有一个业务类型(ref_type)，业务有一个全局唯一的订单号，业务来的时候，先查询表中是否存在相关记录，若不存在，继续放行。</p>
<p>过程如下：</p>
<p>1.接收到支付宝支付成功请求<br>2.查询表t_unique_log (条件ref_id,ref_type)，可以判断订单是否已处理</p>
<p>select * from t_unique_log where ref_type = ‘充值订单’ and ref_id = trade_no;</p>
<p>3.判断订单是已处理<br>4.如果订单已处理直接返回，若未处理，继续向下执行<br>5.打开本地事务<br>6.给本地系统给用户加钱<br>7.将订单状态置为成功<br>8.向t_unique_log（唯一约束） 插入数据，插入成功，提交本地事务，插入失败，回滚本地事务，伪代码：</p>
<p>try{<br>    insert into t_unique_log (ref_type,ref_id) values (‘充值订单’,trade_no);</p>
<p>​    // 提交本地事务：</p>
<p>}catch(Exception e){<br>   // 回滚本地事务;</p>
<p>}</p>
<p>说明：<br>对于同一个业务，ref_type是一样的，当并发时，插入数据只会有一条成功，其他的会违反唯一约束，进入catch逻辑，当前事务会被回滚，最终只有一个操作成功，从而保证了幂等性。<br>关于这种方式可以写成通用的方式，不过业务量大的情况下，t_unique_log 插入数据会成为系统的瓶颈。</p>
<p>总结</p>
<p>1.数据库实现幂等性常见的方式有：悲观锁（for update）、乐观锁、唯一约束<br>2.几种方式，按照最优排序：乐观锁 &gt; 唯一约束 &gt; 悲观锁</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>解决方案</category>
      </categories>
      <tags>
        <tag>分布式解决方案</tag>
      </tags>
  </entry>
  <entry>
    <title>桥接设计模式</title>
    <url>/2020/12/20/%E6%A1%A5%E6%8E%A5%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="桥接设计模式-Bridge-Pattern"><a href="#桥接设计模式-Bridge-Pattern" class="headerlink" title="桥接设计模式(Bridge Pattern)"></a>桥接设计模式(Bridge Pattern)</h4><p><strong>描述：</strong> 桥接设计模式是用于把抽象化于实现化解耦，使得二者可以独立变化。这种类型的设计模式属于结构型设计模式，它通过提供抽象化和实现化之间的桥接结构来实现二者的解耦。</p>
<p><strong>核心思想：</strong> 将抽象部分与实现部分分离，使它们可以独立的变化</p>
<p><strong>使用场景：</strong> </p>
<ul>
<li>如果一个系统需要在构建的抽象和具体角色化之间增加更多的灵活性，避免在两个层次之间建立静态的继承联系通过桥接模式可以使它们在抽象层建立一个关联关系。</li>
<li>对于那些不希望使用继承或者因为多层次导致导致的系统类的个数急剧增加的系统，桥接模式尤为适用</li>
<li>一个类存在两个独立变化的维度，且这两个类都需要进行扩展。</li>
</ul>
<p><strong>桥接设计模式的优点：</strong></p>
<ul>
<li> 抽象和实现的分离。 </li>
<li>优秀的扩展能力。 </li>
<li>实现细节对客户透明。</li>
</ul>
<p><strong>桥接设计模式的缺点：</strong></p>
<ul>
<li>桥接模式的引入会增加系统的理解与设计难度，由于聚合关联关系建立在抽象层，要求开发者针对抽象进行设计与编程。</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>目标接口。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DrawAPI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">drawCircle</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建实现了 <em>DrawAPI</em> 接口的实体桥接实现类。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedCircle</span> <span class="keyword">implements</span> <span class="title">DrawAPI</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawCircle</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Drawing Circle[ color: red, radius: &quot;</span></span><br><span class="line">         + radius +<span class="string">&quot;, x: &quot;</span> +x+<span class="string">&quot;, &quot;</span>+ y +<span class="string">&quot;]&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreenCircle</span> <span class="keyword">implements</span> <span class="title">DrawAPI</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawCircle</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Drawing Circle[ color: green, radius: &quot;</span></span><br><span class="line">         + radius +<span class="string">&quot;, x: &quot;</span> +x+<span class="string">&quot;, &quot;</span>+ y +<span class="string">&quot;]&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>抽象桥接接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">   <span class="keyword">protected</span> DrawAPI drawAPI;</span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="title">Shape</span><span class="params">(DrawAPI drawAPI)</span></span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.drawAPI = drawAPI;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span></span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现桥接接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> x, y, radius;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Circle</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> radius, DrawAPI drawAPI)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(drawAPI);</span><br><span class="line">      <span class="keyword">this</span>.x = x;  </span><br><span class="line">      <span class="keyword">this</span>.y = y;  </span><br><span class="line">      <span class="keyword">this</span>.radius = radius;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      drawAPI.drawCircle(radius,x,y);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BridgePatternDemo</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      Shape redCircle = <span class="keyword">new</span> Circle(<span class="number">100</span>,<span class="number">100</span>, <span class="number">10</span>, <span class="keyword">new</span> RedCircle());</span><br><span class="line">      Shape greenCircle = <span class="keyword">new</span> Circle(<span class="number">100</span>,<span class="number">100</span>, <span class="number">10</span>, <span class="keyword">new</span> GreenCircle());</span><br><span class="line"> </span><br><span class="line">      redCircle.draw();</span><br><span class="line">      greenCircle.draw();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>模板设计模式</title>
    <url>/2021/01/07/%E6%A8%A1%E6%9D%BF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="模板设计模式-Template-Pattern"><a href="#模板设计模式-Template-Pattern" class="headerlink" title="模板设计模式(Template Pattern)"></a>模板设计模式(Template Pattern)</h4><p><strong>描述：</strong> 定义一个操作中的算法骨架，而将具体的步骤延迟到子类当中。模板方法子类不改变一个算法的结构即可重新定义算法的实现</p>
<p><strong>核心思想：</strong> 在父类中定义算法的执行步骤顺序，由子类来具体实现，但不能改变执行顺序</p>
<p><strong>使用场景：</strong>  </p>
<ul>
<li>有多个子类共有的方法，且逻辑相同。 </li>
<li>重要的、复杂的方法，可以考虑作为模板方法。</li>
</ul>
<p><strong>模板设计模式的优点：</strong></p>
<ul>
<li>封装不变部分，扩展可变部分。</li>
<li>提取公共代码，便于维护。 </li>
<li>行为由父类控制，子类实现。</li>
</ul>
<p><strong>模板设计模式的缺点</strong></p>
<ul>
<li>每一个不同的实现都需要一个子类来实现，导致类的个数增加，使得系统更加庞大</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>抽象出一个模板对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Game</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">startPlay</span><span class="params">()</span></span>;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">endPlay</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//模板</span></span><br><span class="line"> <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//初始化游戏</span></span><br><span class="line">        initialize();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始游戏</span></span><br><span class="line">        startPlay();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//结束游戏</span></span><br><span class="line">        endPlay();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>不同对象的实现类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">Cricket</span> <span class="keyword">implements</span>  <span class="title">Game</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Cricket  初始化&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startPlay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Cricket  开始&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endPlay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Cricket  退出结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Football</span> <span class="keyword">implements</span> <span class="title">Game</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endPlay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Football 初始化&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Football 开始&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startPlay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Football 退出结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Game game = <span class="keyword">new</span> Cricket();</span><br><span class="line">        game.play();</span><br><span class="line">        System.out.println();</span><br><span class="line">        game = <span class="keyword">new</span> Football();</span><br><span class="line">        game.play();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>状态设计模式</title>
    <url>/2020/12/25/%E7%8A%B6%E6%80%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="状态设计模式-State-Pattern"><a href="#状态设计模式-State-Pattern" class="headerlink" title="状态设计模式(State Pattern)"></a>状态设计模式(State Pattern)</h4><p><strong>描述：</strong> 在状态设计模式中类的行为是基于状态改变的，这种类型的模式属于行为设计模式。在状态上设计模式中我们创建表示各种状态和一个行为随这状态对象改变而改变</p>
<p><strong>核心思想：</strong> 允许对象在内部状态发生改变时改变它的行为，对象看起来好像改变了它的类</p>
<p><strong>使用场景：</strong></p>
<ul>
<li>行为随状态的改变而改变的场景</li>
<li>条件，分支语句的代替者</li>
</ul>
<p><strong>状态设计模式的优点：</strong></p>
<ul>
<li>封装了转换规则。 </li>
<li> 枚举可能的状态，在枚举状态之前需要确定状态种类。 </li>
<li>将所有与某个状态有关的行为放到一个类中，并且可以方便地增加新的状态，只需要改变对象状态即可改变对象的行为。 </li>
<li>允许状态转换逻辑与状态对象合成一体，而不是某一个巨大的条件语句块。 </li>
<li>可以让多个环境对象共享一个状态对象，从而减少系统中对象的个数。</li>
</ul>
<p><strong>状态设计模式的缺点：</strong></p>
<ul>
<li>状态模式的使用必然会增加系统类和对象的个数。 </li>
<li>状态模式的结构与实现都较为复杂，如果使用不当将导致程序结构和代码的混乱。 </li>
<li>状态模式对”开闭原则”的支持并不太好，对于可以切换状态的状态模式，增加新的状态类需要修改那些负责状态转换的源代码，否则无法切换到新增状态，而且修改某个状态类的行为也需修改对应类的源代码。</li>
</ul>
<p><strong>示例：</strong></p>
<p><strong>需求：</strong></p>
<p>我们考虑设计一个金库警报系统，这个系统会根据白天晚上做出不同的响应。</p>
<p>有一个金库<br> 金库与警报中心相连<br> 金库里有警铃和电话<br> 金库里有时钟</p>
<p>金库只能在白天使用<br> 白天使用金库，会在警报中心留下记录<br> 晚上使用金库，会向警报中心发送紧急事态通知</p>
<p>警铃白天晚上都能用<br> 使用警铃，会向警报中心发送紧急事态通知</p>
<p>电话都可以使用<br> 白天使用电话，会呼叫警报中心<br> 晚上使用电话，会呼叫警报中心的留言电话</p>
<p>基本就是以上的需求逻辑。</p>
<p><strong>分析：</strong></p>
<p>状态模式会发现，这些不同的行为，主要依赖于两个状态，就是白天和晚上。所以状态模式会抽象出这两种状态，每个状态就会有自己的行为实现，比如白天这个状态会实现自己的使用金库的方法，通话的方法，晚上的类也会实现自己的行为逻辑，最后我们只要取得状态对象的委托调用他们的方法就行了，不管他们具体是怎么实现的。</p>
<ul>
<li>抽象状态接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doClock</span><span class="params">(Context context, <span class="keyword">int</span> hour)</span></span>;    <span class="comment">// 设置时间</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doUse</span><span class="params">(Context context)</span></span>;                <span class="comment">// 使用金库</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doAlarm</span><span class="params">(Context context)</span></span>;              <span class="comment">// 按下警铃</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doPhone</span><span class="params">(Context context)</span></span>;              <span class="comment">// 正常通话</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>实现状态接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NightState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NightState singleton = <span class="keyword">new</span> NightState();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NightState</span><span class="params">()</span> </span>&#123;                              <span class="comment">// 构造函数的可见性是private</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> State <span class="title">getInstance</span><span class="params">()</span> </span>&#123;                 <span class="comment">// 获取唯一实例</span></span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClock</span><span class="params">(Context context, <span class="keyword">int</span> hour)</span> </span>&#123;    <span class="comment">// 设置时间</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">9</span> &lt;= hour &amp;&amp; hour &lt; <span class="number">17</span>) &#123;</span><br><span class="line">            context.changeState(DayState.getInstance());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doUse</span><span class="params">(Context context)</span> </span>&#123;                <span class="comment">// 使用金库</span></span><br><span class="line">        context.callSecurityCenter(<span class="string">&quot;紧急：晚上使用金库！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAlarm</span><span class="params">(Context context)</span> </span>&#123;              <span class="comment">// 按下警铃</span></span><br><span class="line">        context.callSecurityCenter(<span class="string">&quot;按下警铃(晚上)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPhone</span><span class="params">(Context context)</span> </span>&#123;              <span class="comment">// 正常通话</span></span><br><span class="line">        context.recordLog(<span class="string">&quot;晚上的通话录音&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;                          <span class="comment">// 显示表示类的文字</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[晚上]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DayState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DayState singleton = <span class="keyword">new</span> DayState();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DayState</span><span class="params">()</span> </span>&#123;                                <span class="comment">// 构造函数的可见性是private</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> State <span class="title">getInstance</span><span class="params">()</span> </span>&#123;                 <span class="comment">// 获取唯一实例</span></span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClock</span><span class="params">(Context context, <span class="keyword">int</span> hour)</span> </span>&#123;    <span class="comment">// 设置时间</span></span><br><span class="line">        <span class="keyword">if</span> (hour &lt; <span class="number">9</span> || <span class="number">17</span> &lt;= hour) &#123;</span><br><span class="line">            context.changeState(NightState.getInstance());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doUse</span><span class="params">(Context context)</span> </span>&#123;                <span class="comment">// 使用金库</span></span><br><span class="line">        context.recordLog(<span class="string">&quot;使用金库(白天)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAlarm</span><span class="params">(Context context)</span> </span>&#123;              <span class="comment">// 按下警铃</span></span><br><span class="line">        context.callSecurityCenter(<span class="string">&quot;按下警铃(白天)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPhone</span><span class="params">(Context context)</span> </span>&#123;              <span class="comment">// 正常通话</span></span><br><span class="line">        context.callSecurityCenter(<span class="string">&quot;正常通话(白天)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;                          <span class="comment">// 显示表示类的文字</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[白天]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>抽象 出上下文 和 白天晚上要干的事情</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setClock</span><span class="params">(<span class="keyword">int</span> hour)</span></span>;                <span class="comment">// 设置时间</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">changeState</span><span class="params">(State state)</span></span>;          <span class="comment">// 改变状态</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">callSecurityCenter</span><span class="params">(String msg)</span></span>;    <span class="comment">// 联系警报中心</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">recordLog</span><span class="params">(String msg)</span></span>;             <span class="comment">// 在警报中心留下记录</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现抽象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SafeFrame</span> <span class="keyword">implements</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> State state = DayState.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置时间</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClock</span><span class="params">(<span class="keyword">int</span> hour)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        state.doClock(<span class="keyword">this</span>, hour);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(Integer e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="number">1</span>) &#123;           <span class="comment">// 金库使用按钮</span></span><br><span class="line">            state.doUse(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e == <span class="number">2</span>) &#123;  <span class="comment">// 按下警铃按钮</span></span><br><span class="line">            state.doAlarm(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e == <span class="number">3</span>) &#123;  <span class="comment">// 正常通话按钮</span></span><br><span class="line">            state.doPhone(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e == <span class="number">4</span>) &#123;   <span class="comment">// 结束按钮</span></span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 改变状态</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        System.out.println(<span class="string">&quot;从&quot;</span> + <span class="keyword">this</span>.state + <span class="string">&quot;状態变为了&quot;</span> + state + <span class="string">&quot;状态。&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 联系警报中心</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callSecurityCenter</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;call! &quot;</span> + msg + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在警报中心留下记录</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordLog</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;record ... &quot;</span> + msg + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SafeFrame frame = <span class="keyword">new</span> SafeFrame();</span><br><span class="line">        frame.setClock(<span class="number">18</span>);</span><br><span class="line">        frame.actionPerformed(<span class="number">1</span>);</span><br><span class="line">        frame.actionPerformed(<span class="number">2</span>);</span><br><span class="line">        frame.actionPerformed(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>硬件级别的缓存对程序的影响</title>
    <url>/2021/06/25/%E7%A1%AC%E4%BB%B6%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98%E5%AF%B9%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%BD%B1%E5%93%8D/</url>
    <content><![CDATA[<h3 id="硬件级别的缓存对程序的影响"><a href="#硬件级别的缓存对程序的影响" class="headerlink" title="硬件级别的缓存对程序的影响"></a>硬件级别的缓存对程序的影响</h3><p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.png" alt="三级缓存"></p>
<h4 id="JVM-合并写-write-combining"><a href="#JVM-合并写-write-combining" class="headerlink" title="JVM-合并写(write combining)"></a>JVM-合并写(write combining)</h4><blockquote>
<p>当cpu修改了某值后会把数据线存入L1中，这个时候可能没有命中，则会一往下查找，会写入到L2中，此时，由于往L2中写的时候需要大量的时间，同时这个变量还可能继续被修改，此时会用到合并写的技术，所谓合并写就是把两次的写的结果一次进行写出。<br>这里会用到合并写的地址空间(WCBuffer)，在64位的操作系统中一共4个字节，也就是如果我们的修改在4个字节以内，则会使用到合并写的技术，如果超过4个字节，则无法使用到合写的红利。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WriteCombining</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ITERATIONS = Integer.MAX_VALUE;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ITEMS = <span class="number">1</span> &lt;&lt; <span class="number">24</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MASK = ITEMS - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] arrayA = <span class="keyword">new</span> <span class="keyword">byte</span>[ITEMS];</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] arrayB = <span class="keyword">new</span> <span class="keyword">byte</span>[ITEMS];</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] arrayC = <span class="keyword">new</span> <span class="keyword">byte</span>[ITEMS];</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] arrayD = <span class="keyword">new</span> <span class="keyword">byte</span>[ITEMS];</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] arrayE = <span class="keyword">new</span> <span class="keyword">byte</span>[ITEMS];</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] arrayF = <span class="keyword">new</span> <span class="keyword">byte</span>[ITEMS];</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) &#123;</span><br><span class="line">           System.out.println(i + <span class="string">&quot; SingleLoop duration (ns) = &quot;</span> + runCaseOne()/<span class="number">10000</span>);</span><br><span class="line">           System.out.println(i + <span class="string">&quot; SplitLoop  duration (ns) = &quot;</span> + runCaseTwo()/<span class="number">10000</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">runCaseOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">       <span class="keyword">int</span> i = ITERATIONS;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span> (--i != <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">int</span> slot = i &amp; MASK;</span><br><span class="line">           <span class="keyword">byte</span> b = (<span class="keyword">byte</span>) i;</span><br><span class="line">           arrayA[slot] = b;</span><br><span class="line">           arrayB[slot] = b;</span><br><span class="line">           arrayC[slot] = b;</span><br><span class="line">           arrayD[slot] = b;</span><br><span class="line">           arrayE[slot] = b;</span><br><span class="line">           arrayF[slot] = b;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> System.nanoTime() - start;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">runCaseTwo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">       <span class="keyword">int</span> i = ITERATIONS;</span><br><span class="line">       <span class="keyword">while</span> (--i != <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">int</span> slot = i &amp; MASK;</span><br><span class="line">           <span class="keyword">byte</span> b = (<span class="keyword">byte</span>) i;</span><br><span class="line">           arrayA[slot] = b;</span><br><span class="line">           arrayB[slot] = b;</span><br><span class="line">           arrayC[slot] = b;</span><br><span class="line">       &#125;</span><br><span class="line">       i = ITERATIONS;</span><br><span class="line">       <span class="keyword">while</span> (--i != <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">int</span> slot = i &amp; MASK;</span><br><span class="line">           <span class="keyword">byte</span> b = (<span class="keyword">byte</span>) i;</span><br><span class="line">           arrayD[slot] = b;</span><br><span class="line">           arrayE[slot] = b;</span><br><span class="line">           arrayF[slot] = b;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> System.nanoTime() - start;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function">SingleLoop <span class="title">duration</span> <span class="params">(ns)</span> </span>= <span class="number">428328</span></span><br><span class="line"><span class="number">1</span> <span class="function">SplitLoop  <span class="title">duration</span> <span class="params">(ns)</span> </span>= <span class="number">415759</span></span><br></pre></td></tr></table></figure>

<p><strong>runCaseTwo</strong></p>
<p>runCaseTwo写的过程是一次四个字节写入，注意b占一个字节</p>
<p><strong>runCaseOne</strong></p>
<p>runCaseOne写的过程是第一次循环下来写入四个字节，然后将剩余的三个字节放入到wc缓存中，等待第二次while的进入，第二次循环进入后在分割出一个字节放入wc中写入告诉缓存，一次类推，所以它比较慢。</p>
<h4 id="JVM-Cache-Line、缓存对齐、伪共享"><a href="#JVM-Cache-Line、缓存对齐、伪共享" class="headerlink" title="JVM-Cache Line、缓存对齐、伪共享"></a>JVM-Cache Line、缓存对齐、伪共享</h4><p>由于寄存器的速度是非常快的，是内存的100被，是硬盘的10的六次方倍。<br>所以cpu读取数据，吸纳从寄存器中读取，如果无，则一次L1\L2\L3读取。</p>
<p><strong>cache line 缓存行</strong></p>
<p>那么系统读取数据是需要什么读取什么吗？当然是的，但是由于缓存行的存在，他会都去更多的数据。比如读取一个int类型4个字节的数据，他会把这四个字节后面的60个字节都读进去，即每次读64个字节的数据。这就是<code>缓存行cache line</code></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/%E7%BC%93%E5%AD%98%E8%A1%8C%E5%AF%B9%E9%BD%90.png" alt="缓存行"></p>
<p>场景：<br>在多核cpu读取数据的时候：</p>
<p>core1 读取了x=1的数据，不好意思，由于cache line的存在，他需要把后面的y=2联通后面的数据一读进core1中；<br>core2 读取了y=2的数据，不好意思，由于cache line的存在，他需要把后面的x=1联通后面的数据一读进core2中；<br>此时core1 对x=1做了运算是的x=11<br>此时core2 对y=2做了运算是的x=22</p>
<p>下你在在core1和core2中的数据如下：</p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/cachline.png" alt="伪对齐"></p>
<p>我们发现出现了数据不一致的问题。关于数据不一致问题，这就是伪<code>共享的问题</code>。</p>
<p><strong>缓存对齐可以提高效率</strong></p>
<p>知道了cache line的存在，我们在写代码的时候可以利用缓存对齐（就是每次64字节）的方式去提供效率，真的可以吗？<br>如果每次不是64个字节，需要等待到了64个字节才会写入缓存哦！中间有等待的时间，是的效率下降。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">One</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">T</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">long</span> x = <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//含有两个Long类型的数据，每个8个字节，大概率会加载到同一个cpu中。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T[] arr = <span class="keyword">new</span> T[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        arr[<span class="number">0</span>] = <span class="keyword">new</span> T();</span><br><span class="line">        arr[<span class="number">1</span>] = <span class="keyword">new</span> T();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//线程t1修改第一个long 在core1中 由于一致性的存在，需要一个机制做一致性，影响效率</span></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">0</span>; i &lt; <span class="number">1000_0000L</span>; i++) &#123;</span><br><span class="line">                arr[<span class="number">0</span>].x = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//线程t2修改第一个long 在core2中 由于一致性的存在，需要一个机制做一致性，影响效率</span></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">0</span>; i &lt; <span class="number">1000_0000L</span>; i++) &#123;</span><br><span class="line">                arr[<span class="number">1</span>].x = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println((System.nanoTime() - start)/<span class="number">100_0000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>缓存对齐时效率高，不存在伪共享</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Two</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Padding</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">long</span> p1, p2, p3, p4, p5, p6, p7;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//继承Padding ,内衣金含有p1, p2, p3, p4, p5, p6, p7 56个字节的数据了，再加上 long x 大概路占用了一个缓存行，</span></span><br><span class="line">    <span class="comment">//线程2 按到T的时候前面也有p1, p2, p3, p4, p5, p6, p7 56个字节的数据了，后面才是long  x 所以 一定不存在为共享的问题，也就不存在某机制保证</span></span><br><span class="line">    <span class="comment">//一致性的问题了。效率会高</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">T</span> <span class="keyword">extends</span> <span class="title">Padding</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">long</span> x = <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T[] arr = <span class="keyword">new</span> T[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        arr[<span class="number">0</span>] = <span class="keyword">new</span> T();</span><br><span class="line">        arr[<span class="number">1</span>] = <span class="keyword">new</span> T();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">0</span>; i &lt; <span class="number">1000_0000L</span>; i++) &#123;</span><br><span class="line">                arr[<span class="number">0</span>].x = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">0</span>; i &lt; <span class="number">1000_0000L</span>; i++) &#123;</span><br><span class="line">                arr[<span class="number">1</span>].x = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println((System.nanoTime() - start)/<span class="number">100_0000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>伪共享问题引出数据一致性问题</strong></p>
<p>数据一致性问题解决方案<br>针对一致性的问题有两种解决方案：</p>
<p>总线锁:在L3和L2直接加锁，拿到锁才能处理下面工作。<br>一致性协议MESI（缓存一致性协议)</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>策略者设计模式</title>
    <url>/2020/12/08/%E7%AD%96%E7%95%A5%E8%80%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="策略者设计模式-StrategyPattern"><a href="#策略者设计模式-StrategyPattern" class="headerlink" title="策略者设计模式 (StrategyPattern)"></a>策略者设计模式 (StrategyPattern)</h4><p><strong>描述：</strong>  策略者解决的是在多种算法相似的情况下，使用if….else…ss等所带来的的复杂代码。解决的思路是，将这些算法的代码封装成一个一个的类，实现统一接口。</p>
<p><strong>核心思想：</strong> 策略设计模式就是 实现一种策略 展示不同的结果</p>
<p><strong>使用场景：</strong> 有多种动物需要对它们进行排序，但每种动物的排序规则都不一样 此时我们就会写很多的if() 判断语句  此时就可以使用策略者设计模式</p>
<p><strong>策略者设计模式的优点：</strong></p>
<ul>
<li>算法可以自由的切换</li>
<li>减少多重判断的使用</li>
<li>扩展性好</li>
</ul>
<p><strong>策略者设计模式的缺点：</strong></p>
<ul>
<li>策略类都会暴露在外，客户端都要知道每个策略算法的区别</li>
<li>如果系统中的的算法种类很多的话 策略类会爆炸式增长，不便于维护</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>猫的对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span>  String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="title">Cat</span><span class="params">(Integer age,String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name=name;</span><br><span class="line">        <span class="keyword">this</span>.age=age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li> 抽象算法规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">compare</span><span class="params">(T o1, T o2)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>猫的算法规则实现类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatSort</span> <span class="keyword">implements</span>  <span class="title">Comparator</span>&lt;<span class="title">Cat</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Cat o1, Cat o2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(o1.getName().compareTo(o2.getName())&gt;<span class="number">0</span>)  <span class="keyword">return</span>  <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span>  <span class="keyword">if</span>(o1.getName().compareTo(o2.getName())==<span class="number">0</span>)&#123;</span><br><span class="line">             <span class="keyword">if</span>(o1.getAge().compareTo(o2.getAge())&gt;<span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">             <span class="keyword">else</span>  <span class="keyword">if</span>(o1.getAge().compareTo(o2.getAge())&lt;<span class="number">0</span>) <span class="keyword">return</span>  -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>统一的算法</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertSort</span><span class="params">(T[] arr, Comparator&lt;T&gt; comparator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">            T temp = arr[i];</span><br><span class="line">            <span class="keyword">int</span> j = i;</span><br><span class="line">            <span class="keyword">for</span> (; j &gt; <span class="number">0</span> &amp;&amp; comparator.compare(arr[j - <span class="number">1</span>], temp) &gt; <span class="number">0</span>; ) &#123;</span><br><span class="line">                arr[j] = arr[j - <span class="number">1</span>];</span><br><span class="line">                j--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (j != i) &#123;</span><br><span class="line">                arr[j] = temp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端的调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    test&lt;Cat&gt; cattest = <span class="keyword">new</span> test&lt;Cat&gt;();</span><br><span class="line">    Cat[] cat = &#123;<span class="keyword">new</span> Cat(<span class="number">2</span>, <span class="string">&quot;a&quot;</span>), <span class="keyword">new</span> Cat(<span class="number">3</span>, <span class="string">&quot;d&quot;</span>), <span class="keyword">new</span> Cat(<span class="number">4</span>, <span class="string">&quot;b&quot;</span>), <span class="keyword">new</span> Cat(<span class="number">6</span>, <span class="string">&quot;a&quot;</span>), <span class="keyword">new</span> Cat(<span class="number">3</span>, <span class="string">&quot;c&quot;</span>)&#125;;</span><br><span class="line">    cattest.insertSort(cat, <span class="keyword">new</span> CatSort());</span><br><span class="line">    System.out.println(Arrays.toString(cat));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p>此处的主要思想就是使用的向上转型的思想，比如我以上的方法想要在加几个猫的排序规则，那么此时我只需要实现排序规则的接口就可以了，不需要改动其他的代码，主要就是我的排序算法insertSort（）使用是父类的Comparator接收的参数，只要实现了它，是它的子类，那么你就可以自由任意切换各种算法。</p>
<p><strong>附图：</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/%E7%AD%96%E7%95%A5%E8%80%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8FUml.png" alt="策略者设计模式UML"></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>组合设计模式</title>
    <url>/2020/12/20/%E7%BB%84%E5%90%88%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="组合设计模式-Composite-Pattern"><a href="#组合设计模式-Composite-Pattern" class="headerlink" title="组合设计模式(Composite Pattern)"></a>组合设计模式(Composite Pattern)</h4><p><strong>描述：</strong> 组合设计模式又叫部分整体模式，是用于把一组相似的对象当作一个单一的对象。组合模式依据树形结构来组合对象，用来表时部分以及整体层次。这种类型的设计模式属于结构型模式，它创建了对象的树形结构</p>
<p><strong>核心思想：</strong> 将对象组合成树形结构以表示“部分—整体”的层次结构。组合模式使得用户对单个对象和组合对象的使用一致性。</p>
<p><strong>使用场景：</strong></p>
<ul>
<li>您想表示的部分-整体层次结构</li>
<li>您希望用户忽略组合对象与单个对象的不同，用户将统一的使用组合结构中的所有对象</li>
</ul>
<p><strong>组合设计模式的优点：</strong> </p>
<ul>
<li>高层模块表用简单</li>
<li>节点自由增加</li>
</ul>
<p><strong>组合设计模式的缺点：</strong></p>
<ul>
<li>在使用组合模式时，其叶子和树枝的声明都是实现类，而不是接口，违反了依赖倒置原则。</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>创建一个对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String dept;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> salary;</span><br><span class="line">   <span class="keyword">private</span> List&lt;Employee&gt; subordinates;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">//构造函数</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(String name,String dept, <span class="keyword">int</span> sal)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.name = name;</span><br><span class="line">      <span class="keyword">this</span>.dept = dept;</span><br><span class="line">      <span class="keyword">this</span>.salary = sal;</span><br><span class="line">      subordinates = <span class="keyword">new</span> ArrayList&lt;Employee&gt;();</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Employee e)</span> </span>&#123;</span><br><span class="line">      subordinates.add(e);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Employee e)</span> </span>&#123;</span><br><span class="line">      subordinates.remove(e);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;Employee&gt; <span class="title">getSubordinates</span><span class="params">()</span></span>&#123;</span><br><span class="line">     <span class="keyword">return</span> subordinates;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (<span class="string">&quot;Employee :[ Name : &quot;</span>+ name </span><br><span class="line">      +<span class="string">&quot;, dept : &quot;</span>+ dept + <span class="string">&quot;, salary :&quot;</span></span><br><span class="line">      + salary+<span class="string">&quot; ]&quot;</span>);</span><br><span class="line">   &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositePatternDemo</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      Employee CEO = <span class="keyword">new</span> Employee(<span class="string">&quot;John&quot;</span>,<span class="string">&quot;CEO&quot;</span>, <span class="number">30000</span>);</span><br><span class="line"> </span><br><span class="line">      Employee headSales = <span class="keyword">new</span> Employee(<span class="string">&quot;Robert&quot;</span>,<span class="string">&quot;Head Sales&quot;</span>, <span class="number">20000</span>);</span><br><span class="line"> </span><br><span class="line">      Employee headMarketing = <span class="keyword">new</span> Employee(<span class="string">&quot;Michel&quot;</span>,<span class="string">&quot;Head Marketing&quot;</span>, <span class="number">20000</span>);</span><br><span class="line"> </span><br><span class="line">      Employee clerk1 = <span class="keyword">new</span> Employee(<span class="string">&quot;Laura&quot;</span>,<span class="string">&quot;Marketing&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">      Employee clerk2 = <span class="keyword">new</span> Employee(<span class="string">&quot;Bob&quot;</span>,<span class="string">&quot;Marketing&quot;</span>, <span class="number">10000</span>);</span><br><span class="line"> </span><br><span class="line">      Employee salesExecutive1 = <span class="keyword">new</span> Employee(<span class="string">&quot;Richard&quot;</span>,<span class="string">&quot;Sales&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">      Employee salesExecutive2 = <span class="keyword">new</span> Employee(<span class="string">&quot;Rob&quot;</span>,<span class="string">&quot;Sales&quot;</span>, <span class="number">10000</span>);</span><br><span class="line"> </span><br><span class="line">      CEO.add(headSales);</span><br><span class="line">      CEO.add(headMarketing);</span><br><span class="line"> </span><br><span class="line">      headSales.add(salesExecutive1);</span><br><span class="line">      headSales.add(salesExecutive2);</span><br><span class="line"> </span><br><span class="line">      headMarketing.add(clerk1);</span><br><span class="line">      headMarketing.add(clerk2);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">//打印该组织的所有员工</span></span><br><span class="line">      System.out.println(CEO); </span><br><span class="line">      <span class="keyword">for</span> (Employee headEmployee : CEO.getSubordinates()) &#123;</span><br><span class="line">         System.out.println(headEmployee);</span><br><span class="line">         <span class="keyword">for</span> (Employee employee : headEmployee.getSubordinates()) &#123;</span><br><span class="line">            System.out.println(employee);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;        </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>缓存的过期策略</title>
    <url>/2021/04/14/%E7%BC%93%E5%AD%98%E7%9A%84%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5/</url>
    <content><![CDATA[<h3 id="缓存的过期策略LFU-FIFO-LRU"><a href="#缓存的过期策略LFU-FIFO-LRU" class="headerlink" title="缓存的过期策略LFU,FIFO,LRU"></a>缓存的过期策略LFU,FIFO,LRU</h3><ul>
<li><strong>FIFO（First In First out）：先见先出，淘汰最先近来的页面，新进来的页面最迟被淘汰，完全符合队列。</strong></li>
</ul>
<p>按照“先进先出（First In，First Out）”的原理淘汰数据，正好符合队列的特性，数据结构上使用队列Queue来实现。<br> 新访问的数据插入FIFO队列尾部，数据在FIFO队列中顺序移动；<br> 淘汰FIFO队列头部的数据；</p>
<ul>
<li><strong>LRU（Least recently used）:最近最少使用，淘汰最近不使用的页面</strong></li>
</ul>
<p>（Least recently used，最近最少使用）<a href="http://lib.csdn.net/base/datastructure">算法</a>根据数据的历史访问记录来进行淘汰数据，其核心思想是“如果数据最近被访问过，那么将来被访问的几率也更高”。<br>最常见的实现是使用一个链表保存缓存数据 ,<br>  新数据插入到链表头部；<br> 每当缓存命中（即缓存数据被访问），则将数据移到链表头部；<br> 当链表满的时候，将链表尾部的数据丢弃。</p>
<ul>
<li><strong>LFU（Least frequently used）: 最近使用次数最少， 淘汰使用次数最少的页面</strong></li>
</ul>
<p>（Least Frequently Used）算法根据数据的历史访问频率来淘汰数据，其核心思想是“如果数据过去被访问多次，那么将来被访问的频率也更高”。<br>LFU的每个数据块都有一个引用计数，所有数据块按照引用计数排序，具有相同引用计数的数据块则按照时间排序。</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>缓存</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>网络OSI七层模型理解</title>
    <url>/2021/03/21/%E7%BD%91%E7%BB%9COSI%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B%E7%90%86%E8%A7%A3/</url>
    <content><![CDATA[<h3 id="网络OSI七层模型"><a href="#网络OSI七层模型" class="headerlink" title="网络OSI七层模型"></a>网络OSI七层模型</h3><p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/data/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9Cosi%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B.png" alt="网络osi七层模型"></p>
<ul>
<li>应用层<br>网络服务与最终用户的一个接口。<br>协议有：HTTP FTP TFTP SMTP SNMP DNS TELNET HTTPS POP3 DHCP</li>
<li>表示层<br>数据的表示、安全、压缩。（在五层模型里面已经合并到了应用层）<br>格式有，JPEG、ASCll、EBCDIC、加密格式等 [2]</li>
<li>会话层<br>建立、管理、终止会话。（在五层模型里面已经合并到了应用层）<br>对应主机进程，指本地主机与远程主机正在进行的会话</li>
<li>传输层<br>定义传输数据的协议端口号，以及流控和差错校验。<br>协议有：TCP UDP，数据包一旦离开网卡即进入网络传输层</li>
<li>网络层<br>进行逻辑地址寻址，实现不同网络之间的路径选择。<br>协议有：ICMP IGMP IP（IPV4 IPV6）</li>
<li>数据链路层<br>建立逻辑连接、进行硬件地址寻址、差错校验 [3]  等功能。（由底层网络定义协议）<br>将比特组合成字节进而组合成帧，用MAC地址访问介质，错误发现但不能纠正。</li>
<li>物理层<br>建立、维护、断开物理连接。（由底层网络定义协议）</li>
</ul>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>网络</category>
      </categories>
      <tags>
        <tag>网络</tag>
      </tags>
  </entry>
  <entry>
    <title>装饰器设计模式</title>
    <url>/2020/12/13/%E8%A3%85%E9%A5%B0%E5%99%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="装饰器设计模式-Decorator-Pattern"><a href="#装饰器设计模式-Decorator-Pattern" class="headerlink" title="装饰器设计模式(Decorator Pattern)"></a>装饰器设计模式(Decorator Pattern)</h4><p><strong>描述：</strong> 装饰器设计模式就是给对象动态的添加职责，行为的，它是用来代替继承的。相比于继承它更显得灵活。</p>
<p><strong>核心思想：</strong> 一般情况下当我们要扩展一个类的时候会使用继承，但这不是很安全，随着功能的增加子类会爆炸式的增长。</p>
<p><strong>装饰器设计模式的优点：</strong> 装饰类和被装饰类可以独立发展，不会相互耦合，装饰模式是继承的一个替代模式，装饰模式可以动态扩展一个实现类的功能</p>
<p><strong>装饰器设计模式的缺点：</strong> 多层装饰比较复杂。</p>
<p><strong>装饰器设计模式的使用场景：</strong>  </p>
<ul>
<li>扩展一个类的功能。 </li>
<li>动态增加功能，动态撤销</li>
</ul>
<p><strong>示例:</strong></p>
<ul>
<li>动物的抽象接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 一个吃的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span>  <span class="title">eat</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>猫实现动物接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span>  <span class="keyword">implements</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;wo是猫，在吃饭&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>装饰器的抽象类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CatDecoractor</span> <span class="keyword">implements</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Animal animal;</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="title">CatDecoractor</span><span class="params">(Animal animal)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.animal=animal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        animal.eat();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li> 现在给猫扩展一个喝水的方法  </li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatDecoractorImpl</span>  <span class="keyword">extends</span>  <span class="title">CatDecoractor</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  Animal animal;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CatDecoractorImpl</span><span class="params">(Animal animal)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(animal);</span><br><span class="line">        <span class="keyword">this</span>.animal=animal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        animal.eat();</span><br><span class="line">        drinking(animal);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">drinking</span><span class="params">(Animal animal)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;吃完之后在喝水&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Cat cat = <span class="keyword">new</span> Cat();</span><br><span class="line">        CatDecoractorImpl catDecoractor = <span class="keyword">new</span> CatDecoractorImpl(cat);</span><br><span class="line">        catDecoractor.eat();</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>附图：</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/%E8%A3%85%E9%A5%B0%E5%99%A8%E7%B1%BB%E5%9B%BE.png" alt="装饰器设计模式UML"></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>观察者设计模式</title>
    <url>/2020/12/14/%E8%A7%82%E5%AF%9F%E8%80%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="观察者设计模式-Observer-Pattern"><a href="#观察者设计模式-Observer-Pattern" class="headerlink" title="观察者设计模式(Observer Pattern)"></a>观察者设计模式(Observer Pattern)</h4><p><strong>描述：</strong> 当对象存在一对多的关系时，使用观察者设计模式。比如一个对象被修改时，则会通知依赖他的对象。观察者设计模式属于行为行设计模式</p>
<p><strong>核心思想：</strong> 当一个对象发生变化时通知其他依赖它的对象</p>
<p><strong>使用场景：</strong> </p>
<ul>
<li><p>一个对象改变一个或多个对象也发生变化，而不知道有多少对象发生变化，降低对象之间的耦合度。</p>
</li>
<li><p>一个对象必须通知其他的对象，而不知道这些对象都有谁</p>
</li>
<li><p>需要在系统中创建一个触发链，A对象的行为将影响B对象，B对象的行为将影响C对象……，可以使用观察者模式创建一种链式触发机制</p>
</li>
<li><p>一个抽象模型有两个方面，其中一个方面依赖于另一个方面。将这些方面封装在独立的对象中使它们可以各自独立地改变和复用。</p>
</li>
</ul>
<p><strong>观察者设计模式优点：</strong> </p>
<ul>
<li>观察者和被观察者时抽象解耦的</li>
<li>建立一套触发机制</li>
</ul>
<p><strong>观察者设计模式缺点：</strong></p>
<ul>
<li>如果一个被观察者对象有很多的直接和间接的观察者的话，将所有的观察者都通知到会花费很多时间。</li>
<li>如果在观察者和观察目标之间有循环依赖的话，观察目标会触发它们之间进行循环调用，可能导致系统崩溃。</li>
<li>观察者模式没有相应的机制让观察者知道所观察的目标对象是怎么发生变化的，而仅仅只是知道观察目标发生了变化。</li>
</ul>
<p><strong>注意事项：</strong></p>
<ul>
<li>JAVA 中已经有了对观察者模式的支持类</li>
<li>避免循环引用</li>
<li>如果顺序执行，某一观察者会导致系统卡壳，一般采用异步的方式</li>
</ul>
<p><strong>示例：</strong></p>
<p>现有一个需求，有一个天气预报系统，获取天气对象，三个字段，温度 ， 湿度， 气压，当它们的数值发生变化时通知到布告板展现出来 </p>
<ul>
<li>抽象出主题接口对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 主题（发布者、被观察者）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="comment">//注册一个观察者进来</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerObserver</span><span class="params">(Observer o)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除一个观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer o)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通知其他观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>抽象观察者的对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;   </span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temp, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>抽象布告对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DisplayElement</span> </span>&#123;    <span class="comment">// 更换布告</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>被观察者的具体实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeatherData</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ArrayList observers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> temperature;<span class="comment">//温度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> humidity;<span class="comment">//湿度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> pressure;<span class="comment">//气压</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WeatherData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        observers = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册观察者     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerObserver</span><span class="params">(Observer o)</span> </span>&#123;</span><br><span class="line">        observers.add(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = observers.indexOf(o);</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            observers.remove(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通知各个观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; observers.size(); i++) &#123;</span><br><span class="line">            Observer observer = (Observer) observers.get(i);</span><br><span class="line">            observer.update(temperature, humidity, pressure);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measurementsChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        notifyObservers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMeasurements</span><span class="params">(<span class="keyword">float</span> temperature, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">        <span class="keyword">this</span>.humidity = humidity;</span><br><span class="line">        <span class="keyword">this</span>.pressure = pressure;</span><br><span class="line">        measurementsChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>显示当前天气的公告牌CurrentConditionsDisplay</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CurrentConditionsDisplay</span> <span class="keyword">implements</span> <span class="title">Observer</span>, <span class="title">DisplayElement</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> humidity;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> pressure;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temperature, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">        <span class="keyword">this</span>.humidity = humidity;</span><br><span class="line">        <span class="keyword">this</span>.pressure = pressure;</span><br><span class="line">        display();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;当前温度为：&quot;</span> + <span class="keyword">this</span>.temperature + <span class="string">&quot;℃&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;当前湿度为：&quot;</span> + <span class="keyword">this</span>.humidity);</span><br><span class="line">        System.out.println(<span class="string">&quot;当前气压为：&quot;</span> + <span class="keyword">this</span>.pressure);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>只显示温度和湿度的公告牌</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Current</span> <span class="keyword">implements</span> <span class="title">Observer</span>, <span class="title">DisplayElement</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> humidity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temperature, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">        <span class="keyword">this</span>.humidity = humidity;</span><br><span class="line">        display();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;当前温度为：&quot;</span> + <span class="keyword">this</span>.temperature + <span class="string">&quot;℃&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;当前湿度为：&quot;</span> + <span class="keyword">this</span>.humidity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    WeatherData weatherData = <span class="keyword">new</span> WeatherData();</span><br><span class="line">    weatherData.registerObserver(<span class="keyword">new</span> CurrentConditionsDisplay());</span><br><span class="line">    weatherData.registerObserver(<span class="keyword">new</span> Current());</span><br><span class="line">    weatherData.setMeasurements(<span class="number">80</span>, <span class="number">65</span>, <span class="number">30.4f</span>);</span><br><span class="line">    weatherData.setMeasurements(<span class="number">82</span>, <span class="number">70</span>, <span class="number">29.2f</span>);</span><br><span class="line">    weatherData.setMeasurements(<span class="number">78</span>, <span class="number">90</span>, <span class="number">29.2f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>附图：</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/%E8%A7%82%E5%AF%9F%E8%80%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8FUML.png" alt="观察者设计模式UML"></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>解释器设计模式</title>
    <url>/2020/12/25/%E8%A7%A3%E9%87%8A%E5%99%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="解释器设计模式-Interpreter-Pattern"><a href="#解释器设计模式-Interpreter-Pattern" class="headerlink" title="解释器设计模式(Interpreter Pattern)"></a>解释器设计模式(Interpreter Pattern)</h4><p><strong>描述：</strong> 解释器设计模式就是提供了评估语言的语法或表达式的方式，它属于行为型模式。这种模式实现了一个表达式接口，该接口解释一个特定的上下文。这种模式被用在 SQL 解析、符号处理引擎等。</p>
<p><strong>核心思想：</strong> 对于一些固定语法构建一个解释 语法 的解释器</p>
<p><strong>使用场景：</strong></p>
<ul>
<li>可以将一个需要解释执行的语言中的句子表示为一个抽象语法树。</li>
<li> 一些重复出现的问题可以用一种简单的语言来进行表达。 </li>
<li>一个简单语法需要解释的场景。</li>
</ul>
<p><strong>解释器设计模式的优点：</strong></p>
<ul>
<li>可扩展性比较好，灵活。 </li>
<li> 增加了新的解释表达式的方式。</li>
<li>易于实现简单文法。</li>
</ul>
<p><strong>解释器设计模式的缺点：</strong></p>
<ul>
<li>可利用场景比较少。 </li>
<li>对于复杂的文法比较难维护。 </li>
<li>解释器模式会引起类膨胀。 </li>
<li>解释器模式采用递归调用方法。</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>抽象出  表达式接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Interpreter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">interpret</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>相加表达式</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">AddInterpreter</span> <span class="keyword">implements</span> <span class="title">Interpreter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Interpreter firstExpression, secondExpression;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AddInterpreter</span> <span class="params">(Interpreter firstExpression, Interpreter secondExpression)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.firstExpression = firstExpression;</span><br><span class="line">        <span class="keyword">this</span>.secondExpression = secondExpression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">interpret</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.firstExpression.interpret() + <span class="keyword">this</span>.secondExpression.interpret();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;+&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>相乘表达式</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiInterpreter</span> <span class="keyword">implements</span> <span class="title">Interpreter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Interpreter firstExpression, secondExpression;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MultiInterpreter</span><span class="params">(Interpreter firstExpression, Interpreter secondExpression)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.firstExpression = firstExpression;</span><br><span class="line">        <span class="keyword">this</span>.secondExpression = secondExpression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">interpret</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.firstExpression.interpret() * <span class="keyword">this</span>.secondExpression.interpret();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;*&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>数值表达式</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">NumberInterpreter</span> <span class="keyword">implements</span> <span class="title">Interpreter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NumberInterpreter</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NumberInterpreter</span><span class="params">(String number)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = Integer.parseInt(number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">interpret</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>格式化</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExpressionParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Stack&lt;Interpreter&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">parse</span> <span class="params">(String expression)</span> </span>&#123;</span><br><span class="line">        String[] itemArray = expression.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String symbol : itemArray) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!OperatorUtil.isOperator(symbol)) &#123;</span><br><span class="line">                Interpreter numberExpression = <span class="keyword">new</span> NumberInterpreter(symbol);</span><br><span class="line">                stack.push(numberExpression);</span><br><span class="line">                System.out.println(String.format(<span class="string">&quot;入栈： %d&quot;</span>, numberExpression.interpret()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//是运算符可以计算</span></span><br><span class="line">                Interpreter firstExpression = stack.pop();</span><br><span class="line">                Interpreter secondExpression = stack.pop();</span><br><span class="line">                System.out.println(String.format(<span class="string">&quot;出栈：%d 和 %d&quot;</span>, firstExpression.interpret(),</span><br><span class="line">                        secondExpression.interpret()));</span><br><span class="line">                Interpreter operator = OperatorUtil.getExpression(firstExpression, secondExpression, symbol);</span><br><span class="line">                System.out.println(String.format(<span class="string">&quot;应用运算符: %s&quot;</span>, operator));</span><br><span class="line">                <span class="keyword">int</span> result = operator.interpret();</span><br><span class="line">                NumberInterpreter numberInterpreter = <span class="keyword">new</span> NumberInterpreter(result);</span><br><span class="line">                stack.push(numberInterpreter);</span><br><span class="line">                System.out.println(String.format(<span class="string">&quot;阶段结果入栈: %d&quot;</span>, result));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stack.pop().interpret();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>工具类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lass OperatorUtil &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isOperator</span><span class="params">(String symbol)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (symbol.equals(<span class="string">&quot;+&quot;</span>) || symbol.equals(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Interpreter <span class="title">getExpression</span><span class="params">(Interpreter first,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            Interpreter second,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            String symbol)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (symbol) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;+&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> AddInterpreter(first, second);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;*&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> MultiInterpreter(first, second);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String input = <span class="string">&quot;6 100 11 + *&quot;</span>;</span><br><span class="line">        ExpressionParser parser = <span class="keyword">new</span> ExpressionParser();</span><br><span class="line">        <span class="keyword">int</span> result = parser.parse(input);</span><br><span class="line">        System.out.println(<span class="string">&quot;解释器运算结果：&quot;</span> + result);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>访问者设计模式</title>
    <url>/2021/01/07/%E8%AE%BF%E9%97%AE%E8%80%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="访问者设计模式-Vistor-Pattern"><a href="#访问者设计模式-Vistor-Pattern" class="headerlink" title="访问者设计模式(Vistor Pattern)"></a>访问者设计模式(Vistor Pattern)</h4><p><strong>描述：</strong></p>
<p><strong>核心思想：</strong></p>
<p><strong>使用场景：</strong></p>
<p><strong>访问者设计模式的优点：</strong></p>
<p><strong>访问者设计模式的缺点：</strong></p>
<p><strong>示例：</strong></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>责任链设计模式</title>
    <url>/2020/12/14/%E8%B4%A3%E4%BB%BB%E9%93%BE%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="责任链设计模式-Chain-of-Responsibility-Pattern"><a href="#责任链设计模式-Chain-of-Responsibility-Pattern" class="headerlink" title="责任链设计模式(Chain of Responsibility Pattern)"></a>责任链设计模式(Chain of Responsibility Pattern)</h4><p><strong>描述：</strong> 责任链设计模式属于行为型模式，在这种模式中通常每个接收者都包含对另一个接收者的调用。</p>
<p>从而形成链式调用</p>
<p><strong>核心思想：</strong> 避免请求发送者于接收者耦合在一起，让多个都有可能接收请求，将这些对象链接成一条链，并且沿着这条链传递请求。直到对象处理完为止。</p>
<p><strong>使用场景：</strong> </p>
<ul>
<li>有多个对象可以处理同一个请求，具体那个对象处理改请求由运行时决定</li>
<li>在不明确指定接收者的情况下，向多个对象中的一个对象提交一个请求</li>
<li>可动态的指定一组对象处理请求</li>
</ul>
<p><strong>责任链设计模式的优点：</strong></p>
<ul>
<li>降低耦合度。它将请求的发送者和接收者解耦。 </li>
<li>简化了对象。使得对象不需要知道链的结构。 </li>
<li>增强给对象指派职责的灵活性。通过改变链内的成员或者调动它们的次序，允许动态地新增或者删除责任。 </li>
<li>增加新的请求处理类很方便。</li>
</ul>
<p><strong>责任链设计模式的缺点：</strong></p>
<ul>
<li>不能保证请求一定被接收。</li>
<li>系统性能将受到一定影响，而且在进行代码调试时不太方便，可能会造成循环调用。 </li>
<li>可能不容易观察运行时的特征，有碍于除错。</li>
</ul>
<p><strong>示例：</strong></p>
<p><strong>现在有需求有一个字符串需要对它进行处理， 替换敏感字符， 特殊符号进行特殊的处理</strong></p>
<ul>
<li>定义一个字符串</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Msg</span></span>&#123;</span><br><span class="line">    String name;</span><br><span class="line">    String msg;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Msg&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;msg=&#x27;&quot;</span> + msg + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>字符串处理的抽象</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Filter</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Msg m)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>做一个链式调用的类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterChain</span> <span class="keyword">implements</span> <span class="title">Filter</span></span>&#123;</span><br><span class="line">    List&lt;Filter&gt; filters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterChain <span class="title">add</span><span class="params">(Filter f)</span></span>&#123;</span><br><span class="line">        filters.add(f);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doFilter</span><span class="params">(Msg m)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Filter f : filters)&#123;</span><br><span class="line">            <span class="keyword">if</span> (!f.doFilter(m)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>特殊符号进行特殊的处理</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTMLFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doFilter</span><span class="params">(Msg m)</span> </span>&#123;</span><br><span class="line">        String r = m.getMsg();</span><br><span class="line">        <span class="keyword">if</span>(r == <span class="keyword">null</span> )&#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        r = r.replace(<span class="string">&#x27;&lt;&#x27;</span>,<span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">        r = r.replace(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">        m.setMsg(r);</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>敏感字符进行处理</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SensitiveFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doFilter</span><span class="params">(Msg msg)</span> </span>&#123;</span><br><span class="line">        String r = msg.getMsg();</span><br><span class="line">        <span class="keyword">if</span>(r == <span class="keyword">null</span> )&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//处理msg，对敏感词进行替换</span></span><br><span class="line">        r = r.replaceAll(<span class="string">&quot;996&quot;</span>,<span class="string">&quot;955&quot;</span>);</span><br><span class="line">        msg.setMsg(r);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Msg msg = <span class="keyword">new</span> Msg();</span><br><span class="line">        msg.setMsg(<span class="string">&quot;大家好,&lt;我是智翁&gt;,欢迎访问 www.yaozw.top,大家都是996&quot;</span>);</span><br><span class="line">        FilterChain filterChain = <span class="keyword">new</span> FilterChain();</span><br><span class="line">        filterChain.add(<span class="keyword">new</span> HTMLFilter()).add(<span class="keyword">new</span> SensitiveFilter());</span><br><span class="line">        <span class="keyword">boolean</span> ss = filterChain.doFilter(msg);</span><br><span class="line">        System.out.println(msg.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p><strong>封装需要进行变化的地方，在现在的实例中，我们需要封装的是字符串的处理逻辑。我们可以将这个逻辑抽象出来，并对其进行封装。</strong></p>
<p><strong>附图：</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/%E8%B4%A3%E4%BB%BB%E9%93%BEUML.png" alt="责任链设计模式"></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>迭代器设计模式</title>
    <url>/2020/12/23/%E8%BF%AD%E4%BB%A3%E5%99%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="迭代器设计模式-Iterator-Pattern"><a href="#迭代器设计模式-Iterator-Pattern" class="headerlink" title="迭代器设计模式(Iterator Pattern)"></a>迭代器设计模式(Iterator Pattern)</h4><p><strong>描述：</strong> 提供一种方法顺序访问一个聚合对象中各个元素，而又不暴露该对象的内部表示。</p>
<p><strong>核心思想：</strong> 使用不同的方式来遍历整个整合对象。 </p>
<p><strong>使用场景：</strong></p>
<ul>
<li>访问聚合对象的内容而无需暴露他的内部表示</li>
<li>需要为聚合对象提供多种访问方式</li>
<li>为便利不同的聚合结构提供一个统一的接口</li>
</ul>
<p><strong>迭代器设计模式的优点：</strong></p>
<ul>
<li>支持一不同的方式遍历一个聚合对象</li>
<li>迭代器简化了聚合类</li>
<li>在同一个聚合上可以有多个遍历</li>
<li>在迭代器设计模式中怎加新的聚合类和迭代类都很方便，无需修改源代码 , 符合开闭原则</li>
</ul>
<p><strong>迭代器设计模式的缺点：</strong></p>
<ul>
<li>由于迭代器模式将存储数据和遍历数据的职责分离，增加新的聚合类需要对应增加新的迭代器类，类的个数成对增加，这在一定程度上增加了系统的复杂性。</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li>定义迭代器接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">E  <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现迭代器</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIterator</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    E[] e;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyIterator</span><span class="params">(E[] e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.e = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; e.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.hasNext())&#123;</span><br><span class="line">            <span class="keyword">return</span> e[index++];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] str = &#123;<span class="string">&quot;nn&quot;</span>, <span class="string">&quot;jj&quot;</span>, <span class="string">&quot;PP&quot;</span>&#125;;</span><br><span class="line">        MyIterator nameRepository = <span class="keyword">new</span> MyIterator(str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (nameRepository.hasNext()) &#123;</span><br><span class="line">            System.out.println(nameRepository.next());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>适配器设计模式</title>
    <url>/2020/12/19/%E9%80%82%E9%85%8D%E5%99%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h4 id="适配器设计模式-adapter-pattern"><a href="#适配器设计模式-adapter-pattern" class="headerlink" title="适配器设计模式(adapter pattern)"></a>适配器设计模式(adapter pattern)</h4><p><strong>描述：</strong> 适配器设计模式主要用于接口的转化或者将接口不兼容的类对象组合在一起形成对外统一的接口，是一种结构性模式其本质是一种中间件，适用于类和对象。</p>
<p><strong>核心思想：</strong> 对现有的接口进行转化以符合新的需求</p>
<p><strong>使用场景：</strong> </p>
<ul>
<li>想用一个已经存在的类，但其接口不符合需求；</li>
<li>想创建一个可以复用的类，该类可以与其他不相关的类协同工作；</li>
<li>想使用一些已经存在的子类，但是不能对每一个都进行子类化以匹配它们的接口（仅适用于对象Adapter）。对象适配器可以适配他的父类接口。</li>
</ul>
<p><strong>适配器设计模式的优点：</strong> </p>
<ul>
<li>提高了类的复用；</li>
<li>组合若干关联对象形成对外提供统一服务的接口；</li>
<li>扩展性、灵活性好。</li>
</ul>
<p><strong>适配器设计模式的缺点：</strong></p>
<ul>
<li>过多使用适配模式容易造成代码功能和逻辑意义的混淆。</li>
<li>部分语言对继承的限制，可能至多只能适配一个适配者类，而且目标类必须是抽象类。</li>
</ul>
<p><strong>适配器设计模式的分类：</strong></p>
<ul>
<li>类适配器</li>
<li>对象适配器</li>
<li>接口适配器</li>
</ul>
<p><strong>示例：</strong></p>
<h5 id="类适配器"><a href="#类适配器" class="headerlink" title="类适配器"></a>类适配器</h5><ul>
<li> 定义目标接口类：Target</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Target</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li> 被适配的类：Adaptee</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adaptee</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adapteeRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;adapteeRequest method of Adaptee! &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>适配类Adapter，实现Target的接口request，同时继承Adaptee的实现adapteeRequest</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">extends</span> <span class="title">Adaptee</span> <span class="keyword">implements</span> <span class="title">Target</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        <span class="keyword">super</span>.adapteeRequest();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String [] args)</span> </span>&#123;</span><br><span class="line">        Target target = <span class="keyword">new</span> Adapter();</span><br><span class="line">        target.request(); <span class="comment">// result: adapteeRequest method of Adaptee! </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="对象适配器"><a href="#对象适配器" class="headerlink" title="对象适配器"></a>对象适配器</h5><ul>
<li>对象适配器和类适配器的主要区别就是<strong>类适配器的适配器类是继承被适配的类，对象适配器的适配器类是依赖被适配的类</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 适配器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">implements</span> <span class="title">Target</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Adaptee adaptee;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Adapter</span><span class="params">(Adaptee adaptee)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.adaptee = adaptee;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        adaptee.operation1();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;operation2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Adaptee adaptee = <span class="keyword">new</span> Adaptee();</span><br><span class="line">        Adapter adapter = <span class="keyword">new</span> Adapter(adaptee);</span><br><span class="line">        Client client = <span class="keyword">new</span> Client();</span><br><span class="line">        client.use(adapter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">use</span><span class="params">(Target target)</span></span>&#123;</span><br><span class="line">        target.operation1();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="接口适配器"><a href="#接口适配器" class="headerlink" title="接口适配器"></a>接口适配器</h5><ul>
<li><p><strong>核心思路：</strong>当不需要全部实现接口提供的方法时，可先设计一个抽象类实现接口，并为该接口中每个方法提供一个默认实现（空方法），那么该抽象类的子类可<strong>有选择地</strong>覆盖父类的某些方法来实现需求</p>
</li>
<li><p><strong>使用场景：</strong> 适用于一个接口不想使用其所有的方法的情况。</p>
</li>
<li><p> 定义目标接口类：Target</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Interface4</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m2</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m3</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m4</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义一个适配的中间抽象类 默认实现目标接口 以便它的子类有选择的实现</li>
</ul>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbsAdapter</span> <span class="keyword">implements</span> <span class="title">Interface4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//默认实现</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		AbsAdapter absAdapter = <span class="keyword">new</span> AbsAdapter() &#123;</span><br><span class="line">			<span class="comment">//只需要去覆盖我们 有需要地使用 接口方法</span></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">				System.out.println(<span class="string">&quot;使用了m1的方法&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		</span><br><span class="line">		absAdapter.m1();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>23种设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>面向对象的七大设计原则</title>
    <url>/2020/12/07/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/</url>
    <content><![CDATA[<h3 id="七大设计原则"><a href="#七大设计原则" class="headerlink" title="七大设计原则"></a>七大设计原则</h3><table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">英文名称</th>
<th align="center">简称</th>
</tr>
</thead>
<tbody><tr>
<td align="center">单一职责原则</td>
<td align="center">Single Responsibility Principle</td>
<td align="center">SRP</td>
</tr>
<tr>
<td align="center">里氏替换原则</td>
<td align="center">Liskov Substitution Principle</td>
<td align="center">LSP</td>
</tr>
<tr>
<td align="center">依赖倒置原则</td>
<td align="center">Dependence Inversion Principle</td>
<td align="center">DIP</td>
</tr>
<tr>
<td align="center">开闭原则</td>
<td align="center">OPen Closed Priciple</td>
<td align="center">OCP</td>
</tr>
<tr>
<td align="center">接口隔离原则</td>
<td align="center">Interface Segregation Principle</td>
<td align="center">ISP</td>
</tr>
<tr>
<td align="center">迪米特法则</td>
<td align="center">Law of Demete</td>
<td align="center">LOD</td>
</tr>
<tr>
<td align="center">组合/聚合复用原则</td>
<td align="center">Composite/Aggregate Reuse Principle</td>
<td align="center">CRP</td>
</tr>
</tbody></table>
<h4 id="1-单一职责原则"><a href="#1-单一职责原则" class="headerlink" title="1. 单一职责原则"></a>1. 单一职责原则</h4><p>​    <strong>描述：</strong> 一个方法只干一件事，一个类只干一件事，甚至一个模块专注于一件事。</p>
<p>​    <strong>特点：</strong> 一个类 一个方法被修改的机率很大，如果一个方法或者类中有好几个功能相互关联，修改一个功能会带来其他功能的变动， 因此在实现的过程中一个类或者一个方法因该只专注于做好一件事情，降低功能之间的关联。<strong>（高内聚，低耦合）</strong></p>
<h4 id="2-里氏替换原则"><a href="#2-里氏替换原则" class="headerlink" title="2.里氏替换原则"></a>2.里氏替换原则</h4><p>​    <strong>描述：</strong> 任何父类出现的地方都可以透明的替换为子类。</p>
<p>​    <strong>特点：</strong> 在继承的过程中子类可以扩展其特有的方法属性，但尽量不要重写父类的方法，继承给程序的设计带来了变利，但也带来的弊端，降低了类的可移值性，增加了对象间的耦合性，如果一个类被另外的一个类继承，那么此时修改父类必然要考虑到所有的子类会出现的故障。因此在使用继承的过程中必遵守里氏替换原则。<strong>（用来检验继承的正确性，约束继承在使用上的泛滥）</strong></p>
<h4 id="3-依赖倒置原则"><a href="#3-依赖倒置原则" class="headerlink" title="3. 依赖倒置原则"></a>3. 依赖倒置原则</h4><p>​     <strong>描述：</strong> 依赖于抽象， 抽象不能依赖于细节，细节应该依赖于抽象 ，高层模块不能依赖低层模块，二者都应该依赖抽象。</p>
<p>​     <strong>特点：</strong> 主要是针对接口编程， 而不是针对实现编程。通过抽象来搭建框架， 建立类和类之间的联系，<strong>减少类之间的耦合性，提高框架的扩展性，同时以便于框架的维护性</strong></p>
<h4 id="4-开闭原则"><a href="#4-开闭原则" class="headerlink" title="4. 开闭原则"></a>4. 开闭原则</h4><p>​      <strong>描述：</strong> 对于扩展开放， 修改关闭</p>
<p>​      <strong>特点：</strong> 当需要一个新功能的时候我们应改首先想到的是 在这个旧的功能上扩展一个新的功能出来，而不是修改原有的旧功，如果修改原有的旧功能这样做的风险很大，可能会导致系统的瘫痪。<strong>增强了程序的扩展性，同时也降低了程序的维护性</strong></p>
<h4 id="5-接口隔离原则"><a href="#5-接口隔离原则" class="headerlink" title="5. 接口隔离原则"></a>5. 接口隔离原则</h4><p>​        <strong>描述：</strong> 客户端的接口是分散的多个接口，而不是一个总的接口</p>
<p>​        **特点:  **  实现类不应该依赖于它不需要的接口，不要建立一个庞大且臃肿的接口，接口该改按照不同的功能或者业务尽可能的建立多个接口。注意也不能太过于的细化，这样会使设计复杂化。好处就是  <strong>避免一个接口中出现不同职责的方法，符合高内聚，低耦合的思想。</strong></p>
<h4 id="6-迪米特法则"><a href="#6-迪米特法则" class="headerlink" title="6.  迪米特法则"></a>6.  迪米特法则</h4><p>​         <strong>描述：</strong> 一个对象尽可能的少接触其他的对象，只和需要接触的对象进行接触</p>
<p>​         <strong>特点：</strong>  使用迪米特法则可以使类与类 之间的耦合降低，减少类与类之间的关联程度，让类与类之间的协作更加直接，提高了类的复用性。</p>
<h4 id="7-组合-聚合复用原则"><a href="#7-组合-聚合复用原则" class="headerlink" title="7.   组合/聚合复用原则"></a>7.   组合/聚合复用原则</h4><p>​          <strong>描述：</strong> 组合或者聚合优于继承</p>
<p>​         <strong>特点：</strong> 在类的构建过程中优先考虑组合或者聚合，继承的时候父类暴露给子类的信息太多，或导致如果需要修改父类，必然要考虑到子类，这也可以提高类的复用性。</p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>程序设计</category>
      </categories>
      <tags>
        <tag>七大设计原则</tag>
      </tags>
  </entry>
  <entry>
    <title>GC的基础知识</title>
    <url>/2021/06/20/GC%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<h1 id="GC和GC-Tuning"><a href="#GC和GC-Tuning" class="headerlink" title="GC和GC Tuning"></a>GC和GC Tuning</h1><h4 id="1-什么是垃圾"><a href="#1-什么是垃圾" class="headerlink" title="1.什么是垃圾"></a>1.什么是垃圾</h4><blockquote>
<p>没有任何引用指向的一个对象或者多个对象（循环引用）</p>
</blockquote>
<h4 id="2-如何定位垃圾"><a href="#2-如何定位垃圾" class="headerlink" title="2.如何定位垃圾"></a>2.如何定位垃圾</h4><blockquote>
<p>引用计数（ReferenceCount）</p>
<p>根可达算法(RootSearching)</p>
</blockquote>
<h4 id="3-GC-roots"><a href="#3-GC-roots" class="headerlink" title="3. GC roots"></a>3. GC roots</h4><blockquote>
<p>JVM stack  (jvm栈)</p>
<p>native method stack （本地方法栈）</p>
<p>run-time constant pool （常量池指向的变量）</p>
<p>static references in method artea （静态变量指向的对象）</p>
<p>Clazz  （对象字节load到内存）</p>
</blockquote>
<h4 id="3-常见的垃圾回收算法"><a href="#3-常见的垃圾回收算法" class="headerlink" title="3.常见的垃圾回收算法"></a>3.常见的垃圾回收算法</h4><blockquote>
<p>标记清除(mark sweep) - 位置不连续 产生碎片 效率偏低（两遍扫描）</p>
<p>拷贝算法 (copying) - 没有碎片，浪费空间</p>
<p>标记压缩(mark compact) - 没有碎片，效率偏低（两遍扫描，指针需要调整）</p>
</blockquote>
<h4 id="4-JVM内存分代模型（用于分代垃圾回收算法）"><a href="#4-JVM内存分代模型（用于分代垃圾回收算法）" class="headerlink" title="4.JVM内存分代模型（用于分代垃圾回收算法）"></a>4.JVM内存分代模型（用于分代垃圾回收算法）</h4><h4 id=""><a href="#" class="headerlink" title=""></a><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/gc/jvm%E5%88%86%E4%BB%A3%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png"></h4><p><strong>1. 部分垃圾回收器使用的模型</strong></p>
<blockquote>
<p>除Epsilon ZGC Shenandoah之外的GC都是使用逻辑分代模型</p>
<p>G1是逻辑分代，物理不分代</p>
<p>除此之外不仅逻辑分代，而且物理分代</p>
</blockquote>
<p><strong>2. 新生代 + 老年代 + 永久代（1.7）Perm Generation/ 元数据区(1.8) Metaspace</strong></p>
<blockquote>
<p>永久代 元数据 - Class</p>
<p>永久代必须指定大小限制 ，元数据可以设置，也可以不设置，无上限（受限于物理内存）</p>
<p>字符串常量 1.7 - 永久代，1.8 - 堆</p>
<p>MethodArea逻辑概念 - 永久代、元数据</p>
</blockquote>
<p><strong>3. 新生代 = Eden + 2个suvivor区</strong> </p>
<blockquote>
<p>YGC回收之后，大多数的对象会被回收，活着的进入s0</p>
<p>再次YGC，活着的对象eden + s0 -&gt; s1</p>
<p>再次YGC，eden + s1 -&gt; s0</p>
<p>年龄足够 -&gt; 老年代 （15 CMS 6）</p>
<p>s区装不下 -&gt; 老年代</p>
</blockquote>
<p><strong>4. 老年代</strong></p>
<blockquote>
<p>顽固分子</p>
<p>老年代满了FGC Full GC</p>
</blockquote>
<p><strong>GC Tuning (Generation)</strong></p>
<blockquote>
<p>尽量减少FGC</p>
<p>MinorGC = YGC</p>
<p>MajorGC = FGC</p>
</blockquote>
<p><strong>动态年龄：</strong><br><a href="https://www.jianshu.com/p/989d3b06a49d">https://www.jianshu.com/p/989d3b06a49d</a></p>
<p><strong>分配担保：</strong><br>YGC期间 survivor区空间不够了 空间担保直接进入老年代<br>参考：<a href="https://cloud.tencent.com/developer/article/1082730">https://cloud.tencent.com/developer/article/1082730</a></p>
<p><strong>对象的分配过程</strong></p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/java%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%86%E9%85%8D%E8%BF%87%E7%A8%8B.png" alt="对象内存分配的过程"></p>
<p><strong>5 .TLAB 分配</strong></p>
<blockquote>
<p>　JVM在内存新生代Eden Space中开辟了一小块线程私有的区域，称作TLAB（Thread-local allocation buffer）。默认设定为占用Eden Space的1%。在Java程序中很多对象都是小对象且用过即丢，它们不存在线程共享也适合被快速GC，所以对于小对象通常JVM会优先分配在TLAB上，并且TLAB上的分配由于是线程私有所以没有锁开销。因此在实践中分配多个小对象的效率通常比分配一个大对象的效率要高。<br>　　也就是说，Java中每个线程都会有自己的缓冲区称作TLAB（Thread-local allocation buffer），每个TLAB都只有一个线程可以操作，TLAB结合bump-the-pointer技术可以实现快速的对象分配，而不需要任何的锁进行同步，也就是说，在对象分配的时候不用锁住整个堆，而只需要在自己的缓冲区分配即可。<br>　　关于对象分配的JDK源码可以参见 [JVM 之 Java对象创建<a href="http://blog.hesey.net/2011/07/object-allocation-on-non-heap.html">初始化]</a> 中对OpenJDK源码的分析。</p>
</blockquote>
<p><strong>为什么需要TLAB？</strong></p>
<blockquote>
<p>　　这是为了加速对象的分配。由于对象一般分配在堆上，而堆是线程共用的，因此可能会有多个线程在堆上申请空间，而每一次的对象分配都必须线程同步，会使分配的效率下降。考虑到对象分配几乎是Java中最常用的操作，因此JVM使用了TLAB这样的线程专有区域来避免多线程冲突，提高对象分配的效率。</p>
</blockquote>
<h4 id="6-常见的垃圾回收器"><a href="#6-常见的垃圾回收器" class="headerlink" title="6.常见的垃圾回收器"></a>6.常见的垃圾回收器</h4><p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/gc/gc%E7%AE%97%E6%B3%95.png" alt="gc"></p>
<ol>
<li>JDK诞生 Serial追随 提高效率，诞生了PS，为了配合CMS，诞生了PN，CMS是1.4版本后期引入，CMS是里程碑式的GC，它开启了并发回收的过程，但是CMS毛病较多，因此目前任何一个JDK版本默认是CMS<br>并发垃圾回收是因为无法忍受STW</li>
<li>Serial 年轻代 串行回收</li>
<li>PS 年轻代 并行回收</li>
<li>ParNew 年轻代 配合CMS的并行回收</li>
<li>SerialOld </li>
<li>ParallelOld</li>
<li>ConcurrentMarkSweep 老年代 并发的， 垃圾回收和应用程序同时运行，降低STW的时间(200ms)<br>CMS问题比较多，所以现在没有一个版本默认是CMS，只能手工指定<br>CMS既然是MarkSweep，就一定会有碎片化的问题，碎片到达一定程度，CMS的老年代分配对象分配不下的时候，使用SerialOld 进行老年代回收<br>想象一下：<br>PS + PO -&gt; 加内存 换垃圾回收器 -&gt; PN + CMS + SerialOld（几个小时 - 几天的STW）<br>几十个G的内存，单线程回收 -&gt; G1 + FGC 几十个G -&gt; 上T内存的服务器 ZGC<br>算法：三色标记 + Incremental Update</li>
<li>G1(10ms)<br>算法：三色标记 + SATB</li>
<li>ZGC (1ms) PK C++<br>算法：ColoredPointers + LoadBarrier</li>
<li>Shenandoah<br>算法：ColoredPointers + WriteBarrier</li>
<li>Eplison</li>
<li>PS 和 PN区别的延伸阅读：<br>▪<a href="https://docs.oracle.com/en/java/javase/13/gctuning/ergonomics.html">https://docs.oracle.com/en/java/javase/13/gctuning/ergonomics.html#GUID-3D0BB91E-9BFF-4EBB-B523-14493A860E73</a></li>
<li>垃圾收集器跟内存大小的关系<ol>
<li>Serial 几十兆</li>
<li>PS 上百兆 - 几个G</li>
<li>CMS - 20G</li>
<li>G1 - 上百G</li>
<li>ZGC - 4T - 16T（JDK13）</li>
</ol>
</li>
</ol>
<p>1.8默认的垃圾回收：PS + ParallelOld</p>
<h4 id="7-常见垃圾回收器组合参数设定：-1-8"><a href="#7-常见垃圾回收器组合参数设定：-1-8" class="headerlink" title="7.常见垃圾回收器组合参数设定：(1.8)"></a>7.常见垃圾回收器组合参数设定：(1.8)</h4><ul>
<li><p>-XX:+UseSerialGC = Serial New (DefNew) + Serial Old</p>
<ul>
<li>小型程序。默认情况下不会是这种选项，HotSpot会根据计算及配置和JDK版本自动选择收集器</li>
</ul>
</li>
<li><p>-XX:+UseParNewGC = ParNew + SerialOld</p>
<ul>
<li>这个组合已经很少用（在某些版本中已经废弃）</li>
<li><a href="https://stackoverflow.com/questions/34962257/why-remove-support-for-parnewserialold-anddefnewcms-in-the-future">https://stackoverflow.com/questions/34962257/why-remove-support-for-parnewserialold-anddefnewcms-in-the-future</a></li>
</ul>
</li>
<li><p>-XX:+UseConc<font color=red>(urrent)</font>MarkSweepGC = ParNew + CMS + Serial Old</p>
</li>
<li><p>-XX:+UseParallelGC = Parallel Scavenge + Parallel Old (1.8默认) 【PS + SerialOld】</p>
</li>
<li><p>-XX:+UseParallelOldGC = Parallel Scavenge + Parallel Old</p>
</li>
<li><p>-XX:+UseG1GC = G1</p>
</li>
<li><p>Linux中没找到默认GC的查看方法，而windows中会打印UseParallelGC </p>
<ul>
<li>java +XX:+PrintCommandLineFlags -version</li>
<li>通过GC的日志来分辨</li>
</ul>
</li>
<li><p>Linux下1.8版本默认的垃圾回收器到底是什么？</p>
<ul>
<li>1.8.0_181 默认（看不出来）Copy MarkCompact</li>
<li>1.8.0_222 默认 PS + PO</li>
</ul>
</li>
</ul>
<h4 id="8-了解JVM常用命令行参数"><a href="#8-了解JVM常用命令行参数" class="headerlink" title="8.了解JVM常用命令行参数"></a>8.了解JVM常用命令行参数</h4><ul>
<li><p>JVM的命令行参数参考：<a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p>
</li>
<li><p>HotSpot参数分类</p>
<blockquote>
<p>标准： - 开头，所有的HotSpot都支持</p>
<p>非标准：-X 开头，特定版本HotSpot支持特定命令</p>
<p>不稳定：-XX 开头，下个版本可能取消</p>
</blockquote>
<p>java -version</p>
<p>试验用程序：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloGC</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;HelloGC!&quot;</span>);</span><br><span class="line">    List list = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">      <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">      list.add(b);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li>区分概念：内存泄漏memory leak，内存溢出out of memory</li>
<li>java -XX:+PrintCommandLineFlags HelloGC</li>
<li>java -Xmn10M -Xms40M -Xmx60M -XX:+PrintCommandLineFlags -XX:+PrintGC  HelloGC<br>PrintGCDetails PrintGCTimeStamps PrintGCCauses</li>
<li>java -XX:+UseConcMarkSweepGC -XX:+PrintCommandLineFlags HelloGC</li>
<li>java -XX:+PrintFlagsInitial 默认参数值</li>
<li>java -XX:+PrintFlagsFinal 最终参数值</li>
<li>java -XX:+PrintFlagsFinal | grep xxx 找到对应的参数</li>
<li>java -XX:+PrintFlagsFinal -version |grep GC</li>
</ol>
</li>
</ul>
<h4 id="9-PS-GC日志详解"><a href="#9-PS-GC日志详解" class="headerlink" title="9. PS GC日志详解"></a>9. PS GC日志详解</h4><p>每种垃圾回收器的日志格式是不同的！</p>
<p>PS日志格式</p>
<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/gc%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A3.png" alt="gc日志详解"></p>
<p>heap dump部分：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">eden space 5632K, <span class="number">94</span>% used [<span class="number">0x00000000ff980000</span>,<span class="number">0x00000000ffeb3e28</span>,<span class="number">0x00000000fff00000</span>)</span><br><span class="line">                            后面的内存地址指的是，起始地址，使用空间结束地址，整体空间结束地址</span><br></pre></td></tr></table></figure>

<p><img src="https://yaozhiwen-1304431220.cos.ap-beijing.myqcloud.com/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/images/jvm/gc%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A32.png" alt="gc日志详解2"></p>
<p>total = eden + 1个survivor</p>
<h4 id="10-调优前的基础概念："><a href="#10-调优前的基础概念：" class="headerlink" title="10. 调优前的基础概念："></a>10. 调优前的基础概念：</h4><ol>
<li>吞吐量：用户代码时间 /（用户代码执行时间 + 垃圾回收时间）</li>
<li>响应时间：STW越短，响应时间越好</li>
</ol>
<p>所谓调优，首先确定，追求啥？吞吐量优先，还是响应时间优先？还是在满足一定的响应时间的情况下，要求达到多大的吞吐量…</p>
<p><strong>什么是调优？</strong></p>
<ol>
<li>根据需求进行JVM规划和预调优</li>
<li>优化运行JVM运行环境（慢，卡顿）</li>
<li>解决JVM运行过程中出现的各种问题(OOM)</li>
</ol>
<h4 id="11-调优步骤"><a href="#11-调优步骤" class="headerlink" title="11. 调优步骤"></a>11. 调优步骤</h4><ul>
<li><p>调优，从业务场景开始，没有业务场景的调优都是耍流氓</p>
</li>
<li><p>无监控（压力测试，能看到结果），不调优</p>
</li>
<li><p>步骤：</p>
<ol>
<li>熟悉业务场景（没有最好的垃圾回收器，只有最合适的垃圾回收器）<ol>
<li>响应时间、停顿时间 [CMS G1 ZGC] （需要给用户作响应）</li>
<li>吞吐量 = 用户时间 /( 用户时间 + GC时间) [PS]</li>
</ol>
</li>
<li>选择回收器组合</li>
<li>计算内存需求（经验值 1.5G 16G）</li>
<li>选定CPU（越高越好）</li>
<li>设定年代大小、升级年龄</li>
<li>设定日志参数<ol>
<li>-Xloggc:/opt/xxx/logs/xxx-xxx-gc-%t.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=20M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCCause</li>
<li>或者每天产生一个日志文件</li>
</ol>
</li>
<li>观察日志情况 </li>
</ol>
</li>
</ul>
<h4 id="GC常用参数"><a href="#GC常用参数" class="headerlink" title="GC常用参数"></a>GC常用参数</h4><ul>
<li>-Xmn -Xms -Xmx -Xss<br>年轻代 最小堆 最大堆 栈空间</li>
<li>-XX:+UseTLAB<br>使用TLAB，默认打开</li>
<li>-XX:+PrintTLAB<br>打印TLAB的使用情况</li>
<li>-XX:TLABSize<br>设置TLAB大小</li>
<li>-XX:+DisableExplictGC<br>System.gc()不管用 ，FGC</li>
<li>-XX:+PrintGC</li>
<li>-XX:+PrintGCDetails</li>
<li>-XX:+PrintHeapAtGC</li>
<li>-XX:+PrintGCTimeStamps</li>
<li>-XX:+PrintGCApplicationConcurrentTime (低)<br>打印应用程序时间</li>
<li>-XX:+PrintGCApplicationStoppedTime （低）<br>打印暂停时长</li>
<li>-XX:+PrintReferenceGC （重要性低）<br>记录回收了多少种不同引用类型的引用</li>
<li>-verbose:class<br>类加载详细过程</li>
<li>-XX:+PrintVMOptions</li>
<li>-XX:+PrintFlagsFinal  -XX:+PrintFlagsInitial<br>必须会用</li>
<li>-Xloggc:opt/log/gc.log</li>
<li>-XX:MaxTenuringThreshold<br>升代年龄，最大值15</li>
<li>锁自旋次数 -XX:PreBlockSpin 热点代码检测参数-XX:CompileThreshold 逃逸分析 标量替换 …<br>这些不建议设置</li>
</ul>
<h4 id="Parallel常用参数"><a href="#Parallel常用参数" class="headerlink" title="Parallel常用参数"></a>Parallel常用参数</h4><ul>
<li>-XX:SurvivorRatio</li>
<li>-XX:PreTenureSizeThreshold<br>大对象到底多大</li>
<li>-XX:MaxTenuringThreshold</li>
<li>-XX:+ParallelGCThreads<br>并行收集器的线程数，同样适用于CMS，一般设为和CPU核数相同</li>
<li>-XX:+UseAdaptiveSizePolicy<br>自动选择各区大小比例</li>
</ul>
<h4 id="CMS常用参数"><a href="#CMS常用参数" class="headerlink" title="CMS常用参数"></a>CMS常用参数</h4><ul>
<li>-XX:+UseConcMarkSweepGC</li>
<li>-XX:ParallelCMSThreads<br>CMS线程数量</li>
<li>-XX:CMSInitiatingOccupancyFraction<br>使用多少比例的老年代后开始CMS收集，默认是68%(近似值)，如果频繁发生SerialOld卡顿，应该调小，（频繁CMS回收）</li>
<li>-XX:+UseCMSCompactAtFullCollection<br>在FGC时进行压缩</li>
<li>-XX:CMSFullGCsBeforeCompaction<br>多少次FGC之后进行压缩</li>
<li>-XX:+CMSClassUnloadingEnabled</li>
<li>-XX:CMSInitiatingPermOccupancyFraction<br>达到什么比例时进行Perm回收</li>
<li>GCTimeRatio<br>设置GC时间占用程序运行时间的百分比</li>
<li>-XX:MaxGCPauseMillis<br>停顿时间，是一个建议时间，GC会尝试用各种手段达到这个时间，比如减小年轻代</li>
</ul>
<h4 id="G1常用参数"><a href="#G1常用参数" class="headerlink" title="G1常用参数"></a>G1常用参数</h4><ul>
<li>-XX:+UseG1GC</li>
<li>-XX:MaxGCPauseMillis<br>建议值，G1会尝试调整Young区的块数来达到这个值</li>
<li>-XX:GCPauseIntervalMillis<br>？GC的间隔时间</li>
<li>-XX:+G1HeapRegionSize<br>分区大小，建议逐渐增大该值，1 2 4 8 16 32。<br>随着size增加，垃圾的存活时间更长，GC间隔更长，但每次GC的时间也会更长<br>ZGC做了改进（动态区块大小）</li>
<li>G1NewSizePercent<br>新生代最小比例，默认为5%</li>
<li>G1MaxNewSizePercent<br>新生代最大比例，默认为60%</li>
<li>GCTimeRatio<br>GC时间建议比例，G1会根据这个值调整堆空间</li>
<li>ConcGCThreads<br>线程数量</li>
<li>InitiatingHeapOccupancyPercent<br>启动G1的堆空间占用比例</li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a href="https://blogs.oracle.com/jonthecollector/our-collectors">https://blogs.oracle.com/</a><a href="https://blogs.oracle.com/jonthecollector/our-collectors">jonthecollector</a><a href="https://blogs.oracle.com/jonthecollector/our-collectors">/our-collectors</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></li>
<li><a href="http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp">http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp</a></li>
<li>JVM调优参考文档：<a href="https://docs.oracle.com/en/java/javase/13/gctuning/introduction-garbage-collection-tuning.html#GUID-8A443184-7E07-4B71-9777-4F12947C8184">https://docs.oracle.com/en/java/javase/13/gctuning/introduction-garbage-collection-tuning.html#GUID-8A443184-7E07-4B71-9777-4F12947C8184</a> </li>
<li><a href="https://www.cnblogs.com/nxlhero/p/11660854.html">https://www.cnblogs.com/nxlhero/p/11660854.html</a> 在线排查工具</li>
<li><a href="https://www.jianshu.com/p/507f7e0cc3a3">https://www.jianshu.com/p/507f7e0cc3a3</a> arthas常用命令</li>
<li>Arthas手册：<ol>
<li>启动arthas java -jar arthas-boot.jar</li>
<li>绑定java进程</li>
<li>dashboard命令观察系统整体情况</li>
<li>help 查看帮助</li>
<li>help xx 查看具体命令帮助</li>
</ol>
</li>
<li>jmap命令参考： <a href="https://www.jianshu.com/p/507f7e0cc3a3">https://www.jianshu.com/p/507f7e0cc3a3</a> <ol>
<li>jmap -heap pid</li>
<li>jmap -histo pid</li>
<li>jmap -clstats pid</li>
</ol>
</li>
</ol>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 中的并发</title>
    <url>/2021/05/26/Java%20%E4%B8%AD%E7%9A%84%E5%B9%B6%E5%8F%91/</url>
    <content><![CDATA[<h3 id="java-中的Lock"><a href="#java-中的Lock" class="headerlink" title="java 中的Lock"></a>java 中的Lock</h3><ol>
<li>ReentrantLock</li>
<li>ReentrantReadWriteLock</li>
<li>ReentrantLock</li>
<li>lock</li>
</ol>
<h3 id="java-中的并发容器"><a href="#java-中的并发容器" class="headerlink" title="java 中的并发容器"></a>java 中的并发容器</h3><ol>
<li>ConcurrentHashMap：并发版 HashMap</li>
<li>CopyOnWriteArrayList：并发版 ArrayList</li>
<li>CopyOnWriteArraySet：并发 Set</li>
<li>ConcurrentLinkedQueue：并发队列 (基于链表)</li>
<li>ConcurrentLinkedDeque：并发队列 (基于双向链表)</li>
<li>ConcurrentSkipListMap：基于跳表的并发 Map</li>
<li>ConcurrentSkipListSet：基于跳表的并发 Set</li>
<li>ArrayBlockingQueue：阻塞队列 (基于数组)</li>
<li>LinkedBlockingQueue：阻塞队列 (基于链表)</li>
<li>LinkedBlockingDeque：阻塞队列 (基于双向链表)</li>
<li>PriorityBlockingQueue：线程安全的优先队列</li>
<li>SynchronousQueue：读写成对的队列</li>
<li>LinkedTransferQueue：基于链表的数据交换队列</li>
<li>DelayQueue：延时队列</li>
</ol>
<h3 id="java-中的并发框架"><a href="#java-中的并发框架" class="headerlink" title="java 中的并发框架"></a>java 中的并发框架</h3><ol>
<li>Fork/join</li>
</ol>
<h3 id="java中的并发工具类"><a href="#java中的并发工具类" class="headerlink" title="java中的并发工具类"></a>java中的并发工具类</h3><ol>
<li><p>CountDownLatch</p>
</li>
<li><p>CyclicBarrier</p>
</li>
<li><p>Semaphore</p>
</li>
<li><p>Exchanger</p>
</li>
</ol>
<h3 id="Java中的原子操作类"><a href="#Java中的原子操作类" class="headerlink" title="Java中的原子操作类"></a>Java中的原子操作类</h3><ul>
<li><p><strong>原子更新基本类型</strong></p>
<p>·AtomicBoolean：原子更新布尔类型。<br>·AtomicInteger：原子更新整型。<br>·AtomicLong：原子更新长整型。</p>
</li>
<li><p><strong>原子更新数组</strong></p>
<p>·AtomicIntegerArray：原子更新整型数组里的元素。<br>·AtomicLongArray：原子更新长整型数组里的元素。<br>·AtomicReferenceArray：原子更新引用类型数组里的元素。</p>
</li>
<li><p><strong>原子更新引用类型</strong></p>
<p>·AtomicReference：原子更新引用类型。</p>
<p>·AtomicReferenceFieldUpdater：原子更新引用类型里的字段。</p>
<p>·AtomicMarkableReference：原子更新带有标记位的引用类型。可以原子更新一个布尔类型的标记位和引用类型。</p>
</li>
<li><p><strong>原子更新字段</strong></p>
<p>·AtomicIntegerFieldUpdater：原子更新整型的字段的更新器。<br>·AtomicLongFieldUpdater：原子更新长整型字段的更新器。<br>·AtomicStampedReference：原子更新带有版本号的引用类型。该类将整数值与引用关联起来，可用于原子的更新数据和数据的版本号，可以解决使用CAS进行原子更新时可能出现的ABA问题。</p>
</li>
</ul>
<h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><h3 id="Disruptor"><a href="#Disruptor" class="headerlink" title="Disruptor"></a>Disruptor</h3><h3 id="java中的ThreadPoolExecutor"><a href="#java中的ThreadPoolExecutor" class="headerlink" title="java中的ThreadPoolExecutor"></a>java中的ThreadPoolExecutor</h3><p><a href="https://cloud.tencent.com/developer/article/1056828">https://cloud.tencent.com/developer/article/1056828</a></p>
<p>参考</p>
<p><a href="https://cloud.tencent.com/developer/article/1056828">https://cloud.tencent.com/developer/article/1056828</a></p>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql锁机制</title>
    <url>/2020/11/24/mysql%E9%94%81%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<h3 id="1、MySQL锁的基本介绍"><a href="#1、MySQL锁的基本介绍" class="headerlink" title="1、MySQL锁的基本介绍"></a>1、MySQL锁的基本介绍</h3><p>​        <strong>锁是计算机协调多个进程或线程并发访问某一资源的机制。</strong>在数据库中，除传统的 计算资源（如CPU、RAM、I/O等）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一 个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</p>
<p>​        相对其他数据库而言，MySQL的锁机制比较简单，其最 显著的特点是不同的<strong>存储引擎</strong>支持不同的锁机制。比如，MyISAM和MEMORY存储引擎采用的是表级锁（table-level locking）；InnoDB存储引擎既支持行级锁（row-level locking），也支持表级锁，但默认情况下是采用行级锁。 </p>
<p>​        <strong>表级锁：</strong>开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。<br>​        <strong>行级锁：</strong>开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。  </p>
<p>​        从上述特点可见，很难笼统地说哪种锁更好，只能就具体应用的特点来说哪种锁更合适！仅从锁的角度 来说：表级锁更适合于以查询为主，只有少量按索引条件更新数据的应用，如Web应用；而行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有 并发查询的应用，如一些在线事务处理（OLTP）系统。 </p>
<h3 id="2、MyISAM表锁"><a href="#2、MyISAM表锁" class="headerlink" title="2、MyISAM表锁"></a>2、MyISAM表锁</h3><p>MySQL的表级锁有两种模式：<strong>表共享读锁（Table Read Lock）</strong>和<strong>表独占写锁（Table Write Lock）</strong>。  </p>
<p>对MyISAM表的读操作，不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写请求；对 MyISAM表的写操作，则会阻塞其他用户对同一表的读和写操作；MyISAM表的读操作与写操作之间，以及写操作之间是串行的！ </p>
<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`mylock`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`NAME`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`mylock`</span> (<span class="string">`id`</span>, <span class="string">`NAME`</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`mylock`</span> (<span class="string">`id`</span>, <span class="string">`NAME`</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`mylock`</span> (<span class="string">`id`</span>, <span class="string">`NAME`</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`mylock`</span> (<span class="string">`id`</span>, <span class="string">`NAME`</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;d&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>MyISAM写锁阻塞读的案例：</strong></p>
<p>​        当一个线程获得对一个表的写锁之后，只有持有锁的线程可以对表进行更新操作。其他线程的读写操作都会等待，直到锁释放为止。</p>
<table>
<thead>
<tr>
<th>session1</th>
<th align="center">session2</th>
</tr>
</thead>
<tbody><tr>
<td>获取表的write锁定<br />lock table mylock write;</td>
<td align="center"></td>
</tr>
<tr>
<td>当前session对表的查询，插入，更新操作都可以执行<br />select * from mylock;<br />insert into mylock values(5,’e’);</td>
<td align="center">当前session对表的查询会被阻塞<br />select * from mylock；</td>
</tr>
<tr>
<td>释放锁：<br />unlock tables；</td>
<td align="center">当前session能够立刻执行，并返回对应结果</td>
</tr>
</tbody></table>
<p><strong>MyISAM读阻塞写的案例：</strong></p>
<p>​        一个session使用lock table给表加读锁，这个session可以锁定表中的记录，但更新和访问其他表都会提示错误，同时，另一个session可以查询表中的记录，但更新就会出现锁等待。</p>
<table>
<thead>
<tr>
<th align="center">session1</th>
<th align="center">session2</th>
</tr>
</thead>
<tbody><tr>
<td align="center">获得表的read锁定<br />lock table mylock read;</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">当前session可以查询该表记录：<br />select * from mylock;</td>
<td align="center">当前session可以查询该表记录：<br />select * from mylock;</td>
</tr>
<tr>
<td align="center">当前session不能查询没有锁定的表<br />select * from person<br />Table ‘person’ was not locked with LOCK TABLES</td>
<td align="center">当前session可以查询或者更新未锁定的表<br />select * from mylock<br />insert into person values(1,’zhangsan’);</td>
</tr>
<tr>
<td align="center">当前session插入或者更新表会提示错误<br />insert into mylock values(6,’f’)<br />Table ‘mylock’ was locked with a READ lock and can’t be updated<br />update mylock set name=’aa’ where id = 1;<br />Table ‘mylock’ was locked with a READ lock and can’t be updated</td>
<td align="center">当前session插入数据会等待获得锁<br />insert into mylock values(6,’f’);</td>
</tr>
<tr>
<td align="center">释放锁<br />unlock tables;</td>
<td align="center">获得锁，更新成功</td>
</tr>
</tbody></table>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意:"></a>注意:</h3><p><strong>MyISAM在执行查询语句之前，会自动给涉及的所有表加读锁，在执行更新操作前，会自动给涉及的表加写锁，这个过程并不需要用户干预，因此用户一般不需要使用命令来显式加锁，上例中的加锁时为了演示效果。</strong></p>
<p><strong>MyISAM的并发插入问题</strong></p>
<p>MyISAM表的读和写是串行的，这是就总体而言的，在一定条件下，MyISAM也支持查询和插入操作的并发执行</p>
<table>
<thead>
<tr>
<th align="center">session1</th>
<th align="center">session2</th>
</tr>
</thead>
<tbody><tr>
<td align="center">获取表的read local锁定<br />lock table mylock read local</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">当前session不能对表进行更新或者插入操作<br />insert into mylock values(6,’f’)<br />Table ‘mylock’ was locked with a READ lock and can’t be updated<br />update mylock set name=’aa’ where id = 1;<br />Table ‘mylock’ was locked with a READ lock and can’t be updated</td>
<td align="center">其他session可以查询该表的记录<br />select* from mylock</td>
</tr>
<tr>
<td align="center">当前session不能查询没有锁定的表<br />select * from person<br />Table ‘person’ was not locked with LOCK TABLES</td>
<td align="center">其他session可以进行插入操作，但是更新会阻塞<br />update mylock set name = ‘aa’ where id = 1;</td>
</tr>
<tr>
<td align="center">当前session不能访问其他session插入的记录；</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">释放锁资源：unlock tables</td>
<td align="center">当前session获取锁，更新操作完成</td>
</tr>
<tr>
<td align="center">当前session可以查看其他session插入的记录</td>
<td align="center"></td>
</tr>
</tbody></table>
<p> 可以通过检查table_locks_waited和table_locks_immediate状态变量来分析系统上的表锁定争夺： </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; show status like &#x27;table%&#x27;;</span><br><span class="line">+<span class="comment">-----------------------+-------+</span></span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+<span class="comment">-----------------------+-------+</span></span><br><span class="line">| Table_locks_immediate | 352   |</span><br><span class="line">| Table_locks_waited    | 2     |</span><br><span class="line">+<span class="comment">-----------------------+-------+</span></span><br><span class="line"><span class="comment">--如果Table_locks_waited的值比较高，则说明存在着较严重的表级锁争用情况。</span></span><br></pre></td></tr></table></figure>

<p><strong>InnoDB锁</strong></p>
<p><strong>1、事务及其ACID属性</strong></p>
<p>事务是由一组SQL语句组成的逻辑处理单元，事务具有4属性，通常称为事务的ACID属性。</p>
<p>原子性（Actomicity）：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。<br>一致性（Consistent）：在事务开始和完成时，数据都必须保持一致状态。<br>隔离性（Isolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。<br>持久性（Durable）：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</p>
<p><strong>2、并发事务带来的问题</strong></p>
<p>相对于串行处理来说，并发事务处理能大大增加数据库资源的利用率，提高数据库系统的事务吞吐量，从而可以支持更多用户的并发操作，但与此同时，会带来一下问题：</p>
<p><strong>脏读</strong>： 一个事务正在对一条记录做修改，在这个事务并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些“脏”的数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。这种现象被形象地叫做“脏读” </p>
<p><strong>不可重复读</strong>：一个事务在读取某些数据已经发生了改变、或某些记录已经被删除了！这种现象叫做“不可重复读”。 </p>
<p><strong>幻读</strong>： 一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为“幻读” </p>
<p>上述出现的问题都是数据库读一致性的问题，可以通过事务的隔离机制来进行保证。</p>
<p>数据库的事务隔离越严格，并发副作用就越小，但付出的代价也就越大，因为事务隔离本质上就是使事务在一定程度上串行化，需要根据具体的业务需求来决定使用哪种隔离级别</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">脏读</th>
<th align="center">不可重复读</th>
<th align="center">幻读</th>
</tr>
</thead>
<tbody><tr>
<td align="center">read uncommitted</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">read committed</td>
<td align="center"></td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">repeatable read</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">serializable</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<p> 可以通过检查InnoDB_row_lock状态变量来分析系统上的行锁的争夺情况： </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; show status like &#x27;innodb_row_lock%&#x27;;</span><br><span class="line">+<span class="comment">-------------------------------+-------+</span></span><br><span class="line">| Variable_name                 | Value |</span><br><span class="line">+<span class="comment">-------------------------------+-------+</span></span><br><span class="line">| Innodb_row_lock_current_waits | 0     |</span><br><span class="line">| Innodb_row_lock_time          | 18702 |</span><br><span class="line">| Innodb_row_lock_time_avg      | 18702 |</span><br><span class="line">| Innodb_row_lock_time_max      | 18702 |</span><br><span class="line">| Innodb_row_lock_waits         | 1     |</span><br><span class="line">+<span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="comment">--如果发现锁争用比较严重，如InnoDB_row_lock_waits和InnoDB_row_lock_time_avg的值比较高</span></span><br></pre></td></tr></table></figure>

<p><strong>3、InnoDB的行锁模式及加锁方法</strong></p>
<p>​        <strong>共享锁（s）</strong>：又称读锁。允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁。若事务T对数据对象A加上S锁，则事务T可以读A但不能修改A，其他事务只能再对A加S锁，而不能加X锁，直到T释放A上的S锁。这保证了其他事务可以读A，但在T释放A上的S锁之前不能对A做任何修改。<br>​        <strong>排他锁（x）</strong>：又称写锁。允许获取排他锁的事务更新数据，阻止其他事务取得相同的数据集共享读锁和排他写锁。若事务T对数据对象A加上X锁，事务T可以读A也可以修改A，其他事务不能再对A加任何锁，直到T释放A上的锁。</p>
<p>​        mysql InnoDB引擎默认的修改数据语句：<strong>update,delete,insert都会自动给涉及到的数据加上排他锁，select语句默认不会加任何锁类型</strong>，如果加排他锁可以使用select …for update语句，加共享锁可以使用select … lock in share mode语句。<strong>所以加过排他锁的数据行在其他事务种是不能修改数据的，也不能通过for update和lock in share mode锁的方式查询数据，但可以直接通过select …from…查询数据，因为普通查询没有任何锁机制。</strong> </p>
<p><strong>InnoDB行锁实现方式</strong></p>
<p>​        InnoDB行锁是通过给<strong>索引</strong>上的索引项加锁来实现的，这一点MySQL与Oracle不同，后者是通过在数据块中对相应数据行加锁来实现的。InnoDB这种行锁实现特点意味着：只有通过索引条件检索数据，InnoDB才使用行级锁，<strong>否则，InnoDB将使用表锁！</strong>  </p>
<p>1、在不通过索引条件查询的时候，innodb使用的是表锁而不是行锁</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tab_no_index(<span class="keyword">id</span> <span class="built_in">int</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>)) <span class="keyword">engine</span>=<span class="keyword">innodb</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tab_no_index <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;2&#x27;</span>),(<span class="number">3</span>,<span class="string">&#x27;3&#x27;</span>),(<span class="number">4</span>,<span class="string">&#x27;4&#x27;</span>);</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">session1</th>
<th align="center">session2</th>
</tr>
</thead>
<tbody><tr>
<td align="center">set autocommit=0<br />select * from tab_no_index where id = 1;</td>
<td align="center">set autocommit=0<br />select * from tab_no_index where id =2</td>
</tr>
<tr>
<td align="center">select * from tab_no_index where id = 1 for update</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">select * from tab_no_index where id = 2 for update;</td>
</tr>
</tbody></table>
<p>session1只给一行加了排他锁，但是session2在请求其他行的排他锁的时候，会出现锁等待。原因是在没有索引的情况下，innodb只能使用表锁。</p>
<p>2、创建带索引的表进行条件查询，innodb使用的是行锁</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tab_with_index(<span class="keyword">id</span> <span class="built_in">int</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>)) <span class="keyword">engine</span>=<span class="keyword">innodb</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tab_with_index <span class="keyword">add</span> <span class="keyword">index</span> <span class="keyword">id</span>(<span class="keyword">id</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tab_with_index <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;2&#x27;</span>),(<span class="number">3</span>,<span class="string">&#x27;3&#x27;</span>),(<span class="number">4</span>,<span class="string">&#x27;4&#x27;</span>);</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">session1</th>
<th align="center">session2</th>
</tr>
</thead>
<tbody><tr>
<td align="center">set autocommit=0<br />select * from tab_with_indexwhere id = 1;</td>
<td align="center">set autocommit=0<br />select * from tab_with_indexwhere id =2</td>
</tr>
<tr>
<td align="center">select * from tab_with_indexwhere id = 1 for update</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">select * from tab_with_indexwhere id = 2 for update;</td>
</tr>
</tbody></table>
<p>3、由于mysql的行锁是针对索引加的锁，不是针对记录加的锁，所以虽然是访问不同行的记录，但是如果是使用相同的索引键，是会出现冲突的。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tab_with_index <span class="keyword">drop</span> <span class="keyword">index</span> <span class="keyword">id</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tab_with_index  <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;4&#x27;</span>);</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">session1</th>
<th align="center">session2</th>
</tr>
</thead>
<tbody><tr>
<td align="center">set autocommit=0</td>
<td align="center">set autocommit=0</td>
</tr>
<tr>
<td align="center">select * from tab_with_index where id = 1 and name=’1’ for update</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">select * from tab_with_index where id = 1 and name=’4’ for update<br />虽然session2访问的是和session1不同的记录，但是因为使用了相同的索引，所以需要等待锁</td>
</tr>
</tbody></table>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>对于MyISAM的表锁，主要讨论了以下几点：</strong><br>（1）共享读锁（S）之间是兼容的，但共享读锁（S）与排他写锁（X）之间，以及排他写锁（X）之间是互斥的，也就是说读和写是串行的。<br>（2）在一定条件下，MyISAM允许查询和插入并发执行，我们可以利用这一点来解决应用中对同一表查询和插入的锁争用问题。<br>（3）MyISAM默认的锁调度机制是写优先，这并不一定适合所有应用，用户可以通过设置LOW_PRIORITY_UPDATES参数，或在INSERT、UPDATE、DELETE语句中指定LOW_PRIORITY选项来调节读写锁的争用。<br>（4）由于表锁的锁定粒度大，读写之间又是串行的，因此，如果更新操作较多，MyISAM表可能会出现严重的锁等待，可以考虑采用InnoDB表来减少锁冲突。</p>
<p><strong>对于InnoDB表，本文主要讨论了以下几项内容：</strong><br>（1）InnoDB的行锁是基于索引实现的，如果不通过索引访问数据，InnoDB会使用表锁。<br>（2）在不同的隔离级别下，InnoDB的锁机制和一致性读策略不同。</p>
<p>在了解InnoDB锁特性后，用户可以通过设计和SQL调整等措施减少锁冲突和死锁，包括：</p>
<ul>
<li>尽量使用较低的隔离级别； 精心设计索引，并尽量使用索引访问数据，使加锁更精确，从而减少锁冲突的机会；</li>
<li>选择合理的事务大小，小事务发生锁冲突的几率也更小；</li>
<li>给记录集显式加锁时，最好一次性请求足够级别的锁。比如要修改数据的话，最好直接申请排他锁，而不是先申请共享锁，修改时再请求排他锁，这样容易产生死锁；</li>
<li>不同的程序访问一组表时，应尽量约定以相同的顺序访问各表，对一个表而言，尽可能以固定的顺序存取表中的行。这样可以大大减少死锁的机会；</li>
<li>尽量用相等条件访问数据，这样可以避免间隙锁对并发插入的影响； 不要申请超过实际需要的锁级别；除非必须，查询时不要显示加锁；</li>
<li>对于一些特定的事务，可以使用表锁来提高处理速度或减少死锁的可能。</li>
</ul>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
  <entry>
    <title>redis</title>
    <url>/2021/04/07/redis/</url>
    <content><![CDATA[<ul>
<li><h1 id="redis"><a href="#redis" class="headerlink" title="redis"></a><a href="http://www.redis.cn/">redis</a></h1><h2 id="redis介绍"><a href="#redis介绍" class="headerlink" title="redis介绍"></a>redis介绍</h2><p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。 它支持多种类型的数据结构，如 字符串（strings）， 散列（hashes）， 列表（lists）， 集合（sets）， 有序集合（sorted sets） 与范围查询， bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。 Redis 内置了 复制（replication），LUA脚本（Lua scripting）， LRU驱动事件（LRU eviction），事务（transactions） 和不同级别的 磁盘持久化（persistence）， 并通过 Redis哨兵（Sentinel）和自动 分区（Cluster）提供高可用性（high availability）。</p>
<h2 id="redis常用的数据类型"><a href="#redis常用的数据类型" class="headerlink" title="redis常用的数据类型"></a><a href="http://www.redis.cn/topics/data-types.html">redis常用的数据类型</a></h2><div class="markmap-container" style="height:300px;" ><svg class="markmap-svg">{"t":"heading","d":1,"v":"redis常用的数据类型","c":[{"t":"heading","d":2,"v":"String","c":[{"t":"heading","d":3,"v":"字符串"},{"t":"heading","d":3,"v":"数值"},{"t":"heading","d":3,"v":"bitmap"}]},{"t":"heading","d":2,"v":"set"},{"t":"heading","d":2,"v":"hash"},{"t":"heading","d":2,"v":"sorted_set"},{"t":"heading","d":2,"v":"list"}]}</svg></div>

<h3 id="1-String"><a href="#1-String" class="headerlink" title="1. String"></a><strong><a href="http://www.redis.cn/topics/data-types-intro.html#strings">1. String</a></strong></h3><ul>
<li><strong><a href="http://www.redis.cn/topics/data-types-intro.html#strings">字符串</a></strong> <ul>
<li><a href="http://www.redis.cn/commands.html#string">1.常用的命令</a><br>set<br>get<br>append<br>strlen<br>type 查看vlue的类型 </li>
<li>2.正负向索引<br>setrange<br>getrange</li>
<li><a href="http://www.redis.cn/commands/object.html">3.object</a></li>
</ul>
</li>
<li><strong><a href="http://www.redis.cn/topics/data-types-intro.html#strings">数值</a></strong><ul>
<li>1.常用命令<br>   INCR 命令将字符串值解析成整型，将其加一，最后将结果保存为新的字符串值<br>   INCRBY   n   对一个k 加 n<br>   DECR  减一<br>   DECRBY n  减n<br>   GETSET命令，行如其名：它为key设置新值并且返回原值      </li>
<li>2.命令说明<br>INCR是原子操作意味着什么呢？就是说即使多个客户端对同一个key发出INCR命令，也决不会导致竞争的情况。例如如下情况永远不可能发生：『客户端1和客户端2同时读出“10”，他们俩都对其加到11，然后将新值设置为11』。最终的值一定是12，read-increment-set操作完成时，其他客户端不会在同一时间执行任何命令。<br>对字符串，另一个的令人感兴趣的操作是GETSET命令，行如其名：他为key设置新值并且返回原值。这有什么用处呢？例如：你的系统每当有新用户访问时就用INCR命令操作一个Redis key。你希望每小时对这个信息收集一次。你就可以GETSET这个key并给其赋值0并读取原值。<br>为减少等待时间，也可以一次存储或获取多个key对应的值，使用MSET和MGET命令:<br>string类型是二进制安全的。意思是redis的string可以包含任何数据。比如jpg图片或者序列化的对象 。</li>
<li>3.使用场景<pre><code>抢购，秒杀，详情页，点赞，评论
规避并发下，
对数据库的事务操作
完全由redis内存操作代替
</code></pre>
</li>
</ul>
</li>
<li><strong><a href="http://www.redis.cn/commands.html">bitmap</a></strong><ul>
<li>1.常用命令<br>setbit<br>bitcount<br>bitpos<br>bitop</li>
<li><a href="http://www.redis.cn/commands/bitcount.html">2.使用场景1</a><br>1,有用户系统，统计用户登录天数，<br>setbit sean 1 1<br>setbit sean 7 1<br>setbit sean 364 1<br>STRLEN sean<br>BITCOUNT sean -2 -1<br> 01   02  03  04<br>sean    0    1   0   1   010101<br>json    0    1   0   1   011111<br>每用户46B *  用户数 10000000  =460 000 000</li>
<li><a href="https://blog.getspool.com/2011/11/29/fast-easy-realtime-metrics-using-redis-bitmaps/">3.使用场景2</a><br>618做活动：送礼物<br>大库备货多少礼物<br>假设京东有2E用户<br>僵尸用户<br>冷热用户/忠诚用户<br>活跃用户统计！1号<del>3号 都有哪些用户进行了登录<br>比如说 1号</del>3号  连续登录要     去重<br>setbit 20190101   1  1<br>setbit 20190102   1  1<br>setbit 20190102   7  1<br>bitop  or   destkey 20190101  20190102<br>BITCOUNT  destkey  0 -1</li>
</ul>
</li>
</ul>
<h3 id="2-set"><a href="#2-set" class="headerlink" title="2. set"></a><strong><a href="http://www.redis.cn/topics/data-types-intro.html#sets">2. set</a></strong></h3><ul>
<li><p><a href="http://www.redis.cn/commands.html#set">1.常用命令</a></p>
</li>
<li><p>2.set介绍<br>Redis Set 是 String 的无序排列。SADD 指令把新的元素添加到 set 中。对 set 也可做一些其他的操作，比如测试一个给定的元素是否存在，对不同 set 取交集，并集或差，等等。</p>
</li>
<li><p><a href="http://www.redis.cn/commands/srandmember.html">3.set中的随机事件</a></p>
<p>SRANDMEMBER  key  count </p>
</li>
<li><p>3.使用场景<br>Sets 适合用于表示对象间的关系。 例如，我们可以轻易使用 set 来表示标记。<br>一个简单的建模方式是，对每一个希望标记的对象使用 set。这个 set 包含和对象相关联的标签的 ID。<br>假设我们想要给新闻打上标签。 假设新闻 ID 1000 被打上了 1,2,5 和 77 四个标签，我们可以使用一个 set 把 tag ID 和新闻条目关联起来：</p>
</li>
</ul>
<h3 id="3-hash"><a href="#3-hash" class="headerlink" title="3. hash"></a><strong><a href="http://www.redis.cn/topics/data-types-intro.html#hashes">3. hash</a></strong></h3></li>
<li><p><a href="http://www.redis.cn/commands.html#hash">1.常用命令</a></p>
</li>
<li><p>hash介绍<br>Hash 便于表示 objects，实际上，你可以放入一个 hash 的域数量实际上没有限制（除了可用内存以外）。所以，你可以在你的应用中以不同的方式使用 hash。<br>HMSET 指令设置 hash 中的多个域，而 HGET 取回单个域。HMGET 和 HGET 类似，但返回一系列值：</p>
</li>
<li><p>使用场景<br>场景：点赞，收藏，详情页</p>
</li>
</ul>
<h3 id="4-sorted-set"><a href="#4-sorted-set" class="headerlink" title="4.sorted_set"></a><strong><a href="http://www.redis.cn/topics/data-types-intro.html#sorted-sets">4.sorted_set</a></strong></h3><ul>
<li><a href="http://www.redis.cn/commands.html#sorted_set">1.常用命令</a></li>
<li>sorted_set介绍<br>Redis排序集—<br>排序集是一种数据类型，类似于集合和哈希之间的混合。像集合一样，排序集合由唯一的，非重复的字符串元素组成，因此从某种意义上说，排序集合也是一个集合。<br>但是，虽然不对集合内的元素进行排序，但是排序后的集合中的每个元素都与一个称为得分的浮点值相关联 （这就是为什么该类型也类似于哈希的原因，因为每个元素都映射到一个值）。<br>此外，已排序集合中的元素是按顺序进行的（因此，它们不是应请求而排序的，顺序是用于表示已排序集合的数据结构的特殊性）。它们按照以下规则排序：<br>如果A和B是两个具有不同分数的元素，那么如果A.score是&gt; B.score，则A&gt;B。<br> 如果A和B的得分完全相同，那么如果A字符串在字典上大于B字符串，则A&gt;B。A和B字符串不能相等，因为排序集仅具有唯一元素。<br> 它的底层核心实现的机制是<a href="https://www.cnblogs.com/wlphp/p/11774171.html">跳跃表</a></li>
<li>功能<br>集合操作<br>并集，交集<br>权重/聚合指令</li>
</ul>
<h3 id="5-list"><a href="#5-list" class="headerlink" title="5.list"></a><strong><a href="http://www.redis.cn/topics/data-types-intro.html#lists">5.list</a></strong></h3><ul>
<li><a href="http://www.redis.cn/commands.html#list">1.常用命令</a></li>
<li>list介绍<br>Lists: 按插入顺序排序的字符串元素的集合。他们基本上就是链表（linked lists）<br>Redis lists基于Linked Lists实现。这意味着即使在一个list中有数百万个元素，在头部或尾部添加一个元素的操作，其时间复杂度也是常数级别的。用LPUSH 命令在十个元素的list头部添加新元素，和在千万元素list头部添加新元素的速度相同。<br>那么，坏消息是什么？在数组实现的list中利用索引访问元素的速度极快，而同样的操作在linked list实现的list上没有那么快。<br>Redis Lists用linked list实现的原因是：对于数据库系统来说，至关重要的特性是：能非常快的在很大的列表上添加元素。另一个重要因素是，正如你将要看到的：Redis lists能在常数时间取得常数长度。</li>
<li>功能<br>栈 同向命令<br>队列 反向命令<br>数组<br>阻塞，单播队列 FIFO</li>
</ul>
<h3 id="6-streams"><a href="#6-streams" class="headerlink" title="6.streams"></a><strong><a href="http://www.redis.cn/topics/streams-intro.html">6.streams</a></strong></h3><ul>
<li>streams介绍<br>Stream是Redis 5.0版本引入的一个新的数据类型，它以更抽象的方式模拟日志数据结构，但日志仍然是完整的：就像一个日志文件，通常实现为以只附加模式打开的文件，Redis流主要是一个仅附加数据结构。至少从概念上来讲，因为Redis流是一种在内存表示的抽象数据类型，他们实现了更加强大的操作，以此来克服日志文件本身的限制。<br> Stream是Redis的数据类型中最复杂的，尽管数据类型本身非常简单，它实现了额外的非强制性的特性：提供了一组允许消费者以阻塞的方式等待生产者向Stream中发送的新消息，此外还有一个名为消费者组的概念。<br>消费者组最早是由名为Kafka（TM）的流行消息系统引入的。Redis用完全不同的术语重新实现了一个相似的概念，但目标是相同的：允许一组客户端相互配合来消费同一个Stream的不同部分的消息。</li>
</ul>
<h2 id="redis的发布-订阅"><a href="#redis的发布-订阅" class="headerlink" title="redis的发布/订阅"></a><a href="http://www.redis.cn/topics/pubsub.html">redis的发布/订阅</a></h2><ul>
<li><p>Pub/Sub<br>订阅，取消订阅和发布实现了发布/订阅消息范式(引自wikipedia)，发送者（发布者）不是计划发送消息给特定的接收者（订阅者）。而是发布的消息分到不同的频道，不需要知道什么样的订阅者订阅。订阅者对一个或多个频道感兴趣，只需接收感兴趣的消息，不需要知道什么样的发布者发布的。这种发布者和订阅者的解耦合可以带来更大的扩展性和更加动态的网络拓扑。<br>为了订阅foo和bar，客户端发出一个订阅的频道名称:<br><em><strong>SUBSCRIBE foo bar</strong></em><br>其他客户端发到这些频道的消息将会被推送到所有订阅的客户端。<br>客户端订阅到一个或多个频道不必发出命令，尽管他能订阅和取消订阅其他频道。订阅和取消订阅的响应被封装在发送的消息中，以便客户端只需要读一个连续的消息流，其中第一个元素表示消息类型。</p>
<p><em><strong>PUBLISH foo Hello</strong></em></p>
</li>
</ul>
<h2 id="redis的内存淘汰策略"><a href="#redis的内存淘汰策略" class="headerlink" title="redis的内存淘汰策略"></a><a href="http://www.redis.cn/topics/lru-cache.html">redis的内存淘汰策略</a></h2><p>LRU是Redis唯一支持的回收方法。本页面包括一些常规话题，Redis的<code>maxmemory</code>指令用于将可用内存限制成一个固定大小，还包括了Redis使用的LRU算法，这个实际上只是近似的LRU。</p>
<ul>
<li>回收策略<br>当maxmemory限制达到的时候Redis会使用的行为由 Redis的maxmemory-policy配置指令来进行配置。<br>以下的策略是可用的:<ul>
<li><strong>noeviction</strong>:当内存不足以容纳新写入数据时，新写入操作会报错（大部分的写入指令，但DEL和几个例外）</li>
<li><strong>allkeys-lru</strong>: 尝试回收最少使用的键（LRU），使得新添加的数据有空间存放。</li>
<li><strong>volatile-lru</strong>: 尝试回收最少使用的键（LRU），但仅限于在过期集合的键,使得新添加的数据有空间存放。</li>
<li><strong>allkeys-random</strong>: 回收随机的键使得新添加的数据有空间存放。</li>
<li><strong>volatile-random</strong>: 回收随机的键使得新添加的数据有空间存放，但仅限于在过期集合的键。</li>
<li><strong>volatile-ttl</strong>: 回收在过期集合的键，并且优先回收存活时间（TTL）较短的键,使得新添加的数据有空间存放。</li>
</ul>
</li>
</ul>
<p>如果没有键满足回收的前提条件的话，策略<strong>volatile-lru</strong>, <strong>volatile-random</strong>以及<strong>volatile-ttl</strong>就和noeviction 差不多了。</p>
<p>选择正确的回收策略是非常重要的，这取决于你的应用的访问模式，不过你可以在运行时进行相关的策略调整，并且监控缓存命中率和没命中的次数，通过RedisINFO命令输出以便调优。</p>
<p>一般的经验规则:</p>
<ul>
<li>使用<strong>allkeys-lru</strong>策略：当你希望你的请求符合一个幂定律分布，也就是说，你希望部分的子集元素将比其它其它元素被访问的更多。如果你不确定选择什么，这是个很好的选择。.</li>
<li>使用<strong>allkeys-random</strong>：如果你是循环访问，所有的键被连续的扫描，或者你希望请求分布正常（所有元素被访问的概率都差不多）。</li>
<li>使用<strong>volatile-ttl</strong>：如果你想要通过创建缓存对象时设置TTL值，来决定哪些对象应该被过期。</li>
</ul>
<p><strong>allkeys-lru</strong> 和 <strong>volatile-random</strong>策略对于当你想要单一的实例实现缓存及持久化一些键时很有用。不过一般运行两个实例是解决这个问题的更好方法。</p>
<p>   为了键设置过期时间也是需要消耗内存的，所以使用<strong>allkeys-lru</strong>这种策略更加高效，因为没有必要为键取设置过期时间当内存有压力时。</p>
<h2 id="redis的过期策略"><a href="#redis的过期策略" class="headerlink" title="redis的过期策略"></a>redis的过期策略</h2><ul>
<li><p><strong>过期策略通常有以下三种：</strong></p>
<ul>
<li><p>定时过期：每个设置过期时间的key都需要创建一个定时器，到过期时间就会立即清除。该策略可以立即清除过期的数据，对内存很友好；但是会占用大量的CPU资源去处理过期的数据，从而影响缓存的响应时间和吞吐量。</p>
</li>
<li><p>惰性过期：只有当访问一个key时，才会判断该key是否已过期，过期则清除。该策略可以最大化地节省CPU资源，却对内存非常不友好。极端情况可能出现大量的过期key没有再次被访问，从而不会被清除，占用大量内存。</p>
</li>
<li><p>定期过期：定期删除指的是Redis默认每隔100ms就随机抽取一些设置了过期时间的key，检测这些key是否过期，如果过期了就将其删掉。该策略是前两者的一个折中方案。通过调整定时扫描的时间间隔和每次扫描的限定耗时，可以在不同情况下使得CPU和内存资源达到最优的平衡效果。<br>(expires字典会保存所有设置了过期时间的key的过期时间数据，其中，key是指向键空间中的某个键的指针，value是该键的毫秒精度的UNIX时间戳表示的过期时间。键空间是指该Redis集群中保存的所有键。)<br><strong>Redis中同时使用了惰性过期和定期过期两种过期策略</strong></p>
</li>
</ul>
</li>
</ul>
<h2 id="持久化如何处理过期"><a href="#持久化如何处理过期" class="headerlink" title="持久化如何处理过期"></a>持久化如何处理过期</h2><ul>
<li><p>RDB<br>从内存数据库持久化数据到RDB文件：持久化key之前，会检查是否过期，过期的key不进入RDB文件 从RDB文件恢复数据到内存数据库：数据载入数据库之前，会对key先进行过期检查，如果过期，不导入数据库（主库情况）。</p>
</li>
<li><p>AOF<br>从内存数据库持久化数据到AOF文件：当key过期后，还没有被删除，此时进行执行持久化操作（该key是不会进入aof文件的，因为没有发生修改命令）<br>当key过期后，在发生删除操作时，程序会向aof文件追加一条del命令（在将来的以aof文件恢复数据的时候该过期的键就会被删掉）<br>AOF重写：重写时，会先判断key是否过期，已过期的key不会重写到aof文件</p>
</li>
</ul>
<h2 id="redis的事务"><a href="#redis的事务" class="headerlink" title="redis的事务"></a><a href="http://www.redis.cn/topics/transactions.html">redis的事务</a></h2><p>   <a href="http://www.redis.cn/commands/multi.html">MULTI</a> 、 <a href="http://www.redis.cn/commands/exec.html">EXEC</a> 、 <a href="http://www.redis.cn/commands/discard.html">DISCARD</a> 和 <a href="http://www.redis.cn/commands/watch.html">WATCH</a> 是 Redis 事务相关的命令。事务可以一次执行多个命令， 并且带有以下两个重要的保证：</p>
<ul>
<li>事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</li>
<li>事务是一个原子操作：事务中的命令要么全部被执行，要么全部都不执行。</li>
</ul>
<p>   <a href="http://www.redis.cn/commands/exec.html">EXEC</a> 命令负责触发并执行事务中的所有命令：</p>
<ul>
<li>如果客户端在使用 <a href="http://www.redis.cn/commands/multi.html">MULTI</a> 开启了一个事务之后，却因为断线而没有成功执行 <a href="http://www.redis.cn/commands/exec.html">EXEC</a> ，那么事务中的所有命令都不会被执行。</li>
<li>另一方面，如果客户端成功在开启事务之后执行 <a href="http://www.redis.cn/commands/exec.html">EXEC</a> ，那么事务中的所有命令都会被执行。</li>
</ul>
<p>   当使用 AOF 方式做持久化的时候， Redis 会使用单个 write(2) 命令将事务写入到磁盘中。</p>
<p>   然而，如果 Redis 服务器因为某些原因被管理员杀死，或者遇上某种硬件故障，那么可能只有部分事务命令会被成功写入到磁盘中。</p>
<p>   如果 Redis 在重新启动时发现 AOF 文件出了这样的问题，那么它会退出，并汇报一个错误。</p>
<p>   使用<code>redis-check-aof</code>程序可以修复这一问题：它会移除 AOF 文件中不完整事务的信息，确保服务器可以顺利启动。</p>
<p>   从 2.2 版本开始，Redis 还可以通过乐观锁（optimistic lock）实现 CAS （check-and-set）操作。</p>
<ul>
<li><a href="https://blog.csdn.net/Evankaka/article/details/70570200">Redis分布式锁—-乐观锁的实现</a><br><a href="https://blog.csdn.net/Evankaka/article/details/70570200">https://blog.csdn.net/Evankaka/article/details/70570200</a></li>
</ul>
<h2 id="redis的缓存穿透-缓存雪崩-缓存穿透-和-缓存预热，缓存降级"><a href="#redis的缓存穿透-缓存雪崩-缓存穿透-和-缓存预热，缓存降级" class="headerlink" title="redis的缓存穿透/缓存雪崩/缓存穿透 和 缓存预热，缓存降级"></a>redis的缓存穿透/缓存雪崩/缓存穿透 和 缓存预热，缓存降级</h2><ul>
<li>缓存穿透<br>1.什么是缓存穿透<br>   缓存穿透是指用户请求的数据在缓存中不存在即没有命中，同时在数据库中也不存在，导致    用户每次请求该数据都要去数据库中查询一遍。如果有恶意攻击者不断请求系统中不存在的数    据，会导致短时间大量请求落在数据库上，造成数据库压力过大，甚至导致数据库承受不住而宕    机崩溃。<br>2.问题分析<br>   缓存穿透的关键在于在Redis中查不到key值，它和缓存击穿的根本区别在于传进来的key    在Redis中是不存在的。假如有黑客传进大量的不存在的key，那么大量的请求打在数据库上是    很致命的问题，所以在日常开发中要对参数做好校验，一些非法的参数，不可能存在的key就直    接返回错误提示。<br>3.解决办法<br>   (1)将无效的key存放进Redis中,当出现Redis查不到数据，数据库也查不到数据的情况，我们就把这个key保存到Redis中，设置value=”null”，并设置其过期时间极短，后面再出现查询这个key的请求的时候，直接返回null，就不需要再查询数据库了。但这种处理方式是有问题的，假如传进来的这个不存在的Key值每次都是随机的，那存进Redis也没有意义。<br>   (2)使用布隆过滤器,如果布隆过滤器判定某个 key 不存在布隆过滤器中，那么就一定不存在，如果判定某个key存在，那么很大可能是存在(存在一定的误判率)。于是我们可以在缓存之前再加一个布隆过滤器，将数据库中的所有key都存储在布隆过滤器中，在查询Redis前先去布隆过滤器查询 key 是否存在，如果不存在就直接返回，不让其访问数据库，从而避免了对底层存储系统的查询压力。<br>4.注<br>   针对一些恶意攻击，攻击带过来的大量key是随机，那么我们采用第一种方案就会缓存大量    不存在key的数据。那么这种方案就不合适了，我们可以先对使用布隆过滤器方案进行过滤掉这    些key。所以，针对这种key异常多、请求重复率比较低的数据，优先使用第二种方案直接过滤    掉。而对于空数据的key有限的，重复率比较高的，则可优先采用第一种方式进行缓存。</li>
<li>缓存击穿<br>1.什么是缓存击穿<br>   缓存击穿跟缓存雪崩有点类似，缓存雪崩是大规模的key失效，而缓存击穿是某个热点的       key失效，大并发集中对其进行请求，就会造成大量请求读缓存没读到数据，从而导致高并发     访问数据库，引起数据库压力剧增。这种现象就叫做缓存击穿。<br>2.问题分析<br>  关键在于某个热点的key失效了，导致大并发集中打在数据库上。所以要从两个方面解        决,第一是否可以考虑热点key不设置过期时间,第二是否可以考虑降低打在数据库上的请求量。<br>3.解决方案<br>  (1)热点数据缓存永远不过期<br>  (2)把过期时间存在key对应的value里，如果发现要过期了，通过一个后台的异步线程进行         缓存的构建<br>  (1)在缓存失效后，通过互斥锁或者队列来控制读数据写缓存的线程数量，比如某个key只允         许一个线程查询数据和写缓存，其他线程等待。这种方式会阻塞其他的线程，此时系统的         吞吐量会下降</li>
<li>缓存雪崩<br>1.什么是缓存雪崩<br>  如果缓在某一个时刻出现大规模的key失效，那么就会导致大量的请求打在了数据库上面，导    致数据库压力巨大，如果在高并发的情况下，可能瞬间就会导致数据库宕机。这时候如果运维马    上又重启数据库，马上又会有新的流量把数据库打死。这就是缓存雪崩。<br>2.问题分析<br>  造成缓存雪崩的关键在于同一时间的大规模的key失效，为什么会出现这个问题，主要有两种    可能：第一种是Redis宕机，第二种可能就是采用了相同的过期时间。搞清楚原因之后，那么有    什么解决方案呢？<br>3.解决方案<br> (1)事前：<br>   ① 均匀过期：设置不同的过期时间，让缓存失效的时间尽量均匀，避免相同的过期时间导致       缓存雪崩，造成大量数据库的访问。<br>   ② 分级缓存：第一级缓存失效的基础上，访问二级缓存，每一级缓存的失效时间都不同。<br>   ③ 热点数据缓存永远不过期。<br> (2)事中<br>   ① 互斥锁：在缓存失效后，通过互斥锁或者队列来控制读数据写缓存的线程数量，比如某个       key只允许一个线程查询数据和写缓存，其他线程等待。这种方式会阻塞其他的线程，此时       系统的吞吐量会下降<br>   ② 使用熔断机制，限流降级。当流量达到一定的阈值，直接返回“系统拥挤”之类的提示，       防止过多的请求打在数据库上将数据库击垮，至少能保证一部分用户是可以正常使用，其他       用户多刷新几次也能得到结果。<br> (3)事后<br>   ① 开启Redis持久化机制，尽快恢复缓存数据，一旦重启，就能从磁盘上自动加载数据恢复       内存中的数据。</li>
<li>缓存预热<br>1.什么是缓存预热<br>   缓存预热是指系统上线后，提前将相关的缓存数据加载到缓存系统。避免在用户请求的时      候，先查询数据库，然后再将数据缓存的问题，用户直接查询事先被预热的缓存数据。<br>   如果不进行预热，那么Redis初始状态数据为空，系统上线初期，对于高并发的流量，都会    访问到数据库中， 对数据库造成流量的压力。<br>2.缓存预热解决方案<br>  (1)数据量不大的时候，工程启动的时候进行加载缓存动作；<br>  (2)数据量大的时候，设置一个定时任务脚本，进行缓存的刷新；<br>  (3)数据量太大的时候，优先保证热点数据进行提前加载到缓存。</li>
<li>缓存降级<br>缓存降级是指缓存失效或缓存服务器挂掉的情况下，不去访问数据库，直接返回默认数据或访问服务的内存数据。降级一般是有损的操作，所以尽量减少降级对于业务的影响程度。<br>在项目实战中通常会将部分热点数据缓存到服务的内存中，这样一旦缓存出现异常，可以直接使用服务的内存数据，从而避免数据库遭受巨大压力。</li>
</ul>
<h2 id="redis中的持久化"><a href="#redis中的持久化" class="headerlink" title="redis中的持久化"></a><a href="http://www.redis.cn/topics/persistence.html">redis中的持久化</a></h2><ul>
<li>  <strong>rdb</strong></li>
<li>  <strong>aof</strong></li>
</ul>
<h2 id="redis的集群"><a href="#redis的集群" class="headerlink" title="redis的集群"></a>redis的集群</h2><ul>
<li><strong><a href="http://www.redis.cn/topics/replication.html">主存复制</a></strong></li>
</ul>
<pre class="mermaid">graph TD
A[Mater] --> B[Slave]
    A --> C[Slave]
    A --> D[Slave]
    D --> E[Slave]
    D --> F[Slave]</pre>

<p>1.全量同步<br>         Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都 复制一份。具体步骤如下：<br>        -从服务器连接主服务器，发送SYNC命令；<br>        -主服务器接收到SYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令；<br>        -主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；<br>        -从服务器收到快照文件后丢弃所有旧数据，载入收到的快照；<br>        -主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令；<br>        -从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令</p>
<p>2.增量同步<br>         -Redis增量复制是指Slave初始化后开始正常工作时主服务器发生的写操作同步到从服务器的过程。<br>         -增量复制的过程主要是主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令。<br>3.Redis主从同步策略<br>         -主从刚刚连接的时候，进行全量同步；全同步结束后，进行增量同步。当然，如果有需要，slave 在任何时候都可以发起全量同步。redis 策略是，无论如何，首先会尝试进行增量  同步，如不成功，要求从机进行全量同步。<br>4.<a href="https://www.cnblogs.com/daofaziran/p/10978628.html">详细文档</a></p>
<ul>
<li><a href="http://www.redis.cn/topics/sentinel.html"><strong>Redis哨兵模式(Sentinel)</strong></a></li>
</ul>
<p>​         Redis 的 Sentinel 系统用于管理多个 Redis 服务器（instance）， 该系统执行以下三个任务：<br>​         -<strong>监控（Monitoring</strong>）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。<br>​         -<strong>提醒（Notification）</strong>： 当被监控的某个 Redis 服务器出现问题时,Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。<br>​         -<strong>自动故障迁移（Automatic failover）</strong>： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。<br>Redis Sentinel 是一个分布式系统， 你可以在一个架构中运行多个 Sentinel 进程（progress）， 这些进程使用流言协议（gossip protocols)来接收关于主服务器是否下线的信息， 并使用投票协议（agreement protocols）来决定是否执行自动故障迁移， 以及选择哪个从服务器作为新的主服务器。<br>虽然 Redis Sentinel 释出为一个单独的可执行文件 redis-sentinel ， 但实际上它只是一个运行在特殊模式下的 Redis 服务器， 你可以在启动一个普通 Redis 服务器时通过给定 –sentinel 选项来启动 Redis Sentinel 。</p>
<ul>
<li><a href="http://www.redis.cn/topics/cluster-tutorial.html"><strong>分区</strong></a><br>有许多分区标准。假如我们有4个Redis实例<strong>R0</strong>, <strong>R1</strong>, <strong>R2</strong>, <strong>R3</strong>,有一批用户数据<code>user:1</code>, <code>user:2</code>, … ,那么有很多存储方案可以选择。从另一方面说，有很多<em>different systems to map</em>方案可以决定用户映射到哪个Redis实例。<br>一种最简单的方法就是<strong>范围分区</strong>,就是将不同范围的对象映射到不同Redis实例。比如说，用户ID从0到10000的都被存储到<strong>R0</strong>,用户ID从10001到20000被存储到<strong>R1</strong>,依此类推。<br>这是一种可行方案并且很多人已经在使用。但是这种方案也有缺点，你需要建一张表存储数据到redis实例的映射关系。这张表需要非常谨慎地维护并且需要为每一类对象建立映射关系，所以redis范围分区通常并不像你想象的那样运行，比另外一种分区方案效率要低很多。<br>另一种可选的范围分区方案是<strong>散列分区</strong>，这种方案要求更低，不需要key必须是<code>object_name:&lt;id&gt;</code>的形式，如此简单：<br>​         -使用散列函数 (如 <code>crc32</code> )将键名称转换为一个数字。例：键<code>foobar</code>, 使用<code>crc32(foobar)</code>函数将产生散列值<code>93024922</code>。<br>​         -对转换后的散列值进行取模，以产生一个0到3的数字，以便可以使这个key映射到4个Redis实例当中的一个。<code>93024922 % 4</code> 等于 <code>2</code>, 所以 <code>foobar</code> 会被存储到第2个Redis实例。 <strong>R2</strong> <em>注意: 对一个数字进行取模，在大多数编程语言中是使用运算符%</em><br>还有很多分区方法，上面只是给出了两个简单示例。有一种比较高级的散列分区方法叫<strong>一致性哈希</strong>，并且有一些客户端和代理（proxies)已经实现.<br><strong>分区的优势</strong><br>​       1.通过利用多台计算机内存的和值，允许我们构造更大的数据库。<br>​        2.通过多核和多台计算机，允许我们扩展计算能力；通过多台计算机和网络适配器，允许我们扩展网络带宽。<br> <strong>分区的不足</strong><br> 1.涉及多个key的操作通常是不被支持的。举例来说，当两个set映射到不同的redis实例上<br> 时，你就不能对这两个set执行交集操作。<br> 2.涉及多个key的redis事务不能使用。<br> 3.当使用分区时，数据处理较为复杂，比如你需要处理多个rdb/aof文件，并且从多个实例<br> 和主机备份持久化文件。<br> 4.增加或删除容量也比较复杂。redis集群大多数支持在运行时增加、删除节点的透明数据<br> 平衡的能力，但是类似于客户端分区、代理等其他系统则不支持这项特性。然而，一种叫做presharding的技术对此是有帮助的。<br><strong>支持redis自动分区的工具</strong><br>   -<a href="https://github.com/joyieldInc/predixy/blob/master/README_CN.md">predix</a><br>   -<a href="https://github.com/twitter/twemproxy">twemprox</a><br>   <a href="https://www.jianshu.com/p/dfd28d3b545f">predix和twemprox性能对比记录</a><br> 综合以上推荐使用predixy，支持的redis的比较全面。</li>
</ul>
<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>中间件</tag>
      </tags>
  </entry>
  <entry>
    <title>代码的精简之道</title>
    <url>/2021/06/10/%E4%BB%A3%E7%A0%81%E7%9A%84%E7%B2%BE%E7%AE%80%E4%B9%8B%E9%81%93/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a><strong>前言</strong></h2><p>古语有云：</p>
<blockquote>
<p>道为术之灵，术为道之体；以道统术，以术得道。</p>
<p>其中：“道”指“规律、道理、理论”，“术”指“方法、技巧、技术”。意思是：“道”是“术”的灵魂，“术”是“道”的肉体；可以用“道”来统管“术”，也可以从“术”中获得“道”。</p>
<p>在拜读大佬“孤尽”的文章<a href="http://mp.weixin.qq.com/s?__biz=MzU4NzU0MDIzOQ==&mid=2247489170&idx=1&sn=e47dcf2227517172ff97105e8a0543d0&chksm=fdeb24f2ca9cade4985b11abd05d4c8e2fdf2cf9b5a73dbe27d320a036d684563679e8d5c565&token=1498852714&lang=zh_CN&scene=21#wechat_redirect">《Code Review是苦涩但有意思的修行》</a>时，感受最深的一句话就是：“优质的代码一定是少即是多的精兵原则”，这就是大佬的代码精简之“道”。</p>
<p>工匠追求“术”到极致，其实就是在寻“道”，且离悟“道”也就不远了，亦或是已经得道，这就是“工匠精神”——一种追求“以术得道”的精神。如果一个工匠只满足于“术”，不能追求“术”到极致去悟“道”，那只是一个靠“术”养家糊口的工匠而已。作者根据多年来的实践探索，总结了大量的 Java 代码精简之“术”，试图阐述出心中的 Java 代码精简之“道”。</p>
</blockquote>
<h2 id="1-利用语法"><a href="#1-利用语法" class="headerlink" title="1.利用语法"></a><strong>1.利用语法</strong></h2><h3 id="1-1-利用三元表达式"><a href="#1-1-利用三元表达式" class="headerlink" title="1.1.利用三元表达式"></a><strong>1.1.利用三元表达式</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String title;</span><br><span class="line"><span class="keyword">if</span> (isMember(phone)) &#123;</span><br><span class="line">    title = <span class="string">&quot;会员&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    title = <span class="string">&quot;游客&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String title = isMember(phone) ? <span class="string">&quot;会员&quot;</span> : <span class="string">&quot;游客&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>注意：对于包装类型的算术计算，需要注意避免拆包时的空指针问题。</p>
<h3 id="1-2-利用-for-each-语句"><a href="#1-2-利用-for-each-语句" class="headerlink" title="1.2.利用 for-each 语句"></a><strong>1.2.利用 for-each 语句</strong></h3><p>从 Java 5 起，提供了 for-each 循环，简化了数组和集合的循环遍历。 for-each 循环允许你无需保持传统 for 循环中的索引就可以遍历数组，或在使用迭代器时无需在 while 循环中调用 hasNext 方法和 next 方法就可以遍历集合。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">double</span>[] values = ...;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">    <span class="keyword">double</span> value = values[i];</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 处理value</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;Double&gt; valueList = ...;</span><br><span class="line">Iterator&lt;Double&gt; iterator = valueList.iterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    Double value = iterator.next();</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 处理value</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">double</span>[] values = ...;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">double</span> value : values) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 处理value</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;Double&gt; valueList = ...;</span><br><span class="line"><span class="keyword">for</span>(Double value : valueList) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 处理value</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-利用-try-with-resource-语句"><a href="#1-3-利用-try-with-resource-语句" class="headerlink" title="1.3.利用 try-with-resource 语句"></a><strong>1.3.利用 try-with-resource 语句</strong></h3><p>所有实现 Closeable 接口的“资源”，均可采用 try-with-resource 进行简化。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BufferedReader reader = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="string">&quot;cities.csv&quot;</span>));</span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 处理line</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;读取文件异常&quot;</span>, e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (reader != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            reader.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;关闭文件异常&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="string">&quot;test.txt&quot;</span>))) &#123;</span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 处理line</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;读取文件异常&quot;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-利用-return-关键字"><a href="#1-4-利用-return-关键字" class="headerlink" title="1.4.利用 return 关键字"></a><strong>1.4.利用 return 关键字</strong></h3><p>利用 return 关键字，可以提前函数返回，避免定义中间变量。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasSuper</span><span class="params">(<span class="meta">@NonNull</span> List&lt;UserDO&gt; userList)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> hasSuper = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (UserDO user : userList) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Boolean.TRUE.equals(user.getIsSuper())) &#123;</span><br><span class="line">            hasSuper = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hasSuper;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasSuper</span><span class="params">(<span class="meta">@NonNull</span> List&lt;UserDO&gt; userList)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (UserDO user : userList) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Boolean.TRUE.equals(user.getIsSuper())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-5-利用-static-关键字"><a href="#1-5-利用-static-关键字" class="headerlink" title="1.5.利用 static 关键字"></a><strong>1.5.利用 static 关键字</strong></h3><p>利用 static 关键字，可以把字段变成静态字段，也可以把函数变为静态函数，调用时就无需初始化类对象。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GisHelper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">distance</span><span class="params">(<span class="keyword">double</span> lng1, <span class="keyword">double</span> lat1, <span class="keyword">double</span> lng2, <span class="keyword">double</span> lat2)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 方法实现代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GisHelper gisHelper = <span class="keyword">new</span> GisHelper();</span><br><span class="line"><span class="keyword">double</span> distance = gisHelper.distance(<span class="number">116.178692D</span>, <span class="number">39.967115D</span>, <span class="number">116.410778D</span>, <span class="number">39.899721D</span>);</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GisHelper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">distance</span><span class="params">(<span class="keyword">double</span> lng1, <span class="keyword">double</span> lat1, <span class="keyword">double</span> lng2, <span class="keyword">double</span> lat2)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 方法实现代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> distance = GisHelper.distance(<span class="number">116.178692D</span>, <span class="number">39.967115D</span>, <span class="number">116.410778D</span>, <span class="number">39.899721D</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-6-利用-lambda-表达式"><a href="#1-6-利用-lambda-表达式" class="headerlink" title="1.6.利用 lambda 表达式"></a><strong>1.6.利用 lambda 表达式</strong></h3><p>Java 8 发布以后，lambda 表达式大量替代匿名内部类的使用，在简化了代码的同时，更突出了原有匿名内部类中真正有用的那部分代码。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 线程处理代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 线程处理代码</span></span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>

<h3 id="1-7-利用方法引用"><a href="#1-7-利用方法引用" class="headerlink" title="1.7.利用方法引用"></a><strong>1.7.利用方法引用</strong></h3><p>方法引用（::），可以简化 lambda 表达式，省略变量声明和函数调用。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Arrays.sort(nameArray, (a, b) -&gt; a.compareToIgnoreCase(b));</span><br><span class="line">List&lt;Long&gt; userIdList = userList.stream()</span><br><span class="line">    .map(user -&gt; user.getId())</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Arrays.sort(nameArray, String::compareToIgnoreCase);</span><br><span class="line">List&lt;Long&gt; userIdList = userList.stream()</span><br><span class="line">    .map(UserDO::getId)</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<h3 id="1-8-利用静态导入"><a href="#1-8-利用静态导入" class="headerlink" title="1.8.利用静态导入"></a><strong>1.8.利用静态导入</strong></h3><p>静态导入（import static），当程序中大量使用同一静态常量和函数时，可以简化静态常量和函数的引用。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Double&gt; areaList = radiusList.stream().map(r -&gt; Math.PI * Math.pow(r, <span class="number">2</span>)).collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Double&gt; areaList = radiusList.stream().map(r -&gt; PI * pow(r, <span class="number">2</span>)).collect(toList());</span><br></pre></td></tr></table></figure>

<p>注意：静态引入容易造成代码阅读困难，所以在实际项目中应该警慎使用。</p>
<h3 id="1-9-利用-unchecked-异常"><a href="#1-9-利用-unchecked-异常" class="headerlink" title="1.9.利用 unchecked 异常"></a><strong>1.9.利用 unchecked 异常</strong></h3><p>Java 的异常分为两类：Checked 异常和 Unchecked 异常。Unchecked 异常继承了RuntimeException ，特点是代码不需要处理它们也能通过编译，所以它们称作 Unchecked 异常。利用 Unchecked 异常，可以避免不必要的 try-catch 和 throws 异常处理。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createUser</span><span class="params">(UserCreateVO create, OpUserVO user)</span> <span class="keyword">throws</span> BusinessException </span>&#123;</span><br><span class="line">        checkOperatorUser(user);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkOperatorUser</span><span class="params">(OpUserVO user)</span> <span class="keyword">throws</span> BusinessException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasPermission(user)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(<span class="string">&quot;用户无操作权限&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/createUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;Void&gt; <span class="title">createUser</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Valid</span> UserCreateVO create, OpUserVO user)</span> <span class="keyword">throws</span> BusinessException </span>&#123;</span><br><span class="line">        userService.createUser(create, user);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createUser</span><span class="params">(UserCreateVO create, OpUserVO user)</span> </span>&#123;</span><br><span class="line">        checkOperatorUser(user);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkOperatorUser</span><span class="params">(OpUserVO user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasPermission(user)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BusinessRuntimeException(<span class="string">&quot;用户无操作权限&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/createUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;Void&gt; <span class="title">createUser</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Valid</span> UserCreateVO create, OpUserVO user)</span> </span>&#123;</span><br><span class="line">        userService.createUser(create, user);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="2-利用注解"><a href="#2-利用注解" class="headerlink" title="2.利用注解"></a><strong>2.利用注解</strong></h2><p><strong>2.1.利用 Lombok 注解</strong></p>
<p>Lombok 提供了一组有用的注解，可以用来消除Java类中的大量样板代码</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-利用-Validation-注解"><a href="#2-2-利用-Validation-注解" class="headerlink" title="2.2.利用 Validation 注解"></a><strong>2.2.利用 Validation 注解</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToStringpublic</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserCreateVO</span> </span>&#123;</span><br><span class="line">     <span class="meta">@NotBlank(message = &quot;用户名称不能为空&quot;)</span></span><br><span class="line">     <span class="keyword">private</span> String name;</span><br><span class="line">     <span class="meta">@NotNull(message = &quot;公司标识不能为空&quot;)</span></span><br><span class="line">     <span class="keyword">private</span> Long companyId;    ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="meta">@Validatedpublic</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">createUser</span><span class="params">(<span class="meta">@Valid</span> UserCreateVO create)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> 创建用户        </span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserCreateVO</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;用户名称不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@NotNull(message = &quot;公司标识不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long companyId;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">createUser</span><span class="params">(<span class="meta">@Valid</span> UserCreateVO create)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 创建用户</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-利用-NonNull-注解"><a href="#2-3-利用-NonNull-注解" class="headerlink" title="2.3.利用 @NonNull 注解"></a><strong>2.3.利用 @NonNull 注解</strong></h3><p>Spring 的 @NonNull 注解，用于标注参数或返回值非空，适用于项目内部团队协作。只要实现方和调用方遵循规范，可以避免不必要的空值判断，这充分体现了阿里的“新六脉神剑”提倡的“因为信任，所以简单”。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;UserVO&gt; <span class="title">queryCompanyUser</span><span class="params">(Long companyId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检查公司标识</span></span><br><span class="line">    <span class="keyword">if</span> (companyId == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询返回用户</span></span><br><span class="line">    List&lt;UserDO&gt; userList = userDAO.queryByCompanyId(companyId);</span><br><span class="line">    <span class="keyword">return</span> userList.stream().map(<span class="keyword">this</span>::transUser).collect(Collectors.toList());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Long companyId = <span class="number">1L</span>;</span><br><span class="line">List&lt;UserVO&gt; userList = queryCompanyUser(companyId);</span><br><span class="line"><span class="keyword">if</span> (CollectionUtils.isNotEmpty(userList)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (UserVO user : userList) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 处理公司用户</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@NonNull</span> <span class="function">List&lt;UserVO&gt; <span class="title">queryCompanyUser</span><span class="params">(<span class="meta">@NonNull</span> Long companyId)</span> </span>&#123;</span><br><span class="line">    List&lt;UserDO&gt; userList = userDAO.queryByCompanyId(companyId);</span><br><span class="line">    <span class="keyword">return</span> userList.stream().map(<span class="keyword">this</span>::transUser).collect(Collectors.toList());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Long companyId = <span class="number">1L</span>;</span><br><span class="line">List&lt;UserVO&gt; userList = queryCompanyUser(companyId);</span><br><span class="line"><span class="keyword">for</span> (UserVO user : userList) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 处理公司用户</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-利用注解特性"><a href="#2-4-利用注解特性" class="headerlink" title="2.4.利用注解特性"></a><strong>2.4.利用注解特性</strong></h3><p>注解有以下特性可用于精简注解声明：</p>
<p>1、当注解属性值跟默认值一致时，可以删除该属性赋值；</p>
<p>2、当注解只有value属性时，可以去掉value进行简写；</p>
<p>3、当注解属性组合等于另一个特定注解时，直接采用该特定注解。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Lazy(true)</span>;</span><br><span class="line"><span class="meta">@Service(value = &quot;userService&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/getUser&quot;, method = RequestMethod.GET)</span></span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Lazy</span></span><br><span class="line"><span class="meta">@Service(&quot;userService&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getUser&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="3-利用泛型"><a href="#3-利用泛型" class="headerlink" title="3.利用泛型"></a><strong>3.利用泛型</strong></h2><p><strong>3.1.泛型接口</strong></p>
<p>在 Java 没有引入泛型前，都是采用 Object 表示通用对象，最大的问题就是类型无法强校验并且需要强制类型转换。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object other)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVO</span> <span class="keyword">implements</span> <span class="title">Comparable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object other)</span> </span>&#123;</span><br><span class="line">        UserVO user = (UserVO)other;</span><br><span class="line">        <span class="keyword">return</span> Long.compare(<span class="keyword">this</span>.id, user.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(T other)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVO</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">UserVO</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(UserVO other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Long.compare(<span class="keyword">this</span>.id, other.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-泛型类"><a href="#3-2-泛型类" class="headerlink" title="3.2.泛型类"></a><strong>3.2.泛型类</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntPoint</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer x;</span><br><span class="line">    <span class="keyword">private</span> Integer y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoublePoint</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Double x;</span><br><span class="line">    <span class="keyword">private</span> Double y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Point</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Number</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T x;</span><br><span class="line">    <span class="keyword">private</span> T y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-泛型方法"><a href="#3-3-泛型方法" class="headerlink" title="3.3.泛型方法"></a><strong>3.3.泛型方法</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Integer&gt; <span class="title">newHashMap</span><span class="params">(String[] keys, Integer[] values)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检查参数非空</span></span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(keys) || ArrayUtils.isEmpty(values)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转化哈希映射</span></span><br><span class="line">    Map&lt;String, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> length = Math.min(keys.length, values.length);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        map.put(keys[i], values[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K, V&gt; <span class="function">Map&lt;K, V&gt; <span class="title">newHashMap</span><span class="params">(K[] keys, V[] values)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检查参数非空</span></span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(keys) || ArrayUtils.isEmpty(values)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转化哈希映射</span></span><br><span class="line">    Map&lt;K, V&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> length = Math.min(keys.length, values.length);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        map.put(keys[i], values[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-利用自身方法"><a href="#4-利用自身方法" class="headerlink" title="4.利用自身方法"></a><strong>4.利用自身方法</strong></h2><p><strong>4.1.利用构造方法</strong></p>
<p>构造方法，可以简化对象的初始化和设置属性操作。对于属性字段较少的类，可以自定义构造方法。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageDataVO</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long totalCount;</span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; dataList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PageDataVO&lt;UserVO&gt; pageData = <span class="keyword">new</span> PageDataVO&lt;&gt;();</span><br><span class="line">pageData.setTotalCount(totalCount);</span><br><span class="line">pageData.setDataList(userList);</span><br><span class="line"><span class="keyword">return</span> pageData;</span><br></pre></td></tr></table></figure>

<p><strong>精简</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageDataVO</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long totalCount;</span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; dataList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> PageDataVO&lt;&gt;(totalCount, userList);</span><br></pre></td></tr></table></figure>

<p>注意：如果属性字段被替换时，存在构造函数初始化赋值问题。比如把属性字段title替换为 nickname ，由于构造函数的参数个数和类型不变，原有构造函数初始化语句不会报错，导致把原title值赋值给 nickname 。如果采用 Setter 方法赋值，编译器会提示错误并要求修复。</p>
<h3 id="4-2-利用-Set-的-add-方法"><a href="#4-2-利用-Set-的-add-方法" class="headerlink" title="4.2.利用 Set 的 add 方法"></a><strong>4.2.利用 Set 的 add 方法</strong></h3><p>利用 Set 的 add 方法的返回值，可以直接知道该值是否已经存在，可以避免调用 contains 方法判断存在。</p>
<p><strong>普通：</strong></p>
<p>以下案例是进行用户去重转化操作，需要先调用 contains 方法判断存在，后调用add方法进行添加。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Set&lt;Long&gt; userIdSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">List&lt;UserVO&gt; userVOList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (UserDO userDO : userDOList) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!userIdSet.contains(userDO.getId())) &#123;</span><br><span class="line">        userIdSet.add(userDO.getId());</span><br><span class="line">        userVOList.add(transUser(userDO));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SSet&lt;Long&gt; userIdSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">List&lt;UserVO&gt; userVOList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (UserDO userDO : userDOList) &#123;</span><br><span class="line">    <span class="keyword">if</span> (userIdSet.add(userDO.getId())) &#123;</span><br><span class="line">        userVOList.add(transUser(userDO));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-利用-Map-的-computeIfAbsent-方法"><a href="#4-3-利用-Map-的-computeIfAbsent-方法" class="headerlink" title="4.3.利用 Map 的 computeIfAbsent 方法"></a><strong>4.3.利用 Map 的 computeIfAbsent</strong> <strong>方法</strong></h3><p>利用 Map 的 computeIfAbsent 方法，可以保证获取到的对象非空，从而避免了不必要的空判断和重新设置值。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Long, List&lt;UserDO&gt;&gt; roleUserMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (UserDO userDO : userDOList) &#123;</span><br><span class="line">    Long roleId = userDO.getRoleId();</span><br><span class="line">    List&lt;UserDO&gt; userList = roleUserMap.get(roleId);</span><br><span class="line">    <span class="keyword">if</span> (Objects.isNull(userList)) &#123;</span><br><span class="line">        userList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        roleUserMap.put(roleId, userList);</span><br><span class="line">    &#125;</span><br><span class="line">    userList.add(userDO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Long, List&lt;UserDO&gt;&gt; roleUserMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (UserDO userDO : userDOList) &#123;</span><br><span class="line">    roleUserMap.computeIfAbsent(userDO.getRoleId(), key -&gt; <span class="keyword">new</span> ArrayList&lt;&gt;())</span><br><span class="line">        .add(userDO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-利用链式编程"><a href="#4-4-利用链式编程" class="headerlink" title="4.4.利用链式编程"></a><strong>4.4.利用链式编程</strong></h3><p>链式编程，也叫级联式编程，调用对象的函数时返回一个this对象指向对象本身，达到链式效果，可以级联调用。链式编程的优点是：编程性强、可读性强、代码简洁。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">StringBuilder builder = <span class="keyword">new</span> StringBuilder(<span class="number">96</span>);</span><br><span class="line">builder.append(<span class="string">&quot;select id, name from &quot;</span>);</span><br><span class="line">builder.append(T_USER);</span><br><span class="line">builder.append(<span class="string">&quot; where id = &quot;</span>);</span><br><span class="line">builder.append(userId);</span><br><span class="line">builder.append(<span class="string">&quot;;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">StringBuilder builder = <span class="keyword">new</span> StringBuilder(<span class="number">96</span>);</span><br><span class="line">builder.append(<span class="string">&quot;select id, name from &quot;</span>)</span><br><span class="line">    .append(T_USER)</span><br><span class="line">    .append(<span class="string">&quot; where id = &quot;</span>)</span><br><span class="line">    .append(userId)</span><br><span class="line">    .append(<span class="string">&quot;;&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="5-利用工具方法"><a href="#5-利用工具方法" class="headerlink" title="5.利用工具方法"></a><strong>5.利用工具方法</strong></h2><p><strong>5.1.避免空值判断</strong></p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (userList != <span class="keyword">null</span> &amp;&amp; !userList.isEmpty()) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 处理代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (CollectionUtils.isNotEmpty(userList)) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 处理代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-避免条件判断"><a href="#5-2-避免条件判断" class="headerlink" title="5.2.避免条件判断"></a><strong>5.2.避免条件判断</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">double</span> result;</span><br><span class="line"><span class="keyword">if</span> (value &lt;= MIN_LIMIT) &#123;</span><br><span class="line">    result = MIN_LIMIT;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    result = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">double</span> result = Math.max(MIN_LIMIT, value);</span><br></pre></td></tr></table></figure>

<h3 id="5-3-简化赋值语句"><a href="#5-3-简化赋值语句" class="headerlink" title="5.3.简化赋值语句"></a><strong>5.3.简化赋值语句</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; ANIMAL_LIST;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    List&lt;String&gt; animalList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    animalList.add(<span class="string">&quot;dog&quot;</span>);</span><br><span class="line">    animalList.add(<span class="string">&quot;cat&quot;</span>);</span><br><span class="line">    animalList.add(<span class="string">&quot;tiger&quot;</span>);</span><br><span class="line">    ANIMAL_LIST = Collections.unmodifiableList(animalList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JDK流派</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; ANIMAL_LIST = Arrays.asList(<span class="string">&quot;dog&quot;</span>, <span class="string">&quot;cat&quot;</span>, <span class="string">&quot;tiger&quot;</span>);</span><br><span class="line"><span class="comment">// Guava流派</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; ANIMAL_LIST = ImmutableList.of(<span class="string">&quot;dog&quot;</span>, <span class="string">&quot;cat&quot;</span>, <span class="string">&quot;tiger&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>注意：Arrays.asList 返回的 List 并不是 ArrayList ，不支持 add 等变更操作。</p>
<h3 id="5-4-简化数据拷贝"><a href="#5-4-简化数据拷贝" class="headerlink" title="5.4.简化数据拷贝"></a><strong>5.4.简化数据拷贝</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">UserVO userVO = <span class="keyword">new</span> UserVO();</span><br><span class="line">userVO.setId(userDO.getId());</span><br><span class="line">userVO.setName(userDO.getName());</span><br><span class="line">...</span><br><span class="line">userVO.setDescription(userDO.getDescription());</span><br><span class="line">userVOList.add(userVO);</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">UserVO userVO = <span class="keyword">new</span> UserVO();</span><br><span class="line">BeanUtils.copyProperties(userDO, userVO);</span><br><span class="line">userVOList.add(userVO);</span><br></pre></td></tr></table></figure>

<p><strong>反列：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;UserVO&gt; userVOList = JSON.parseArray(JSON.toJSONString(userDOList), UserVO.class);</span><br></pre></td></tr></table></figure>

<p>精简代码，但不能以过大的性能损失为代价。例子是浅层拷贝，用不着 JSON 这样重量级的武器。</p>
<p><strong>5.5.简化异常断言</strong></p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (Objects.isNull(userId)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;用户标识不能为空&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Assert.notNull(userId, <span class="string">&quot;用户标识不能为空&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>注意：可能有些插件不认同这种判断，导致使用该对象时会有空指针警告。</p>
<h3 id="5-6-简化测试用例"><a href="#5-6-简化测试用例" class="headerlink" title="5.6.简化测试用例"></a><strong>5.6.简化测试用例</strong></h3><p>把测试用例数据以 JSON 格式存入文件中，通过 JSON 的 parseObject 和 parseArray 方法解析成对象。虽然执行效率上有所下降，但可以减少大量的赋值语句，从而精简了测试代码。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserCreateVO userCreate = <span class="keyword">new</span> UserCreateVO();</span><br><span class="line">    userCreate.setName(<span class="string">&quot;Changyi&quot;</span>);</span><br><span class="line">    userCreate.setTitle(<span class="string">&quot;Developer&quot;</span>);</span><br><span class="line">    userCreate.setCompany(<span class="string">&quot;AMAP&quot;</span>);</span><br><span class="line">    ...</span><br><span class="line">    Long userId  = userService.createUser(OPERATOR, userCreate);</span><br><span class="line">    Assert.assertNotNull(userId, <span class="string">&quot;创建用户失败&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String jsonText = ResourceHelper.getResourceAsString(getClass(), <span class="string">&quot;createUser.json&quot;</span>);</span><br><span class="line">    UserCreateVO userCreate = JSON.parseObject(jsonText, UserCreateVO.class);</span><br><span class="line">    Long userId  = userService.createUser(OPERATOR, userCreate);</span><br><span class="line">    Assert.assertNotNull(userId, <span class="string">&quot;创建用户失败&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>建议：JSON 文件名最好以被测试的方法命名，如果有多个版本可以用数字后缀表示。</p>
<h3 id="5-7-简化算法实现"><a href="#5-7-简化算法实现" class="headerlink" title="5.7.简化算法实现"></a><strong>5.7.简化算法实现</strong></h3><p>一些常规算法，已有现成的工具方法，我们就没有必要自己实现了。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> totalSize = valueList.size();</span><br><span class="line">List&lt;List&lt;Integer&gt;&gt; partitionList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; totalSize; i += PARTITION_SIZE) &#123;</span><br><span class="line">    partitionList.add(valueList.subList(i, Math.min(i + PARTITION_SIZE, totalSize)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;List&lt;Integer&gt;&gt; partitionList = ListUtils.partition(valueList, PARTITION_SIZE);</span><br></pre></td></tr></table></figure>

<p><strong>5.8.封装工具方法</strong></p>
<p>一些特殊算法，没有现成的工具方法，我们就只好自己亲自实现了。</p>
<p><strong>普通：</strong></p>
<p>比如，SQL 设置参数值的方法就比较难用，setLong 方法不能设置参数值为 null 。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 设置参数值</span></span><br><span class="line"><span class="keyword">if</span> (Objects.nonNull(user.getId())) &#123;</span><br><span class="line">  statement.setLong(<span class="number">1</span>, user.getId());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    statement.setNull(<span class="number">1</span>, Types.BIGINT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<p>我们可以封装为一个工具类 SqlHelper ，简化设置参数值的代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** SQL辅助类 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlHelper</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 设置长整数值 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setLong</span><span class="params">(PreparedStatement statement, <span class="keyword">int</span> index, Long value)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(value)) &#123;</span><br><span class="line">            statement.setLong(index, value.longValue());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            statement.setNull(index, Types.BIGINT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 设置参数值</span></span><br><span class="line">SqlHelper.setLong(statement, <span class="number">1</span>, user.getId());</span><br></pre></td></tr></table></figure>

<h2 id="6-利用数据结构"><a href="#6-利用数据结构" class="headerlink" title="6.利用数据结构"></a><strong>6.利用数据结构</strong></h2><p><strong>6.1.利用数组简化</strong></p>
<p>对于固定上下限范围的 if-else 语句，可以用数组+循环来简化。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getGrade</span><span class="params">(<span class="keyword">double</span> score)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (score &gt;= <span class="number">90.0D</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (score &gt;= <span class="number">80.0D</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (score &gt;= <span class="number">60.0D</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (score &gt;= <span class="number">30.0D</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span>[] SCORE_RANGES = <span class="keyword">new</span> <span class="keyword">double</span>[] &#123;<span class="number">90.0D</span>, <span class="number">80.0D</span>, <span class="number">60.0D</span>, <span class="number">30.0D</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getGrade</span><span class="params">(<span class="keyword">double</span> score)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SCORE_RANGES.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (score &gt;= SCORE_RANGES[i]) &#123;</span><br><span class="line">            <span class="keyword">return</span> i + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SCORE_RANGES.length + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思考：上面的案例返回值是递增的，所以用数组简化是没有问题的。但是，如果返回值不是递增的，能否用数组进行简化呢？答案是可以的，请自行思考解决。</p>
<h3 id="6-2-利用-Map-简化"><a href="#6-2-利用-Map-简化" class="headerlink" title="6.2.利用 Map 简化"></a><strong>6.2.利用 Map 简化</strong></h3><p>对于映射关系的 if-else 语句，可以用Map来简化。此外，此规则同样适用于简化映射关系的 switch 语句。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getBiologyClass</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (name) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;dog&quot;</span> :</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;animal&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;cat&quot;</span> :</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;animal&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;lavender&quot;</span> :</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;plant&quot;</span>;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">default</span> :</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, String&gt; BIOLOGY_CLASS_MAP</span><br><span class="line">    = ImmutableMap.&lt;String, String&gt;builder()</span><br><span class="line">        .put(<span class="string">&quot;dog&quot;</span>, <span class="string">&quot;animal&quot;</span>)</span><br><span class="line">        .put(<span class="string">&quot;cat&quot;</span>, <span class="string">&quot;animal&quot;</span>)</span><br><span class="line">        .put(<span class="string">&quot;lavender&quot;</span>, <span class="string">&quot;plant&quot;</span>)</span><br><span class="line">        ...</span><br><span class="line">        .build();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getBiologyClass</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BIOLOGY_CLASS_MAP.get(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>已经把方法简化为一行代码，其实都没有封装方法的必要了。</p>
<h3 id="6-3-利用容器类简化"><a href="#6-3-利用容器类简化" class="headerlink" title="6.3.利用容器类简化"></a><strong>6.3.利用容器类简化</strong></h3><p>Java 不像 Python 和 Go ，方法不支持返回多个对象。如果需要返回多个对象，就必须自定义类，或者利用容器类。常见的容器类有 Apache 的 Pair 类和 Triple 类， Pair 类支持返回 2 个对象， Triple 类支持返回 3 个对象。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PointAndDistance</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Point point;</span><br><span class="line">    <span class="keyword">private</span> Double distance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PointAndDistance <span class="title">getNearest</span><span class="params">(Point point, Point[] points)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 计算最近点和距离</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回最近点和距离</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PointAndDistance(nearestPoint, nearestDistance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Pair&lt;Point, Double&gt; <span class="title">getNearest</span><span class="params">(Point point, Point[] points)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 计算最近点和距离</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回最近点和距离</span></span><br><span class="line">    <span class="keyword">return</span> ImmutablePair.of(nearestPoint, nearestDistance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-利用-ThreadLocal-简化"><a href="#6-4-利用-ThreadLocal-简化" class="headerlink" title="6.4.利用 ThreadLocal 简化"></a><strong>6.4.利用 ThreadLocal 简化</strong></h3><p>ThreadLocal 提供了线程专有对象，可以在整个线程生命周期中随时取用，极大地方便了一些逻辑的实现。用 ThreadLocal 保存线程上下文对象，可以避免不必要的参数传递。</p>
<p><strong>普通：</strong></p>
<p>由于 DateFormat 的 format 方法线程非安全（建议使用替代方法），在线程中频繁初始化 DateFormat 性能太低，如果考虑重用只能用参数传入 DateFormat 。例子如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">formatDate</span><span class="params">(Date date, DateFormat format)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> format.format(date);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getDateList</span><span class="params">(Date minDate, Date maxDate, DateFormat format)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; dateList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    Calendar calendar = Calendar.getInstance();</span><br><span class="line">    calendar.setTime(minDate);</span><br><span class="line">    String currDate = formatDate(calendar.getTime(), format);</span><br><span class="line">    String maxsDate = formatDate(maxDate, format);</span><br><span class="line">    <span class="keyword">while</span> (currDate.compareTo(maxsDate) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        dateList.add(currDate);</span><br><span class="line">        calendar.add(Calendar.DATE, <span class="number">1</span>);</span><br><span class="line">        currDate = formatDate(calendar.getTime(), format);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dateList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<p>可能你会觉得以下的代码量反而多了，如果调用工具方法的地方比较多，就可以省下一大堆 DateFormat 初始化和传入参数的代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DateFormat&gt; LOCAL_DATE_FORMAT = <span class="keyword">new</span> ThreadLocal&lt;DateFormat&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> DateFormat <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyyMMdd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">formatDate</span><span class="params">(Date date)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> LOCAL_DATE_FORMAT.get().format(date);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getDateList</span><span class="params">(Date minDate, Date maxDate)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; dateList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    Calendar calendar = Calendar.getInstance();</span><br><span class="line">    calendar.setTime(minDate);</span><br><span class="line">    String currDate = formatDate(calendar.getTime());</span><br><span class="line">    String maxsDate = formatDate(maxDate);</span><br><span class="line">    <span class="keyword">while</span> (currDate.compareTo(maxsDate) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        dateList.add(currDate);</span><br><span class="line">        calendar.add(Calendar.DATE, <span class="number">1</span>);</span><br><span class="line">        currDate = formatDate(calendar.getTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dateList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：ThreadLocal 有一定的内存泄露的风险，尽量在业务代码结束前调用 remove 方法进行数据清除。</p>
<h2 id="7-利用-Optional"><a href="#7-利用-Optional" class="headerlink" title="7.利用 Optional"></a><strong>7.利用 Optional</strong></h2><p>在 Java 8 里，引入了一个 Optional 类，该类是一个可以为 null 的容器对象。</p>
<h3 id="7-1-保证值存在"><a href="#7-1-保证值存在" class="headerlink" title="7.1.保证值存在"></a><strong>7.1.保证值存在</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Integer thisValue;</span><br><span class="line"><span class="keyword">if</span> (Objects.nonNull(value)) &#123;</span><br><span class="line">    thisValue = value;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    thisValue = DEFAULT_VALUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Integer thisValue = Optional.ofNullable(value).orElse(DEFAULT_VALUE);</span><br></pre></td></tr></table></figure>

<h3 id="7-2-保证值合法"><a href="#7-2-保证值合法" class="headerlink" title="7.2.保证值合法"></a><strong>7.2.保证值合法</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Integer thisValue;</span><br><span class="line"><span class="keyword">if</span> (Objects.nonNull(value) &amp;&amp; value.compareTo(MAX_VALUE) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    thisValue = value;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    thisValue = MAX_VALUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Integer thisValue = Optional.ofNullable(value)</span><br><span class="line">    .filter(tempValue -&gt; tempValue.compareTo(MAX_VALUE) &lt;= <span class="number">0</span>).orElse(MAX_VALUE);</span><br></pre></td></tr></table></figure>

<h3 id="7-3-避免空判断"><a href="#7-3-避免空判断" class="headerlink" title="7.3.避免空判断"></a><strong>7.3.避免空判断</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String zipcode = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (Objects.nonNull(user)) &#123;</span><br><span class="line">    Address address = user.getAddress();</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(address)) &#123;</span><br><span class="line">        Country country = address.getCountry();</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(country)) &#123;</span><br><span class="line">            zipcode = country.getZipcode();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">tring zipcode = Optional.ofNullable(user).map(User::getAddress)</span><br><span class="line">    .map(Address::getCountry).map(Country::getZipcode).orElse(<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>

<h2 id="8-利用-Stream"><a href="#8-利用-Stream" class="headerlink" title="8.利用 Stream"></a><strong>8.利用 Stream</strong></h2><p>流（Stream）是Java 8的新成员，允许你以声明式处理数据集合，可以看成为一个遍历数据集的高级迭代器。流主要有三部分构成：获取一个数据源→数据转换→执行操作获取想要的结果。每次转换原有 Stream 对象不改变，返回一个新的 Stream 对象，这就允许对其操作可以像链条一样排列，形成了一个管道。流（Stream）提供的功能非常有用，主要包括匹配、过滤、汇总、转化、分组、分组汇总等功能。</p>
<h3 id="8-1-匹配集合数据"><a href="#8-1-匹配集合数据" class="headerlink" title="8.1.匹配集合数据"></a><strong>8.1.匹配集合数据</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">boolean</span> isFound = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">for</span> (UserDO user : userList) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Objects.equals(user.getId(), userId)) &#123;</span><br><span class="line">        isFound = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">boolean</span> isFound = userList.stream()</span><br><span class="line">    .anyMatch(user -&gt; Objects.equals(user.getId(), userId));</span><br></pre></td></tr></table></figure>

<h3 id="8-2-过滤集合数据"><a href="#8-2-过滤集合数据" class="headerlink" title="8.2.过滤集合数据"></a><strong>8.2.过滤集合数据</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;UserDO&gt; resultList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (UserDO user : userList) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Boolean.TRUE.equals(user.getIsSuper())) &#123;</span><br><span class="line">        resultList.add(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;UserDO&gt; resultList = userList.stream()</span><br><span class="line">    .filter(user -&gt; Boolean.TRUE.equals(user.getIsSuper()))</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<h3 id="8-3-汇总集合数据"><a href="#8-3-汇总集合数据" class="headerlink" title="8.3.汇总集合数据"></a><strong>8.3.汇总集合数据</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">double</span> total = <span class="number">0.0D</span>;</span><br><span class="line"><span class="keyword">for</span> (Account account : accountList) &#123;</span><br><span class="line">    total += account.getBalance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">double</span> total = accountList.stream().mapToDouble(Account::getBalance).sum();</span><br></pre></td></tr></table></figure>

<h3 id="8-4-转化集合数据"><a href="#8-4-转化集合数据" class="headerlink" title="8.4.转化集合数据"></a><strong>8.4.转化集合数据</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;UserVO&gt; userVOList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (UserDO userDO : userDOList) &#123;</span><br><span class="line">    userVOList.add(transUser(userDO));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;UserVO&gt; userVOList = userDOList.stream()</span><br><span class="line">    .map(<span class="keyword">this</span>::transUser).collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<h3 id="8-5-分组集合数据"><a href="#8-5-分组集合数据" class="headerlink" title="8.5.分组集合数据"></a><strong>8.5.分组集合数据</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Long, List&lt;UserDO&gt;&gt; roleUserMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (UserDO userDO : userDOList) &#123;</span><br><span class="line">    roleUserMap.computeIfAbsent(userDO.getRoleId(), key -&gt; <span class="keyword">new</span> ArrayList&lt;&gt;())</span><br><span class="line">        .add(userDO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Long, List&lt;UserDO&gt;&gt; roleUserMap = userDOList.stream()</span><br><span class="line">    .collect(Collectors.groupingBy(UserDO::getRoleId));</span><br></pre></td></tr></table></figure>

<h3 id="8-6-分组汇总集合"><a href="#8-6-分组汇总集合" class="headerlink" title="8.6.分组汇总集合"></a><strong>8.6.分组汇总集合</strong></h3><p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Long, Double&gt; roleTotalMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (Account account : accountList) &#123;</span><br><span class="line">    Long roleId = account.getRoleId();</span><br><span class="line">    Double total = Optional.ofNullable(roleTotalMap.get(roleId)).orElse(<span class="number">0.0D</span>);</span><br><span class="line">    roleTotalMap.put(roleId, total + account.getBalance());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">roleTotalMap = accountList.stream().collect(Collectors.groupingBy(Account::getRoleId, Collectors.summingDouble(Account::getBalance)));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="8-7-生成范围集合"><a href="#8-7-生成范围集合" class="headerlink" title="8.7.生成范围集合"></a><strong>8.7.生成范围集合</strong></h3><p>Python 的 range 非常方便，Stream 也提供了类似的方法。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span>[] array1 = <span class="keyword">new</span> <span class="keyword">int</span>[N];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    array1[i] = i + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>[] array2 = <span class="keyword">new</span> <span class="keyword">int</span>[N];</span><br><span class="line">array2[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; N; i++) &#123;</span><br><span class="line">    array2[i] = array2[i - <span class="number">1</span>] * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span>[] array1 = IntStream.rangeClosed(<span class="number">1</span>, N).toArray();</span><br><span class="line"><span class="keyword">int</span>[] array2 = IntStream.iterate(<span class="number">1</span>, n -&gt; n * <span class="number">2</span>).limit(N).toArray();</span><br></pre></td></tr></table></figure>

<h2 id="9-利用程序结构"><a href="#9-利用程序结构" class="headerlink" title="9.利用程序结构"></a><strong>9.利用程序结构</strong></h2><h3 id="9-1-返回条件表达式"><a href="#9-1-返回条件表达式" class="headerlink" title="9.1.返回条件表达式"></a><strong>9.1.返回条件表达式</strong></h3><p>条件表达式判断返回布尔值，条件表达式本身就是结果。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSuper</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    UserDO user </span>= userDAO.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(user) &amp;&amp; Boolean.TRUE.equals(user.getIsSuper())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSuper</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    UserDO user </span>= userDAO.get(userId);</span><br><span class="line">    <span class="keyword">return</span> Objects.nonNull(user) &amp;&amp; Boolean.TRUE.equals(user.getIsSuper());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-2-最小化条件作用域"><a href="#9-2-最小化条件作用域" class="headerlink" title="9.2.最小化条件作用域"></a><strong>9.2.最小化条件作用域</strong></h3><p>最小化条件作用域，尽量提出公共处理代码。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Result result = summaryService.reportWorkDaily(workDaily);</span><br><span class="line"><span class="keyword">if</span> (result.isSuccess()) &#123;</span><br><span class="line">    String message = <span class="string">&quot;上报工作日报成功&quot;</span>;</span><br><span class="line">    dingtalkService.sendMessage(user.getPhone(), message);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    String message = <span class="string">&quot;上报工作日报失败:&quot;</span> + result.getMessage();</span><br><span class="line">    log.warn(message);</span><br><span class="line">    dingtalkService.sendMessage(user.getPhone(), message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String message;</span><br><span class="line">Result result = summaryService.reportWorkDaily(workDaily);</span><br><span class="line"><span class="keyword">if</span> (result.isSuccess()) &#123;</span><br><span class="line">    message = <span class="string">&quot;上报工作日报成功&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    message = <span class="string">&quot;上报工作日报失败:&quot;</span> + result.getMessage();</span><br><span class="line">    log.warn(message);</span><br><span class="line">&#125;</span><br><span class="line">dingtalkService.sendMessage(user.getPhone(), message);</span><br></pre></td></tr></table></figure>

<h3 id="9-3-调整表达式位置"><a href="#9-3-调整表达式位置" class="headerlink" title="9.3.调整表达式位置"></a><strong>9.3.调整表达式位置</strong></h3><p>调整表达式位置，在逻辑不变的前提下，让代码变得更简洁。</p>
<p><strong>普通1：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String line = readLine();</span><br><span class="line"><span class="keyword">while</span> (Objects.nonNull(line)) &#123;</span><br><span class="line">    ... <span class="comment">// 处理逻辑代码</span></span><br><span class="line">    line = readLine();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>普通2：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (String line = readLine(); Objects.nonNull(line); line = readLine()) &#123;</span><br><span class="line">    ... <span class="comment">// 处理逻辑代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String line;</span><br><span class="line"><span class="keyword">while</span> (Objects.nonNull(line = readLine())) &#123;</span><br><span class="line">    ... <span class="comment">// 处理逻辑代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：有些规范可能不建议这种精简写法。</p>
<h3 id="9-4-利用非空对象"><a href="#9-4-利用非空对象" class="headerlink" title="9.4.利用非空对象"></a><strong>9.4.利用非空对象</strong></h3><p>在比较对象时，交换对象位置，利用非空对象，可以避免空指针判断。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_VALUE = <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">boolean</span> isMax = (value != <span class="keyword">null</span> &amp;&amp; value.equals(MAX_VALUE));</span><br><span class="line"><span class="keyword">boolean</span> isTrue = (result != <span class="keyword">null</span> &amp;&amp; result.equals(Boolean.TRUE));</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer MAX_VALUE = <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">boolean</span> isMax = MAX_VALUE.equals(value);</span><br><span class="line"><span class="keyword">boolean</span> isTrue = Boolean.TRUE.equals(result);</span><br></pre></td></tr></table></figure>

<h2 id="10-利用设计模式"><a href="#10-利用设计模式" class="headerlink" title="10.利用设计模式"></a><strong>10.利用设计模式</strong></h2><h3 id="10-1-模板方法模式"><a href="#10-1-模板方法模式" class="headerlink" title="10.1.模板方法模式"></a><strong>10.1.模板方法模式</strong></h3><p>模板方法模式（Template Method Pattern）定义一个固定的算法框架，而将算法的一些步骤放到子类中实现，使得子类可以在不改变算法框架的情况下重定义该算法的某些步骤。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserValue</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 值操作 */</span></span><br><span class="line">    <span class="meta">@Resource(name = &quot;stringRedisTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ValueOperations&lt;String, String&gt; valueOperations;</span><br><span class="line">    <span class="comment">/** 值模式 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_FORMAT = <span class="string">&quot;Value:User:%s&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 设置值 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Long id, UserDO value)</span> </span>&#123;</span><br><span class="line">        String key = String.format(KEY_FORMAT, id);</span><br><span class="line">        valueOperations.set(key, JSON.toJSONString(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取值 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDO <span class="title">get</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        String key = String.format(KEY_FORMAT, id);</span><br><span class="line">        String value = valueOperations.get(key);</span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(value, UserDO.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleValue</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 值操作 */</span></span><br><span class="line">    <span class="meta">@Resource(name = &quot;stringRedisTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ValueOperations&lt;String, String&gt; valueOperations;</span><br><span class="line">    <span class="comment">/** 值模式 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_FORMAT = <span class="string">&quot;Value:Role:%s&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 设置值 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Long id, RoleDO value)</span> </span>&#123;</span><br><span class="line">        String key = String.format(KEY_FORMAT, id);</span><br><span class="line">        valueOperations.set(key, JSON.toJSONString(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取值 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RoleDO <span class="title">get</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        String key = String.format(KEY_FORMAT, id);</span><br><span class="line">        String value = valueOperations.get(key);</span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(value, RoleDO.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDynamicValue</span>&lt;<span class="title">I</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** 值操作 */</span></span><br><span class="line">    <span class="meta">@Resource(name = &quot;stringRedisTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ValueOperations&lt;String, String&gt; valueOperations;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 设置值 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(I id, V value)</span> </span>&#123;</span><br><span class="line">        valueOperations.set(getKey(id), JSON.toJSONString(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取值 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(I id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(valueOperations.get(getKey(id)), getValueClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取主键 */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getKey</span><span class="params">(I id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取值类 */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Class&lt;V&gt; <span class="title">getValueClass</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserValue</span> <span class="keyword">extends</span> <span class="title">AbstractValue</span>&lt;<span class="title">Long</span>, <span class="title">UserDO</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** 获取主键 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getKey</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Value:User:%s&quot;</span>, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取值类 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Class&lt;UserDO&gt; <span class="title">getValueClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UserDO.class;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleValue</span> <span class="keyword">extends</span> <span class="title">AbstractValue</span>&lt;<span class="title">Long</span>, <span class="title">RoleDO</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** 获取主键 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getKey</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Value:Role:%s&quot;</span>, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取值类 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Class&lt;RoleDO&gt; <span class="title">getValueClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RoleDO.class;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-2-建造者模式"><a href="#10-2-建造者模式" class="headerlink" title="10.2.建造者模式"></a><strong>10.2.建造者模式</strong></h3><p>建造者模式（Builder Pattern）将一个复杂对象的构造与它的表示分离，使同样的构建过程可以创建不同的表示，这样的设计模式被称为建造者模式。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataHandler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** 解析数据 */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">parseData</span><span class="params">(Record record)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 存储数据 */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">storeData</span><span class="params">(List&lt;T&gt; dataList)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">long</span> <span class="title">executeFetch</span><span class="params">(String tableName, <span class="keyword">int</span> batchSize, DataHandler&lt;T&gt; dataHandler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 构建下载会话</span></span><br><span class="line">    DownloadSession session = buildSession(tableName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据数量</span></span><br><span class="line">    <span class="keyword">long</span> recordCount = session.getRecordCount();</span><br><span class="line">    <span class="keyword">if</span> (recordCount == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进行数据读取</span></span><br><span class="line">    <span class="keyword">long</span> fetchCount = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">try</span> (RecordReader reader = session.openRecordReader(<span class="number">0L</span>, recordCount, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        <span class="comment">// 依次读取数据</span></span><br><span class="line">        Record record;</span><br><span class="line">        List&lt;T&gt; dataList = <span class="keyword">new</span> ArrayList&lt;&gt;(batchSize);</span><br><span class="line">        <span class="keyword">while</span> ((record = reader.read()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 解析添加数据</span></span><br><span class="line">            T data = dataHandler.parseData(record);</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(data)) &#123;</span><br><span class="line">                dataList.add(data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 批量存储数据</span></span><br><span class="line">            <span class="keyword">if</span> (dataList.size() == batchSize) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> isContinue = dataHandler.storeData(dataList);</span><br><span class="line">                fetchCount += batchSize;</span><br><span class="line">                dataList.clear();</span><br><span class="line">                <span class="keyword">if</span> (!isContinue) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储剩余数据</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(dataList)) &#123;</span><br><span class="line">            dataHandler.storeData(dataList);</span><br><span class="line">            fetchCount += dataList.size();</span><br><span class="line">            dataList.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回获取数量</span></span><br><span class="line">    <span class="keyword">return</span> fetchCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 使用案例</span></span><br><span class="line"><span class="keyword">long</span> fetchCount = odpsService.executeFetch(<span class="string">&quot;user&quot;</span>, <span class="number">5000</span>, <span class="keyword">new</span> DataHandler() &#123;</span><br><span class="line">    <span class="comment">/** 解析数据 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">parseData</span><span class="params">(Record record)</span> </span>&#123;</span><br><span class="line">        UserDO user = <span class="keyword">new</span> UserDO();</span><br><span class="line">        user.setId(record.getBigint(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">        user.setName(record.getString(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 存储数据 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">storeData</span><span class="params">(List&lt;T&gt; dataList)</span> </span>&#123;</span><br><span class="line">        userDAO.batchInsert(dataList);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">long</span> <span class="title">executeFetch</span><span class="params">(String tableName, <span class="keyword">int</span> batchSize, Function&lt;Record, T&gt; dataParser, Function&lt;List&lt;T&gt;, Boolean&gt; dataStorage)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 构建下载会话</span></span><br><span class="line">    DownloadSession session = buildSession(tableName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据数量</span></span><br><span class="line">    <span class="keyword">long</span> recordCount = session.getRecordCount();</span><br><span class="line">    <span class="keyword">if</span> (recordCount == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进行数据读取</span></span><br><span class="line">    <span class="keyword">long</span> fetchCount = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">try</span> (RecordReader reader = session.openRecordReader(<span class="number">0L</span>, recordCount, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        <span class="comment">// 依次读取数据</span></span><br><span class="line">        Record record;</span><br><span class="line">        List&lt;T&gt; dataList = <span class="keyword">new</span> ArrayList&lt;&gt;(batchSize);</span><br><span class="line">        <span class="keyword">while</span> ((record = reader.read()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 解析添加数据</span></span><br><span class="line">            T data = dataParser.apply(record);</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(data)) &#123;</span><br><span class="line">                dataList.add(data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 批量存储数据</span></span><br><span class="line">            <span class="keyword">if</span> (dataList.size() == batchSize) &#123;</span><br><span class="line">                Boolean isContinue = dataStorage.apply(dataList);</span><br><span class="line">                fetchCount += batchSize;</span><br><span class="line">                dataList.clear();</span><br><span class="line">                <span class="keyword">if</span> (!Boolean.TRUE.equals(isContinue)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储剩余数据</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(dataList)) &#123;</span><br><span class="line">            dataStorage.apply(dataList);</span><br><span class="line">            fetchCount += dataList.size();</span><br><span class="line">            dataList.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回获取数量</span></span><br><span class="line">    <span class="keyword">return</span> fetchCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 使用案例</span></span><br><span class="line"><span class="keyword">long</span> fetchCount = odpsService.executeFetch(<span class="string">&quot;user&quot;</span>, <span class="number">5000</span>, record -&gt; &#123;</span><br><span class="line">        UserDO user = <span class="keyword">new</span> UserDO();</span><br><span class="line">        user.setId(record.getBigint(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">        user.setName(record.getString(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;, dataList -&gt; &#123;</span><br><span class="line">        userDAO.batchInsert(dataList);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>部类，代码较多较繁琐。而精简后的建造者模式，充分利用了函数式编程，实现时无需定义接口，直接使用 Function 接口；调用时无需实现匿名内部类，直接采用 lambda 表达式，代码较少较简洁。</p>
<h3 id="10-3-代理模式"><a href="#10-3-代理模式" class="headerlink" title="10.3.代理模式"></a><strong>10.3.代理模式</strong></h3><p>Spring 中最重要的代理模式就是 AOP (Aspect-Oriented Programming，面向切面的编程)，是使用 JDK 动态代理和 CGLIB 动态代理技术来实现的。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 用户服务 */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 查询用户 */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/queryUser&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;?&gt; queryUser(<span class="meta">@RequestBody</span> <span class="meta">@Valid</span> UserQueryVO query) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PageDataVO&lt;UserVO&gt; pageData = userService.queryUser(query);</span><br><span class="line">            <span class="keyword">return</span> Result.success(pageData);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.failure(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简1：</strong></p>
<p>基于 @ControllerAdvice 的异常处理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 用户服务 */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 查询用户 */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/queryUser&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;PageDataVO&lt;UserVO&gt;&gt; queryUser(<span class="meta">@RequestBody</span> <span class="meta">@Valid</span> UserQueryVO query) &#123;</span><br><span class="line">        PageDataVO&lt;UserVO&gt; pageData = userService.queryUser(query);</span><br><span class="line">        <span class="keyword">return</span> Result.success(pageData);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalControllerAdvice</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 处理异常 */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;Void&gt; <span class="title">handleException</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> Result.failure(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简2：</strong></p>
<p>基于 AOP 的异常处理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UserController代码同&quot;精简1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebExceptionAspect</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 点切面 */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(org.springframework.web.bind.annotation.RequestMapping)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">webPointcut</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 处理异常 */</span></span><br><span class="line">    <span class="meta">@AfterThrowing(pointcut = &quot;webPointcut()&quot;, throwing = &quot;e&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        Result&lt;Void&gt; result = Result.failure(e.getMessage());</span><br><span class="line">        writeContent(JSON.toJSONString(result));</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-利用删除代码"><a href="#11-利用删除代码" class="headerlink" title="11.利用删除代码"></a><strong>11.利用删除代码</strong></h2><p>“少即是多”，“少”不是空白而是精简，“多”不是拥挤而是完美。删除多余的代码，才能使代码更精简更完美。</p>
<h3 id="11-1-删除已废弃的代码"><a href="#11-1-删除已废弃的代码" class="headerlink" title="11.1.删除已废弃的代码"></a><strong>11.1.删除已废弃的代码</strong></h3><p>删除项目中的已废弃的包、类、字段、方法、变量、常量、导入、注解、注释、已注释代码、Maven包导入、MyBatis的SQL语句、属性配置字段等，可以精简项目代码便于维护。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;discardRate&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> discardRate;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> ProductVO <span class="title">transProductDO</span><span class="params">(ProductDO productDO)</span> </span>&#123;</span><br><span class="line">        ProductVO productVO = <span class="keyword">new</span> ProductVO();</span><br><span class="line">        BeanUtils.copyProperties(productDO, productVO);</span><br><span class="line">        <span class="comment">// productVO.setPrice(getDiscardPrice(productDO.getPrice()));</span></span><br><span class="line">        <span class="keyword">return</span> productVO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> BigDecimal <span class="title">getDiscardPrice</span><span class="params">(BigDecimal originalPrice)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> ProductVO <span class="title">transProductDO</span><span class="params">(ProductDO productDO)</span> </span>&#123;</span><br><span class="line">        ProductVO productVO = <span class="keyword">new</span> ProductVO();</span><br><span class="line">        BeanUtils.copyProperties(productDO, productVO);</span><br><span class="line">        <span class="keyword">return</span> productVO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">11.2</span>.删除接口方法的<span class="keyword">public</span>对于接口(<span class="class"><span class="keyword">interface</span>)，所有的字段和方法都是<span class="title">public</span>的，可以不用显式声明为<span class="title">public</span>。普通：<span class="title">public</span> <span class="title">interface</span> <span class="title">UserDAO</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">countUser</span><span class="params">(<span class="meta">@Param(&quot;query&quot;)</span> UserQuery query)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserDO&gt; <span class="title">queryUser</span><span class="params">(<span class="meta">@Param(&quot;query&quot;)</span> UserQuery query)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-2-删除接口方法的public"><a href="#11-2-删除接口方法的public" class="headerlink" title="11.2.删除接口方法的public"></a><strong>11.2.删除接口方法的public</strong></h3><p>对于接口(interface)，所有的字段和方法都是 public 的，可以不用显式声明为 public 。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDAO</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">countUser</span><span class="params">(<span class="meta">@Param(&quot;query&quot;)</span> UserQuery query)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserDO&gt; <span class="title">queryUser</span><span class="params">(<span class="meta">@Param(&quot;query&quot;)</span> UserQuery query)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDAO</span> </span>&#123;</span><br><span class="line">    <span class="function">Long <span class="title">countUser</span><span class="params">(<span class="meta">@Param(&quot;query&quot;)</span> UserQuery query)</span></span>;</span><br><span class="line">    <span class="function">List&lt;UserDO&gt; <span class="title">queryUser</span><span class="params">(<span class="meta">@Param(&quot;query&quot;)</span> UserQuery query)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-3-删除枚举构造方法的-private"><a href="#11-3-删除枚举构造方法的-private" class="headerlink" title="11.3.删除枚举构造方法的 private"></a><strong>11.3.删除枚举构造方法的 private</strong></h3><p>对于枚举(menu)，构造方法都是 private 的，可以不用显式声明为 private 。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">UserStatus</span> </span>&#123;</span><br><span class="line">    DISABLED(<span class="number">0</span>, <span class="string">&quot;禁用&quot;</span>),</span><br><span class="line">    ENABLED(<span class="number">1</span>, <span class="string">&quot;启用&quot;</span>);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Integer value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">UserStatus</span><span class="params">(Integer value, String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">UserStatus</span> </span>&#123;</span><br><span class="line">    DISABLED(<span class="number">0</span>, <span class="string">&quot;禁用&quot;</span>),</span><br><span class="line">    ENABLED(<span class="number">1</span>, <span class="string">&quot;启用&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line">    UserStatus(Integer value, String desc) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-4-删除-final-类方法的-final"><a href="#11-4-删除-final-类方法的-final" class="headerlink" title="11.4.删除 final 类方法的 final"></a><strong>11.4.删除 final 类方法的 final</strong></h3><p>对于 final 类，不能被子类继承，所以其方法不会被覆盖，没有必要添加 final 修饰。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Rectangle implements Shape &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">double</span> <span class="title">getArea</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> width * height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Rectangle implements Shape &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getArea</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> width * height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-5-删除基类-implements-的接口"><a href="#11-5-删除基类-implements-的接口" class="headerlink" title="11.5.删除基类 implements 的接口"></a><strong>11.5.删除基类 implements 的接口</strong></h3><p>如果基类已 implements 某接口，子类没有必要再 implements 该接口，只需要直接实现接口方法即可。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getArea</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> AbstractShape implements Shape &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Rectangle extends AbstractShape implements Shape &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getArea</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> width * height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Rectangle extends AbstractShape &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getArea</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> width * height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-6-删除不必要的变量"><a href="#11-6-删除不必要的变量" class="headerlink" title="11.6.删除不必要的变量"></a><strong>11.6.删除不必要的变量</strong></h3><p>不必要的变量，只会让代码看起来更繁琐。</p>
<p><strong>普通：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">existsUser</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">    Boolean exists = userDAO.exists(userId);</span><br><span class="line">    <span class="keyword">return</span> exists;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精简：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">existsUser</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userDAO.exists(userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>随笔记录</category>
      </categories>
      <tags>
        <tag>Demo</tag>
      </tags>
  </entry>
  <entry>
    <title>HashMap源码详解</title>
    <url>/2021/06/05/HashMap%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> java.util.concurrent;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentHashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ConcurrentMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7249069246763182397L</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//容器最大长度</span></span><br><span class="line">     <span class="comment">//  1. int的最大的值是2的31次方-1，所以容量无法到达2的31次方，</span></span><br><span class="line">     <span class="comment">//  2. 需要让容量满足2的幂次，所以设置为2的30次方 </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//初始值   </span></span><br><span class="line">     <span class="comment">// 1. 方便数据迁移</span></span><br><span class="line">     <span class="comment">//  2. 方便进行计算对应的位置</span></span><br><span class="line">     <span class="comment">//3. 概率统计</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//数组最大长度</span></span><br><span class="line">    <span class="comment">// 由于Array是jvm直接操作的，所以会在头部存储一些头部信息，所以此处需要-8</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ARRAY_SIZE = Integer.MAX_VALUE - <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//默认的并发数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CONCURRENCY_LEVEL = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 加载因子  </span></span><br><span class="line">     <span class="comment">//当前数组的长度是0.75倍的时候进行扩容  即当数组长度是16  16*0.75=12 即在12的时候进行扩容</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line">      <span class="comment">// 泊松分布</span></span><br><span class="line">     <span class="comment">//当链表长度&gt;=8的时候转红黑树</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line">     <span class="comment">// 泊松分布</span></span><br><span class="line">    <span class="comment">//红黑树转链表</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//最小</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Minimum number of rebinnings per transfer step. Ranges are</span></span><br><span class="line"><span class="comment">     * subdivided to allow multiple resizer threads.  This value</span></span><br><span class="line"><span class="comment">     * serves as a lower bound to avoid resizers encountering</span></span><br><span class="line"><span class="comment">     * excessive memory contention.  The value should be at least</span></span><br><span class="line"><span class="comment">     * DEFAULT_CAPACITY.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TRANSFER_STRIDE = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The number of bits used for generation stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     * Must be at least 6 for 32bit arrays.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> RESIZE_STAMP_BITS = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The maximum number of threads that can help resize.</span></span><br><span class="line"><span class="comment">     * Must fit in 32 - RESIZE_STAMP_BITS bits.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_RESIZERS = (<span class="number">1</span> &lt;&lt; (<span class="number">32</span> - RESIZE_STAMP_BITS)) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The bit shift for recording size stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESIZE_STAMP_SHIFT = <span class="number">32</span> - RESIZE_STAMP_BITS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Encodings for Node hash fields. See above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hash for forwarding nodes</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// hash for roots of trees</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESERVED  = -<span class="number">3</span>; <span class="comment">// hash for transient reservations</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_BITS = <span class="number">0x7fffffff</span>; <span class="comment">// usable bits of normal node hash</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Number of CPUS, to place bounds on some sizings */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NCPU = Runtime.getRuntime().availableProcessors();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** For serialization compatibility. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectStreamField[] serialPersistentFields = &#123;</span><br><span class="line">        <span class="keyword">new</span> ObjectStreamField(<span class="string">&quot;segments&quot;</span>, Segment[].class),</span><br><span class="line">        <span class="keyword">new</span> ObjectStreamField(<span class="string">&quot;segmentMask&quot;</span>, Integer.TYPE),</span><br><span class="line">        <span class="keyword">new</span> ObjectStreamField(<span class="string">&quot;segmentShift&quot;</span>, Integer.TYPE)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- Nodes -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Key-value entry.  This class is never exported out as a</span></span><br><span class="line"><span class="comment">     * user-mutable Map.Entry (i.e., one supporting setValue; see</span></span><br><span class="line"><span class="comment">     * MapEntry below), but can be used for read-only traversals used</span></span><br><span class="line"><span class="comment">     * in bulk tasks.  Subclasses of Node with a negative hash field</span></span><br><span class="line"><span class="comment">     * are special, and contain null keys and values (but are never</span></span><br><span class="line"><span class="comment">     * exported).  Otherwise, keys and vals are never null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        <span class="keyword">volatile</span> V val;</span><br><span class="line">        <span class="keyword">volatile</span> Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">        Node(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">            <span class="keyword">this</span>.hash = hash;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.val = val;</span><br><span class="line">            <span class="keyword">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>       </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> val; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span>   </span>&#123; <span class="keyword">return</span> key.hashCode() ^ val.hashCode(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> key + <span class="string">&quot;=&quot;</span> + val; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            Object k, v, u; Map.Entry&lt;?,?&gt; e;</span><br><span class="line">            <span class="keyword">return</span> ((o <span class="keyword">instanceof</span> Map.Entry) &amp;&amp;</span><br><span class="line">                    (k = (e = (Map.Entry&lt;?,?&gt;)o).getKey()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (v = e.getValue()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (k == key || k.equals(key)) &amp;&amp;</span><br><span class="line">                    (v == (u = val) || v.equals(u)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Virtualized support for map.get(); overridden in subclasses.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt; e = <span class="keyword">this</span>;</span><br><span class="line">            <span class="keyword">if</span> (k != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    K ek;</span><br><span class="line">                    <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                        ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                        <span class="keyword">return</span> e;</span><br><span class="line">                &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- Static utilities -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spreads (XORs) higher bits of hash to lower and also forces top</span></span><br><span class="line"><span class="comment">     * bit to 0. Because the table uses power-of-two masking, sets of</span></span><br><span class="line"><span class="comment">     * hashes that vary only in bits above the current mask will</span></span><br><span class="line"><span class="comment">     * always collide. (Among known examples are sets of Float keys</span></span><br><span class="line"><span class="comment">     * holding consecutive whole numbers in small tables.)  So we</span></span><br><span class="line"><span class="comment">     * apply a transform that spreads the impact of higher bits</span></span><br><span class="line"><span class="comment">     * downward. There is a tradeoff between speed, utility, and</span></span><br><span class="line"><span class="comment">     * quality of bit-spreading. Because many common sets of hashes</span></span><br><span class="line"><span class="comment">     * are already reasonably distributed (so don&#x27;t benefit from</span></span><br><span class="line"><span class="comment">     * spreading), and because we use trees to handle large sets of</span></span><br><span class="line"><span class="comment">     * collisions in bins, we just XOR some shifted bits in the</span></span><br><span class="line"><span class="comment">     * cheapest possible way to reduce systematic lossage, as well as</span></span><br><span class="line"><span class="comment">     * to incorporate impact of the highest bits that would otherwise</span></span><br><span class="line"><span class="comment">     * never be used in index calculations because of table bounds.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">spread</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (h ^ (h &gt;&gt;&gt; <span class="number">16</span>)) &amp; HASH_BITS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a power of two table size for the given desired capacity.</span></span><br><span class="line"><span class="comment">     * See Hackers Delight, sec 3.2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = c - <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns x&#x27;s Class if it is of the form &quot;class C implements</span></span><br><span class="line"><span class="comment">     * Comparable&lt;C&gt;&quot;, else null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> Class&lt;?&gt; comparableClassFor(Object x) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x <span class="keyword">instanceof</span> Comparable) &#123;</span><br><span class="line">            Class&lt;?&gt; c; Type[] ts, as; Type t; ParameterizedType p;</span><br><span class="line">            <span class="keyword">if</span> ((c = x.getClass()) == String.class) <span class="comment">// bypass checks</span></span><br><span class="line">                <span class="keyword">return</span> c;</span><br><span class="line">            <span class="keyword">if</span> ((ts = c.getGenericInterfaces()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ts.length; ++i) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (((t = ts[i]) <span class="keyword">instanceof</span> ParameterizedType) &amp;&amp;</span><br><span class="line">                        ((p = (ParameterizedType)t).getRawType() ==</span><br><span class="line">                         Comparable.class) &amp;&amp;</span><br><span class="line">                        (as = p.getActualTypeArguments()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        as.length == <span class="number">1</span> &amp;&amp; as[<span class="number">0</span>] == c) <span class="comment">// type arg is c</span></span><br><span class="line">                        <span class="keyword">return</span> c;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns k.compareTo(x) if x matches kc (k&#x27;s screened comparable</span></span><br><span class="line"><span class="comment">     * class), else 0.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span> <span class="comment">// for cast to Comparable</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compareComparables</span><span class="params">(Class&lt;?&gt; kc, Object k, Object x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (x == <span class="keyword">null</span> || x.getClass() != kc ? <span class="number">0</span> :</span><br><span class="line">                ((Comparable)k).compareTo(x));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- Table element access -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Volatile access methods are used for table elements as well as</span></span><br><span class="line"><span class="comment">     * elements of in-progress next table while resizing.  All uses of</span></span><br><span class="line"><span class="comment">     * the tab arguments must be null checked by callers.  All callers</span></span><br><span class="line"><span class="comment">     * also paranoically precheck that tab&#x27;s length is not zero (or an</span></span><br><span class="line"><span class="comment">     * equivalent check), thus ensuring that any index argument taking</span></span><br><span class="line"><span class="comment">     * the form of a hash value anded with (length - 1) is a valid</span></span><br><span class="line"><span class="comment">     * index.  Note that, to be correct wrt arbitrary concurrency</span></span><br><span class="line"><span class="comment">     * errors by users, these checks must operate on local variables,</span></span><br><span class="line"><span class="comment">     * which accounts for some odd-looking inline assignments below.</span></span><br><span class="line"><span class="comment">     * Note that calls to setTabAt always occur within locked regions,</span></span><br><span class="line"><span class="comment">     * and so in principle require only release ordering, not</span></span><br><span class="line"><span class="comment">     * full volatile semantics, but are currently coded as volatile</span></span><br><span class="line"><span class="comment">     * writes to be conservative.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">        U.putObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- Fields -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The array of bins. Lazily initialized upon first insertion.</span></span><br><span class="line"><span class="comment">     * Size is always a power of two. Accessed directly by iterators.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The next table to use; non-null only while resizing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base counter value, used mainly when there is no contention,</span></span><br><span class="line"><span class="comment">     * but also as a fallback during table initialization</span></span><br><span class="line"><span class="comment">     * races. Updated via CAS.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> baseCount;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// -1 初始化</span></span><br><span class="line">    <span class="comment">// -n 扩容</span></span><br><span class="line">    <span class="comment">// 正数  代表当前数组扩容的阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The next table index (plus one) to split while resizing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> transferIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spinlock (locked via CAS) used when resizing and/or creating CounterCells.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table of counter cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// views</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> KeySetView&lt;K,V&gt; keySet;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ValuesView&lt;K,V&gt; values;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> EntrySetView&lt;K,V&gt; entrySet;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- Public operations -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new, empty map with the default initial table size (16).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new, empty map with an initial table size</span></span><br><span class="line"><span class="comment">     * accommodating the specified number of elements without the need</span></span><br><span class="line"><span class="comment">     * to dynamically resize.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> initialCapacity The implementation performs internal</span></span><br><span class="line"><span class="comment">     * sizing to accommodate this many elements.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity of</span></span><br><span class="line"><span class="comment">     * elements is negative</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">                   MAXIMUM_CAPACITY :</span><br><span class="line">                   tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new map with the same mappings as the given map.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> m the map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sizeCtl = DEFAULT_CAPACITY;</span><br><span class="line">        putAll(m);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new, empty map with an initial table size based on</span></span><br><span class="line"><span class="comment">     * the given number of elements (&#123;<span class="doctag">@code</span> initialCapacity&#125;) and</span></span><br><span class="line"><span class="comment">     * initial table density (&#123;<span class="doctag">@code</span> loadFactor&#125;).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> initialCapacity the initial capacity. The implementation</span></span><br><span class="line"><span class="comment">     * performs internal sizing to accommodate this many elements,</span></span><br><span class="line"><span class="comment">     * given the specified load factor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loadFactor the load factor (table density) for</span></span><br><span class="line"><span class="comment">     * establishing the initial table size</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity of</span></span><br><span class="line"><span class="comment">     * elements is negative or the load factor is nonpositive</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.6</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(initialCapacity, loadFactor, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new, empty map with an initial table size based on</span></span><br><span class="line"><span class="comment">     * the given number of elements (&#123;<span class="doctag">@code</span> initialCapacity&#125;), table</span></span><br><span class="line"><span class="comment">     * density (&#123;<span class="doctag">@code</span> loadFactor&#125;), and number of concurrently</span></span><br><span class="line"><span class="comment">     * updating threads (&#123;<span class="doctag">@code</span> concurrencyLevel&#125;).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> initialCapacity the initial capacity. The implementation</span></span><br><span class="line"><span class="comment">     * performs internal sizing to accommodate this many elements,</span></span><br><span class="line"><span class="comment">     * given the specified load factor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loadFactor the load factor (table density) for</span></span><br><span class="line"><span class="comment">     * establishing the initial table size</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> concurrencyLevel the estimated number of concurrently</span></span><br><span class="line"><span class="comment">     * updating threads. The implementation may use this value as</span></span><br><span class="line"><span class="comment">     * a sizing hint.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity is</span></span><br><span class="line"><span class="comment">     * negative or the load factor or concurrencyLevel are</span></span><br><span class="line"><span class="comment">     * nonpositive</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">float</span> loadFactor, <span class="keyword">int</span> concurrencyLevel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="comment">// Use at least as many bins</span></span><br><span class="line">            initialCapacity = concurrencyLevel;   <span class="comment">// as estimated threads</span></span><br><span class="line">        <span class="keyword">long</span> size = (<span class="keyword">long</span>)(<span class="number">1.0</span> + (<span class="keyword">long</span>)initialCapacity / loadFactor);</span><br><span class="line">        <span class="keyword">int</span> cap = (size &gt;= (<span class="keyword">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">            MAXIMUM_CAPACITY : tableSizeFor((<span class="keyword">int</span>)size);</span><br><span class="line">        <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Original (since JDK1.2) Map methods</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n = sumCount();</span><br><span class="line">        <span class="keyword">return</span> ((n &lt; <span class="number">0L</span>) ? <span class="number">0</span> :</span><br><span class="line">                (n &gt; (<span class="keyword">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :</span><br><span class="line">                (<span class="keyword">int</span>)n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sumCount() &lt;= <span class="number">0L</span>; <span class="comment">// ignore transient negative values</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the value to which the specified key is mapped,</span></span><br><span class="line"><span class="comment">     * or &#123;<span class="doctag">@code</span> null&#125; if this map contains no mapping for the key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;More formally, if this map contains a mapping from a key</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> k&#125; to a value &#123;<span class="doctag">@code</span> v&#125; such that &#123;<span class="doctag">@code</span> key.equals(k)&#125;,</span></span><br><span class="line"><span class="comment">     * then this method returns &#123;<span class="doctag">@code</span> v&#125;; otherwise it returns</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> null&#125;.  (There can be at most one such mapping.)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">        <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">        <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                    <span class="keyword">return</span> e.val;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                    ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                    <span class="keyword">return</span> e.val;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tests if the specified object is a key in this table.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  key possible key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if and only if the specified object</span></span><br><span class="line"><span class="comment">     *         is a key in this table, as determined by the</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> equals&#125; method; &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get(key) != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns &#123;<span class="doctag">@code</span> true&#125; if this map maps one or more keys to the</span></span><br><span class="line"><span class="comment">     * specified value. Note: This method may require a full traversal</span></span><br><span class="line"><span class="comment">     * of the map, and is much slower than method &#123;<span class="doctag">@code</span> containsKey&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value value whose presence in this map is to be tested</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if this map maps one or more keys to the</span></span><br><span class="line"><span class="comment">     *         specified value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified value is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        <span class="keyword">if</span> ((t = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, t.length, <span class="number">0</span>, t.length);</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = it.advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                V v;</span><br><span class="line">                <span class="keyword">if</span> ((v = p.val) == value || (v != <span class="keyword">null</span> &amp;&amp; value.equals(v)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Maps the specified key to the specified value in this table.</span></span><br><span class="line"><span class="comment">     * Neither the key nor the value can be null.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The value can be retrieved by calling the &#123;<span class="doctag">@code</span> get&#125; method</span></span><br><span class="line"><span class="comment">     * with a key that is equal to the original key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key key with which the specified value is to be associated</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value value to be associated with the specified key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value associated with &#123;<span class="doctag">@code</span> key&#125;, or</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> null&#125; if there was no mapping for &#123;<span class="doctag">@code</span> key&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key or value is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Implementation for put and putIfAbsent */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">        <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">            <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">                tab = initTable();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                             <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                    <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                tab = helpTransfer(tab, f);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                V oldVal = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            binCount = <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                                K ek;</span><br><span class="line">                                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                    ((ek = e.key) == key ||</span><br><span class="line">                                     (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                    oldVal = e.val;</span><br><span class="line">                                    <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                        e.val = value;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                Node&lt;K,V&gt; pred = e;</span><br><span class="line">                                <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                              value, <span class="keyword">null</span>);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            Node&lt;K,V&gt; p;</span><br><span class="line">                            binCount = <span class="number">2</span>;</span><br><span class="line">                            <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                           value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                oldVal = p.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    p.val = value;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                        treeifyBin(tab, i);</span><br><span class="line">                    <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span> oldVal;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Copies all of the mappings from the specified map to this one.</span></span><br><span class="line"><span class="comment">     * These mappings replace any mappings that this map had for any of the</span></span><br><span class="line"><span class="comment">     * keys currently in the specified map.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> m mappings to be stored in this map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putAll</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">        tryPresize(m.size());</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;? extends K, ? extends V&gt; e : m.entrySet())</span><br><span class="line">            putVal(e.getKey(), e.getValue(), <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Removes the key (and its corresponding value) from this map.</span></span><br><span class="line"><span class="comment">     * This method does nothing if the key is not in the map.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  key the key that needs to be removed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value associated with &#123;<span class="doctag">@code</span> key&#125;, or</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> null&#125; if there was no mapping for &#123;<span class="doctag">@code</span> key&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> replaceNode(key, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Implementation for the four public remove/replace methods:</span></span><br><span class="line"><span class="comment">     * Replaces node value with v, conditional upon match of cv if</span></span><br><span class="line"><span class="comment">     * non-null.  If resulting value is null, delete.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> V <span class="title">replaceNode</span><span class="params">(Object key, V value, Object cv)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">            <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">                (f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                tab = helpTransfer(tab, f);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                V oldVal = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">boolean</span> validated = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            validated = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = f, pred = <span class="keyword">null</span>;;) &#123;</span><br><span class="line">                                K ek;</span><br><span class="line">                                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                    ((ek = e.key) == key ||</span><br><span class="line">                                     (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                    V ev = e.val;</span><br><span class="line">                                    <span class="keyword">if</span> (cv == <span class="keyword">null</span> || cv == ev ||</span><br><span class="line">                                        (ev != <span class="keyword">null</span> &amp;&amp; cv.equals(ev))) &#123;</span><br><span class="line">                                        oldVal = ev;</span><br><span class="line">                                        <span class="keyword">if</span> (value != <span class="keyword">null</span>)</span><br><span class="line">                                            e.val = value;</span><br><span class="line">                                        <span class="keyword">else</span> <span class="keyword">if</span> (pred != <span class="keyword">null</span>)</span><br><span class="line">                                            pred.next = e.next;</span><br><span class="line">                                        <span class="keyword">else</span></span><br><span class="line">                                            setTabAt(tab, i, e.next);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                pred = e;</span><br><span class="line">                                <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>)</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            validated = <span class="keyword">true</span>;</span><br><span class="line">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                            TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                            <span class="keyword">if</span> ((r = t.root) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (p = r.findTreeNode(hash, key, <span class="keyword">null</span>)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                V pv = p.val;</span><br><span class="line">                                <span class="keyword">if</span> (cv == <span class="keyword">null</span> || cv == pv ||</span><br><span class="line">                                    (pv != <span class="keyword">null</span> &amp;&amp; cv.equals(pv))) &#123;</span><br><span class="line">                                    oldVal = pv;</span><br><span class="line">                                    <span class="keyword">if</span> (value != <span class="keyword">null</span>)</span><br><span class="line">                                        p.val = value;</span><br><span class="line">                                    <span class="keyword">else</span> <span class="keyword">if</span> (t.removeTreeNode(p))</span><br><span class="line">                                        setTabAt(tab, i, untreeify(t.first));</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (validated) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (value == <span class="keyword">null</span>)</span><br><span class="line">                            addCount(-<span class="number">1L</span>, -<span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">return</span> oldVal;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Removes all of the mappings from this map.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> delta = <span class="number">0L</span>; <span class="comment">// negative number of deletions</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = table;</span><br><span class="line">        <span class="keyword">while</span> (tab != <span class="keyword">null</span> &amp;&amp; i &lt; tab.length) &#123;</span><br><span class="line">            <span class="keyword">int</span> fh;</span><br><span class="line">            Node&lt;K,V&gt; f = tabAt(tab, i);</span><br><span class="line">            <span class="keyword">if</span> (f == <span class="keyword">null</span>)</span><br><span class="line">                ++i;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED) &#123;</span><br><span class="line">                tab = helpTransfer(tab, f);</span><br><span class="line">                i = <span class="number">0</span>; <span class="comment">// restart</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p = (fh &gt;= <span class="number">0</span> ? f :</span><br><span class="line">                                       (f <span class="keyword">instanceof</span> TreeBin) ?</span><br><span class="line">                                       ((TreeBin&lt;K,V&gt;)f).first : <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">while</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            --delta;</span><br><span class="line">                            p = p.next;</span><br><span class="line">                        &#125;</span><br><span class="line">                        setTabAt(tab, i++, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (delta != <span class="number">0L</span>)</span><br><span class="line">            addCount(delta, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a &#123;<span class="doctag">@link</span> Set&#125; view of the keys contained in this map.</span></span><br><span class="line"><span class="comment">     * The set is backed by the map, so changes to the map are</span></span><br><span class="line"><span class="comment">     * reflected in the set, and vice-versa. The set supports element</span></span><br><span class="line"><span class="comment">     * removal, which removes the corresponding mapping from this map,</span></span><br><span class="line"><span class="comment">     * via the &#123;<span class="doctag">@code</span> Iterator.remove&#125;, &#123;<span class="doctag">@code</span> Set.remove&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> removeAll&#125;, &#123;<span class="doctag">@code</span> retainAll&#125;, and &#123;<span class="doctag">@code</span> clear&#125;</span></span><br><span class="line"><span class="comment">     * operations.  It does not support the &#123;<span class="doctag">@code</span> add&#125; or</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> addAll&#125; operations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The view&#x27;s iterators and spliterators are</span></span><br><span class="line"><span class="comment">     * &lt;a href=&quot;package-summary.html#Weakly&quot;&gt;&lt;i&gt;weakly consistent&lt;/i&gt;&lt;/a&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The view&#x27;s &#123;<span class="doctag">@code</span> spliterator&#125; reports &#123;<span class="doctag">@link</span> Spliterator#CONCURRENT&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Spliterator#DISTINCT&#125;, and &#123;<span class="doctag">@link</span> Spliterator#NONNULL&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the set view</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeySetView&lt;K,V&gt; <span class="title">keySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KeySetView&lt;K,V&gt; ks;</span><br><span class="line">        <span class="keyword">return</span> (ks = keySet) != <span class="keyword">null</span> ? ks : (keySet = <span class="keyword">new</span> KeySetView&lt;K,V&gt;(<span class="keyword">this</span>, <span class="keyword">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a &#123;<span class="doctag">@link</span> Collection&#125; view of the values contained in this map.</span></span><br><span class="line"><span class="comment">     * The collection is backed by the map, so changes to the map are</span></span><br><span class="line"><span class="comment">     * reflected in the collection, and vice-versa.  The collection</span></span><br><span class="line"><span class="comment">     * supports element removal, which removes the corresponding</span></span><br><span class="line"><span class="comment">     * mapping from this map, via the &#123;<span class="doctag">@code</span> Iterator.remove&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> Collection.remove&#125;, &#123;<span class="doctag">@code</span> removeAll&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> retainAll&#125;, and &#123;<span class="doctag">@code</span> clear&#125; operations.  It does not</span></span><br><span class="line"><span class="comment">     * support the &#123;<span class="doctag">@code</span> add&#125; or &#123;<span class="doctag">@code</span> addAll&#125; operations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The view&#x27;s iterators and spliterators are</span></span><br><span class="line"><span class="comment">     * &lt;a href=&quot;package-summary.html#Weakly&quot;&gt;&lt;i&gt;weakly consistent&lt;/i&gt;&lt;/a&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The view&#x27;s &#123;<span class="doctag">@code</span> spliterator&#125; reports &#123;<span class="doctag">@link</span> Spliterator#CONCURRENT&#125;</span></span><br><span class="line"><span class="comment">     * and &#123;<span class="doctag">@link</span> Spliterator#NONNULL&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the collection view</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;V&gt; <span class="title">values</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ValuesView&lt;K,V&gt; vs;</span><br><span class="line">        <span class="keyword">return</span> (vs = values) != <span class="keyword">null</span> ? vs : (values = <span class="keyword">new</span> ValuesView&lt;K,V&gt;(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a &#123;<span class="doctag">@link</span> Set&#125; view of the mappings contained in this map.</span></span><br><span class="line"><span class="comment">     * The set is backed by the map, so changes to the map are</span></span><br><span class="line"><span class="comment">     * reflected in the set, and vice-versa.  The set supports element</span></span><br><span class="line"><span class="comment">     * removal, which removes the corresponding mapping from the map,</span></span><br><span class="line"><span class="comment">     * via the &#123;<span class="doctag">@code</span> Iterator.remove&#125;, &#123;<span class="doctag">@code</span> Set.remove&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> removeAll&#125;, &#123;<span class="doctag">@code</span> retainAll&#125;, and &#123;<span class="doctag">@code</span> clear&#125;</span></span><br><span class="line"><span class="comment">     * operations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The view&#x27;s iterators and spliterators are</span></span><br><span class="line"><span class="comment">     * &lt;a href=&quot;package-summary.html#Weakly&quot;&gt;&lt;i&gt;weakly consistent&lt;/i&gt;&lt;/a&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The view&#x27;s &#123;<span class="doctag">@code</span> spliterator&#125; reports &#123;<span class="doctag">@link</span> Spliterator#CONCURRENT&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Spliterator#DISTINCT&#125;, and &#123;<span class="doctag">@link</span> Spliterator#NONNULL&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the set view</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet() &#123;</span><br><span class="line">        EntrySetView&lt;K,V&gt; es;</span><br><span class="line">        <span class="keyword">return</span> (es = entrySet) != <span class="keyword">null</span> ? es : (entrySet = <span class="keyword">new</span> EntrySetView&lt;K,V&gt;(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the hash code value for this &#123;<span class="doctag">@link</span> Map&#125;, i.e.,</span></span><br><span class="line"><span class="comment">     * the sum of, for each key-value pair in the map,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> key.hashCode() ^ value.hashCode()&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the hash code value for this map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        <span class="keyword">if</span> ((t = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, t.length, <span class="number">0</span>, t.length);</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = it.advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                h += p.key.hashCode() ^ p.val.hashCode();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a string representation of this map.  The string</span></span><br><span class="line"><span class="comment">     * representation consists of a list of key-value mappings (in no</span></span><br><span class="line"><span class="comment">     * particular order) enclosed in braces (&quot;&#123;<span class="doctag">@code</span> &#123;&#125;&#125;&quot;).  Adjacent</span></span><br><span class="line"><span class="comment">     * mappings are separated by the characters &#123;<span class="doctag">@code</span> &quot;, &quot;&#125; (comma</span></span><br><span class="line"><span class="comment">     * and space).  Each key-value mapping is rendered as the key</span></span><br><span class="line"><span class="comment">     * followed by an equals sign (&quot;&#123;<span class="doctag">@code</span> =&#125;&quot;) followed by the</span></span><br><span class="line"><span class="comment">     * associated value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a string representation of this map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        <span class="keyword">int</span> f = (t = table) == <span class="keyword">null</span> ? <span class="number">0</span> : t.length;</span><br><span class="line">        Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, f, <span class="number">0</span>, f);</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(<span class="string">&#x27;&#123;&#x27;</span>);</span><br><span class="line">        Node&lt;K,V&gt; p;</span><br><span class="line">        <span class="keyword">if</span> ((p = it.advance()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                K k = p.key;</span><br><span class="line">                V v = p.val;</span><br><span class="line">                sb.append(k == <span class="keyword">this</span> ? <span class="string">&quot;(this Map)&quot;</span> : k);</span><br><span class="line">                sb.append(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">                sb.append(v == <span class="keyword">this</span> ? <span class="string">&quot;(this Map)&quot;</span> : v);</span><br><span class="line">                <span class="keyword">if</span> ((p = it.advance()) == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                sb.append(<span class="string">&#x27;,&#x27;</span>).append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.append(<span class="string">&#x27;&#125;&#x27;</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Compares the specified object with this map for equality.</span></span><br><span class="line"><span class="comment">     * Returns &#123;<span class="doctag">@code</span> true&#125; if the given object is a map with the same</span></span><br><span class="line"><span class="comment">     * mappings as this map.  This operation may return misleading</span></span><br><span class="line"><span class="comment">     * results if either map is concurrently modified during execution</span></span><br><span class="line"><span class="comment">     * of this method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o object to be compared for equality with this map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the specified object is equal to this map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o != <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            <span class="keyword">int</span> f = (t = table) == <span class="keyword">null</span> ? <span class="number">0</span> : t.length;</span><br><span class="line">            Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, f, <span class="number">0</span>, f);</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = it.advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                V val = p.val;</span><br><span class="line">                Object v = m.get(p.key);</span><br><span class="line">                <span class="keyword">if</span> (v == <span class="keyword">null</span> || (v != val &amp;&amp; !v.equals(val)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;?,?&gt; e : m.entrySet()) &#123;</span><br><span class="line">                Object mk, mv, v;</span><br><span class="line">                <span class="keyword">if</span> ((mk = e.getKey()) == <span class="keyword">null</span> ||</span><br><span class="line">                    (mv = e.getValue()) == <span class="keyword">null</span> ||</span><br><span class="line">                    (v = get(mk)) == <span class="keyword">null</span> ||</span><br><span class="line">                    (mv != v &amp;&amp; !mv.equals(v)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Stripped-down version of helper class used in previous version,</span></span><br><span class="line"><span class="comment">     * declared for the sake of serialization compatibility</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Segment</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2249069246763182397L</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</span><br><span class="line">        Segment(<span class="keyword">float</span> lf) &#123; <span class="keyword">this</span>.loadFactor = lf; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Saves the state of the &#123;<span class="doctag">@code</span> ConcurrentHashMap&#125; instance to a</span></span><br><span class="line"><span class="comment">     * stream (i.e., serializes it).</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s the stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> java.io.IOException if an I/O error occurs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serialData</span></span></span><br><span class="line"><span class="comment">     * the key (Object) and value (Object)</span></span><br><span class="line"><span class="comment">     * for each key-value mapping, followed by a null pair.</span></span><br><span class="line"><span class="comment">     * The key-value mappings are emitted in no particular order.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">        <span class="comment">// For serialization compatibility</span></span><br><span class="line">        <span class="comment">// Emulate segment calculation from previous version of this class</span></span><br><span class="line">        <span class="keyword">int</span> sshift = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> ssize = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (ssize &lt; DEFAULT_CONCURRENCY_LEVEL) &#123;</span><br><span class="line">            ++sshift;</span><br><span class="line">            ssize &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> segmentShift = <span class="number">32</span> - sshift;</span><br><span class="line">        <span class="keyword">int</span> segmentMask = ssize - <span class="number">1</span>;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        Segment&lt;K,V&gt;[] segments = (Segment&lt;K,V&gt;[])</span><br><span class="line">            <span class="keyword">new</span> Segment&lt;?,?&gt;[DEFAULT_CONCURRENCY_LEVEL];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; segments.length; ++i)</span><br><span class="line">            segments[i] = <span class="keyword">new</span> Segment&lt;K,V&gt;(LOAD_FACTOR);</span><br><span class="line">        s.putFields().put(<span class="string">&quot;segments&quot;</span>, segments);</span><br><span class="line">        s.putFields().put(<span class="string">&quot;segmentShift&quot;</span>, segmentShift);</span><br><span class="line">        s.putFields().put(<span class="string">&quot;segmentMask&quot;</span>, segmentMask);</span><br><span class="line">        s.writeFields();</span><br><span class="line"></span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        <span class="keyword">if</span> ((t = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, t.length, <span class="number">0</span>, t.length);</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = it.advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                s.writeObject(p.key);</span><br><span class="line">                s.writeObject(p.val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        s.writeObject(<span class="keyword">null</span>);</span><br><span class="line">        s.writeObject(<span class="keyword">null</span>);</span><br><span class="line">        segments = <span class="keyword">null</span>; <span class="comment">// throw away</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reconstitutes the instance from a stream (that is, deserializes it).</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s the stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ClassNotFoundException if the class of a serialized object</span></span><br><span class="line"><span class="comment">     *         could not be found</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> java.io.IOException if an I/O error occurs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * To improve performance in typical cases, we create nodes</span></span><br><span class="line"><span class="comment">         * while reading, then place in table once size is known.</span></span><br><span class="line"><span class="comment">         * However, we must also validate uniqueness and deal with</span></span><br><span class="line"><span class="comment">         * overpopulated bins while doing so, which requires</span></span><br><span class="line"><span class="comment">         * specialized versions of putVal mechanics.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        sizeCtl = -<span class="number">1</span>; <span class="comment">// force exclusion for table construction</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        <span class="keyword">long</span> size = <span class="number">0L</span>;</span><br><span class="line">        Node&lt;K,V&gt; p = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            K k = (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            V v = (V) s.readObject();</span><br><span class="line">            <span class="keyword">if</span> (k != <span class="keyword">null</span> &amp;&amp; v != <span class="keyword">null</span>) &#123;</span><br><span class="line">                p = <span class="keyword">new</span> Node&lt;K,V&gt;(spread(k.hashCode()), k, v, p);</span><br><span class="line">                ++size;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0L</span>)</span><br><span class="line">            sizeCtl = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> n;</span><br><span class="line">            <span class="keyword">if</span> (size &gt;= (<span class="keyword">long</span>)(MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>))</span><br><span class="line">                n = MAXIMUM_CAPACITY;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> sz = (<span class="keyword">int</span>)size;</span><br><span class="line">                n = tableSizeFor(sz + (sz &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">            <span class="keyword">int</span> mask = n - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">long</span> added = <span class="number">0L</span>;</span><br><span class="line">            <span class="keyword">while</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> insertAtFront;</span><br><span class="line">                Node&lt;K,V&gt; next = p.next, first;</span><br><span class="line">                <span class="keyword">int</span> h = p.hash, j = h &amp; mask;</span><br><span class="line">                <span class="keyword">if</span> ((first = tabAt(tab, j)) == <span class="keyword">null</span>)</span><br><span class="line">                    insertAtFront = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    K k = p.key;</span><br><span class="line">                    <span class="keyword">if</span> (first.hash &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)first;</span><br><span class="line">                        <span class="keyword">if</span> (t.putTreeVal(h, k, p.val) == <span class="keyword">null</span>)</span><br><span class="line">                            ++added;</span><br><span class="line">                        insertAtFront = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">                        insertAtFront = <span class="keyword">true</span>;</span><br><span class="line">                        Node&lt;K,V&gt; q; K qk;</span><br><span class="line">                        <span class="keyword">for</span> (q = first; q != <span class="keyword">null</span>; q = q.next) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (q.hash == h &amp;&amp;</span><br><span class="line">                                ((qk = q.key) == k ||</span><br><span class="line">                                 (qk != <span class="keyword">null</span> &amp;&amp; k.equals(qk)))) &#123;</span><br><span class="line">                                insertAtFront = <span class="keyword">false</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            ++binCount;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (insertAtFront &amp;&amp; binCount &gt;= TREEIFY_THRESHOLD) &#123;</span><br><span class="line">                            insertAtFront = <span class="keyword">false</span>;</span><br><span class="line">                            ++added;</span><br><span class="line">                            p.next = first;</span><br><span class="line">                            TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">for</span> (q = p; q != <span class="keyword">null</span>; q = q.next) &#123;</span><br><span class="line">                                TreeNode&lt;K,V&gt; t = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                    (q.hash, q.key, q.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">if</span> ((t.prev = tl) == <span class="keyword">null</span>)</span><br><span class="line">                                    hd = t;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    tl.next = t;</span><br><span class="line">                                tl = t;</span><br><span class="line">                            &#125;</span><br><span class="line">                            setTabAt(tab, j, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (insertAtFront) &#123;</span><br><span class="line">                    ++added;</span><br><span class="line">                    p.next = first;</span><br><span class="line">                    setTabAt(tab, j, p);</span><br><span class="line">                &#125;</span><br><span class="line">                p = next;</span><br><span class="line">            &#125;</span><br><span class="line">            table = tab;</span><br><span class="line">            sizeCtl = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">            baseCount = added;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ConcurrentMap methods</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value associated with the specified key,</span></span><br><span class="line"><span class="comment">     *         or &#123;<span class="doctag">@code</span> null&#125; if there was no mapping for the key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key or value is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">putIfAbsent</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> putVal(key, value, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> value != <span class="keyword">null</span> &amp;&amp; replaceNode(key, <span class="keyword">null</span>, value) != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if any of the arguments are null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replace</span><span class="params">(K key, V oldValue, V newValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || oldValue == <span class="keyword">null</span> || newValue == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> replaceNode(key, newValue, oldValue) != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value associated with the specified key,</span></span><br><span class="line"><span class="comment">     *         or &#123;<span class="doctag">@code</span> null&#125; if there was no mapping for the key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key or value is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">replace</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> replaceNode(key, value, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Overrides of JDK8+ Map extension method defaults</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the value to which the specified key is mapped, or the</span></span><br><span class="line"><span class="comment">     * given default value if this map contains no mapping for the</span></span><br><span class="line"><span class="comment">     * key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key the key whose associated value is to be returned</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultValue the value to return if this map contains</span></span><br><span class="line"><span class="comment">     * no mapping for the given key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the mapping for the key, if present; else the default value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">getOrDefault</span><span class="params">(Object key, V defaultValue)</span> </span>&#123;</span><br><span class="line">        V v;</span><br><span class="line">        <span class="keyword">return</span> (v = get(key)) == <span class="keyword">null</span> ? defaultValue : v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(BiConsumer&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        <span class="keyword">if</span> ((t = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, t.length, <span class="number">0</span>, t.length);</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = it.advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                action.accept(p.key, p.val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replaceAll</span><span class="params">(BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; function)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (function == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        <span class="keyword">if</span> ((t = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, t.length, <span class="number">0</span>, t.length);</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = it.advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                V oldValue = p.val;</span><br><span class="line">                <span class="keyword">for</span> (K key = p.key;;) &#123;</span><br><span class="line">                    V newValue = function.apply(key, oldValue);</span><br><span class="line">                    <span class="keyword">if</span> (newValue == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">                    <span class="keyword">if</span> (replaceNode(key, newValue, oldValue) != <span class="keyword">null</span> ||</span><br><span class="line">                        (oldValue = get(key)) == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If the specified key is not already associated with a value,</span></span><br><span class="line"><span class="comment">     * attempts to compute its value using the given mapping function</span></span><br><span class="line"><span class="comment">     * and enters it into this map unless &#123;<span class="doctag">@code</span> null&#125;.  The entire</span></span><br><span class="line"><span class="comment">     * method invocation is performed atomically, so the function is</span></span><br><span class="line"><span class="comment">     * applied at most once per key.  Some attempted update operations</span></span><br><span class="line"><span class="comment">     * on this map by other threads may be blocked while computation</span></span><br><span class="line"><span class="comment">     * is in progress, so the computation should be short and simple,</span></span><br><span class="line"><span class="comment">     * and must not attempt to update any other mappings of this map.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key key with which the specified value is to be associated</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mappingFunction the function to compute a value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the current (existing or computed) value associated with</span></span><br><span class="line"><span class="comment">     *         the specified key, or null if the computed value is null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key or mappingFunction</span></span><br><span class="line"><span class="comment">     *         is null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if the computation detectably</span></span><br><span class="line"><span class="comment">     *         attempts a recursive update to this map that would</span></span><br><span class="line"><span class="comment">     *         otherwise never complete</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RuntimeException or Error if the mappingFunction does so,</span></span><br><span class="line"><span class="comment">     *         in which case the mapping is left unestablished</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">computeIfAbsent</span><span class="params">(K key, Function&lt;? <span class="keyword">super</span> K, ? extends V&gt; mappingFunction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || mappingFunction == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">        V val = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">            <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">                tab = initTable();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Node&lt;K,V&gt; r = <span class="keyword">new</span> ReservationNode&lt;K,V&gt;();</span><br><span class="line">                <span class="keyword">synchronized</span> (r) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>, r)) &#123;</span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        Node&lt;K,V&gt; node = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> ((val = mappingFunction.apply(key)) != <span class="keyword">null</span>)</span><br><span class="line">                                node = <span class="keyword">new</span> Node&lt;K,V&gt;(h, key, val, <span class="keyword">null</span>);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            setTabAt(tab, i, node);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (binCount != <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                tab = helpTransfer(tab, f);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">boolean</span> added = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            binCount = <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                                K ek; V ev;</span><br><span class="line">                                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                                    ((ek = e.key) == key ||</span><br><span class="line">                                     (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                    val = e.val;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                Node&lt;K,V&gt; pred = e;</span><br><span class="line">                                <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((val = mappingFunction.apply(key)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                        added = <span class="keyword">true</span>;</span><br><span class="line">                                        pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(h, key, val, <span class="keyword">null</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            binCount = <span class="number">2</span>;</span><br><span class="line">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                            TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                            <span class="keyword">if</span> ((r = t.root) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (p = r.findTreeNode(h, key, <span class="keyword">null</span>)) != <span class="keyword">null</span>)</span><br><span class="line">                                val = p.val;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> ((val = mappingFunction.apply(key)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                added = <span class="keyword">true</span>;</span><br><span class="line">                                t.putTreeVal(h, key, val);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                        treeifyBin(tab, i);</span><br><span class="line">                    <span class="keyword">if</span> (!added)</span><br><span class="line">                        <span class="keyword">return</span> val;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (val != <span class="keyword">null</span>)</span><br><span class="line">            addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If the value for the specified key is present, attempts to</span></span><br><span class="line"><span class="comment">     * compute a new mapping given the key and its current mapped</span></span><br><span class="line"><span class="comment">     * value.  The entire method invocation is performed atomically.</span></span><br><span class="line"><span class="comment">     * Some attempted update operations on this map by other threads</span></span><br><span class="line"><span class="comment">     * may be blocked while computation is in progress, so the</span></span><br><span class="line"><span class="comment">     * computation should be short and simple, and must not attempt to</span></span><br><span class="line"><span class="comment">     * update any other mappings of this map.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key key with which a value may be associated</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> remappingFunction the function to compute a value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the new value associated with the specified key, or null if none</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key or remappingFunction</span></span><br><span class="line"><span class="comment">     *         is null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if the computation detectably</span></span><br><span class="line"><span class="comment">     *         attempts a recursive update to this map that would</span></span><br><span class="line"><span class="comment">     *         otherwise never complete</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RuntimeException or Error if the remappingFunction does so,</span></span><br><span class="line"><span class="comment">     *         in which case the mapping is unchanged</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">computeIfPresent</span><span class="params">(K key, BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">        V val = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> delta = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">            <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">                tab = initTable();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                tab = helpTransfer(tab, f);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            binCount = <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = f, pred = <span class="keyword">null</span>;; ++binCount) &#123;</span><br><span class="line">                                K ek;</span><br><span class="line">                                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                                    ((ek = e.key) == key ||</span><br><span class="line">                                     (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                    val = remappingFunction.apply(key, e.val);</span><br><span class="line">                                    <span class="keyword">if</span> (val != <span class="keyword">null</span>)</span><br><span class="line">                                        e.val = val;</span><br><span class="line">                                    <span class="keyword">else</span> &#123;</span><br><span class="line">                                        delta = -<span class="number">1</span>;</span><br><span class="line">                                        Node&lt;K,V&gt; en = e.next;</span><br><span class="line">                                        <span class="keyword">if</span> (pred != <span class="keyword">null</span>)</span><br><span class="line">                                            pred.next = en;</span><br><span class="line">                                        <span class="keyword">else</span></span><br><span class="line">                                            setTabAt(tab, i, en);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                pred = e;</span><br><span class="line">                                <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>)</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            binCount = <span class="number">2</span>;</span><br><span class="line">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                            TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                            <span class="keyword">if</span> ((r = t.root) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (p = r.findTreeNode(h, key, <span class="keyword">null</span>)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                val = remappingFunction.apply(key, p.val);</span><br><span class="line">                                <span class="keyword">if</span> (val != <span class="keyword">null</span>)</span><br><span class="line">                                    p.val = val;</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    delta = -<span class="number">1</span>;</span><br><span class="line">                                    <span class="keyword">if</span> (t.removeTreeNode(p))</span><br><span class="line">                                        setTabAt(tab, i, untreeify(t.first));</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (binCount != <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (delta != <span class="number">0</span>)</span><br><span class="line">            addCount((<span class="keyword">long</span>)delta, binCount);</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempts to compute a mapping for the specified key and its</span></span><br><span class="line"><span class="comment">     * current mapped value (or &#123;<span class="doctag">@code</span> null&#125; if there is no current</span></span><br><span class="line"><span class="comment">     * mapping). The entire method invocation is performed atomically.</span></span><br><span class="line"><span class="comment">     * Some attempted update operations on this map by other threads</span></span><br><span class="line"><span class="comment">     * may be blocked while computation is in progress, so the</span></span><br><span class="line"><span class="comment">     * computation should be short and simple, and must not attempt to</span></span><br><span class="line"><span class="comment">     * update any other mappings of this Map.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key key with which the specified value is to be associated</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> remappingFunction the function to compute a value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the new value associated with the specified key, or null if none</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key or remappingFunction</span></span><br><span class="line"><span class="comment">     *         is null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if the computation detectably</span></span><br><span class="line"><span class="comment">     *         attempts a recursive update to this map that would</span></span><br><span class="line"><span class="comment">     *         otherwise never complete</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RuntimeException or Error if the remappingFunction does so,</span></span><br><span class="line"><span class="comment">     *         in which case the mapping is unchanged</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">compute</span><span class="params">(K key,</span></span></span><br><span class="line"><span class="function"><span class="params">                     BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">        V val = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> delta = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">            <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">                tab = initTable();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Node&lt;K,V&gt; r = <span class="keyword">new</span> ReservationNode&lt;K,V&gt;();</span><br><span class="line">                <span class="keyword">synchronized</span> (r) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>, r)) &#123;</span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        Node&lt;K,V&gt; node = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> ((val = remappingFunction.apply(key, <span class="keyword">null</span>)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                delta = <span class="number">1</span>;</span><br><span class="line">                                node = <span class="keyword">new</span> Node&lt;K,V&gt;(h, key, val, <span class="keyword">null</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            setTabAt(tab, i, node);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (binCount != <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                tab = helpTransfer(tab, f);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            binCount = <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = f, pred = <span class="keyword">null</span>;; ++binCount) &#123;</span><br><span class="line">                                K ek;</span><br><span class="line">                                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                                    ((ek = e.key) == key ||</span><br><span class="line">                                     (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                    val = remappingFunction.apply(key, e.val);</span><br><span class="line">                                    <span class="keyword">if</span> (val != <span class="keyword">null</span>)</span><br><span class="line">                                        e.val = val;</span><br><span class="line">                                    <span class="keyword">else</span> &#123;</span><br><span class="line">                                        delta = -<span class="number">1</span>;</span><br><span class="line">                                        Node&lt;K,V&gt; en = e.next;</span><br><span class="line">                                        <span class="keyword">if</span> (pred != <span class="keyword">null</span>)</span><br><span class="line">                                            pred.next = en;</span><br><span class="line">                                        <span class="keyword">else</span></span><br><span class="line">                                            setTabAt(tab, i, en);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                pred = e;</span><br><span class="line">                                <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    val = remappingFunction.apply(key, <span class="keyword">null</span>);</span><br><span class="line">                                    <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                        delta = <span class="number">1</span>;</span><br><span class="line">                                        pred.next =</span><br><span class="line">                                            <span class="keyword">new</span> Node&lt;K,V&gt;(h, key, val, <span class="keyword">null</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            binCount = <span class="number">1</span>;</span><br><span class="line">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                            TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                            <span class="keyword">if</span> ((r = t.root) != <span class="keyword">null</span>)</span><br><span class="line">                                p = r.findTreeNode(h, key, <span class="keyword">null</span>);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                p = <span class="keyword">null</span>;</span><br><span class="line">                            V pv = (p == <span class="keyword">null</span>) ? <span class="keyword">null</span> : p.val;</span><br><span class="line">                            val = remappingFunction.apply(key, pv);</span><br><span class="line">                            <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (p != <span class="keyword">null</span>)</span><br><span class="line">                                    p.val = val;</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    delta = <span class="number">1</span>;</span><br><span class="line">                                    t.putTreeVal(h, key, val);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                delta = -<span class="number">1</span>;</span><br><span class="line">                                <span class="keyword">if</span> (t.removeTreeNode(p))</span><br><span class="line">                                    setTabAt(tab, i, untreeify(t.first));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                        treeifyBin(tab, i);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (delta != <span class="number">0</span>)</span><br><span class="line">            addCount((<span class="keyword">long</span>)delta, binCount);</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If the specified key is not already associated with a</span></span><br><span class="line"><span class="comment">     * (non-null) value, associates it with the given value.</span></span><br><span class="line"><span class="comment">     * Otherwise, replaces the value with the results of the given</span></span><br><span class="line"><span class="comment">     * remapping function, or removes if &#123;<span class="doctag">@code</span> null&#125;. The entire</span></span><br><span class="line"><span class="comment">     * method invocation is performed atomically.  Some attempted</span></span><br><span class="line"><span class="comment">     * update operations on this map by other threads may be blocked</span></span><br><span class="line"><span class="comment">     * while computation is in progress, so the computation should be</span></span><br><span class="line"><span class="comment">     * short and simple, and must not attempt to update any other</span></span><br><span class="line"><span class="comment">     * mappings of this Map.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key key with which the specified value is to be associated</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value the value to use if absent</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> remappingFunction the function to recompute a value if present</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the new value associated with the specified key, or null if none</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified key or the</span></span><br><span class="line"><span class="comment">     *         remappingFunction is null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RuntimeException or Error if the remappingFunction does so,</span></span><br><span class="line"><span class="comment">     *         in which case the mapping is unchanged</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">merge</span><span class="params">(K key, V value, BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span> || remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">        V val = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> delta = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">            <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">                tab = initTable();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>, <span class="keyword">new</span> Node&lt;K,V&gt;(h, key, value, <span class="keyword">null</span>))) &#123;</span><br><span class="line">                    delta = <span class="number">1</span>;</span><br><span class="line">                    val = value;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                tab = helpTransfer(tab, f);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            binCount = <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = f, pred = <span class="keyword">null</span>;; ++binCount) &#123;</span><br><span class="line">                                K ek;</span><br><span class="line">                                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                                    ((ek = e.key) == key ||</span><br><span class="line">                                     (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                    val = remappingFunction.apply(e.val, value);</span><br><span class="line">                                    <span class="keyword">if</span> (val != <span class="keyword">null</span>)</span><br><span class="line">                                        e.val = val;</span><br><span class="line">                                    <span class="keyword">else</span> &#123;</span><br><span class="line">                                        delta = -<span class="number">1</span>;</span><br><span class="line">                                        Node&lt;K,V&gt; en = e.next;</span><br><span class="line">                                        <span class="keyword">if</span> (pred != <span class="keyword">null</span>)</span><br><span class="line">                                            pred.next = en;</span><br><span class="line">                                        <span class="keyword">else</span></span><br><span class="line">                                            setTabAt(tab, i, en);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                pred = e;</span><br><span class="line">                                <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    delta = <span class="number">1</span>;</span><br><span class="line">                                    val = value;</span><br><span class="line">                                    pred.next =</span><br><span class="line">                                        <span class="keyword">new</span> Node&lt;K,V&gt;(h, key, val, <span class="keyword">null</span>);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            binCount = <span class="number">2</span>;</span><br><span class="line">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                            TreeNode&lt;K,V&gt; r = t.root;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = (r == <span class="keyword">null</span>) ? <span class="keyword">null</span> :</span><br><span class="line">                                r.findTreeNode(h, key, <span class="keyword">null</span>);</span><br><span class="line">                            val = (p == <span class="keyword">null</span>) ? value :</span><br><span class="line">                                remappingFunction.apply(p.val, value);</span><br><span class="line">                            <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (p != <span class="keyword">null</span>)</span><br><span class="line">                                    p.val = val;</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    delta = <span class="number">1</span>;</span><br><span class="line">                                    t.putTreeVal(h, key, val);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                delta = -<span class="number">1</span>;</span><br><span class="line">                                <span class="keyword">if</span> (t.removeTreeNode(p))</span><br><span class="line">                                    setTabAt(tab, i, untreeify(t.first));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                        treeifyBin(tab, i);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (delta != <span class="number">0</span>)</span><br><span class="line">            addCount((<span class="keyword">long</span>)delta, binCount);</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hashtable legacy methods</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Legacy method testing if some key maps into the specified value</span></span><br><span class="line"><span class="comment">     * in this table.  This method is identical in functionality to</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #containsValue(Object)&#125;, and exists solely to ensure</span></span><br><span class="line"><span class="comment">     * full compatibility with class &#123;<span class="doctag">@link</span> java.util.Hashtable&#125;,</span></span><br><span class="line"><span class="comment">     * which supported this method prior to introduction of the</span></span><br><span class="line"><span class="comment">     * Java Collections framework.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  value a value to search for</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if and only if some key maps to the</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> value&#125; argument in this table as</span></span><br><span class="line"><span class="comment">     *         determined by the &#123;<span class="doctag">@code</span> equals&#125; method;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the specified value is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> containsValue(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an enumeration of the keys in this table.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an enumeration of the keys in this table</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #keySet()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;K&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        <span class="keyword">int</span> f = (t = table) == <span class="keyword">null</span> ? <span class="number">0</span> : t.length;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeyIterator&lt;K,V&gt;(t, f, <span class="number">0</span>, f, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an enumeration of the values in this table.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an enumeration of the values in this table</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #values()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;V&gt; <span class="title">elements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        <span class="keyword">int</span> f = (t = table) == <span class="keyword">null</span> ? <span class="number">0</span> : t.length;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ValueIterator&lt;K,V&gt;(t, f, <span class="number">0</span>, f, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ConcurrentHashMap-only methods</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of mappings. This method should be used</span></span><br><span class="line"><span class="comment">     * instead of &#123;<span class="doctag">@link</span> #size&#125; because a ConcurrentHashMap may</span></span><br><span class="line"><span class="comment">     * contain more mappings than can be represented as an int. The</span></span><br><span class="line"><span class="comment">     * value returned is an estimate; the actual count may differ if</span></span><br><span class="line"><span class="comment">     * there are concurrent insertions or removals.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of mappings</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">mappingCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n = sumCount();</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0L</span>) ? <span class="number">0L</span> : n; <span class="comment">// ignore transient negative values</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new &#123;<span class="doctag">@link</span> Set&#125; backed by a ConcurrentHashMap</span></span><br><span class="line"><span class="comment">     * from the given type to &#123;<span class="doctag">@code</span> Boolean.TRUE&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;K&gt; the element type of the returned set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the new set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;K&gt; <span class="function">KeySetView&lt;K,Boolean&gt; <span class="title">newKeySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeySetView&lt;K,Boolean&gt;</span><br><span class="line">            (<span class="keyword">new</span> ConcurrentHashMap&lt;K,Boolean&gt;(), Boolean.TRUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new &#123;<span class="doctag">@link</span> Set&#125; backed by a ConcurrentHashMap</span></span><br><span class="line"><span class="comment">     * from the given type to &#123;<span class="doctag">@code</span> Boolean.TRUE&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> initialCapacity The implementation performs internal</span></span><br><span class="line"><span class="comment">     * sizing to accommodate this many elements.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;K&gt; the element type of the returned set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the new set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity of</span></span><br><span class="line"><span class="comment">     * elements is negative</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;K&gt; <span class="function">KeySetView&lt;K,Boolean&gt; <span class="title">newKeySet</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeySetView&lt;K,Boolean&gt;</span><br><span class="line">            (<span class="keyword">new</span> ConcurrentHashMap&lt;K,Boolean&gt;(initialCapacity), Boolean.TRUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a &#123;<span class="doctag">@link</span> Set&#125; view of the keys in this map, using the</span></span><br><span class="line"><span class="comment">     * given common mapped value for any additions (i.e., &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     * Collection#add&#125; and &#123;<span class="doctag">@link</span> Collection#addAll(Collection)&#125;).</span></span><br><span class="line"><span class="comment">     * This is of course only appropriate if it is acceptable to use</span></span><br><span class="line"><span class="comment">     * the same value for all additions from this view.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mappedValue the mapped value to use for any additions</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the set view</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if the mappedValue is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeySetView&lt;K,V&gt; <span class="title">keySet</span><span class="params">(V mappedValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mappedValue == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeySetView&lt;K,V&gt;(<span class="keyword">this</span>, mappedValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- Special Nodes -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A node inserted at head of bins during transfer operations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">        ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">            <span class="keyword">super</span>(MOVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.nextTable = tab;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// loop to avoid arbitrarily deep recursion on forwarding nodes</span></span><br><span class="line">            outer: <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = nextTable;;) &#123;</span><br><span class="line">                Node&lt;K,V&gt; e; <span class="keyword">int</span> n;</span><br><span class="line">                <span class="keyword">if</span> (k == <span class="keyword">null</span> || tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">                    (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    <span class="keyword">int</span> eh; K ek;</span><br><span class="line">                    <span class="keyword">if</span> ((eh = e.hash) == h &amp;&amp;</span><br><span class="line">                        ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                        <span class="keyword">return</span> e;</span><br><span class="line">                    <span class="keyword">if</span> (eh &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                            tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                            <span class="keyword">continue</span> outer;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            <span class="keyword">return</span> e.find(h, k);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A place-holder node used in computeIfAbsent and compute</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReservationNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        ReservationNode() &#123;</span><br><span class="line">            <span class="keyword">super</span>(RESERVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- Table Initialization and Resizing -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the stamp bits for resizing a table of size n.</span></span><br><span class="line"><span class="comment">     * Must be negative when shifted left by RESIZE_STAMP_SHIFT.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">resizeStamp</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.numberOfLeadingZeros(n) | (<span class="number">1</span> &lt;&lt; (RESIZE_STAMP_BITS - <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes table, using the size recorded in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">        <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">                Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = tab = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tab;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds to count, and if table is too small and not already</span></span><br><span class="line"><span class="comment">     * resizing, initiates transfer. If already resizing, helps</span></span><br><span class="line"><span class="comment">     * perform transfer if work is available.  Rechecks occupancy</span></span><br><span class="line"><span class="comment">     * after a transfer to see if another resize is already needed</span></span><br><span class="line"><span class="comment">     * because resizings are lagging additions.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x the count to add</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> check if &lt;0, don&#x27;t check resize, if &lt;= 1 only check if uncontended</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">        CounterCell[] as; <span class="keyword">long</span> b, s;</span><br><span class="line">        <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">            !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">            CounterCell a; <span class="keyword">long</span> v; <span class="keyword">int</span> m;</span><br><span class="line">            <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">                (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">                !(uncontended =</span><br><span class="line">                  U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">                fullAddCount(x, uncontended);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">            <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                   (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">                <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">                <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                        sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                        transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                        transfer(tab, nt);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                             (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                    transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">                s = sumCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Helps transfer if a resize is in progress.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] nextTab; <span class="keyword">int</span> sc;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; (f <span class="keyword">instanceof</span> ForwardingNode) &amp;&amp;</span><br><span class="line">            (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(tab.length);</span><br><span class="line">            <span class="keyword">while</span> (nextTab == nextTable &amp;&amp; table == tab &amp;&amp;</span><br><span class="line">                   (sc = sizeCtl) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>)) &#123;</span><br><span class="line">                    transfer(tab, nextTab);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> nextTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> table;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tries to presize table to accommodate the given number of elements.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size number of elements (doesn&#x27;t need to be perfectly accurate)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryPresize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">            tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">int</span> sc;</span><br><span class="line">        <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            Node&lt;K,V&gt;[] tab = table; <span class="keyword">int</span> n;</span><br><span class="line">            <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">                n = (sc &gt; c) ? sc : c;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">                            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                            table = nt;</span><br><span class="line">                            sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        sizeCtl = sc;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line">                <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">                <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Node&lt;K,V&gt;[] nt;</span><br><span class="line">                    <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                        sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                        transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                        transfer(tab, nt);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                             (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                    transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Moves and/or copies the nodes in each bin to new table. See</span></span><br><span class="line"><span class="comment">     * above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">        <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">            stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">        <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                nextTab = nt;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">                sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nextTable = nextTab;</span><br><span class="line">            transferIndex = n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">        ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">        <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">            <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">                <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">                <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    i = -<span class="number">1</span>;</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                         (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                          nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                       nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                    bound = nextBound;</span><br><span class="line">                    i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">                <span class="keyword">int</span> sc;</span><br><span class="line">                <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                    nextTable = <span class="keyword">null</span>;</span><br><span class="line">                    table = nextTab;</span><br><span class="line">                    sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                    i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">                advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">                            Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">                                <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                    runBit = b;</span><br><span class="line">                                    lastRun = p;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                                ln = lastRun;</span><br><span class="line">                                hn = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                hn = lastRun;</span><br><span class="line">                                ln = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                                <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                    ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                            &#125;</span><br><span class="line">                            setTabAt(nextTab, i, ln);</span><br><span class="line">                            setTabAt(nextTab, i + n, hn);</span><br><span class="line">                            setTabAt(tab, i, fwd);</span><br><span class="line">                            advance = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                            TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                            TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> h = e.hash;</span><br><span class="line">                                TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                    (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                                        lo = p;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        loTail.next = p;</span><br><span class="line">                                    loTail = p;</span><br><span class="line">                                    ++lc;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                                        hi = p;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        hiTail.next = p;</span><br><span class="line">                                    hiTail = p;</span><br><span class="line">                                    ++hc;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                                (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">                            hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                                (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                            setTabAt(nextTab, i, ln);</span><br><span class="line">                            setTabAt(nextTab, i + n, hn);</span><br><span class="line">                            setTabAt(tab, i, fwd);</span><br><span class="line">                            advance = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- Counter support -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A padded cell for distributing counts.  Adapted from LongAdder</span></span><br><span class="line"><span class="comment">     * and Striped64.  See their internal docs for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterCell</span> </span>&#123;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">        CounterCell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">        <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">        <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                    sum += a.value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// See LongAdder version for explanation</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">fullAddCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> h;</span><br><span class="line">        <span class="keyword">if</span> ((h = ThreadLocalRandom.getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">            ThreadLocalRandom.localInit();      <span class="comment">// force initialization</span></span><br><span class="line">            h = ThreadLocalRandom.getProbe();</span><br><span class="line">            wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;                <span class="comment">// True if last slot nonempty</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            CounterCell[] as; CounterCell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">            <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;            <span class="comment">// Try to attach new Cell</span></span><br><span class="line">                        CounterCell r = <span class="keyword">new</span> CounterCell(x); <span class="comment">// Optimistic create</span></span><br><span class="line">                        <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                            U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                            <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">try</span> &#123;               <span class="comment">// Recheck under lock</span></span><br><span class="line">                                CounterCell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                                <span class="keyword">if</span> ((rs = counterCells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                    (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                    rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    rs[j] = r;</span><br><span class="line">                                    created = <span class="keyword">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                cellsBusy = <span class="number">0</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (created)</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    collide = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)       <span class="comment">// CAS already known to fail</span></span><br><span class="line">                    wasUncontended = <span class="keyword">true</span>;      <span class="comment">// Continue after rehash</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (counterCells != as || n &gt;= NCPU)</span><br><span class="line">                    collide = <span class="keyword">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                    collide = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (counterCells == as) &#123;<span class="comment">// Expand table unless stale</span></span><br><span class="line">                            CounterCell[] rs = <span class="keyword">new</span> CounterCell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                                rs[i] = as[i];</span><br><span class="line">                            counterCells = rs;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        cellsBusy = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    collide = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">                &#125;</span><br><span class="line">                h = ThreadLocalRandom.advanceProbe(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; counterCells == as &amp;&amp;</span><br><span class="line">                     U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;                           <span class="comment">// Initialize table</span></span><br><span class="line">                    <span class="keyword">if</span> (counterCells == as) &#123;</span><br><span class="line">                        CounterCell[] rs = <span class="keyword">new</span> CounterCell[<span class="number">2</span>];</span><br><span class="line">                        rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> CounterCell(x);</span><br><span class="line">                        counterCells = rs;</span><br><span class="line">                        init = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (init)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, v = baseCount, v + x))</span><br><span class="line">                <span class="keyword">break</span>;                          <span class="comment">// Fall back on using base</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- Conversion from/to TreeBins -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Replaces all linked nodes in bin at given index unless table is</span></span><br><span class="line"><span class="comment">     * too small, in which case resizes instead.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt; b; <span class="keyword">int</span> n, sc;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">                tryPresize(n &lt;&lt; <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p =</span><br><span class="line">                                <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                                  <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                            <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)</span><br><span class="line">                                hd = p;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                tl.next = p;</span><br><span class="line">                            tl = p;</span><br><span class="line">                        &#125;</span><br><span class="line">                        setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a list on non-TreeNodes replacing those in given list.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">untreeify</span><span class="params">(Node&lt;K,V&gt; b)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; q = b; q != <span class="keyword">null</span>; q = q.next) &#123;</span><br><span class="line">            Node&lt;K,V&gt; p = <span class="keyword">new</span> Node&lt;K,V&gt;(q.hash, q.key, q.val, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</span><br><span class="line">                hd = p;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                tl.next = p;</span><br><span class="line">            tl = p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- TreeNodes -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Nodes for use in TreeBins</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">        TreeNode&lt;K,V&gt; left;</span><br><span class="line">        TreeNode&lt;K,V&gt; right;</span><br><span class="line">        TreeNode&lt;K,V&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">        <span class="keyword">boolean</span> red;</span><br><span class="line"></span><br><span class="line">        TreeNode(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next,</span><br><span class="line">                 TreeNode&lt;K,V&gt; parent) &#123;</span><br><span class="line">            <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">            <span class="keyword">this</span>.parent = parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> findTreeNode(h, k, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns the TreeNode (or null if not found) for the given key</span></span><br><span class="line"><span class="comment">         * starting at given root.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">findTreeNode</span><span class="params">(<span class="keyword">int</span> h, Object k, Class&lt;?&gt; kc)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (k != <span class="keyword">null</span>) &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>;</span><br><span class="line">                <span class="keyword">do</span>  &#123;</span><br><span class="line">                    <span class="keyword">int</span> ph, dir; K pk; TreeNode&lt;K,V&gt; q;</span><br><span class="line">                    TreeNode&lt;K,V&gt; pl = p.left, pr = p.right;</span><br><span class="line">                    <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                        p = pl;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                        p = pr;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (pk != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">                        <span class="keyword">return</span> p;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (pl == <span class="keyword">null</span>)</span><br><span class="line">                        p = pr;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (pr == <span class="keyword">null</span>)</span><br><span class="line">                        p = pl;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ((kc != <span class="keyword">null</span> ||</span><br><span class="line">                              (kc = comparableClassFor(k)) != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">                             (dir = compareComparables(kc, k, pk)) != <span class="number">0</span>)</span><br><span class="line">                        p = (dir &lt; <span class="number">0</span>) ? pl : pr;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ((q = pr.findTreeNode(h, k, kc)) != <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span> q;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        p = pl;</span><br><span class="line">                &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---------------- TreeBins -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * TreeNodes used at the heads of bins. TreeBins do not hold user</span></span><br><span class="line"><span class="comment">     * keys or values, but instead point to list of TreeNodes and</span></span><br><span class="line"><span class="comment">     * their root. They also maintain a parasitic read-write lock</span></span><br><span class="line"><span class="comment">     * forcing writers (who hold bin lock) to wait for readers (who do</span></span><br><span class="line"><span class="comment">     * not) to complete before tree restructuring operations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeBin</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; root;</span><br><span class="line">        <span class="keyword">volatile</span> TreeNode&lt;K,V&gt; first;</span><br><span class="line">        <span class="keyword">volatile</span> Thread waiter;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">int</span> lockState;</span><br><span class="line">        <span class="comment">// values for lockState</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITER = <span class="number">1</span>; <span class="comment">// set while holding write lock</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WAITER = <span class="number">2</span>; <span class="comment">// set when waiting for write lock</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> READER = <span class="number">4</span>; <span class="comment">// increment value for setting read lock</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Tie-breaking utility for ordering insertions when equal</span></span><br><span class="line"><span class="comment">         * hashCodes and non-comparable. We don&#x27;t require a total</span></span><br><span class="line"><span class="comment">         * order, just a consistent insertion rule to maintain</span></span><br><span class="line"><span class="comment">         * equivalence across rebalancings. Tie-breaking further than</span></span><br><span class="line"><span class="comment">         * necessary simplifies testing a bit.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tieBreakOrder</span><span class="params">(Object a, Object b)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> d;</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span> || b == <span class="keyword">null</span> ||</span><br><span class="line">                (d = a.getClass().getName().</span><br><span class="line">                 compareTo(b.getClass().getName())) == <span class="number">0</span>)</span><br><span class="line">                d = (System.identityHashCode(a) &lt;= System.identityHashCode(b) ?</span><br><span class="line">                     -<span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> d;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates bin with initial set of nodes headed by b.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        TreeBin(TreeNode&lt;K,V&gt; b) &#123;</span><br><span class="line">            <span class="keyword">super</span>(TREEBIN, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.first = b;</span><br><span class="line">            TreeNode&lt;K,V&gt; r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; x = b, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">                next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">                x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.parent = <span class="keyword">null</span>;</span><br><span class="line">                    x.red = <span class="keyword">false</span>;</span><br><span class="line">                    r = x;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    K k = x.key;</span><br><span class="line">                    <span class="keyword">int</span> h = x.hash;</span><br><span class="line">                    Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = r;;) &#123;</span><br><span class="line">                        <span class="keyword">int</span> dir, ph;</span><br><span class="line">                        K pk = p.key;</span><br><span class="line">                        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                            dir = -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                            dir = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                  (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                                 (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">                            dir = tieBreakOrder(k, pk);</span><br><span class="line">                            TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                        <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            x.parent = xp;</span><br><span class="line">                            <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                                xp.left = x;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                xp.right = x;</span><br><span class="line">                            r = balanceInsertion(r, x);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.root = r;</span><br><span class="line">            <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Acquires write lock for tree restructuring.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lockRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!U.compareAndSwapInt(<span class="keyword">this</span>, LOCKSTATE, <span class="number">0</span>, WRITER))</span><br><span class="line">                contendedLock(); <span class="comment">// offload to separate method</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Releases write lock for tree restructuring.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">unlockRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            lockState = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Possibly blocks awaiting root lock.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">contendedLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">boolean</span> waiting = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> s;;) &#123;</span><br><span class="line">                <span class="keyword">if</span> (((s = lockState) &amp; ~WAITER) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, LOCKSTATE, s, WRITER)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (waiting)</span><br><span class="line">                            waiter = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((s &amp; WAITER) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, LOCKSTATE, s, s | WAITER)) &#123;</span><br><span class="line">                        waiting = <span class="keyword">true</span>;</span><br><span class="line">                        waiter = Thread.currentThread();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (waiting)</span><br><span class="line">                    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns matching node or null if none. Tries to search</span></span><br><span class="line"><span class="comment">         * using tree comparisons from root, but continues linear</span></span><br><span class="line"><span class="comment">         * search when lock not available.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (k != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; e = first; e != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    <span class="keyword">int</span> s; K ek;</span><br><span class="line">                    <span class="keyword">if</span> (((s = lockState) &amp; (WAITER|WRITER)) != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                            ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                            <span class="keyword">return</span> e;</span><br><span class="line">                        e = e.next;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, LOCKSTATE, s,</span><br><span class="line">                                                 s + READER)) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            p = ((r = root) == <span class="keyword">null</span> ? <span class="keyword">null</span> :</span><br><span class="line">                                 r.findTreeNode(h, k, <span class="keyword">null</span>));</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            Thread w;</span><br><span class="line">                            <span class="keyword">if</span> (U.getAndAddInt(<span class="keyword">this</span>, LOCKSTATE, -READER) ==</span><br><span class="line">                                (READER|WAITER) &amp;&amp; (w = waiter) != <span class="keyword">null</span>)</span><br><span class="line">                                LockSupport.unpark(w);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> p;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Finds or adds a node.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> null if added</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">putTreeVal</span><span class="params">(<span class="keyword">int</span> h, K k, V v)</span> </span>&#123;</span><br><span class="line">            Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">boolean</span> searched = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">                <span class="keyword">int</span> dir, ph; K pk;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    first = root = <span class="keyword">new</span> TreeNode&lt;K,V&gt;(h, k, v, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                    dir = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                    dir = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (pk != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">                    <span class="keyword">return</span> p;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                          (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                         (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!searched) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; q, ch;</span><br><span class="line">                        searched = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">if</span> (((ch = p.left) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                             (q = ch.findTreeNode(h, k, kc)) != <span class="keyword">null</span>) ||</span><br><span class="line">                            ((ch = p.right) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                             (q = ch.findTreeNode(h, k, kc)) != <span class="keyword">null</span>))</span><br><span class="line">                            <span class="keyword">return</span> q;</span><br><span class="line">                    &#125;</span><br><span class="line">                    dir = tieBreakOrder(k, pk);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    TreeNode&lt;K,V&gt; x, f = first;</span><br><span class="line">                    first = x = <span class="keyword">new</span> TreeNode&lt;K,V&gt;(h, k, v, f, xp);</span><br><span class="line">                    <span class="keyword">if</span> (f != <span class="keyword">null</span>)</span><br><span class="line">                        f.prev = x;</span><br><span class="line">                    <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                        xp.left = x;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        xp.right = x;</span><br><span class="line">                    <span class="keyword">if</span> (!xp.red)</span><br><span class="line">                        x.red = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        lockRoot();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            root = balanceInsertion(root, x);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            unlockRoot();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Removes the given node, that must be present before this</span></span><br><span class="line"><span class="comment">         * call.  This is messier than typical red-black deletion code</span></span><br><span class="line"><span class="comment">         * because we cannot swap the contents of an interior node</span></span><br><span class="line"><span class="comment">         * with a leaf successor that is pinned by &quot;next&quot; pointers</span></span><br><span class="line"><span class="comment">         * that are accessible independently of lock. So instead we</span></span><br><span class="line"><span class="comment">         * swap the tree linkages.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> true if now too small, so should be untreeified</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">removeTreeNode</span><span class="params">(TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; next = (TreeNode&lt;K,V&gt;)p.next;</span><br><span class="line">            TreeNode&lt;K,V&gt; pred = p.prev;  <span class="comment">// unlink traversal pointers</span></span><br><span class="line">            TreeNode&lt;K,V&gt; r, rl;</span><br><span class="line">            <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">                first = next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                pred.next = next;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span>)</span><br><span class="line">                next.prev = pred;</span><br><span class="line">            <span class="keyword">if</span> (first == <span class="keyword">null</span>) &#123;</span><br><span class="line">                root = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((r = root) == <span class="keyword">null</span> || r.right == <span class="keyword">null</span> || <span class="comment">// too small</span></span><br><span class="line">                (rl = r.left) == <span class="keyword">null</span> || rl.left == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            lockRoot();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; replacement;</span><br><span class="line">                TreeNode&lt;K,V&gt; pl = p.left;</span><br><span class="line">                TreeNode&lt;K,V&gt; pr = p.right;</span><br><span class="line">                <span class="keyword">if</span> (pl != <span class="keyword">null</span> &amp;&amp; pr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    TreeNode&lt;K,V&gt; s = pr, sl;</span><br><span class="line">                    <span class="keyword">while</span> ((sl = s.left) != <span class="keyword">null</span>) <span class="comment">// find successor</span></span><br><span class="line">                        s = sl;</span><br><span class="line">                    <span class="keyword">boolean</span> c = s.red; s.red = p.red; p.red = c; <span class="comment">// swap colors</span></span><br><span class="line">                    TreeNode&lt;K,V&gt; sr = s.right;</span><br><span class="line">                    TreeNode&lt;K,V&gt; pp = p.parent;</span><br><span class="line">                    <span class="keyword">if</span> (s == pr) &#123; <span class="comment">// p was s&#x27;s direct parent</span></span><br><span class="line">                        p.parent = s;</span><br><span class="line">                        s.right = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; sp = s.parent;</span><br><span class="line">                        <span class="keyword">if</span> ((p.parent = sp) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (s == sp.left)</span><br><span class="line">                                sp.left = p;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                sp.right = p;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> ((s.right = pr) != <span class="keyword">null</span>)</span><br><span class="line">                            pr.parent = s;</span><br><span class="line">                    &#125;</span><br><span class="line">                    p.left = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> ((p.right = sr) != <span class="keyword">null</span>)</span><br><span class="line">                        sr.parent = p;</span><br><span class="line">                    <span class="keyword">if</span> ((s.left = pl) != <span class="keyword">null</span>)</span><br><span class="line">                        pl.parent = s;</span><br><span class="line">                    <span class="keyword">if</span> ((s.parent = pp) == <span class="keyword">null</span>)</span><br><span class="line">                        r = s;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">                        pp.left = s;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        pp.right = s;</span><br><span class="line">                    <span class="keyword">if</span> (sr != <span class="keyword">null</span>)</span><br><span class="line">                        replacement = sr;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        replacement = p;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (pl != <span class="keyword">null</span>)</span><br><span class="line">                    replacement = pl;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (pr != <span class="keyword">null</span>)</span><br><span class="line">                    replacement = pr;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    replacement = p;</span><br><span class="line">                <span class="keyword">if</span> (replacement != p) &#123;</span><br><span class="line">                    TreeNode&lt;K,V&gt; pp = replacement.parent = p.parent;</span><br><span class="line">                    <span class="keyword">if</span> (pp == <span class="keyword">null</span>)</span><br><span class="line">                        r = replacement;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">                        pp.left = replacement;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        pp.right = replacement;</span><br><span class="line">                    p.left = p.right = p.parent = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                root = (p.red) ? r : balanceDeletion(r, replacement);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (p == replacement) &#123;  <span class="comment">// detach pointers</span></span><br><span class="line">                    TreeNode&lt;K,V&gt; pp;</span><br><span class="line">                    <span class="keyword">if</span> ((pp = p.parent) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">                            pp.left = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.right)</span><br><span class="line">                            pp.right = <span class="keyword">null</span>;</span><br><span class="line">                        p.parent = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlockRoot();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ------------------------------------------------------------ */</span></span><br><span class="line">        <span class="comment">// Red-black tree methods, all adapted from CLR</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">rotateLeft</span><span class="params">(TreeNode&lt;K,V&gt; root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; r, pp, rl;</span><br><span class="line">            <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (r = p.right) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((rl = p.right = r.left) != <span class="keyword">null</span>)</span><br><span class="line">                    rl.parent = p;</span><br><span class="line">                <span class="keyword">if</span> ((pp = r.parent = p.parent) == <span class="keyword">null</span>)</span><br><span class="line">                    (root = r).red = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (pp.left == p)</span><br><span class="line">                    pp.left = r;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    pp.right = r;</span><br><span class="line">                r.left = p;</span><br><span class="line">                p.parent = r;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">rotateRight</span><span class="params">(TreeNode&lt;K,V&gt; root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; l, pp, lr;</span><br><span class="line">            <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (l = p.left) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((lr = p.left = l.right) != <span class="keyword">null</span>)</span><br><span class="line">                    lr.parent = p;</span><br><span class="line">                <span class="keyword">if</span> ((pp = l.parent = p.parent) == <span class="keyword">null</span>)</span><br><span class="line">                    (root = l).red = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (pp.right == p)</span><br><span class="line">                    pp.right = l;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    pp.left = l;</span><br><span class="line">                l.right = p;</span><br><span class="line">                p.parent = l;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceInsertion</span><span class="params">(TreeNode&lt;K,V&gt; root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    TreeNode&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class="line">            x.red = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; xp, xpp, xppl, xppr;;) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.red = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span> x;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!xp.red || (xpp = xp.parent) == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> root;</span><br><span class="line">                <span class="keyword">if</span> (xp == (xppl = xpp.left)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((xppr = xpp.right) != <span class="keyword">null</span> &amp;&amp; xppr.red) &#123;</span><br><span class="line">                        xppr.red = <span class="keyword">false</span>;</span><br><span class="line">                        xp.red = <span class="keyword">false</span>;</span><br><span class="line">                        xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                        x = xpp;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (x == xp.right) &#123;</span><br><span class="line">                            root = rotateLeft(root, x = xp);</span><br><span class="line">                            xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            xp.red = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                                root = rotateRight(root, xpp);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (xppl != <span class="keyword">null</span> &amp;&amp; xppl.red) &#123;</span><br><span class="line">                        xppl.red = <span class="keyword">false</span>;</span><br><span class="line">                        xp.red = <span class="keyword">false</span>;</span><br><span class="line">                        xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                        x = xpp;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (x == xp.left) &#123;</span><br><span class="line">                            root = rotateRight(root, x = xp);</span><br><span class="line">                            xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            xp.red = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                                root = rotateLeft(root, xpp);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceDeletion</span><span class="params">(TreeNode&lt;K,V&gt; root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                   TreeNode&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; xp, xpl, xpr;;)  &#123;</span><br><span class="line">                <span class="keyword">if</span> (x == <span class="keyword">null</span> || x == root)</span><br><span class="line">                    <span class="keyword">return</span> root;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.red = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span> x;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (x.red) &#123;</span><br><span class="line">                    x.red = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span> root;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((xpl = xp.left) == x) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((xpr = xp.right) != <span class="keyword">null</span> &amp;&amp; xpr.red) &#123;</span><br><span class="line">                        xpr.red = <span class="keyword">false</span>;</span><br><span class="line">                        xp.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateLeft(root, xp);</span><br><span class="line">                        xpr = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.right;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xpr == <span class="keyword">null</span>)</span><br><span class="line">                        x = xp;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; sl = xpr.left, sr = xpr.right;</span><br><span class="line">                        <span class="keyword">if</span> ((sr == <span class="keyword">null</span> || !sr.red) &amp;&amp;</span><br><span class="line">                            (sl == <span class="keyword">null</span> || !sl.red)) &#123;</span><br><span class="line">                            xpr.red = <span class="keyword">true</span>;</span><br><span class="line">                            x = xp;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (sr == <span class="keyword">null</span> || !sr.red) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (sl != <span class="keyword">null</span>)</span><br><span class="line">                                    sl.red = <span class="keyword">false</span>;</span><br><span class="line">                                xpr.red = <span class="keyword">true</span>;</span><br><span class="line">                                root = rotateRight(root, xpr);</span><br><span class="line">                                xpr = (xp = x.parent) == <span class="keyword">null</span> ?</span><br><span class="line">                                    <span class="keyword">null</span> : xp.right;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (xpr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                xpr.red = (xp == <span class="keyword">null</span>) ? <span class="keyword">false</span> : xp.red;</span><br><span class="line">                                <span class="keyword">if</span> ((sr = xpr.right) != <span class="keyword">null</span>)</span><br><span class="line">                                    sr.red = <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                xp.red = <span class="keyword">false</span>;</span><br><span class="line">                                root = rotateLeft(root, xp);</span><br><span class="line">                            &#125;</span><br><span class="line">                            x = root;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// symmetric</span></span><br><span class="line">                    <span class="keyword">if</span> (xpl != <span class="keyword">null</span> &amp;&amp; xpl.red) &#123;</span><br><span class="line">                        xpl.red = <span class="keyword">false</span>;</span><br><span class="line">                        xp.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateRight(root, xp);</span><br><span class="line">                        xpl = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.left;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xpl == <span class="keyword">null</span>)</span><br><span class="line">                        x = xp;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; sl = xpl.left, sr = xpl.right;</span><br><span class="line">                        <span class="keyword">if</span> ((sl == <span class="keyword">null</span> || !sl.red) &amp;&amp;</span><br><span class="line">                            (sr == <span class="keyword">null</span> || !sr.red)) &#123;</span><br><span class="line">                            xpl.red = <span class="keyword">true</span>;</span><br><span class="line">                            x = xp;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (sl == <span class="keyword">null</span> || !sl.red) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (sr != <span class="keyword">null</span>)</span><br><span class="line">                                    sr.red = <span class="keyword">false</span>;</span><br><span class="line">                                xpl.red = <span class="keyword">true</span>;</span><br><span class="line">                                root = rotateLeft(root, xpl);</span><br><span class="line">                                xpl = (xp = x.parent) == <span class="keyword">null</span> ?</span><br><span class="line">                                    <span class="keyword">null</span> : xp.left;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (xpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                xpl.red = (xp == <span class="keyword">null</span>) ? <span class="keyword">false</span> : xp.red;</span><br><span class="line">                                <span class="keyword">if</span> ((sl = xpl.left) != <span class="keyword">null</span>)</span><br><span class="line">                                    sl.red = <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                xp.red = <span class="keyword">false</span>;</span><br><span class="line">                                root = rotateRight(root, xp);</span><br><span class="line">                            &#125;</span><br><span class="line">                            x = root;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Recursive invariant check</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">checkInvariants</span><span class="params">(TreeNode&lt;K,V&gt; t)</span> </span>&#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; tp = t.parent, tl = t.left, tr = t.right,</span><br><span class="line">                tb = t.prev, tn = (TreeNode&lt;K,V&gt;)t.next;</span><br><span class="line">            <span class="keyword">if</span> (tb != <span class="keyword">null</span> &amp;&amp; tb.next != t)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (tn != <span class="keyword">null</span> &amp;&amp; tn.prev != t)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (tp != <span class="keyword">null</span> &amp;&amp; t != tp.left &amp;&amp; t != tp.right)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (tl != <span class="keyword">null</span> &amp;&amp; (tl.parent != t || tl.hash &gt; t.hash))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (tr != <span class="keyword">null</span> &amp;&amp; (tr.parent != t || tr.hash &lt; t.hash))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (t.red &amp;&amp; tl != <span class="keyword">null</span> &amp;&amp; tl.red &amp;&amp; tr != <span class="keyword">null</span> &amp;&amp; tr.red)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (tl != <span class="keyword">null</span> &amp;&amp; !checkInvariants(tl))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (tr != <span class="keyword">null</span> &amp;&amp; !checkInvariants(tr))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe U;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> LOCKSTATE;</span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">                Class&lt;?&gt; k = TreeBin.class;</span><br><span class="line">                LOCKSTATE = U.objectFieldOffset</span><br><span class="line">                    (k.getDeclaredField(<span class="string">&quot;lockState&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ----------------Table Traversal -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Records the table, its length, and current traversal index for a</span></span><br><span class="line"><span class="comment">     * traverser that must process a region of a forwarded table before</span></span><br><span class="line"><span class="comment">     * proceeding with current table.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TableStack</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length;</span><br><span class="line">        <span class="keyword">int</span> index;</span><br><span class="line">        Node&lt;K,V&gt;[] tab;</span><br><span class="line">        TableStack&lt;K,V&gt; next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Encapsulates traversal for methods such as containsValue; also</span></span><br><span class="line"><span class="comment">     * serves as a base class for other iterators and spliterators.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Method advance visits once each still-valid node that was</span></span><br><span class="line"><span class="comment">     * reachable upon iterator construction. It might miss some that</span></span><br><span class="line"><span class="comment">     * were added to a bin after the bin was visited, which is OK wrt</span></span><br><span class="line"><span class="comment">     * consistency guarantees. Maintaining this property in the face</span></span><br><span class="line"><span class="comment">     * of possible ongoing resizes requires a fair amount of</span></span><br><span class="line"><span class="comment">     * bookkeeping state that is difficult to optimize away amidst</span></span><br><span class="line"><span class="comment">     * volatile accesses.  Even so, traversal maintains reasonable</span></span><br><span class="line"><span class="comment">     * throughput.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Normally, iteration proceeds bin-by-bin traversing lists.</span></span><br><span class="line"><span class="comment">     * However, if the table has been resized, then all future steps</span></span><br><span class="line"><span class="comment">     * must traverse both the bin at the current index as well as at</span></span><br><span class="line"><span class="comment">     * (index + baseSize); and so on for further resizings. To</span></span><br><span class="line"><span class="comment">     * paranoically cope with potential sharing by users of iterators</span></span><br><span class="line"><span class="comment">     * across threads, iteration terminates if a bounds checks fails</span></span><br><span class="line"><span class="comment">     * for a table read.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Traverser</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab;        <span class="comment">// current table; updated if resized</span></span><br><span class="line">        Node&lt;K,V&gt; next;         <span class="comment">// the next entry to use</span></span><br><span class="line">        TableStack&lt;K,V&gt; stack, spare; <span class="comment">// to save/restore on ForwardingNodes</span></span><br><span class="line">        <span class="keyword">int</span> index;              <span class="comment">// index of bin to use next</span></span><br><span class="line">        <span class="keyword">int</span> baseIndex;          <span class="comment">// current index of initial table</span></span><br><span class="line">        <span class="keyword">int</span> baseLimit;          <span class="comment">// index bound for initial table</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> baseSize;     <span class="comment">// initial table size</span></span><br><span class="line"></span><br><span class="line">        Traverser(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> size, <span class="keyword">int</span> index, <span class="keyword">int</span> limit) &#123;</span><br><span class="line">            <span class="keyword">this</span>.tab = tab;</span><br><span class="line">            <span class="keyword">this</span>.baseSize = size;</span><br><span class="line">            <span class="keyword">this</span>.baseIndex = <span class="keyword">this</span>.index = index;</span><br><span class="line">            <span class="keyword">this</span>.baseLimit = limit;</span><br><span class="line">            <span class="keyword">this</span>.next = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Advances if possible, returning next valid node, or null if none.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">advance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = next) != <span class="keyword">null</span>)</span><br><span class="line">                e = e.next;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                Node&lt;K,V&gt;[] t; <span class="keyword">int</span> i, n;  <span class="comment">// must use locals in checks</span></span><br><span class="line">                <span class="keyword">if</span> (e != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> next = e;</span><br><span class="line">                <span class="keyword">if</span> (baseIndex &gt;= baseLimit || (t = tab) == <span class="keyword">null</span> ||</span><br><span class="line">                    (n = t.length) &lt;= (i = index) || i &lt; <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> next = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> ((e = tabAt(t, i)) != <span class="keyword">null</span> &amp;&amp; e.hash &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                        tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                        e = <span class="keyword">null</span>;</span><br><span class="line">                        pushState(t, i, n);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeBin)</span><br><span class="line">                        e = ((TreeBin&lt;K,V&gt;)e).first;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        e = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (stack != <span class="keyword">null</span>)</span><br><span class="line">                    recoverState(n);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((index = i + baseSize) &gt;= n)</span><br><span class="line">                    index = ++baseIndex; <span class="comment">// visit upper slots if present</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Saves traversal state upon encountering a forwarding node.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pushState</span><span class="params">(Node&lt;K,V&gt;[] t, <span class="keyword">int</span> i, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">            TableStack&lt;K,V&gt; s = spare;  <span class="comment">// reuse if possible</span></span><br><span class="line">            <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">                spare = s.next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                s = <span class="keyword">new</span> TableStack&lt;K,V&gt;();</span><br><span class="line">            s.tab = t;</span><br><span class="line">            s.length = n;</span><br><span class="line">            s.index = i;</span><br><span class="line">            s.next = stack;</span><br><span class="line">            stack = s;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Possibly pops traversal state.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> n length of current table</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recoverState</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">            TableStack&lt;K,V&gt; s; <span class="keyword">int</span> len;</span><br><span class="line">            <span class="keyword">while</span> ((s = stack) != <span class="keyword">null</span> &amp;&amp; (index += (len = s.length)) &gt;= n) &#123;</span><br><span class="line">                n = len;</span><br><span class="line">                index = s.index;</span><br><span class="line">                tab = s.tab;</span><br><span class="line">                s.tab = <span class="keyword">null</span>;</span><br><span class="line">                TableStack&lt;K,V&gt; next = s.next;</span><br><span class="line">                s.next = spare; <span class="comment">// save for reuse</span></span><br><span class="line">                stack = next;</span><br><span class="line">                spare = s;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span> &amp;&amp; (index += baseSize) &gt;= n)</span><br><span class="line">                index = ++baseIndex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base of key, value, and entry Iterators. Adds fields to</span></span><br><span class="line"><span class="comment">     * Traverser to support iterator.remove.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseIterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Traverser</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ConcurrentHashMap&lt;K,V&gt; map;</span><br><span class="line">        Node&lt;K,V&gt; lastReturned;</span><br><span class="line">        BaseIterator(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> size, <span class="keyword">int</span> index, <span class="keyword">int</span> limit,</span><br><span class="line">                    ConcurrentHashMap&lt;K,V&gt; map) &#123;</span><br><span class="line">            <span class="keyword">super</span>(tab, size, index, limit);</span><br><span class="line">            <span class="keyword">this</span>.map = map;</span><br><span class="line">            advance();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> next != <span class="keyword">null</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> next != <span class="keyword">null</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt; p;</span><br><span class="line">            <span class="keyword">if</span> ((p = lastReturned) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">            lastReturned = <span class="keyword">null</span>;</span><br><span class="line">            map.replaceNode(p.key, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyIterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">BaseIterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">K</span>&gt;, <span class="title">Enumeration</span>&lt;<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">        KeyIterator(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index, <span class="keyword">int</span> size, <span class="keyword">int</span> limit,</span><br><span class="line">                    ConcurrentHashMap&lt;K,V&gt; map) &#123;</span><br><span class="line">            <span class="keyword">super</span>(tab, index, size, limit, map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt; p;</span><br><span class="line">            <span class="keyword">if</span> ((p = next) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">            K k = p.key;</span><br><span class="line">            lastReturned = p;</span><br><span class="line">            advance();</span><br><span class="line">            <span class="keyword">return</span> k;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">nextElement</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> next(); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueIterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">BaseIterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">V</span>&gt;, <span class="title">Enumeration</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        ValueIterator(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index, <span class="keyword">int</span> size, <span class="keyword">int</span> limit,</span><br><span class="line">                      ConcurrentHashMap&lt;K,V&gt; map) &#123;</span><br><span class="line">            <span class="keyword">super</span>(tab, index, size, limit, map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt; p;</span><br><span class="line">            <span class="keyword">if</span> ((p = next) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">            V v = p.val;</span><br><span class="line">            lastReturned = p;</span><br><span class="line">            advance();</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">nextElement</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> next(); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntryIterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">BaseIterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">        EntryIterator(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index, <span class="keyword">int</span> size, <span class="keyword">int</span> limit,</span><br><span class="line">                      ConcurrentHashMap&lt;K,V&gt; map) &#123;</span><br><span class="line">            <span class="keyword">super</span>(tab, index, size, limit, map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> Map.<span class="function">Entry&lt;K,V&gt; <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt; p;</span><br><span class="line">            <span class="keyword">if</span> ((p = next) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">            K k = p.key;</span><br><span class="line">            V v = p.val;</span><br><span class="line">            lastReturned = p;</span><br><span class="line">            advance();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MapEntry&lt;K,V&gt;(k, v, map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Exported Entry for EntryIterator</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapEntry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> K key; <span class="comment">// non-null</span></span><br><span class="line">        V val;       <span class="comment">// non-null</span></span><br><span class="line">        <span class="keyword">final</span> ConcurrentHashMap&lt;K,V&gt; map;</span><br><span class="line">        MapEntry(K key, V val, ConcurrentHashMap&lt;K,V&gt; map) &#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.val = val;</span><br><span class="line">            <span class="keyword">this</span>.map = map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> K <span class="title">getKey</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> V <span class="title">getValue</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> val; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span>    </span>&#123; <span class="keyword">return</span> key.hashCode() ^ val.hashCode(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> key + <span class="string">&quot;=&quot;</span> + val; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            Object k, v; Map.Entry&lt;?,?&gt; e;</span><br><span class="line">            <span class="keyword">return</span> ((o <span class="keyword">instanceof</span> Map.Entry) &amp;&amp;</span><br><span class="line">                    (k = (e = (Map.Entry&lt;?,?&gt;)o).getKey()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (v = e.getValue()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (k == key || k.equals(key)) &amp;&amp;</span><br><span class="line">                    (v == val || v.equals(val)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Sets our entry&#x27;s value and writes through to the map. The</span></span><br><span class="line"><span class="comment">         * value to return is somewhat arbitrary here. Since we do not</span></span><br><span class="line"><span class="comment">         * necessarily track asynchronous changes, the most recent</span></span><br><span class="line"><span class="comment">         * &quot;previous&quot; value could be different from what we return (or</span></span><br><span class="line"><span class="comment">         * could even have been removed, in which case the put will</span></span><br><span class="line"><span class="comment">         * re-establish). We do not and cannot guarantee more.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> V <span class="title">setValue</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            V v = val;</span><br><span class="line">            val = value;</span><br><span class="line">            map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">KeySpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Traverser</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Spliterator</span>&lt;<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> est;               <span class="comment">// size estimate</span></span><br><span class="line">        KeySpliterator(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> size, <span class="keyword">int</span> index, <span class="keyword">int</span> limit,</span><br><span class="line">                       <span class="keyword">long</span> est) &#123;</span><br><span class="line">            <span class="keyword">super</span>(tab, size, index, limit);</span><br><span class="line">            <span class="keyword">this</span>.est = est;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Spliterator&lt;K&gt; <span class="title">trySplit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> i, f, h;</span><br><span class="line">            <span class="keyword">return</span> (h = ((i = baseIndex) + (f = baseLimit)) &gt;&gt;&gt; <span class="number">1</span>) &lt;= i ? <span class="keyword">null</span> :</span><br><span class="line">                <span class="keyword">new</span> KeySpliterator&lt;K,V&gt;(tab, baseSize, baseLimit = h,</span><br><span class="line">                                        f, est &gt;&gt;&gt;= <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> K&gt; action)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>;)</span><br><span class="line">                action.accept(p.key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAdvance</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> K&gt; action)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            Node&lt;K,V&gt; p;</span><br><span class="line">            <span class="keyword">if</span> ((p = advance()) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            action.accept(p.key);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">estimateSize</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> est; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Spliterator.DISTINCT | Spliterator.CONCURRENT |</span><br><span class="line">                Spliterator.NONNULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Traverser</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Spliterator</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> est;               <span class="comment">// size estimate</span></span><br><span class="line">        ValueSpliterator(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> size, <span class="keyword">int</span> index, <span class="keyword">int</span> limit,</span><br><span class="line">                         <span class="keyword">long</span> est) &#123;</span><br><span class="line">            <span class="keyword">super</span>(tab, size, index, limit);</span><br><span class="line">            <span class="keyword">this</span>.est = est;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Spliterator&lt;V&gt; <span class="title">trySplit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> i, f, h;</span><br><span class="line">            <span class="keyword">return</span> (h = ((i = baseIndex) + (f = baseLimit)) &gt;&gt;&gt; <span class="number">1</span>) &lt;= i ? <span class="keyword">null</span> :</span><br><span class="line">                <span class="keyword">new</span> ValueSpliterator&lt;K,V&gt;(tab, baseSize, baseLimit = h,</span><br><span class="line">                                          f, est &gt;&gt;&gt;= <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>;)</span><br><span class="line">                action.accept(p.val);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAdvance</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            Node&lt;K,V&gt; p;</span><br><span class="line">            <span class="keyword">if</span> ((p = advance()) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            action.accept(p.val);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">estimateSize</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> est; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Spliterator.CONCURRENT | Spliterator.NONNULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Traverser</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Spliterator</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ConcurrentHashMap&lt;K,V&gt; map; <span class="comment">// To export MapEntry</span></span><br><span class="line">        <span class="keyword">long</span> est;               <span class="comment">// size estimate</span></span><br><span class="line">        EntrySpliterator(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> size, <span class="keyword">int</span> index, <span class="keyword">int</span> limit,</span><br><span class="line">                         <span class="keyword">long</span> est, ConcurrentHashMap&lt;K,V&gt; map) &#123;</span><br><span class="line">            <span class="keyword">super</span>(tab, size, index, limit);</span><br><span class="line">            <span class="keyword">this</span>.map = map;</span><br><span class="line">            <span class="keyword">this</span>.est = est;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Spliterator&lt;Map.Entry&lt;K,V&gt;&gt; trySplit() &#123;</span><br><span class="line">            <span class="keyword">int</span> i, f, h;</span><br><span class="line">            <span class="keyword">return</span> (h = ((i = baseIndex) + (f = baseLimit)) &gt;&gt;&gt; <span class="number">1</span>) &lt;= i ? <span class="keyword">null</span> :</span><br><span class="line">                <span class="keyword">new</span> EntrySpliterator&lt;K,V&gt;(tab, baseSize, baseLimit = h,</span><br><span class="line">                                          f, est &gt;&gt;&gt;= <span class="number">1</span>, map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> Map.Entry&lt;K,V&gt;&gt; action)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                action.accept(<span class="keyword">new</span> MapEntry&lt;K,V&gt;(p.key, p.val, map));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAdvance</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> Map.Entry&lt;K,V&gt;&gt; action)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            Node&lt;K,V&gt; p;</span><br><span class="line">            <span class="keyword">if</span> ((p = advance()) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            action.accept(<span class="keyword">new</span> MapEntry&lt;K,V&gt;(p.key, p.val, map));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">estimateSize</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> est; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Spliterator.DISTINCT | Spliterator.CONCURRENT |</span><br><span class="line">                Spliterator.NONNULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parallel bulk operations</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Computes initial batch value for bulk tasks. The returned value</span></span><br><span class="line"><span class="comment">     * is approximately exp2 of the number of times (minus one) to</span></span><br><span class="line"><span class="comment">     * split task by two before executing leaf action. This value is</span></span><br><span class="line"><span class="comment">     * faster to compute and more convenient to use as a guide to</span></span><br><span class="line"><span class="comment">     * splitting than is the depth, since it is used while dividing by</span></span><br><span class="line"><span class="comment">     * two anyway.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">batchFor</span><span class="params">(<span class="keyword">long</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n;</span><br><span class="line">        <span class="keyword">if</span> (b == Long.MAX_VALUE || (n = sumCount()) &lt;= <span class="number">1L</span> || n &lt; b)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> sp = ForkJoinPool.getCommonPoolParallelism() &lt;&lt; <span class="number">2</span>; <span class="comment">// slack of 4</span></span><br><span class="line">        <span class="keyword">return</span> (b &lt;= <span class="number">0L</span> || (n /= b) &gt;= sp) ? sp : (<span class="keyword">int</span>)n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs the given action for each (key, value).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action the action</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                        BiConsumer&lt;? <span class="keyword">super</span> K,? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">new</span> ForEachMappingTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             action).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs the given action for each non-null transformation</span></span><br><span class="line"><span class="comment">     * of each (key, value).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element, or null if there is no transformation (in</span></span><br><span class="line"><span class="comment">     * which case the action is not applied)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action the action</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the transformer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function"><span class="keyword">void</span> <span class="title">forEach</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                            BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Consumer&lt;? <span class="keyword">super</span> U&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">new</span> ForEachTransformedMappingTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             transformer, action).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a non-null result from applying the given search</span></span><br><span class="line"><span class="comment">     * function on each (key, value), or null if none.  Upon</span></span><br><span class="line"><span class="comment">     * success, further element processing is suppressed and the</span></span><br><span class="line"><span class="comment">     * results of any other parallel invocations of the search</span></span><br><span class="line"><span class="comment">     * function are ignored.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchFunction a function returning a non-null</span></span><br><span class="line"><span class="comment">     * result on success, else null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the search function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a non-null result from applying the given search</span></span><br><span class="line"><span class="comment">     * function on each (key, value), or null if none</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function">U <span class="title">search</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                        BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; searchFunction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (searchFunction == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SearchMappingsTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             searchFunction, <span class="keyword">new</span> AtomicReference&lt;U&gt;()).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all (key, value) pairs using the given reducer to</span></span><br><span class="line"><span class="comment">     * combine values, or null if none.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element, or null if there is no transformation (in</span></span><br><span class="line"><span class="comment">     * which case it is not combined)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the transformer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all (key, value) pairs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function">U <span class="title">reduce</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                        BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                        BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceMappingsTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all (key, value) pairs using the given reducer to</span></span><br><span class="line"><span class="comment">     * combine values, and the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all (key, value) pairs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">reduceToDouble</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 ToDoubleBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">double</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 DoubleBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceMappingsToDoubleTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all (key, value) pairs using the given reducer to</span></span><br><span class="line"><span class="comment">     * combine values, and the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all (key, value) pairs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">reduceToLong</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                             ToLongBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">long</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                             LongBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceMappingsToLongTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all (key, value) pairs using the given reducer to</span></span><br><span class="line"><span class="comment">     * combine values, and the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all (key, value) pairs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reduceToInt</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                           ToIntBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">int</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                           IntBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceMappingsToIntTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs the given action for each key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action the action</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachKey</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                           Consumer&lt;? <span class="keyword">super</span> K&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">new</span> ForEachKeyTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             action).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs the given action for each non-null transformation</span></span><br><span class="line"><span class="comment">     * of each key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element, or null if there is no transformation (in</span></span><br><span class="line"><span class="comment">     * which case the action is not applied)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action the action</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the transformer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function"><span class="keyword">void</span> <span class="title">forEachKey</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Consumer&lt;? <span class="keyword">super</span> U&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">new</span> ForEachTransformedKeyTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             transformer, action).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a non-null result from applying the given search</span></span><br><span class="line"><span class="comment">     * function on each key, or null if none. Upon success,</span></span><br><span class="line"><span class="comment">     * further element processing is suppressed and the results of</span></span><br><span class="line"><span class="comment">     * any other parallel invocations of the search function are</span></span><br><span class="line"><span class="comment">     * ignored.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchFunction a function returning a non-null</span></span><br><span class="line"><span class="comment">     * result on success, else null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the search function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a non-null result from applying the given search</span></span><br><span class="line"><span class="comment">     * function on each key, or null if none</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function">U <span class="title">searchKeys</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; searchFunction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (searchFunction == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SearchKeysTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             searchFunction, <span class="keyword">new</span> AtomicReference&lt;U&gt;()).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating all keys using the given</span></span><br><span class="line"><span class="comment">     * reducer to combine values, or null if none.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating all keys using the given</span></span><br><span class="line"><span class="comment">     * reducer to combine values, or null if none</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> K <span class="title">reduceKeys</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                        BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> K, ? extends K&gt; reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reducer == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReduceKeysTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all keys using the given reducer to combine values, or</span></span><br><span class="line"><span class="comment">     * null if none.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element, or null if there is no transformation (in</span></span><br><span class="line"><span class="comment">     * which case it is not combined)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the transformer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all keys</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function">U <span class="title">reduceKeys</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">         BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceKeysTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all keys using the given reducer to combine values, and</span></span><br><span class="line"><span class="comment">     * the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all keys</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">reduceKeysToDouble</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     ToDoubleFunction&lt;? <span class="keyword">super</span> K&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">double</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     DoubleBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceKeysToDoubleTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all keys using the given reducer to combine values, and</span></span><br><span class="line"><span class="comment">     * the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all keys</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">reduceKeysToLong</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 ToLongFunction&lt;? <span class="keyword">super</span> K&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">long</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 LongBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceKeysToLongTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all keys using the given reducer to combine values, and</span></span><br><span class="line"><span class="comment">     * the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all keys</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reduceKeysToInt</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                               ToIntFunction&lt;? <span class="keyword">super</span> K&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">int</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                               IntBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceKeysToIntTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs the given action for each value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action the action</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachValue</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Consumer&lt;? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">new</span> ForEachValueTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             action).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs the given action for each non-null transformation</span></span><br><span class="line"><span class="comment">     * of each value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element, or null if there is no transformation (in</span></span><br><span class="line"><span class="comment">     * which case the action is not applied)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action the action</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the transformer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function"><span class="keyword">void</span> <span class="title">forEachValue</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 Consumer&lt;? <span class="keyword">super</span> U&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">new</span> ForEachTransformedValueTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             transformer, action).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a non-null result from applying the given search</span></span><br><span class="line"><span class="comment">     * function on each value, or null if none.  Upon success,</span></span><br><span class="line"><span class="comment">     * further element processing is suppressed and the results of</span></span><br><span class="line"><span class="comment">     * any other parallel invocations of the search function are</span></span><br><span class="line"><span class="comment">     * ignored.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchFunction a function returning a non-null</span></span><br><span class="line"><span class="comment">     * result on success, else null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the search function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a non-null result from applying the given search</span></span><br><span class="line"><span class="comment">     * function on each value, or null if none</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function">U <span class="title">searchValues</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; searchFunction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (searchFunction == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SearchValuesTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             searchFunction, <span class="keyword">new</span> AtomicReference&lt;U&gt;()).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating all values using the</span></span><br><span class="line"><span class="comment">     * given reducer to combine values, or null if none.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating all values</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">reduceValues</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                          BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reducer == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReduceValuesTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all values using the given reducer to combine values, or</span></span><br><span class="line"><span class="comment">     * null if none.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element, or null if there is no transformation (in</span></span><br><span class="line"><span class="comment">     * which case it is not combined)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the transformer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all values</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function">U <span class="title">reduceValues</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceValuesTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all values using the given reducer to combine values,</span></span><br><span class="line"><span class="comment">     * and the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all values</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">reduceValuesToDouble</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       ToDoubleFunction&lt;? <span class="keyword">super</span> V&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">double</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       DoubleBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceValuesToDoubleTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all values using the given reducer to combine values,</span></span><br><span class="line"><span class="comment">     * and the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all values</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">reduceValuesToLong</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   ToLongFunction&lt;? <span class="keyword">super</span> V&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">long</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   LongBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceValuesToLongTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all values using the given reducer to combine values,</span></span><br><span class="line"><span class="comment">     * and the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all values</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reduceValuesToInt</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 ToIntFunction&lt;? <span class="keyword">super</span> V&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">int</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 IntBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceValuesToIntTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs the given action for each entry.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action the action</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachEntry</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Consumer&lt;? <span class="keyword">super</span> Map.Entry&lt;K,V&gt;&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">new</span> ForEachEntryTask&lt;K,V&gt;(<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">                                  action).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Performs the given action for each non-null transformation</span></span><br><span class="line"><span class="comment">     * of each entry.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element, or null if there is no transformation (in</span></span><br><span class="line"><span class="comment">     * which case the action is not applied)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action the action</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the transformer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function"><span class="keyword">void</span> <span class="title">forEachEntry</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 Function&lt;Map.Entry&lt;K,V&gt;, ? extends U&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 Consumer&lt;? <span class="keyword">super</span> U&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">new</span> ForEachTransformedEntryTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             transformer, action).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a non-null result from applying the given search</span></span><br><span class="line"><span class="comment">     * function on each entry, or null if none.  Upon success,</span></span><br><span class="line"><span class="comment">     * further element processing is suppressed and the results of</span></span><br><span class="line"><span class="comment">     * any other parallel invocations of the search function are</span></span><br><span class="line"><span class="comment">     * ignored.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchFunction a function returning a non-null</span></span><br><span class="line"><span class="comment">     * result on success, else null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the search function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a non-null result from applying the given search</span></span><br><span class="line"><span class="comment">     * function on each entry, or null if none</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function">U <span class="title">searchEntries</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Function&lt;Map.Entry&lt;K,V&gt;, ? extends U&gt; searchFunction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (searchFunction == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SearchEntriesTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             searchFunction, <span class="keyword">new</span> AtomicReference&lt;U&gt;()).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating all entries using the</span></span><br><span class="line"><span class="comment">     * given reducer to combine values, or null if none.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating all entries</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map.<span class="function">Entry&lt;K,V&gt; <span class="title">reduceEntries</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        BiFunction&lt;Map.Entry&lt;K,V&gt;, Map.Entry&lt;K,V&gt;, ? extends Map.Entry&lt;K,V&gt;&gt; reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reducer == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReduceEntriesTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all entries using the given reducer to combine values,</span></span><br><span class="line"><span class="comment">     * or null if none.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element, or null if there is no transformation (in</span></span><br><span class="line"><span class="comment">     * which case it is not combined)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;U&gt; the return type of the transformer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all entries</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;U&gt; <span class="function">U <span class="title">reduceEntries</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Function&lt;Map.Entry&lt;K,V&gt;, ? extends U&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                               BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceEntriesTask&lt;K,V,U&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all entries using the given reducer to combine values,</span></span><br><span class="line"><span class="comment">     * and the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all entries</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">reduceEntriesToDouble</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        ToDoubleFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">double</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        DoubleBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceEntriesToDoubleTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all entries using the given reducer to combine values,</span></span><br><span class="line"><span class="comment">     * and the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all entries</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">reduceEntriesToLong</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    ToLongFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">long</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    LongBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceEntriesToLongTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all entries using the given reducer to combine values,</span></span><br><span class="line"><span class="comment">     * and the given basis as an identity value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parallelismThreshold the (estimated) number of elements</span></span><br><span class="line"><span class="comment">     * needed for this operation to be executed in parallel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transformer a function returning the transformation</span></span><br><span class="line"><span class="comment">     * for an element</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basis the identity (initial default value) for the reduction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reducer a commutative associative combining function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of accumulating the given transformation</span></span><br><span class="line"><span class="comment">     * of all entries</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reduceEntriesToInt</span><span class="params">(<span class="keyword">long</span> parallelismThreshold,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  ToIntFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">int</span> basis,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  IntBinaryOperator reducer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (transformer == <span class="keyword">null</span> || reducer == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapReduceEntriesToIntTask&lt;K,V&gt;</span><br><span class="line">            (<span class="keyword">null</span>, batchFor(parallelismThreshold), <span class="number">0</span>, <span class="number">0</span>, table,</span><br><span class="line">             <span class="keyword">null</span>, transformer, basis, reducer).invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ----------------Views -------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base class for views.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectionView</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Collection</span>&lt;<span class="title">E</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7249069246763182397L</span>;</span><br><span class="line">        <span class="keyword">final</span> ConcurrentHashMap&lt;K,V&gt; map;</span><br><span class="line">        CollectionView(ConcurrentHashMap&lt;K,V&gt; map)  &#123; <span class="keyword">this</span>.map = map; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns the map backing this view.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> the map backing this view</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ConcurrentHashMap&lt;K,V&gt; <span class="title">getMap</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> map; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Removes all of the elements from this view, by removing all</span></span><br><span class="line"><span class="comment">         * the mappings from the map backing this view.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span>      </span>&#123; map.clear(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> map.size(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> map.isEmpty(); &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// implementations below rely on concrete classes supplying these</span></span><br><span class="line">        <span class="comment">// abstract methods</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns an iterator over the elements in this collection.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;The returned iterator is</span></span><br><span class="line"><span class="comment">         * &lt;a href=&quot;package-summary.html#Weakly&quot;&gt;&lt;i&gt;weakly consistent&lt;/i&gt;&lt;/a&gt;.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> an iterator over the elements in this collection</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String oomeMsg = <span class="string">&quot;Required array size too large&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> Object[] toArray() &#123;</span><br><span class="line">            <span class="keyword">long</span> sz = map.mappingCount();</span><br><span class="line">            <span class="keyword">if</span> (sz &gt; MAX_ARRAY_SIZE)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError(oomeMsg);</span><br><span class="line">            <span class="keyword">int</span> n = (<span class="keyword">int</span>)sz;</span><br><span class="line">            Object[] r = <span class="keyword">new</span> Object[n];</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (E e : <span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i == n) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (n &gt;= MAX_ARRAY_SIZE)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError(oomeMsg);</span><br><span class="line">                    <span class="keyword">if</span> (n &gt;= MAX_ARRAY_SIZE - (MAX_ARRAY_SIZE &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>)</span><br><span class="line">                        n = MAX_ARRAY_SIZE;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        n += (n &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">                    r = Arrays.copyOf(r, n);</span><br><span class="line">                &#125;</span><br><span class="line">                r[i++] = e;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (i == n) ? r : Arrays.copyOf(r, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> &lt;T&gt; T[] toArray(T[] a) &#123;</span><br><span class="line">            <span class="keyword">long</span> sz = map.mappingCount();</span><br><span class="line">            <span class="keyword">if</span> (sz &gt; MAX_ARRAY_SIZE)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError(oomeMsg);</span><br><span class="line">            <span class="keyword">int</span> m = (<span class="keyword">int</span>)sz;</span><br><span class="line">            T[] r = (a.length &gt;= m) ? a :</span><br><span class="line">                (T[])java.lang.reflect.Array</span><br><span class="line">                .newInstance(a.getClass().getComponentType(), m);</span><br><span class="line">            <span class="keyword">int</span> n = r.length;</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (E e : <span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i == n) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (n &gt;= MAX_ARRAY_SIZE)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError(oomeMsg);</span><br><span class="line">                    <span class="keyword">if</span> (n &gt;= MAX_ARRAY_SIZE - (MAX_ARRAY_SIZE &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>)</span><br><span class="line">                        n = MAX_ARRAY_SIZE;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        n += (n &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">                    r = Arrays.copyOf(r, n);</span><br><span class="line">                &#125;</span><br><span class="line">                r[i++] = (T)e;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (a == r &amp;&amp; i &lt; n) &#123;</span><br><span class="line">                r[i] = <span class="keyword">null</span>; <span class="comment">// null-terminate</span></span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (i == n) ? r : Arrays.copyOf(r, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns a string representation of this collection.</span></span><br><span class="line"><span class="comment">         * The string representation consists of the string representations</span></span><br><span class="line"><span class="comment">         * of the collection&#x27;s elements in the order they are returned by</span></span><br><span class="line"><span class="comment">         * its iterator, enclosed in square brackets (&#123;<span class="doctag">@code</span> &quot;[]&quot;&#125;).</span></span><br><span class="line"><span class="comment">         * Adjacent elements are separated by the characters &#123;<span class="doctag">@code</span> &quot;, &quot;&#125;</span></span><br><span class="line"><span class="comment">         * (comma and space).  Elements are converted to strings as by</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@link</span> String#valueOf(Object)&#125;.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> a string representation of this collection</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            sb.append(<span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">            Iterator&lt;E&gt; it = iterator();</span><br><span class="line">            <span class="keyword">if</span> (it.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    Object e = it.next();</span><br><span class="line">                    sb.append(e == <span class="keyword">this</span> ? <span class="string">&quot;(this Collection)&quot;</span> : e);</span><br><span class="line">                    <span class="keyword">if</span> (!it.hasNext())</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    sb.append(<span class="string">&#x27;,&#x27;</span>).append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.append(<span class="string">&#x27;]&#x27;</span>).toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">containsAll</span><span class="params">(Collection&lt;?&gt; c)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (c != <span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Object e : c) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e == <span class="keyword">null</span> || !contains(e))</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">removeAll</span><span class="params">(Collection&lt;?&gt; c)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">boolean</span> modified = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;E&gt; it = iterator(); it.hasNext();) &#123;</span><br><span class="line">                <span class="keyword">if</span> (c.contains(it.next())) &#123;</span><br><span class="line">                    it.remove();</span><br><span class="line">                    modified = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> modified;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">retainAll</span><span class="params">(Collection&lt;?&gt; c)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">boolean</span> modified = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;E&gt; it = iterator(); it.hasNext();) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!c.contains(it.next())) &#123;</span><br><span class="line">                    it.remove();</span><br><span class="line">                    modified = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> modified;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A view of a ConcurrentHashMap as a &#123;<span class="doctag">@link</span> Set&#125; of keys, in</span></span><br><span class="line"><span class="comment">     * which additions may optionally be enabled by mapping to a</span></span><br><span class="line"><span class="comment">     * common value.  This class cannot be directly instantiated.</span></span><br><span class="line"><span class="comment">     * See &#123;<span class="doctag">@link</span> #keySet() keySet()&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #keySet(Object) keySet(V)&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #newKeySet() newKeySet()&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #newKeySet(int) newKeySet(int)&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">KeySetView</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">CollectionView</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">K</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Set</span>&lt;<span class="title">K</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7249069246763182397L</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> V value;</span><br><span class="line">        KeySetView(ConcurrentHashMap&lt;K,V&gt; map, V value) &#123;  <span class="comment">// non-public</span></span><br><span class="line">            <span class="keyword">super</span>(map);</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns the default mapped value for additions,</span></span><br><span class="line"><span class="comment">         * or &#123;<span class="doctag">@code</span> null&#125; if additions are not supported.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> the default mapped value for additions, or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">         * if not supported</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> V <span class="title">getMappedValue</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> NullPointerException if the specified key is null</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123; <span class="keyword">return</span> map.containsKey(o); &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Removes the key from this map view, by removing the key (and its</span></span><br><span class="line"><span class="comment">         * corresponding value) from the backing map.  This method does</span></span><br><span class="line"><span class="comment">         * nothing if the key is not in the map.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span>  o the key to be removed from the backing map</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the backing map contained the specified key</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> NullPointerException if the specified key is null</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123; <span class="keyword">return</span> map.remove(o) != <span class="keyword">null</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> an iterator over the keys of the backing map</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Iterator&lt;K&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            ConcurrentHashMap&lt;K,V&gt; m = map;</span><br><span class="line">            <span class="keyword">int</span> f = (t = m.table) == <span class="keyword">null</span> ? <span class="number">0</span> : t.length;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> KeyIterator&lt;K,V&gt;(t, f, <span class="number">0</span>, f, m);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Adds the specified key to this set view by mapping the key to</span></span><br><span class="line"><span class="comment">         * the default mapped value in the backing map, if defined.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e key to be added</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if this set changed as a result of the call</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> NullPointerException if the specified key is null</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> UnsupportedOperationException if no default mapped value</span></span><br><span class="line"><span class="comment">         * for additions was provided</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(K e)</span> </span>&#123;</span><br><span class="line">            V v;</span><br><span class="line">            <span class="keyword">if</span> ((v = value) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">            <span class="keyword">return</span> map.putVal(e, v, <span class="keyword">true</span>) == <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Adds all of the elements in the specified collection to this set,</span></span><br><span class="line"><span class="comment">         * as if by calling &#123;<span class="doctag">@link</span> #add&#125; on each one.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> c the elements to be inserted into this set</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if this set changed as a result of the call</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> NullPointerException if the collection or any of its</span></span><br><span class="line"><span class="comment">         * elements are &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> UnsupportedOperationException if no default mapped value</span></span><br><span class="line"><span class="comment">         * for additions was provided</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends K&gt; c)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">boolean</span> added = <span class="keyword">false</span>;</span><br><span class="line">            V v;</span><br><span class="line">            <span class="keyword">if</span> ((v = value) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">            <span class="keyword">for</span> (K e : c) &#123;</span><br><span class="line">                <span class="keyword">if</span> (map.putVal(e, v, <span class="keyword">true</span>) == <span class="keyword">null</span>)</span><br><span class="line">                    added = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> added;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (K e : <span class="keyword">this</span>)</span><br><span class="line">                h += e.hashCode();</span><br><span class="line">            <span class="keyword">return</span> h;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            Set&lt;?&gt; c;</span><br><span class="line">            <span class="keyword">return</span> ((o <span class="keyword">instanceof</span> Set) &amp;&amp;</span><br><span class="line">                    ((c = (Set&lt;?&gt;)o) == <span class="keyword">this</span> ||</span><br><span class="line">                     (containsAll(c) &amp;&amp; c.containsAll(<span class="keyword">this</span>))));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Spliterator&lt;K&gt; <span class="title">spliterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            ConcurrentHashMap&lt;K,V&gt; m = map;</span><br><span class="line">            <span class="keyword">long</span> n = m.sumCount();</span><br><span class="line">            <span class="keyword">int</span> f = (t = m.table) == <span class="keyword">null</span> ? <span class="number">0</span> : t.length;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> KeySpliterator&lt;K,V&gt;(t, f, <span class="number">0</span>, f, n &lt; <span class="number">0L</span> ? <span class="number">0L</span> : n);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> K&gt; action)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            <span class="keyword">if</span> ((t = map.table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, t.length, <span class="number">0</span>, t.length);</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = it.advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    action.accept(p.key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A view of a ConcurrentHashMap as a &#123;<span class="doctag">@link</span> Collection&#125; of</span></span><br><span class="line"><span class="comment">     * values, in which additions are disabled. This class cannot be</span></span><br><span class="line"><span class="comment">     * directly instantiated. See &#123;<span class="doctag">@link</span> #values()&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ValuesView</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">CollectionView</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Collection</span>&lt;<span class="title">V</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2249069246763182397L</span>;</span><br><span class="line">        ValuesView(ConcurrentHashMap&lt;K,V&gt; map) &#123; <span class="keyword">super</span>(map); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> map.containsValue(o);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (o != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Iterator&lt;V&gt; it = iterator(); it.hasNext();) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (o.equals(it.next())) &#123;</span><br><span class="line">                        it.remove();</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Iterator&lt;V&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ConcurrentHashMap&lt;K,V&gt; m = map;</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            <span class="keyword">int</span> f = (t = m.table) == <span class="keyword">null</span> ? <span class="number">0</span> : t.length;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ValueIterator&lt;K,V&gt;(t, f, <span class="number">0</span>, f, m);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(V e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends V&gt; c)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Spliterator&lt;V&gt; <span class="title">spliterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            ConcurrentHashMap&lt;K,V&gt; m = map;</span><br><span class="line">            <span class="keyword">long</span> n = m.sumCount();</span><br><span class="line">            <span class="keyword">int</span> f = (t = m.table) == <span class="keyword">null</span> ? <span class="number">0</span> : t.length;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ValueSpliterator&lt;K,V&gt;(t, f, <span class="number">0</span>, f, n &lt; <span class="number">0L</span> ? <span class="number">0L</span> : n);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            <span class="keyword">if</span> ((t = map.table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, t.length, <span class="number">0</span>, t.length);</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = it.advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    action.accept(p.val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A view of a ConcurrentHashMap as a &#123;<span class="doctag">@link</span> Set&#125; of (key, value)</span></span><br><span class="line"><span class="comment">     * entries.  This class cannot be directly instantiated. See</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #entrySet()&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySetView</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">CollectionView</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Set</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2249069246763182397L</span>;</span><br><span class="line">        EntrySetView(ConcurrentHashMap&lt;K,V&gt; map) &#123; <span class="keyword">super</span>(map); &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            Object k, v, r; Map.Entry&lt;?,?&gt; e;</span><br><span class="line">            <span class="keyword">return</span> ((o <span class="keyword">instanceof</span> Map.Entry) &amp;&amp;</span><br><span class="line">                    (k = (e = (Map.Entry&lt;?,?&gt;)o).getKey()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (r = map.get(k)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (v = e.getValue()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (v == r || v.equals(r)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            Object k, v; Map.Entry&lt;?,?&gt; e;</span><br><span class="line">            <span class="keyword">return</span> ((o <span class="keyword">instanceof</span> Map.Entry) &amp;&amp;</span><br><span class="line">                    (k = (e = (Map.Entry&lt;?,?&gt;)o).getKey()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (v = e.getValue()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    map.remove(k, v));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> an iterator over the entries of the backing map</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> Iterator&lt;Map.Entry&lt;K,V&gt;&gt; iterator() &#123;</span><br><span class="line">            ConcurrentHashMap&lt;K,V&gt; m = map;</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            <span class="keyword">int</span> f = (t = m.table) == <span class="keyword">null</span> ? <span class="number">0</span> : t.length;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> EntryIterator&lt;K,V&gt;(t, f, <span class="number">0</span>, f, m);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Entry&lt;K,V&gt; e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> map.putVal(e.getKey(), e.getValue(), <span class="keyword">false</span>) == <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends Entry&lt;K,V&gt;&gt; c)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">boolean</span> added = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (Entry&lt;K,V&gt; e : c) &#123;</span><br><span class="line">                <span class="keyword">if</span> (add(e))</span><br><span class="line">                    added = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> added;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            <span class="keyword">if</span> ((t = map.table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, t.length, <span class="number">0</span>, t.length);</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = it.advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    h += p.hashCode();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> h;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            Set&lt;?&gt; c;</span><br><span class="line">            <span class="keyword">return</span> ((o <span class="keyword">instanceof</span> Set) &amp;&amp;</span><br><span class="line">                    ((c = (Set&lt;?&gt;)o) == <span class="keyword">this</span> ||</span><br><span class="line">                     (containsAll(c) &amp;&amp; c.containsAll(<span class="keyword">this</span>))));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Spliterator&lt;Map.Entry&lt;K,V&gt;&gt; spliterator() &#123;</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            ConcurrentHashMap&lt;K,V&gt; m = map;</span><br><span class="line">            <span class="keyword">long</span> n = m.sumCount();</span><br><span class="line">            <span class="keyword">int</span> f = (t = m.table) == <span class="keyword">null</span> ? <span class="number">0</span> : t.length;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> EntrySpliterator&lt;K,V&gt;(t, f, <span class="number">0</span>, f, n &lt; <span class="number">0L</span> ? <span class="number">0L</span> : n, m);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> Map.Entry&lt;K,V&gt;&gt; action)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (action == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            Node&lt;K,V&gt;[] t;</span><br><span class="line">            <span class="keyword">if</span> ((t = map.table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Traverser&lt;K,V&gt; it = <span class="keyword">new</span> Traverser&lt;K,V&gt;(t, t.length, <span class="number">0</span>, t.length);</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = it.advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    action.accept(<span class="keyword">new</span> MapEntry&lt;K,V&gt;(p.key, p.val, map));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// -------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base class for bulk tasks. Repeats some fields and code from</span></span><br><span class="line"><span class="comment">     * class Traverser, because we need to subclass CountedCompleter.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">R</span>&gt; <span class="keyword">extends</span> <span class="title">CountedCompleter</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab;        <span class="comment">// same as Traverser</span></span><br><span class="line">        Node&lt;K,V&gt; next;</span><br><span class="line">        TableStack&lt;K,V&gt; stack, spare;</span><br><span class="line">        <span class="keyword">int</span> index;</span><br><span class="line">        <span class="keyword">int</span> baseIndex;</span><br><span class="line">        <span class="keyword">int</span> baseLimit;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> baseSize;</span><br><span class="line">        <span class="keyword">int</span> batch;              <span class="comment">// split control</span></span><br><span class="line"></span><br><span class="line">        BulkTask(BulkTask&lt;K,V,?&gt; par, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t) &#123;</span><br><span class="line">            <span class="keyword">super</span>(par);</span><br><span class="line">            <span class="keyword">this</span>.batch = b;</span><br><span class="line">            <span class="keyword">this</span>.index = <span class="keyword">this</span>.baseIndex = i;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">this</span>.tab = t) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">this</span>.baseSize = <span class="keyword">this</span>.baseLimit = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (par == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">this</span>.baseSize = <span class="keyword">this</span>.baseLimit = t.length;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.baseLimit = f;</span><br><span class="line">                <span class="keyword">this</span>.baseSize = par.baseSize;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Same as Traverser version</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">advance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = next) != <span class="keyword">null</span>)</span><br><span class="line">                e = e.next;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                Node&lt;K,V&gt;[] t; <span class="keyword">int</span> i, n;</span><br><span class="line">                <span class="keyword">if</span> (e != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> next = e;</span><br><span class="line">                <span class="keyword">if</span> (baseIndex &gt;= baseLimit || (t = tab) == <span class="keyword">null</span> ||</span><br><span class="line">                    (n = t.length) &lt;= (i = index) || i &lt; <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> next = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> ((e = tabAt(t, i)) != <span class="keyword">null</span> &amp;&amp; e.hash &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                        tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                        e = <span class="keyword">null</span>;</span><br><span class="line">                        pushState(t, i, n);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeBin)</span><br><span class="line">                        e = ((TreeBin&lt;K,V&gt;)e).first;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        e = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (stack != <span class="keyword">null</span>)</span><br><span class="line">                    recoverState(n);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((index = i + baseSize) &gt;= n)</span><br><span class="line">                    index = ++baseIndex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pushState</span><span class="params">(Node&lt;K,V&gt;[] t, <span class="keyword">int</span> i, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">            TableStack&lt;K,V&gt; s = spare;</span><br><span class="line">            <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">                spare = s.next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                s = <span class="keyword">new</span> TableStack&lt;K,V&gt;();</span><br><span class="line">            s.tab = t;</span><br><span class="line">            s.length = n;</span><br><span class="line">            s.index = i;</span><br><span class="line">            s.next = stack;</span><br><span class="line">            stack = s;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recoverState</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">            TableStack&lt;K,V&gt; s; <span class="keyword">int</span> len;</span><br><span class="line">            <span class="keyword">while</span> ((s = stack) != <span class="keyword">null</span> &amp;&amp; (index += (len = s.length)) &gt;= n) &#123;</span><br><span class="line">                n = len;</span><br><span class="line">                index = s.index;</span><br><span class="line">                tab = s.tab;</span><br><span class="line">                s.tab = <span class="keyword">null</span>;</span><br><span class="line">                TableStack&lt;K,V&gt; next = s.next;</span><br><span class="line">                s.next = spare; <span class="comment">// save for reuse</span></span><br><span class="line">                stack = next;</span><br><span class="line">                spare = s;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span> &amp;&amp; (index += baseSize) &gt;= n)</span><br><span class="line">                index = ++baseIndex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Task classes. Coded in a regular but ugly format/style to</span></span><br><span class="line"><span class="comment">     * simplify checks that each variant differs in the right way from</span></span><br><span class="line"><span class="comment">     * others. The null screenings exist because compilers cannot tell</span></span><br><span class="line"><span class="comment">     * that we&#x27;ve already null-checked task arguments, so we force</span></span><br><span class="line"><span class="comment">     * simplest hoisted bypass to help avoid convoluted traps.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForEachKeyTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> K&gt; action;</span><br><span class="line">        ForEachKeyTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             Consumer&lt;? <span class="keyword">super</span> K&gt; action) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.action = action;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> K&gt; action;</span><br><span class="line">            <span class="keyword">if</span> ((action = <span class="keyword">this</span>.action) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> ForEachKeyTask&lt;K,V&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         action).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>;)</span><br><span class="line">                    action.accept(p.key);</span><br><span class="line">                propagateCompletion();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForEachValueTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> V&gt; action;</span><br><span class="line">        ForEachValueTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             Consumer&lt;? <span class="keyword">super</span> V&gt; action) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.action = action;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> V&gt; action;</span><br><span class="line">            <span class="keyword">if</span> ((action = <span class="keyword">this</span>.action) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> ForEachValueTask&lt;K,V&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         action).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>;)</span><br><span class="line">                    action.accept(p.val);</span><br><span class="line">                propagateCompletion();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForEachEntryTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> Entry&lt;K,V&gt;&gt; action;</span><br><span class="line">        ForEachEntryTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             Consumer&lt;? <span class="keyword">super</span> Entry&lt;K,V&gt;&gt; action) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.action = action;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> Entry&lt;K,V&gt;&gt; action;</span><br><span class="line">            <span class="keyword">if</span> ((action = <span class="keyword">this</span>.action) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> ForEachEntryTask&lt;K,V&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         action).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    action.accept(p);</span><br><span class="line">                propagateCompletion();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForEachMappingTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BiConsumer&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; action;</span><br><span class="line">        ForEachMappingTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             BiConsumer&lt;? <span class="keyword">super</span> K,? <span class="keyword">super</span> V&gt; action) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.action = action;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> BiConsumer&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; action;</span><br><span class="line">            <span class="keyword">if</span> ((action = <span class="keyword">this</span>.action) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> ForEachMappingTask&lt;K,V&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         action).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    action.accept(p.key, p.val);</span><br><span class="line">                propagateCompletion();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForEachTransformedKeyTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> U&gt; action;</span><br><span class="line">        ForEachTransformedKeyTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; transformer, Consumer&lt;? <span class="keyword">super</span> U&gt; action) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer; <span class="keyword">this</span>.action = action;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> U&gt; action;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (action = <span class="keyword">this</span>.action) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> ForEachTransformedKeyTask&lt;K,V,U&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         transformer, action).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    <span class="keyword">if</span> ((u = transformer.apply(p.key)) != <span class="keyword">null</span>)</span><br><span class="line">                        action.accept(u);</span><br><span class="line">                &#125;</span><br><span class="line">                propagateCompletion();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForEachTransformedValueTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> U&gt; action;</span><br><span class="line">        ForEachTransformedValueTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; transformer, Consumer&lt;? <span class="keyword">super</span> U&gt; action) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer; <span class="keyword">this</span>.action = action;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> U&gt; action;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (action = <span class="keyword">this</span>.action) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> ForEachTransformedValueTask&lt;K,V,U&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         transformer, action).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    <span class="keyword">if</span> ((u = transformer.apply(p.val)) != <span class="keyword">null</span>)</span><br><span class="line">                        action.accept(u);</span><br><span class="line">                &#125;</span><br><span class="line">                propagateCompletion();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForEachTransformedEntryTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;Map.Entry&lt;K,V&gt;, ? extends U&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> U&gt; action;</span><br><span class="line">        ForEachTransformedEntryTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             Function&lt;Map.Entry&lt;K,V&gt;, ? extends U&gt; transformer, Consumer&lt;? <span class="keyword">super</span> U&gt; action) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer; <span class="keyword">this</span>.action = action;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Function&lt;Map.Entry&lt;K,V&gt;, ? extends U&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> U&gt; action;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (action = <span class="keyword">this</span>.action) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> ForEachTransformedEntryTask&lt;K,V,U&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         transformer, action).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    <span class="keyword">if</span> ((u = transformer.apply(p)) != <span class="keyword">null</span>)</span><br><span class="line">                        action.accept(u);</span><br><span class="line">                &#125;</span><br><span class="line">                propagateCompletion();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForEachTransformedMappingTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> U&gt; action;</span><br><span class="line">        ForEachTransformedMappingTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; transformer,</span><br><span class="line">             Consumer&lt;? <span class="keyword">super</span> U&gt; action) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer; <span class="keyword">this</span>.action = action;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> U&gt; action;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (action = <span class="keyword">this</span>.action) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> ForEachTransformedMappingTask&lt;K,V,U&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         transformer, action).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    <span class="keyword">if</span> ((u = transformer.apply(p.key, p.val)) != <span class="keyword">null</span>)</span><br><span class="line">                        action.accept(u);</span><br><span class="line">                &#125;</span><br><span class="line">                propagateCompletion();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchKeysTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; searchFunction;</span><br><span class="line">        <span class="keyword">final</span> AtomicReference&lt;U&gt; result;</span><br><span class="line">        SearchKeysTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; searchFunction,</span><br><span class="line">             AtomicReference&lt;U&gt; result) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.searchFunction = searchFunction; <span class="keyword">this</span>.result = result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> U <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result.get(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; searchFunction;</span><br><span class="line">            <span class="keyword">final</span> AtomicReference&lt;U&gt; result;</span><br><span class="line">            <span class="keyword">if</span> ((searchFunction = <span class="keyword">this</span>.searchFunction) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (result = <span class="keyword">this</span>.result) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (result.get() != <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> SearchKeysTask&lt;K,V,U&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         searchFunction, result).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (result.get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    Node&lt;K,V&gt; p;</span><br><span class="line">                    <span class="keyword">if</span> ((p = advance()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        propagateCompletion();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((u = searchFunction.apply(p.key)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (result.compareAndSet(<span class="keyword">null</span>, u))</span><br><span class="line">                            quietlyCompleteRoot();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchValuesTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; searchFunction;</span><br><span class="line">        <span class="keyword">final</span> AtomicReference&lt;U&gt; result;</span><br><span class="line">        SearchValuesTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; searchFunction,</span><br><span class="line">             AtomicReference&lt;U&gt; result) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.searchFunction = searchFunction; <span class="keyword">this</span>.result = result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> U <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result.get(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; searchFunction;</span><br><span class="line">            <span class="keyword">final</span> AtomicReference&lt;U&gt; result;</span><br><span class="line">            <span class="keyword">if</span> ((searchFunction = <span class="keyword">this</span>.searchFunction) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (result = <span class="keyword">this</span>.result) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (result.get() != <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> SearchValuesTask&lt;K,V,U&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         searchFunction, result).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (result.get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    Node&lt;K,V&gt; p;</span><br><span class="line">                    <span class="keyword">if</span> ((p = advance()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        propagateCompletion();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((u = searchFunction.apply(p.val)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (result.compareAndSet(<span class="keyword">null</span>, u))</span><br><span class="line">                            quietlyCompleteRoot();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchEntriesTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;Entry&lt;K,V&gt;, ? extends U&gt; searchFunction;</span><br><span class="line">        <span class="keyword">final</span> AtomicReference&lt;U&gt; result;</span><br><span class="line">        SearchEntriesTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             Function&lt;Entry&lt;K,V&gt;, ? extends U&gt; searchFunction,</span><br><span class="line">             AtomicReference&lt;U&gt; result) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.searchFunction = searchFunction; <span class="keyword">this</span>.result = result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> U <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result.get(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Function&lt;Entry&lt;K,V&gt;, ? extends U&gt; searchFunction;</span><br><span class="line">            <span class="keyword">final</span> AtomicReference&lt;U&gt; result;</span><br><span class="line">            <span class="keyword">if</span> ((searchFunction = <span class="keyword">this</span>.searchFunction) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (result = <span class="keyword">this</span>.result) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (result.get() != <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> SearchEntriesTask&lt;K,V,U&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         searchFunction, result).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (result.get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    Node&lt;K,V&gt; p;</span><br><span class="line">                    <span class="keyword">if</span> ((p = advance()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        propagateCompletion();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((u = searchFunction.apply(p)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (result.compareAndSet(<span class="keyword">null</span>, u))</span><br><span class="line">                            quietlyCompleteRoot();</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchMappingsTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; searchFunction;</span><br><span class="line">        <span class="keyword">final</span> AtomicReference&lt;U&gt; result;</span><br><span class="line">        SearchMappingsTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; searchFunction,</span><br><span class="line">             AtomicReference&lt;U&gt; result) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t);</span><br><span class="line">            <span class="keyword">this</span>.searchFunction = searchFunction; <span class="keyword">this</span>.result = result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> U <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result.get(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; searchFunction;</span><br><span class="line">            <span class="keyword">final</span> AtomicReference&lt;U&gt; result;</span><br><span class="line">            <span class="keyword">if</span> ((searchFunction = <span class="keyword">this</span>.searchFunction) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (result = <span class="keyword">this</span>.result) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (result.get() != <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> SearchMappingsTask&lt;K,V,U&gt;</span><br><span class="line">                        (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                         searchFunction, result).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (result.get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    Node&lt;K,V&gt; p;</span><br><span class="line">                    <span class="keyword">if</span> ((p = advance()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        propagateCompletion();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((u = searchFunction.apply(p.key, p.val)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (result.compareAndSet(<span class="keyword">null</span>, u))</span><br><span class="line">                            quietlyCompleteRoot();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReduceKeysTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> K, ? extends K&gt; reducer;</span><br><span class="line">        K result;</span><br><span class="line">        ReduceKeysTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        ReduceKeysTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             ReduceKeysTask&lt;K,V&gt; nextRight,</span><br><span class="line">             BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> K, ? extends K&gt; reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> K, ? extends K&gt; reducer;</span><br><span class="line">            <span class="keyword">if</span> ((reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> ReduceKeysTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                K r = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    K u = p.key;</span><br><span class="line">                    r = (r == <span class="keyword">null</span>) ? u : u == <span class="keyword">null</span> ? r : reducer.apply(r, u);</span><br><span class="line">                &#125;</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    ReduceKeysTask&lt;K,V&gt;</span><br><span class="line">                        t = (ReduceKeysTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        K tr, sr;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = s.result) != <span class="keyword">null</span>)</span><br><span class="line">                            t.result = (((tr = t.result) == <span class="keyword">null</span>) ? sr :</span><br><span class="line">                                        reducer.apply(tr, sr));</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReduceValuesTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; reducer;</span><br><span class="line">        V result;</span><br><span class="line">        ReduceValuesTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        ReduceValuesTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             ReduceValuesTask&lt;K,V&gt; nextRight,</span><br><span class="line">             BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; reducer;</span><br><span class="line">            <span class="keyword">if</span> ((reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> ReduceValuesTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                V r = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    V v = p.val;</span><br><span class="line">                    r = (r == <span class="keyword">null</span>) ? v : reducer.apply(r, v);</span><br><span class="line">                &#125;</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    ReduceValuesTask&lt;K,V&gt;</span><br><span class="line">                        t = (ReduceValuesTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        V tr, sr;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = s.result) != <span class="keyword">null</span>)</span><br><span class="line">                            t.result = (((tr = t.result) == <span class="keyword">null</span>) ? sr :</span><br><span class="line">                                        reducer.apply(tr, sr));</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReduceEntriesTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BiFunction&lt;Map.Entry&lt;K,V&gt;, Map.Entry&lt;K,V&gt;, ? extends Map.Entry&lt;K,V&gt;&gt; reducer;</span><br><span class="line">        Map.Entry&lt;K,V&gt; result;</span><br><span class="line">        ReduceEntriesTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        ReduceEntriesTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             ReduceEntriesTask&lt;K,V&gt; nextRight,</span><br><span class="line">             BiFunction&lt;Entry&lt;K,V&gt;, Map.Entry&lt;K,V&gt;, ? extends Map.Entry&lt;K,V&gt;&gt; reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> Map.<span class="function">Entry&lt;K,V&gt; <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> BiFunction&lt;Map.Entry&lt;K,V&gt;, Map.Entry&lt;K,V&gt;, ? extends Map.Entry&lt;K,V&gt;&gt; reducer;</span><br><span class="line">            <span class="keyword">if</span> ((reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> ReduceEntriesTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                Map.Entry&lt;K,V&gt; r = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = (r == <span class="keyword">null</span>) ? p : reducer.apply(r, p);</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    ReduceEntriesTask&lt;K,V&gt;</span><br><span class="line">                        t = (ReduceEntriesTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Map.Entry&lt;K,V&gt; tr, sr;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = s.result) != <span class="keyword">null</span>)</span><br><span class="line">                            t.result = (((tr = t.result) == <span class="keyword">null</span>) ? sr :</span><br><span class="line">                                        reducer.apply(tr, sr));</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceKeysTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer;</span><br><span class="line">        U result;</span><br><span class="line">        MapReduceKeysTask&lt;K,V,U&gt; rights, nextRight;</span><br><span class="line">        MapReduceKeysTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceKeysTask&lt;K,V,U&gt; nextRight,</span><br><span class="line">             Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; transformer,</span><br><span class="line">             BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> U <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> K, ? extends U&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceKeysTask&lt;K,V,U&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                U r = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    <span class="keyword">if</span> ((u = transformer.apply(p.key)) != <span class="keyword">null</span>)</span><br><span class="line">                        r = (r == <span class="keyword">null</span>) ? u : reducer.apply(r, u);</span><br><span class="line">                &#125;</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceKeysTask&lt;K,V,U&gt;</span><br><span class="line">                        t = (MapReduceKeysTask&lt;K,V,U&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        U tr, sr;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = s.result) != <span class="keyword">null</span>)</span><br><span class="line">                            t.result = (((tr = t.result) == <span class="keyword">null</span>) ? sr :</span><br><span class="line">                                        reducer.apply(tr, sr));</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceValuesTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer;</span><br><span class="line">        U result;</span><br><span class="line">        MapReduceValuesTask&lt;K,V,U&gt; rights, nextRight;</span><br><span class="line">        MapReduceValuesTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceValuesTask&lt;K,V,U&gt; nextRight,</span><br><span class="line">             Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; transformer,</span><br><span class="line">             BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> U <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> V, ? extends U&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceValuesTask&lt;K,V,U&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                U r = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    <span class="keyword">if</span> ((u = transformer.apply(p.val)) != <span class="keyword">null</span>)</span><br><span class="line">                        r = (r == <span class="keyword">null</span>) ? u : reducer.apply(r, u);</span><br><span class="line">                &#125;</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceValuesTask&lt;K,V,U&gt;</span><br><span class="line">                        t = (MapReduceValuesTask&lt;K,V,U&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        U tr, sr;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = s.result) != <span class="keyword">null</span>)</span><br><span class="line">                            t.result = (((tr = t.result) == <span class="keyword">null</span>) ? sr :</span><br><span class="line">                                        reducer.apply(tr, sr));</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceEntriesTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;Map.Entry&lt;K,V&gt;, ? extends U&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer;</span><br><span class="line">        U result;</span><br><span class="line">        MapReduceEntriesTask&lt;K,V,U&gt; rights, nextRight;</span><br><span class="line">        MapReduceEntriesTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceEntriesTask&lt;K,V,U&gt; nextRight,</span><br><span class="line">             Function&lt;Map.Entry&lt;K,V&gt;, ? extends U&gt; transformer,</span><br><span class="line">             BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> U <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Function&lt;Map.Entry&lt;K,V&gt;, ? extends U&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceEntriesTask&lt;K,V,U&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                U r = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    <span class="keyword">if</span> ((u = transformer.apply(p)) != <span class="keyword">null</span>)</span><br><span class="line">                        r = (r == <span class="keyword">null</span>) ? u : reducer.apply(r, u);</span><br><span class="line">                &#125;</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceEntriesTask&lt;K,V,U&gt;</span><br><span class="line">                        t = (MapReduceEntriesTask&lt;K,V,U&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        U tr, sr;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = s.result) != <span class="keyword">null</span>)</span><br><span class="line">                            t.result = (((tr = t.result) == <span class="keyword">null</span>) ? sr :</span><br><span class="line">                                        reducer.apply(tr, sr));</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceMappingsTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer;</span><br><span class="line">        U result;</span><br><span class="line">        MapReduceMappingsTask&lt;K,V,U&gt; rights, nextRight;</span><br><span class="line">        MapReduceMappingsTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceMappingsTask&lt;K,V,U&gt; nextRight,</span><br><span class="line">             BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; transformer,</span><br><span class="line">             BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> U <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends U&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> BiFunction&lt;? <span class="keyword">super</span> U, ? <span class="keyword">super</span> U, ? extends U&gt; reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceMappingsTask&lt;K,V,U&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                U r = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                    U u;</span><br><span class="line">                    <span class="keyword">if</span> ((u = transformer.apply(p.key, p.val)) != <span class="keyword">null</span>)</span><br><span class="line">                        r = (r == <span class="keyword">null</span>) ? u : reducer.apply(r, u);</span><br><span class="line">                &#125;</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceMappingsTask&lt;K,V,U&gt;</span><br><span class="line">                        t = (MapReduceMappingsTask&lt;K,V,U&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        U tr, sr;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = s.result) != <span class="keyword">null</span>)</span><br><span class="line">                            t.result = (((tr = t.result) == <span class="keyword">null</span>) ? sr :</span><br><span class="line">                                        reducer.apply(tr, sr));</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceKeysToDoubleTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Double</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToDoubleFunction&lt;? <span class="keyword">super</span> K&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> DoubleBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">double</span> basis;</span><br><span class="line">        <span class="keyword">double</span> result;</span><br><span class="line">        MapReduceKeysToDoubleTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceKeysToDoubleTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceKeysToDoubleTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToDoubleFunction&lt;? <span class="keyword">super</span> K&gt; transformer,</span><br><span class="line">             <span class="keyword">double</span> basis,</span><br><span class="line">             DoubleBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Double <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToDoubleFunction&lt;? <span class="keyword">super</span> K&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> DoubleBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">double</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceKeysToDoubleTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsDouble(r, transformer.applyAsDouble(p.key));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceKeysToDoubleTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceKeysToDoubleTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsDouble(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceValuesToDoubleTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Double</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToDoubleFunction&lt;? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> DoubleBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">double</span> basis;</span><br><span class="line">        <span class="keyword">double</span> result;</span><br><span class="line">        MapReduceValuesToDoubleTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceValuesToDoubleTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceValuesToDoubleTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToDoubleFunction&lt;? <span class="keyword">super</span> V&gt; transformer,</span><br><span class="line">             <span class="keyword">double</span> basis,</span><br><span class="line">             DoubleBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Double <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToDoubleFunction&lt;? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> DoubleBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">double</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceValuesToDoubleTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsDouble(r, transformer.applyAsDouble(p.val));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceValuesToDoubleTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceValuesToDoubleTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsDouble(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceEntriesToDoubleTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Double</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToDoubleFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> DoubleBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">double</span> basis;</span><br><span class="line">        <span class="keyword">double</span> result;</span><br><span class="line">        MapReduceEntriesToDoubleTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceEntriesToDoubleTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceEntriesToDoubleTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToDoubleFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer,</span><br><span class="line">             <span class="keyword">double</span> basis,</span><br><span class="line">             DoubleBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Double <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToDoubleFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> DoubleBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">double</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceEntriesToDoubleTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsDouble(r, transformer.applyAsDouble(p));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceEntriesToDoubleTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceEntriesToDoubleTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsDouble(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceMappingsToDoubleTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Double</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToDoubleBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> DoubleBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">double</span> basis;</span><br><span class="line">        <span class="keyword">double</span> result;</span><br><span class="line">        MapReduceMappingsToDoubleTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceMappingsToDoubleTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceMappingsToDoubleTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToDoubleBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer,</span><br><span class="line">             <span class="keyword">double</span> basis,</span><br><span class="line">             DoubleBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Double <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToDoubleBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> DoubleBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">double</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceMappingsToDoubleTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsDouble(r, transformer.applyAsDouble(p.key, p.val));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceMappingsToDoubleTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceMappingsToDoubleTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsDouble(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceKeysToLongTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToLongFunction&lt;? <span class="keyword">super</span> K&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> LongBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> basis;</span><br><span class="line">        <span class="keyword">long</span> result;</span><br><span class="line">        MapReduceKeysToLongTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceKeysToLongTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceKeysToLongTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToLongFunction&lt;? <span class="keyword">super</span> K&gt; transformer,</span><br><span class="line">             <span class="keyword">long</span> basis,</span><br><span class="line">             LongBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Long <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToLongFunction&lt;? <span class="keyword">super</span> K&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> LongBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceKeysToLongTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsLong(r, transformer.applyAsLong(p.key));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceKeysToLongTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceKeysToLongTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsLong(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceValuesToLongTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToLongFunction&lt;? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> LongBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> basis;</span><br><span class="line">        <span class="keyword">long</span> result;</span><br><span class="line">        MapReduceValuesToLongTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceValuesToLongTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceValuesToLongTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToLongFunction&lt;? <span class="keyword">super</span> V&gt; transformer,</span><br><span class="line">             <span class="keyword">long</span> basis,</span><br><span class="line">             LongBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Long <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToLongFunction&lt;? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> LongBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceValuesToLongTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsLong(r, transformer.applyAsLong(p.val));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceValuesToLongTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceValuesToLongTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsLong(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceEntriesToLongTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToLongFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> LongBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> basis;</span><br><span class="line">        <span class="keyword">long</span> result;</span><br><span class="line">        MapReduceEntriesToLongTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceEntriesToLongTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceEntriesToLongTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToLongFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer,</span><br><span class="line">             <span class="keyword">long</span> basis,</span><br><span class="line">             LongBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Long <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToLongFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> LongBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceEntriesToLongTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsLong(r, transformer.applyAsLong(p));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceEntriesToLongTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceEntriesToLongTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsLong(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceMappingsToLongTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToLongBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> LongBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> basis;</span><br><span class="line">        <span class="keyword">long</span> result;</span><br><span class="line">        MapReduceMappingsToLongTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceMappingsToLongTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceMappingsToLongTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToLongBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer,</span><br><span class="line">             <span class="keyword">long</span> basis,</span><br><span class="line">             LongBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Long <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToLongBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> LongBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceMappingsToLongTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsLong(r, transformer.applyAsLong(p.key, p.val));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceMappingsToLongTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceMappingsToLongTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsLong(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceKeysToIntTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToIntFunction&lt;? <span class="keyword">super</span> K&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> IntBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> basis;</span><br><span class="line">        <span class="keyword">int</span> result;</span><br><span class="line">        MapReduceKeysToIntTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceKeysToIntTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceKeysToIntTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToIntFunction&lt;? <span class="keyword">super</span> K&gt; transformer,</span><br><span class="line">             <span class="keyword">int</span> basis,</span><br><span class="line">             IntBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Integer <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToIntFunction&lt;? <span class="keyword">super</span> K&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> IntBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceKeysToIntTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsInt(r, transformer.applyAsInt(p.key));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceKeysToIntTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceKeysToIntTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsInt(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceValuesToIntTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToIntFunction&lt;? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> IntBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> basis;</span><br><span class="line">        <span class="keyword">int</span> result;</span><br><span class="line">        MapReduceValuesToIntTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceValuesToIntTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceValuesToIntTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToIntFunction&lt;? <span class="keyword">super</span> V&gt; transformer,</span><br><span class="line">             <span class="keyword">int</span> basis,</span><br><span class="line">             IntBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Integer <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToIntFunction&lt;? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> IntBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceValuesToIntTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsInt(r, transformer.applyAsInt(p.val));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceValuesToIntTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceValuesToIntTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsInt(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceEntriesToIntTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToIntFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> IntBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> basis;</span><br><span class="line">        <span class="keyword">int</span> result;</span><br><span class="line">        MapReduceEntriesToIntTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceEntriesToIntTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceEntriesToIntTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToIntFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer,</span><br><span class="line">             <span class="keyword">int</span> basis,</span><br><span class="line">             IntBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Integer <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToIntFunction&lt;Map.Entry&lt;K,V&gt;&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> IntBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceEntriesToIntTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsInt(r, transformer.applyAsInt(p));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceEntriesToIntTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceEntriesToIntTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsInt(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapReduceMappingsToIntTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">BulkTask</span>&lt;<span class="title">K</span>,<span class="title">V</span>,<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ToIntBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">        <span class="keyword">final</span> IntBinaryOperator reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> basis;</span><br><span class="line">        <span class="keyword">int</span> result;</span><br><span class="line">        MapReduceMappingsToIntTask&lt;K,V&gt; rights, nextRight;</span><br><span class="line">        MapReduceMappingsToIntTask</span><br><span class="line">            (BulkTask&lt;K,V,?&gt; p, <span class="keyword">int</span> b, <span class="keyword">int</span> i, <span class="keyword">int</span> f, Node&lt;K,V&gt;[] t,</span><br><span class="line">             MapReduceMappingsToIntTask&lt;K,V&gt; nextRight,</span><br><span class="line">             ToIntBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer,</span><br><span class="line">             <span class="keyword">int</span> basis,</span><br><span class="line">             IntBinaryOperator reducer) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p, b, i, f, t); <span class="keyword">this</span>.nextRight = nextRight;</span><br><span class="line">            <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">            <span class="keyword">this</span>.basis = basis; <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Integer <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ToIntBiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; transformer;</span><br><span class="line">            <span class="keyword">final</span> IntBinaryOperator reducer;</span><br><span class="line">            <span class="keyword">if</span> ((transformer = <span class="keyword">this</span>.transformer) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (reducer = <span class="keyword">this</span>.reducer) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> r = <span class="keyword">this</span>.basis;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = baseIndex, f, h; batch &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         (h = ((f = baseLimit) + i) &gt;&gt;&gt; <span class="number">1</span>) &gt; i;) &#123;</span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    (rights = <span class="keyword">new</span> MapReduceMappingsToIntTask&lt;K,V&gt;</span><br><span class="line">                     (<span class="keyword">this</span>, batch &gt;&gt;&gt;= <span class="number">1</span>, baseLimit = h, f, tab,</span><br><span class="line">                      rights, transformer, r, reducer)).fork();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; p; (p = advance()) != <span class="keyword">null</span>; )</span><br><span class="line">                    r = reducer.applyAsInt(r, transformer.applyAsInt(p.key, p.val));</span><br><span class="line">                result = r;</span><br><span class="line">                CountedCompleter&lt;?&gt; c;</span><br><span class="line">                <span class="keyword">for</span> (c = firstComplete(); c != <span class="keyword">null</span>; c = c.nextComplete()) &#123;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    MapReduceMappingsToIntTask&lt;K,V&gt;</span><br><span class="line">                        t = (MapReduceMappingsToIntTask&lt;K,V&gt;)c,</span><br><span class="line">                        s = t.rights;</span><br><span class="line">                    <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        t.result = reducer.applyAsInt(t.result, s.result);</span><br><span class="line">                        s = t.rights = s.nextRight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unsafe mechanics</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe U;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SIZECTL;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TRANSFERINDEX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> BASECOUNT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLSBUSY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLVALUE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> ABASE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ASHIFT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; k = ConcurrentHashMap.class;</span><br><span class="line">            SIZECTL = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">&quot;sizeCtl&quot;</span>));</span><br><span class="line">            TRANSFERINDEX = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">&quot;transferIndex&quot;</span>));</span><br><span class="line">            BASECOUNT = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">&quot;baseCount&quot;</span>));</span><br><span class="line">            CELLSBUSY = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">&quot;cellsBusy&quot;</span>));</span><br><span class="line">            Class&lt;?&gt; ck = CounterCell.class;</span><br><span class="line">            CELLVALUE = U.objectFieldOffset</span><br><span class="line">                (ck.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">            Class&lt;?&gt; ak = Node[].class;</span><br><span class="line">            ABASE = U.arrayBaseOffset(ak);</span><br><span class="line">            <span class="keyword">int</span> scale = U.arrayIndexScale(ak);</span><br><span class="line">            <span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;data type scale not a power of two&quot;</span>);</span><br><span class="line">            ASHIFT = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">]]></content>
      <categories>
        <category>Java基础知识</category>
      </categories>
      <tags>
        <tag>随笔记录</tag>
      </tags>
  </entry>
</search>
